if($==undefined){$=jQuery}var dateformat=["yyyymmdd","yyyy-mm-dd","yyyy年mm月dd日","yyyymm","yyyy-mm","yyyy年mm月","yyyy","yyyy年"];function loadData(){var b=$("#tableid").val();if(b==""){$("#tabledata").html("")}else{var a=b.split(",");pageJson.tid=a[0];pageJson.tName=a[1];$.ajax({type:"POST",url:"../etl/queryTableData.action",dataType:"HTML",data:{tableName:pageJson.tName,saveType:a[2]=="n"?"sql":"",tableId:a[0]},success:function(c){$("#tabledata").html(c)}})}}function cubehome(){$("#seltables").css("display","block");$("#showcolumns").css("display","none");$("#cubeinfo").css("display","none")}function cubenext(){var b=$("#cubename").val();if(b==""){$.messager.alert("出错了","请录入名称！","error",function(){$("#cubename").focus()});return}var a=$("#ftype").val();if(a==""){$.messager.alert("出错了","请选中一个分类！","error",function(){});return}var d=$("#tableid").val();if(d==""){$.messager.alert("出错了","请选中一个数据表！","error",function(){});return}var c;$.ajax({type:"POST",url:"tableExist.action",async:false,dataType:"json",data:{tableId:pageJson.tid},success:function(e){c=Number(e.rows)}});if(c>0){$.messager.alert("出错了","您选择的数据表已经建模！","error",function(){$("#tableid").focus()});return}$("#seltables").css("display","none");$("#showcolumns").css("display","block");$("#cubeinfo").css("display","none");pageJson.tDesc=b;pageJson.tNote=$("#cubenote").val();pageJson.typeId=a;getColumns()}function cubenext2(){$("#showcolumns").css("display","none");$("#cubeinfo").css("display","block");$.ajax({type:"POST",url:"../etl/getTableColumns.action",dataType:"JSON",data:{tableId:pageJson.tid},success:function(c){var b=[{id:"leftroot",text:pageJson.tName,iconCls:"icon-table",children:[]}];for(i=0;i<c.length;i++){var a={id:c[i].colName,text:(c[i].colNote?c[i].colNote:c[i].colName),iconCls:"icon-dscol",attributes:{tp:"node",vtype:c[i].colType,col:c[i].colName,expression:c[i].expression}};b[0].children.push(a)}$("#cubelefttree").tree({data:b});$("#autoCubeBtn").unbind("click").bind("click",function(){autoCube(c)});$("#addDateDimBtn").unbind("click").bind("click",function(){addDateDim(c)});$("#addDynaBtn").unbind("click").bind("click",function(){editCalcKpi(pageJson.tid)})}});initRightCubeTree({tid:pageJson.tid})}function autoCube(b){var b=$("#cubelefttree").tree("getChildren",$("#cubelefttree").tree("find","leftroot").target);for(x=0;x<b.length;x++){var a=b[x];if($(a.target).attr("hide")=="y"){continue}var d=a.attributes.vtype;if(d=="Double"||d=="Int"){var e=findCubeMaxId($("#cuberighttree").tree("find","cubedl").target);var c={id:e,text:"sum("+a.text+")",attributes:{tp:"kpi",drag:true,aggre:"sum",col:(a.attributes.expression==null?a.attributes.col:a.attributes.expression),colNote:a.attributes.colNote,dispName:a.text,alias:"d"+e,vtype:d,fromCol:a.attributes.col,calcKpi:0,calc:(a.attributes.expression==null?0:1)},iconCls:"icon-kpi"};$("#cuberighttree").tree("append",{parent:$("#cuberighttree").tree("find","cubedl").target,data:c});$(a.target).attr("hide","y").hide()}else{if(d=="Datetime"){}else{var e=findCubeMaxId($("#cuberighttree").tree("find","cubewd").target);var c={id:e,text:a.text,attributes:{tp:"dim",drag:true,col:(a.attributes.expression==null?a.attributes.col:a.attributes.expression),dispName:a.text,colNote:a.attributes.colNote,tname:a.attributes.tname,vtype:a.attributes.vtype,alias:"k"+e,fromCol:a.attributes.col},iconCls:"icon-dim",targetId:""};$("#cuberighttree").tree("append",{parent:$("#cuberighttree").tree("find","cubewd").target,data:c});$(a.target).attr("hide","y").hide()}}}}function initRightCubeTree(a){var o=[{id:"cbroot",text:"数据立方体",iconCls:"icon-cube",children:[]}];o[0].children.push({id:"cubewd",text:"维度",iconCls:"icon-dim2",children:[]});o[0].children.push({id:"cubedl",text:"度量",iconCls:"icon-kpigroup",children:[]});if(a&&a.dims&&a.kpis){var h=o[0].children[0].children;var c=function(p){var d=h;var k=null;for(e=0;e<d.length;e++){if(d[e].id==p){k=d[e];break}}return k};for(i=0;i<a.dims.length;i++){var g=a.dims[i];var f={id:g.id,text:g.dimdesc,attributes:{tp:"dim",drag:true,col:g.colname,dispName:g.dimdesc,vtype:g.vtype,alias:g.alias,dimtype:g.type,colkey:(g.tableColKey==null?"":g.tableColKey),coltext:(g.tableColName==null?"":g.tableColName),ordcol:(g.ordcol==null?"":g.ordcol),dimord:(g.dimord==null?"":g.dimord),dateformat:(g.dateformat==null?"":g.dateformat),targetId:g.id,fromCol:g.fromCol},iconCls:"icon-dim"};if(g.grouptype!=""&&g.grouptype!=null){var m=c(g.grouptype);if(m==null){f={id:g.grouptype,text:g.groupname,iconCls:"icon-group",children:[f],attributes:{tp:"group",dispName:g.groupname,drag:true,targetId:g.grouptype}};o[0].children[0].children.push(f)}else{m.children.push(f)}}else{o[0].children[0].children.push(f)}}var n=o[0].children[1].children;var b=function(d){var k=null;for(l=0;l<n.length;l++){if(n[l].id==d){k=n[l];break}}return k};for(i=0;i<a.kpis.length;i++){var e=a.kpis[i];var f={id:e.colId,text:e.aggre+"("+e.name+")",attributes:{tp:"kpi",drag:true,aggre:e.aggre,col:(e.calcKpi==1||e.calc==1?e.col:e.fromCol),unit:(e.unit==null?"":e.unit),fmt:(e.fmt==null?"":e.fmt),dispName:e.name,alias:e.alias,kpinote:(e.kpinote==null?"":e.kpinote),calcKpi:e.calcKpi,calc:e.calc,targetId:e.colId,fromCol:e.fromCol},iconCls:(e.calcKpi==0?"icon-kpi":"icon-ckpi")};if(e.kpiGroup!=null&&e.kpiGroup!=""){var m=b(e.kpiGroup);if(m==null){n.push({id:e.kpiGroup,text:e.kpiGroupName,iconCls:"icon-open",children:[f],attributes:{tp:"kpigroup",dispName:e.kpiGroupName,drag:true,targetId:e.kpiGroup}})}else{m.children.push(f)}}else{n.push(f)}}}$("#cuberighttree").tree({data:o,dnd:true,onBeforeDrag:function(d){if(d.attributes&&d.attributes.drag){return true}else{return false}},onDragEnter:function(p,k){var d=$("#cuberighttree").tree("getNode",p);if(d.id=="cbroot"){return false}else{return true}},onBeforeDrop:function(r,q,d){var p=$("#cuberighttree").tree("getNode",r);if(!p.attributes||p.attributes.drag==false){return false}var k=q.attributes.tp,t=p.attributes.tp;if((k=="kpigroup"||k=="kpi")&&(t=="dim"||t=="group")){return false}if((k=="dim"||k=="group")&&(t=="kpigroup"||t=="kpi")){return false}if(((k=="group"&&t=="dim")||(k=="kpigroup"&&t=="kpi"))&&d=="append"){return false}if((k=="kpi"&&t=="kpi"&&d=="append")||(k=="dim"&&t=="dim"&&d=="append")||(k=="group"&&t=="group"&&d=="append")||(k=="kpigroup"&&t=="kpigroup"&&d=="append")){return false}return true},onDblClick:function(d){editcubecol(a.tid)},onDrop:function(p,k,d){k.attributes.isupdate="y"}})}function editcubecol(e){var n=$("#cuberighttree").tree("getSelected");if(n==null||!n.attributes){msginfo("您还未选择需要编辑的度量或维度。");return}var a=n.id;if(!a){return}if(n.attributes.tp=="kpi"&&n.attributes.calcKpi==1){editCalcKpi(e,true,n.id);return}var o="";var m=["sum","avg","count","count(distinct)","max","min"];if(n.attributes.tp=="dim"){var k=$("#cubelefttree").tree("getChildren",$("#cubelefttree").tree("find","leftroot").target);var b='<option value=""></option>';var g='<option value=""></option>';for(i=0;i<k.length;i++){var h=k[i];b=b+'<option value="'+h.id+"@"+h.attributes.vtype+'" '+(n.attributes.colkey==h.id?"selected":"")+">"+h.id+"</option>";g=g+'<option value="'+h.id+'" '+(n.attributes.coltext==h.id?"selected":"")+">"+h.id+"</option>"}var d='<option value=""></option>';for(i=0;i<dateformat.length;i++){d=d+'<option value="'+dateformat[i]+'" '+(n.attributes.dateformat==dateformat[i]?"selected":"")+">"+dateformat[i]+"</option>"}o='<div class="textpanel"><span class="inputtext">维度字段：</span>'+n.attributes.col+'<br/><span class="inputtext">别名：</span>'+n.attributes.alias+'<br/><span class="inputtext">显示名称：</span><input type="text" id="dimname" name="dimname" class="inputform" value="'+n.attributes.dispName+'"><br/><span class="inputtext">维度类型：</span><select id="dimtype" name="dimtype" class="inputform"><option value=""></option><option value="year" '+(n.attributes.dimtype=="year"?"selected":"")+'>年</option><option value="quarter" '+(n.attributes.dimtype=="quarter"?"selected":"")+'>季度</option><option value="month" '+(n.attributes.dimtype=="month"?"selected":"")+'>月</option><option value="day" '+(n.attributes.dimtype=="day"?"selected":"")+'>日</option><option value="prov" '+(n.attributes.dimtype=="prov"?"selected":"")+'>省份</option><option value="city" '+(n.attributes.dimtype=="city"?"selected":"")+'>地市</option></select><br/><span class="inputtext">维度格式：</span><select id="dateformat" class="inputform">'+d+'</select><br/><span class="inputtext">维度Key字段：</span><select id="colkey" class="inputform" name="colkey">'+b+'</select><br/><span class="inputtext">维度Text字段：</span><select id="coltext" name="coltext" class="inputform">'+g+'</select><br/><span class="inputtext">排序方式：</span><select id="dimord" name="dimord" class="inputform"><option value=""></option><option '+(n.attributes.dimord=="asc"?"selected":"")+' value="asc">正序</option><option value="desc" '+(n.attributes.dimord=="desc"?"selected":"")+">倒叙</option></select></div>"}else{if(n.attributes.tp=="kpi"){var f="";for(i=0;i<m.length;i++){f=f+'<option value="'+m[i]+'" '+(m[i]==n.attributes.aggre?"selected":"")+">"+m[i]+"</option>"}o='<div class="textpanel"><span class="inputtext">度量字段：</span>'+n.attributes.col+'<br/><span class="inputtext">别名：</span>'+n.attributes.alias+'<br/><span class="inputtext">显示名称：</span><input type="text" id="kpiname" name="kpiname" class="inputform" value="'+n.attributes.dispName+'"><br/><span class="inputtext">计算方式：</span><select id="kpiaggre" name="kpiaggre" class="inputform">'+f+'</select> <br><span class="inputtext">度量单位：</span><input type="text" id="kpiunit" name="kpiunit" class="inputform" value="'+(n.attributes.unit?n.attributes.unit:"")+'"> <br><span class="inputtext">格式化：</span>'+ftmstr("kpifmt","inputform",n.attributes.fmt?n.attributes.fmt:"")+'<br/><span class="inputtext">度量解释：</span><textarea name="kpinote" id="kpinote"  cols="25" style="height:32px;line-height:20px;" class="inputform" rows="2">'+(n.attributes.kpinote?n.attributes.kpinote:"")+"</textarea></div>"}else{if(n.attributes.tp=="group"){o='<div class="textpanel"><span class="inputtext">分组名称：</span><input type="text" id="groupname" name="groupname" value="'+n.attributes.dispName+'" class="inputform"><br/></div>'}else{if(n.attributes.tp=="kpigroup"){o='<div class="textpanel"><span class="inputtext">度量分类：</span><input type="text" id="kpigroup" name="kpigroup" value="'+n.attributes.dispName+'" class="inputform"><br/></div>'}}}}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:n.attributes.tp=="group"||n.attributes.tp=="kpigroup"?"编辑分组":"编辑维度及度量",width:420,height:n.attributes.tp=="group"||n.attributes.tp=="kpigroup"?180:380,closed:false,cache:false,modal:true,toolbar:null,content:o,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){if(n.attributes.tp=="kpi"){n.attributes.aggre=$("#dsColumn_div #kpiaggre").val();n.attributes.fmt=$("#dsColumn_div #kpifmt").val();n.attributes.unit=$("#dsColumn_div #kpiunit").val();n.attributes.dispName=$("#dsColumn_div #kpiname").val();n.attributes.kpinote=$("#dsColumn_div #kpinote").val();n.attributes.isupdate="y";$("#cuberighttree").tree("update",{target:n.target,text:n.attributes.aggre+"("+n.attributes.dispName+")"})}else{if(n.attributes.tp=="dim"){var r=$("#dsColumn_div #dimtype").val();var p=$("#dsColumn_div #dateformat").val();if(r!=""&&(r=="year"||r=="month"||r=="quarter"||r=="day")&&p==""){msginfo("请选择时间维度格式。",function(){$("#dsColumn_div #dateformat").select()});return}n.attributes.dispName=$("#dsColumn_div #dimname").val();n.attributes.dimtype=r;var s=$("#dsColumn_div #colkey").val();if(s!=""){var q=s.split("@");n.attributes.colkey=q[0];n.attributes.vtype=q[1]}else{n.attributes.colkey="";var u=n.attributes.fromCol;var t=$("#cubelefttree").tree("find",u);n.attributes.vtype=t.attributes.vtype}n.attributes.coltext=$("#dsColumn_div #coltext").val();n.attributes.dimord=$("#dsColumn_div #dimord").val();n.attributes.dateformat=p;n.attributes.isupdate="y";$("#cuberighttree").tree("update",{target:n.target,text:$("#dsColumn_div #dimname").val()})}else{if(n.attributes.tp=="group"){n.attributes.dispName=$("#dsColumn_div #groupname").val();n.attributes.isupdate="y";$("#cuberighttree").tree("update",{target:n.target,text:$("#dsColumn_div #groupname").val()})}else{if(n.attributes.tp=="kpigroup"){n.attributes.dispName=$("#dsColumn_div #kpigroup").val();n.attributes.isupdate="y";$("#cuberighttree").tree("update",{target:n.target,text:$("#dsColumn_div #kpigroup").val()})}}}}$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function addgroup(){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var a='<div class="textpanel"><span class="inputtext">分组名称：</span><input type="text" value="" id="groupname" name="groupname" class="inputform"></div>';$("#dsColumn_div").dialog({title:"创建维度分组",width:320,height:160,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var b=$("#dsColumn_div #groupname").val();if(b==""){msginfo("请填写分组名称！");$("#dsColumn_div #groupname").focus();return}var d=newGuid();var c={id:d,text:b,iconCls:"icon-group",attributes:{tp:"group",dispName:b,drag:true}};$("#cuberighttree").tree("append",{parent:$("#cuberighttree").tree("find","cubewd").target,data:[c]});$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function editCalcKpi(b,c,g){var h;if(c){h=$("#cuberighttree").tree("getSelected")}var m=["sum","avg","count","max","min","distinct"];var d="";for(i=0;i<m.length;i++){d=d+'<option value="'+m[i]+'" '+(h&&m[i]==h.attributes.aggre?"selected":"")+">"+m[i]+"</option>"}var e="";var f=$("#cubelefttree").tree("getChildren",$("#cubelefttree").tree("find","leftroot").target);for(i=0;i<f.length;i++){var a=f[i].attributes;e=e+'<button name="'+a.col+'" expression="'+(a.expression==null?"":a.expression)+'" class="btn btn-primary btn-xs">'+a.col+"</button> "}e=e+"<br/>";for(i=0;i<m.length;i++){e=e+'<button name="'+m[i]+'( )" class="btn btn-primary btn-xs">'+m[i]+"</button> "}var n='<div class="textpanel"><span class="inputtext">度量标识：</span><input type="text" class="inputform" name="alias" id="alias" value="'+(h?h.attributes.alias:"")+'" placeholder="英文字符"><br/><span class="inputtext">显示名称：</span><input type="text" class="inputform" name="kpiname" id="kpiname" value="'+(h?h.attributes.dispName:"")+'"><br/><table cellspacing="0" cellpadding="0"><tbody><tr><td valign="top"><span class="inputtext">表 达 式：<a hef=\'javascript:;\' onclick=\'bdshelper2()\'><i class="fa fa-question-circle"></i></a></span></td><td><textarea rows="2" style="height:52px; line-height:20px;" cols="40" id="expression" name="expression" class="inputform">'+(h?h.attributes.col:"")+"</textarea></td><td valign='top'> <buttton class='btn btn-default btn-sm' style='margin-left:5px;' id=\"testDynacolBtn\">测试</button></td></tr></tbody></table><div class=\"actColumn\">"+e+'</div><span class="inputtext">计算方式：</span><select id="kpiaggre" name="kpiaggre" class="inputform">'+d+'</select><br><span class="inputtext">度量单位：</span><input type="text" value="'+(h?h.attributes.unit:"")+'" class="inputform" name="kpiunit" id="kpiunit"><br/><span class="inputtext">格式化：</span>'+ftmstr("kpifmt","inputform",(h?h.attributes.fmt:""))+'<br/><span class="inputtext">指标解释：</span><textarea name="kpinote" id="kpinote"  cols="25" style="height:32px;line-height:20px;" class="inputform" rows="2">'+(h?h.attributes.kpinote:"")+"</textarea></div>";if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:c?"编辑表达式度量":"创建表达式度量",width:450,height:420,closed:false,cache:false,modal:true,toolbar:null,content:n,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var p=$("#dsColumn_div #alias").val();var o=$("#dsColumn_div #kpiname").val();var q=$("#dsColumn_div #expression").val();if(p==""){msginfo("请填写度量标识。");$("#dsColumn_div #alias").focus();return}if(ischinese(p)){msginfo("度量标识只能是英文字符。");$("#dsColumn_div #alias").focus();return}if(o==""){msginfo("请填写度量名称。");$("#dsColumn_div #kpiname").focus();return}if(q==""){msginfo("请填写度量表达式。");$("#dsColumn_div #expression").focus();return}var k=function(){if(c){h.attributes.aggre=$("#dsColumn_div #kpiaggre").val();h.attributes.fmt=$("#dsColumn_div #kpifmt").val();h.attributes.unit=$("#dsColumn_div #kpiunit").val();h.attributes.dispName=o;h.attributes.kpinote=$("#dsColumn_div #kpinote").val();h.attributes.col=q;h.attributes.alias=$("#dsColumn_div #alias").val();h.attributes.isupdate="y";$("#cuberighttree").tree("update",{target:h.target,text:h.attributes.aggre+"("+o+")"})}else{var s=findCubeMaxId($("#cuberighttree").tree("find","cubedl").target);var r={id:s,text:$("#dsColumn_div #kpiaggre").val()+"("+o+")",attributes:{tp:"kpi",calcKpi:1,calc:0,drag:true,aggre:$("#dsColumn_div #kpiaggre").val(),col:q,alias:$("#dsColumn_div #alias").val(),dispName:o,tname:"",fmt:$("#dsColumn_div #kpifmt").val(),unit:$("#dsColumn_div #kpiunit").val(),kpinote:$("#dsColumn_div #kpinote").val()},iconCls:"icon-ckpi"};$("#cuberighttree").tree("append",{parent:$("#cuberighttree").tree("find","cubedl").target,data:[r]})}$("#dsColumn_div").dialog("close")};$.ajax({type:"POST",url:"../etl/testDynaColumn.action",dataType:"json",data:{expression:escape(q),tid:b,mustAgg:true},success:function(r){if(r.result==1){k()}else{$.messager.alert("表达式出错",r.msg,"error")}}})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#dsColumn_div .actColumn button").bind("click",function(){var k=$(this).attr("name");var o=$(this).attr("expression");if(o&&o!=""){k=o}insertText2focus(document.getElementById("expression"),k+" ")});$("#testDynacolBtn").unbind("click").bind("click",function(){var k=$("#expression").val();if(k==""){$.messager.alert("出错了","请录入表达式。","error");return}$.ajax({type:"POST",url:"../etl/testDynaColumn.action",dataType:"json",data:{expression:escape(k),tid:b,mustAgg:true},success:function(o){if(o.result==1){$.messager.alert("成功了","表达式测试成功。","info")}else{$.messager.alert("出错了",o.msg,"error")}}})})}function findCubeMaxId(c){var b=0;var a=$("#cuberighttree").tree("getChildren",c);for(i=0;i<a.length;i++){if(Number(a[i].id)>b){b=Number(a[i].id)}}return b+1}function ds2cube(){var c=$("#cubelefttree").tree("getSelected");if(c==null){$.messager.alert("出错了","您还未从左边选择字段。","error");return}if(!c.attributes){$.messager.alert("出错了","请选择字段。","error");return}if($(c.target).attr("hide")=="y"){return}var a=$("#cuberighttree").tree("getSelected");if(a==null){$.messager.alert("出错了","您还未选择右边度量或维度。","error");return}var b=$("#cuberighttree").tree("getParent",a.target);if(b==null){$.messager.alert("出错了","您还未选择右边度量或维度。","error");return}if(a.text=="度量"||b.text=="度量"||(b.attributes&&b.attributes.tp=="kpigroup")){var e=findCubeMaxId($("#cuberighttree").tree("find","cubedl").target);var d={id:e,text:"sum("+c.text+")",attributes:{tp:"kpi",drag:true,aggre:"sum",col:(c.attributes.expression==null?c.attributes.col:c.attributes.expression),dispName:c.text,alias:"d"+e,fromCol:c.attributes.col,calcKpi:0,calc:(c.attributes.expression==null?0:1)},iconCls:"icon-kpi"};if(a.text=="度量"||(b.text=="度量"&&a.attributes.tp=="kpigroup")){$("#cuberighttree").tree("append",{parent:a.target,data:d})}else{$("#cuberighttree").tree("insert",{after:a.target,data:d})}$(c.target).attr("hide","y").hide()}else{if(a.text=="维度"||b.text=="维度"||(b.attributes&&b.attributes.tp=="group")){var e=findCubeMaxId($("#cuberighttree").tree("find","cubewd").target);var d={id:e,text:c.text,attributes:{tp:"dim",drag:true,col:(c.attributes.expression==null?c.attributes.col:c.attributes.expression),dispName:c.text,tname:c.attributes.tname,vtype:c.attributes.vtype,alias:"k"+e,fromCol:c.attributes.col},iconCls:"icon-dim",targetId:""};if(a.text=="维度"||(b.text=="维度"&&a.attributes.tp=="group")){$("#cuberighttree").tree("append",{parent:a.target,data:d})}else{$("#cuberighttree").tree("insert",{after:a.target,data:d})}$(c.target).attr("hide","y").hide()}}}function cube2ds(){var b=$("#cuberighttree").tree("getSelected");if(b==null||!b.attributes){$.messager.alert("出错了","您还未选择需要删除的度量或维度。","error");return}if(b.attributes.tp=="group"){if($("#cuberighttree").tree("getChildren",b.target).length>0){$.messager.alert("出错了","您要删除的分组含有维度，不能删除。","error");return}}if(b.attributes.tp=="kpigroup"){if($("#cuberighttree").tree("getChildren",b.target).length>0){$.messager.alert("出错了","您要删除的分类下含有度量，不能删除。","error");return}}if(b.attributes.tp!="group"){var d=b.attributes.fromCol;var a=$("#cubelefttree").tree("getRoot");var c=$("#cubelefttree").tree("getChildren",a.target);for(i=0;i<c.length;i++){if(c[i].id==d){$(c[i].target).attr("hide","n").show();break}}}if(window.delObj){window.delObj.push({type:b.attributes.tp,id:b.attributes.targetId})}$("#cuberighttree").tree("remove",b.target)}function getColumns(a){if(!a){a=pageJson.tid}$.ajax({type:"POST",url:"newCubeStep2.action",dataType:"HTML",data:{tableId:a},success:function(b){$("#showcolumns_ctx").html(b)}})}function createDyna(g,d,a){var f=d?d:pageJson.tid;var h;var b;$.ajax({type:"GET",url:"../etl/getTableColumns.action",async:false,dataType:"JSON",data:{tableId:f},success:function(o){h=o;if(g){for(j=0;j<o.length;j++){if(o[j].colId==a){b=o[j];break}}}}});if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var m='<div class="actColumn" style="margin-top:12px;">';var e=h;for(i=0;i<e.length;i++){if(e[i].expression==null){m=m+'<button class="btn btn-primary btn-xs" name="'+e[i].colName+'">'+e[i].colName+"</button> "}}var k="";var c=["String","Int","Double","Date"];for(i=0;i<c.length;i++){k=k+'<option value="'+c[i]+'" '+(b&&b.colType==c[i]?"selected":"")+">"+c[i]+"</option>"}m=m+"</div>";var n='<div class="textpanel"><span class="inputtext">字段名：</span><input type="text" id="colname" name="colname" class="inputform" value="'+(b?b.colName:"")+'" placeholder="添加后不能更改"><br/><span class="inputtext">备注：</span><input type="text" id="note" name="note" class="inputform" value="'+(b&&b.colNote!=null?b.colNote:"")+'"><br/><span class="inputtext">字段类型：</span><select id="ctype" name="ctype" class="inputform" value="">'+k+'</select><br/><table cellspacing="0" cellpadding="0"><tbody><tr><td valign="top"><span class="inputtext">表 达 式：<a hef=\'javascript:;\' onclick=\'bdshelper()\'><i class="fa fa-question-circle"></i></a></span></td><td><textarea name="expression" id="expression" class="inputform" style="height:52px; line-height:20px;">'+(b?b.expression:"")+"</textarea></td><td valign='top'> <buttton class='btn btn-default btn-sm' style='margin-left:5px;' id=\"testDynacolBtn\">测试</button></td></tr></tbody></table>"+m+"</div>";$("#dsColumn_div").dialog({title:!g?"创建动态字段":"修改动态字段",width:450,height:320,closed:false,cache:false,modal:true,toolbar:null,content:n,onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var r=$("#dsColumn_div #colname").val();var q=$("#dsColumn_div #note").val();var s=$("#dsColumn_div #expression").val();var p=$("#dsColumn_div #ctype").val();if(r==""){$.messager.alert("出错了","字段名是必填项。","error",function(){$("#colname").focus()});return}if(ischinese(r)){$.messager.alert("出错了","字段名必须是英文字符。","error",function(){$("#colname").focus()});return}if(s==""){$.messager.alert("出错了","表达式是必填项。","error",function(){$("#expression").focus()});return}var o=function(){if(g){$.ajax({type:"POST",url:"../etl/updateTableDyna.action",dataType:"json",data:{tableId:f,colId:a,colName:r,colNote:q,expression:s,colType:p},success:function(t){$("#dsColumn_div").dialog("close");getColumns(d);$("#pdailog").dialog("close")}})}else{$.ajax({type:"POST",url:"../etl/createTableDyna.action",dataType:"json",data:{tableId:f,colName:r,colNote:q,expression:s,colType:p},success:function(t){$("#dsColumn_div").dialog("close");getColumns(d)}})}};$.ajax({type:"POST",url:"../etl/testDynaColumn.action",dataType:"json",data:{expression:escape(s),tid:f,mustAgg:false},success:function(t){if(t.result==1){o()}else{$.messager.alert("表达式错误",t.msg,"error")}}})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#dsColumn_div .actColumn button").bind("click",function(){var o=$(this).attr("name")+" ";insertText2focus(document.getElementById("expression"),o)});$("#testDynacolBtn").unbind("click").bind("click",function(){var o=$("#expression").val();if(o==""){$.messager.alert("出错了","请录入表达式。","error");return}$.ajax({type:"POST",url:"../etl/testDynaColumn.action",dataType:"json",data:{expression:escape(o),tid:f,mustAgg:true},success:function(p){if(p.result==1){$.messager.alert("成功了","表达式测试成功。","info")}else{$.messager.alert("出错了",p.msg,"error")}}})})}function removeDyna(c,a){var b;if(a){b=a}else{b=pageJson.tid}if(confirm("是否确认删除？")){$.ajax({type:"POST",url:"../etl/delTableColumn.action",dataType:"json",data:{tableId:b,colId:c},success:function(d){getColumns(b)}})}}function savecubecfg(m,e){var c=[];var n=$("#cuberighttree").tree("getChildren",$("#cuberighttree").tree("find","cubewd").target);if(n.length==0){msginfo("您还未配置维度。");return}var f=null;for(i=0;i<n.length;i++){var k=n[i];if(k.attributes.tp=="group"){f=k}else{var g={name:k.attributes.dispName,type:k.attributes.dimtype,col:k.attributes.col,alias:k.attributes.alias,vtype:k.attributes.vtype,colkey:k.attributes.colkey,coltext:k.attributes.coltext,ordcol:k.attributes.ordcol,dimord:k.attributes.dimord,dateformat:k.attributes.dateformat,targetId:k.attributes.targetId,isupdate:k.attributes.isupdate,fromCol:k.attributes.fromCol};var a=$("#cuberighttree").tree("getParent",k.target);if(a.attributes&&a.attributes.tp=="group"){g.groupName=a.text;g.groupId=a.id}else{g.groupName="";g.groupId=""}c.push(g)}}var h=[];var q=$("#cuberighttree").tree("getChildren",$("#cuberighttree").tree("find","cubedl").target);if(q.length==0){msginfo("您还未配置度量。");return}for(i=0;i<q.length;i++){var s=q[i];if(s.attributes.tp=="kpigroup"){}else{var b={name:s.attributes.dispName,col:s.attributes.col,alias:s.attributes.alias,fmt:s.attributes.fmt,unit:s.attributes.unit,aggre:s.attributes.aggre,kpinote:s.attributes.kpinote,calcKpi:s.attributes.calcKpi,calc:s.attributes.calc,targetId:s.attributes.targetId,isupdate:s.attributes.isupdate,fromCol:s.attributes.fromCol};var a=$("#cuberighttree").tree("getParent",q[i].target);if(a.attributes&&a.attributes.tp=="kpigroup"){b.kpiGroupName=a.text;b.kpiGroup=a.id}else{b.kpiGroupName="";b.kpiGroup=""}h.push(b)}}m.dims=c;m.kpis=h;if(e){m.delObj=window.delObj}var r=JSON.stringify(m);if(e){__showLoading();$.ajax({type:"POST",url:"updateCube.action",dataType:"json",contentType:"application/json",data:r,success:function(d){__hideLoading();$.messager.alert("提示信息","立方体更新成功。","info");$("#cubelist").bootstrapTable("refresh",{query:{t:Math.random()}})},error:function(){__hideLoading();msginfo("立方体更新失败。")}})}else{$.ajax({type:"POST",url:"saveCube.action",dataType:"json",contentType:"application/json",data:r,success:function(d){$.messager.alert("提示信息","立方体配置成功。","info",function(){location.href="SubjectManager.action"})},error:function(){msginfo("立方体配置失败。")}})}}function editcube(c){window.delObj=[];var a;var b="";var d=function(m){a=m.table;for(i=0;i<m.types.length;i++){b=b+'<option value="'+m.types[i].dsId+'" '+(m.types[i].dsId==a.typeId?"selected":"")+">"+m.types[i].name+"</option>"}var n='<div style="margin:5px;"><button class="btn btn-sm btn-info" onclick="createDyna(false, '+a.tid+')" >创建动态字段</button></div><div id="showcolumns_ctx"><table cellspacing="0" cellpadding="0" class="grid3"><tbody><tr><th width="10%">操作</th><th width="19%">字段名</th><th width="10%">字段类型</th><th width="9%">长度</th><th width="33%">表达式</th><th width="16%">备注</th></tr>';for(i=0;i<m.cols.length;i++){var h=m.cols[i];n=n+'<tr><td align="center" class="kpiData1 grid3-td">'+(h.expression!=null&&h.expression.length>0?'<button class="btn btn-info btn-xs" onclick="createDyna(true,'+a.tid+","+h.colId+')"><i class="fa fa-edit"></i></button> <button class="btn btn-danger btn-xs" onclick="removeDyna('+h.colId+","+a.tid+')"><i class="fa fa-remove"></i></button>':"")+'</td><td class="kpiData1 grid3-td">'+h.colName+'</td><td align="center" class="kpiData1 grid3-td">'+h.colType+'</td><td align="center" class="kpiData1 grid3-td">'+(h.colLength==null?"":h.colLength)+'</td><td align="center" class="kpiData1 grid3-td">'+(h.expression==null?"":h.expression)+'</td><td class="kpiData1 grid3-td">'+(h.colNote==null?"":h.colNote)+"</td></tr>"}n=n+"</tbody></table></div>";var o='<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top" align="right"><div class="easyui-panel" data-options="width:220,height:380,cls:\'mycubecfg\'" title="待选字段"><ul id="cubelefttree"></ul></div></td> <td align="center" valign="top"><p style="height:150px;"></p><button type="button" title="选择" class="btn btn-success btn-circle" onclick="ds2cube()">&gt;</button><br/><br/><button type="button" onclick="cube2ds()" class="btn btn-success btn-circle" title="移除">&lt;</button></td><td valign="top"><div class="easyui-panel" data-options="width:220,height:380,cls:\'mycubecfg\'" title="维度和度量"><ul id="cuberighttree"></ul></div></td><td valign="top"><div style="width:80px;line-height:25px;"><button class="btn btn-default btn-xs" style="width:70px;" id="addDateDimBtn"><i class="fa fa-calendar-plus-o"></i>时间维度</button><br/><button class="btn btn-default btn-xs" style="width:70px;" onclick="addgroup()" ><i class="fa fa-plus"></i> 维度分组</button><br/><button style="width:70px;" class="btn btn-default btn-xs" onclick="editCalcKpi('+c+',false);"><i class="fa fa-plus-square"></i> 计算度量</button><br/><button style="width:70px;" class="btn btn-default btn-xs" onclick="kpiCatalog();"><i class="fa fa-folder-open-o"></i>度量分类</button><br/><button onclick="editcubecol('+c+');" class="btn btn-default btn-xs" style="width:70px;"><i class="fa fa-edit"></i> 编辑</button><br/><button onclick="cube2ds();" class="btn btn-default btn-xs" style="width:70px;"><i class="fa fa-remove"></i> 删除</button></div></td></tr></table>';var p='<div id="crtdataset" data-options="fit:true,border:false,tabPosition:\'left\'"><div title="基本信息"><div class="textpanel"><span class="inputtext">数据模型名称：</span><input type="text" value="'+a.tDesc+'" class="inputform" id="name"><br/><span class="inputtext">所属分类：</span><select id="cubetype" class="inputform">'+b+'</select><br/><span class="inputtext">备注信息：</span><input type="text" value="'+(a.tNote==null?"":a.tNote)+'" class="inputform" id="note"><br/><span class="inputtext">对应数据表：</span>'+a.tName+'</div></div><div title="表字段">'+n+'</div><div title="数据预览" href="../etl/queryTableData.action?tableId='+a.tid+'"></div><div title="立方体信息">'+o+"</div></div>";$("#pdailog").dialog({title:"编辑数据模型",width:760,height:470,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:p,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var s=$("#pdailog #name").val();var u=$("#pdailog #cubetype").val();var t=$("#pdailog #note").val();if(s==""){$.messager.alert("出错了","请填写数据模型名称！","error");return}var r={};r.tDesc=s;r.tNote=t;r.typeId=u;r.tid=c;savecubecfg(r,true);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#crtfz,#crtcalckpi,#dim_editbtn,#dim_delbtn").linkbutton({});$("#crtdataset").tabs({});$("#addDateDimBtn").click(function(){addDateDim(m.cols)});var q=function(t){var s=[{id:"leftroot",text:a.tName,iconCls:"icon-table",children:[]}];for(i=0;i<t.length;i++){var r={id:t[i].colName,text:(t[i].colNote?t[i].colNote:t[i].colName),iconCls:"icon-dscol",attributes:{tp:"node",vtype:t[i].colType,col:t[i].colName,expression:t[i].expression}};s[0].children.push(r)}$("#cubelefttree").tree({data:s,dnd:false})};q(m.cols);initRightCubeTree(a);var k=a;var f=function(s){var r=null;for(j=0;j<k.dims.length;j++){if(k.dims[j].fromCol==s){r=k.dims[j];break}}if(r==null){for(j=0;j<k.kpis.length;j++){if(k.kpis[j].fromCol==s){r=k.kpis[j];break}}}return r};var e=$("#cubelefttree").tree("getChildren",$("#cubelefttree").tree("find","leftroot").target);for(i=0;i<e.length;i++){var g=e[i].id;if(f(g)!=null){$(e[i].target).attr("hide","y").hide()}}};__showLoading();$.ajax({type:"POST",url:"getSubject.action",dataType:"JSON",data:{tableId:c,t:Math.random()},success:function(e){__hideLoading();d(e)}})}function addDateDim(e){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var d=function(h){var g=$("#cuberighttree").tree("getChildren",$("#cuberighttree").tree("getRoot").target);for(l=0;l<g.length;l++){if(g[l].attributes&&g[l].attributes.fromCol==h){return true}}return false};var f='<option value=""></option>';for(i=0;i<e.length;i++){var b=e[i];if((b.colType=="Datetime"||b.colType=="Date")&&!d(b.colName)){f=f+'<option value="'+b.colName+'">'+(b.colNote?b.colNote:b.colName)+"</option> "}}var a='<div class="textpanel"><p class="text-warning">根据您数据表中的时间字段自动创建分析维度。</p><span class="inputtext">时间列：</span><select id="timecol" name="timecol" class="inputform2">'+f+'</select><br/><span class="inputtext">分析维度：</span><label><input type="checkbox" name="dims" value="year" desc="年" fmt="yyyy" dbfmt1="%Y" checked="true" dbfmt2="yyyy">年</label>   <label><input type="checkbox" name="dims" value="month" desc="月份" fmt="yyyy-mm" dbfmt1="%Y-%m" checked="true" dbfmt2="yyyy-MM">月份</label>  <label><input type="checkbox" name="dims" value="day" desc="日期" fmt="yyyy-mm-dd"  dbfmt1="%Y-%m-%d" checked="true" dbfmt2="yyyy-MM-dd">日期</label></div>';$("#dsColumn_div").dialog({title:"创建时间维度",width:360,height:220,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var h=$("#dsColumn_div #timecol").val();var g=[];$("#dsColumn_div input[name='dims']:checked").each(function(k){var m=$(this);g.push({key:m.val(),text:m.attr("desc"),fmt:m.attr("fmt"),dbfmt1:m.attr("dbfmt1"),dbfmt2:m.attr("dbfmt2")})});if(h==""){msginfo("请选择时间列。");return}if(g.length==0){return}var c=function(r){var n=newGuid();var p={id:n,text:"时间",iconCls:"icon-group",attributes:{tp:"group",dispName:"时间",drag:true}};$("#cuberighttree").tree("append",{parent:$("#cuberighttree").tree("find","cubewd").target,data:[p]});var k=[];for(b=0;b<g.length;b++){var t=findCubeMaxId($("#cuberighttree").tree("find","cubewd").target)+b;var m=g[b].text;var s="";if("mysql"==r){s="DATE_FORMAT("+h+",'"+g[b].dbfmt1+"')"}else{if("oracle"==r){s="to_char("+h+",'"+g[b].dbfmt2+"')"}}var q={id:t,text:m,attributes:{tp:"dim",drag:true,col:s,dispName:m,colNote:m,tname:"",dimtype:g[b].key,dateformat:g[b].fmt,dimord:"asc",vtype:"String",alias:"k"+t,fromCol:h},iconCls:"icon-dim",targetId:""};k.push(q)}$("#cuberighttree").tree("append",{parent:$("#cuberighttree").tree("find",n).target,data:k});$("#dsColumn_div").dialog("close")};$.getJSON("../etl/getDBName.action",{},function(k){c(k.rows)})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function kpiCatalog(){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var a='<div class="textpanel"><span class="inputtext">分类名称：</span><input type="text" value="" id="kpigroup" name="kpigroup" class="inputform"></div>';$("#dsColumn_div").dialog({title:"创建度量分类",width:320,height:160,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var b=$("#dsColumn_div #kpigroup").val();if(b==""){msginfo("请填写分类名称！");$("#dsColumn_div #kpigroup").focus();return}var d=newGuid();var c={id:d,text:b,iconCls:"icon-open",attributes:{tp:"kpigroup",dispName:b,drag:true}};$("#cuberighttree").tree("append",{parent:$("#cuberighttree").tree("find","cubedl").target,data:[c]});$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function insertText2focus(e,f){e.focus();if(document.selection){var d=document.selection.createRange();d.text=f}else{if(typeof e.selectionStart=="number"&&typeof e.selectionEnd=="number"){var c=e.selectionStart,b=e.selectionEnd,g=c,a=e.value;e.value=a.substring(0,c)+""+f+a.substring(b,a.length);g+=f.length;e.selectionStart=e.selectionEnd=g}else{e.value+=f}}}function ftmstr(d,b,a){var c='<select id="'+d+'" name="'+d+'" class="'+b+'">';c=c+'<option value=""></option><option '+(a=="#,###"?"selected":"")+' value="#,###">整数</option><option '+(a=="#,##0.00"?"selected":"")+' value="#,##0.00">小数(保留两位)</option><option '+(a=="#,##0.0000"?"selected":"")+' value="#,##0.0000">小数(保留四位)</option><option '+(a=="0.00%"?"selected":"")+' value="0.00%">百分比</option>';c=c+"</select>";return c}function msginfo(b,a){$.messager.alert("出错了",b,"error",a)}function ischinese(b){if(/[\u4E00-\u9FA5]/i.test(b)){return true}else{return false}}function newGuid(){var a="";for(var b=1;b<=32;b++){var c=Math.floor(Math.random()*16).toString(16);a+=c}return a}function bdshelper(){openModelDailog("表达式说明","<div style='line-height:30px;'>表达式是一句SQL片段，用来提高系统灵活性。<li>通过表达式来对字段进行运算；</li>字段相加：<div class=\"mycode\"> a+ b</div><li>对字段进行case when 转换；</li><div class=\"mycode\">case when a=1 then '是' when a=2 then '否' else '未知' end</div><p class=\"text-warning\">请注意：此处表达式请勿使用sum/avg/max/min/count等聚合函数。<p></div>")}function bdshelper2(){openModelDailog("表达式度量说明",'<div style=\'line-height:30px;\'>表达式度量是一句SQL片段，用来提高系统灵活性。<li>通过表达式来对度量进行运算；</li>字段相加：<div class="mycode"> sum(a)+sum(b) </div>或：<div class="mycode"> sum(a + b) </div><li>数据量计数；</li><div class="mycode">count(*)</div><p class="text-warning">请注意：此处创建的表达式度量必须使用sum/avg/max/min/count等聚合函数。<p></div>')};