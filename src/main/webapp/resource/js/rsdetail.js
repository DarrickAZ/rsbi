if($==undefined){$=jQuery}function changeChart(){$("#pdailog").dialog({title:"切换图形",width:380,height:378,closed:false,cache:false,modal:true,toolbar:null,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var b=pageInfo.chart;var c=b.chartJson.type=curTmpInfo.selectChart;$("#pdailog").dialog("close");if(b.kpiJson&&b.kpiJson.length>1&&b.kpiJson[1]){delete b.kpiJson[1]}if(b.kpiJson&&b.kpiJson.length>2&&b.kpiJson[2]){delete b.kpiJson[2]}if(c=="pie"||c=="gauge"){delete b.chartJson.scol}if(c=="map"){var a=$("#pdailog #maparea").val().split(",");b.chartJson.maparea=a[0];b.chartJson.mapAreaName=a[1]}addChart(c,b)}},{text:"取消",iconCls:"icon-cancel",handler:function(){delete curTmpInfo.selectChart;$("#pdailog").dialog("close")}}]});$("#pdailog").dialog("refresh","../bireport/insertChart.action?tp="+pageInfo.chart.chartJson.type)}function chartcss(){curTmpInfo.selectChart="line";$(".chartselect .selleft ul li").bind("click",function(){var b=$(this).attr("cid");$(".chartselect .selleft ul li").removeClass("select");$(this).addClass("select");$(".chartselect .selright .one").css("display","none");$("#schart"+b).css("display","block");var a=$("#schart"+b).attr("tp");curTmpInfo.selectChart=a})}function addChart(f,d){curTmpInfo.charttype=f;var a="图形 -";if(f=="line"){a=a+"曲线图"}else{if(f=="column"){a=a+"柱状图"}else{if(f=="pie"){a=a+"饼图"}else{if(f=="gauge"){a=a+"仪表盘"}else{if(f=="radar"){a=a+"雷达图"}else{if(f=="scatter"){a=a+"散点图"}else{if(f=="bubble"){a=a+"气泡图"}}}}}}}if(!pageInfo.chart){pageInfo.chart={}}var l=pageInfo.chart;if(d){l.chartJson=d.chartJson}else{l.chartJson={type:f,label:"C3",xcol:{},ycol:{},scol:{}}}var c=false;var g=false;var b=false;c=f=="pie"||f=="gauge";g=f=="bubble"||f=="scatter";b=f=="bubble";var e='<div class="tsbd">'+(g?'<div class="ts_h">'+(c?"观察维度":"横轴")+'：<div id="y2col" class="h_ctx">'+(d&&d.kpiJson&&d.kpiJson.length>1&&d.kpiJson[1]!=null?'<span title="聚合方式" onclick="chartAggreType(this,\'y2col\')" class="grouptype"></span><span class="charttxt" style="width:75px;">'+d.kpiJson[1].aggre+"("+(d.kpiJson[1].kpi_name!=""?d.kpiJson[1].kpi_name:d.kpiJson[1].col_name)+')</span><span class="chartdel" title="配置" onclick="delChartCol(\'y2col\')"></span>':'<span class="charttip">将字段拖到这里</span>')+"</div></div>":'<div class="ts_h">'+(c?"观察维度":"横轴")+'：<div id="xcol" class="h_ctx">'+(d&&d.chartJson.xcol&&!$.isEmptyObject(d.chartJson.xcol)?'<span class="charttxt">'+(d.chartJson.xcol.dimdesc!=""?d.chartJson.xcol.dimdesc:d.chartJson.xcol.colname)+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'xcol\')"></span>':'<span class="charttip">将字段拖到这里</span>')+"</div></div>")+'<div class="ts_h">'+(c?"度量":"纵轴")+'：<div id="ycol" class="h_ctx">'+(d&&d.kpiJson&&d.kpiJson.length>0&&d.kpiJson[0]!=null?'<span title="聚合方式" onclick="chartAggreType(this, \'ycol\')" class="grouptype"></span><span class="charttxt" style="width:75px;">'+d.kpiJson[0].aggre+"("+(d.kpiJson[0].kpi_name==""?d.kpiJson[0].col_name:d.kpiJson[0].kpi_name)+')</span><span class="chartdel" title="配置" onclick="delChartCol(\'ycol\')"></span>':'<span class="charttip">将字段拖到这里</span>')+"</div></div>"+(b?'<div class="ts_h">气泡大小：<div id="y3col" class="h_ctx">'+(d&&d.kpiJson&&d.kpiJson.length>2&&d.kpiJson[2]!=null?'<span title="聚合方式" onclick="chartAggreType(this, \'y3col\')" class="grouptype"></span><span class="charttxt" style="width:75px;">'+d.kpiJson[2].aggre+"("+(d.kpiJson[2].kpi_name==""?d.kpiJson[2].col_name:d.kpiJson[2].kpi_name)+')</span><span class="chartdel" title="配置" onclick="delChartCol(\'y3col\')"></span>':'<span class="charttip">将字段拖到这里</span>')+"</div></div>":"")+(g?'<div class="ts_h">观察维度：<div id="xcol" class="h_ctx">'+(d&&d.chartJson.xcol&&!$.isEmptyObject(d.chartJson.xcol)?'<span class="charttxt">'+(d.chartJson.xcol.dimdesc!=""?d.chartJson.xcol.dimdesc:d.chartJson.xcol.colname)+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'xcol\')"></span>':'<span class="charttip">将字段拖到这里</span>')+"</div></div>":"")+(b?"":'<div class="ts_h" '+(c?'style="display:none"':"")+'>图例：<div id="scol" class="h_ctx">'+(d&&d.chartJson.scol&&!$.isEmptyObject(d.chartJson.scol)?'<span class="charttxt">'+(d.chartJson.scol.dimdesc!=""?d.chartJson.scol.dimdesc:d.chartJson.scol.colname)+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'scol\')"></span>':'<span class="charttip">将字段拖到这里</span>')+"</div></div>")+"</div>"+(c||g?"":"<div class=\"exchangexs\"><img src='../resource/img/exchangexs1.gif'><a title='交换维度' href='javascript:exchangexs();'><img src='../resource/img/reload.png' border='0'></a><img src='../resource/img/exchangexs2.gif'></div>")+'<div class="chartctx" style="'+(g?"height:220px;":"")+'">图形预览区域</div>';var h='<div id="T3" class="comp_table"><div class="ctx"> '+e+" </div></div>";$("#chart_div").html(h);if(curTmpInfo.charttype=="bubble"||curTmpInfo.charttype=="scatter"){initChartByScatter()}else{initChartKpiDrop()}if(d){chartview(d)}}function initChartKpiDrop(){var a=3;$("#T"+a+" #xcol, #T"+a+" #ycol, #T"+a+" #scol").droppable({accept:"#selectdatatree .tree-node",onDragEnter:function(c,b){$(b).draggable("proxy").find("span").removeClass("tree-dnd-no");$(b).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#ff0000");c.cancelBubble=true;c.stopPropagation()},onDragLeave:function(c,b){$(b).draggable("proxy").find("span").addClass("tree-dnd-no");$(b).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#7F9DB9");c.cancelBubble=true;c.stopPropagation()},onDrop:function(f,d){$("#T"+a+" #"+$(this).attr("id")).css("border-color","#7F9DB9");var c=$("#selectdatatree").tree("getNode",d);f.cancelBubble=true;f.stopPropagation();var b=pageInfo.chart;if(b.datasetid&&b.datasetid!=c.attributes.tid){msginfo("你拖入的字段"+c.text+"与图形已有的内容不在同一个数据集中，拖放失败！");return}else{b.datasetid=c.attributes.tid}if(b.kpiJson==undefined){b.kpiJson=[]}if($(this).attr("id")=="ycol"){if(b.chartJson.xcol!=undefined&&b.chartJson.xcol.id==c.id){msginfo("您拖放的字段已存在于横轴中，不能拖放。");return}if(b.chartJson.scol!=undefined&&b.chartJson.scol.id==c.id){msginfo("您拖放的字段已存在于图例中，不能拖放。");return}b.kpiJson=[];b.kpiJson.push({kpi_id:c.id,alias:"c"+c.id,col_name:c.attributes.name,valType:c.attributes.type,tname:c.attributes.tname,kpi_name:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression,aggre:"count"});b.chartJson.ycol={type:"kpi"};$(this).html('<span title="聚合方式" onclick="chartAggreType(this,\'ycol\')" class="grouptype"></span><span class="charttxt" style="width:75px;">count('+c.text+')</span><span class="chartdel" title="配置" onclick="delChartCol(\'ycol\')"></span>');curTmpInfo.isupdate=true;chartview(b)}if($(this).attr("id")=="xcol"){if(b.chartJson.scol!=undefined&&b.chartJson.scol.id==c.id){msginfo("您拖放的字段已存在于图例项中，不能拖放。");return}if(kpiExist(b.kpiJson,c.id)){msginfo("您拖放的字段已存在于纵轴中，不能拖放。");return}b.chartJson.xcol={id:c.id,alias:"c"+c.id,colname:c.attributes.name,tname:c.attributes.tname,type:c.attributes.type,dimdesc:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression};$(this).html('<span class="charttxt">'+c.text+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'xcol\')"></span>');curTmpInfo.isupdate=true;chartview(b)}if($(this).attr("id")=="scol"){if(b.chartJson.xcol!=undefined&&b.chartJson.xcol.id==c.id){msginfo("您拖放的字段已存在于横轴中，不能拖放。");return}if(kpiExist(b.kpiJson,c.id)){msginfo("您拖放的字段已存在于纵轴中，不能拖放。");return}b.chartJson.scol={id:c.id,alias:"c"+c.id,colname:c.attributes.name,tname:c.attributes.tname,type:c.attributes.type,dimdesc:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression};$(this).html('<span class="charttxt">'+c.text+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'scol\')"></span>');curTmpInfo.isupdate=true;chartview(b)}}})}function kpiExist(b,c){var a=false;for(k=0;b&&k<b.length;k++){if(b[k]!=null&&b[k].kpi_id==c){a=true;break}}return a}function initChartByScatter(){var a=3;$("#T"+a+" #xcol, #T"+a+" #ycol, #T"+a+" #y2col, #T"+a+" #y3col, #T"+a+" #scol").droppable({accept:"#selectdatatree .tree-node",onDragEnter:function(d,c){var b=$("#selectdatatree").tree("getNode",c);$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T3 #"+$(this).attr("id")).css("border-color","#ff0000");d.cancelBubble=true;d.stopPropagation()},onDragLeave:function(c,b){$(b).draggable("proxy").find("span").addClass("tree-dnd-no");$(b).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#T3 #"+$(this).attr("id")).css("border-color","#7F9DB9");c.cancelBubble=true;c.stopPropagation()},onDrop:function(f,d){$("#T3 #"+$(this).attr("id")).css("border-color","#7F9DB9");var c=$("#selectdatatree").tree("getNode",d);f.cancelBubble=true;f.stopPropagation();var b=pageInfo.chart;if(b.datasetid&&b.datasetid!=c.attributes.tid){msginfo("你拖入的字段"+c.text+"与图形已有的内容不在同一个数据集中，拖放失败！");return}else{b.datasetid=c.attributes.tid}if(!b.kpiJson){if(b.chartJson.type=="bubble"){b.kpiJson=[null,null,null]}else{b.kpiJson=[null,null]}}if($(this).attr("id")=="ycol"){if(b.chartJson.xcol!=undefined&&b.chartJson.xcol.id==c.id){msginfo("您拖放的字段已存在，不能拖放。");return}if(b.chartJson.scol!=undefined&&b.chartJson.scol.id==c.id){msginfo("您拖放的字段已存在，不能拖放。");return}b.kpiJson[0]={kpi_id:c.id,alias:"c"+c.id,col_name:c.attributes.name,valType:c.attributes.type,tname:c.attributes.tname,kpi_name:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression,aggre:"count"};b.chartJson.ycol={type:"kpi"};$(this).html('<span title="聚合方式" onclick="chartAggreType(this, \'ycol\')" class="grouptype"></span><span class="charttxt" style="width:75px;">count('+c.text+')</span><span class="chartdel" title="配置" onclick="delChartCol(\'ycol\')"></span>');curTmpInfo.isupdate=true}if($(this).attr("id")=="y2col"){if(b.chartJson.xcol!=undefined&&b.chartJson.xcol.id==c.id){msginfo("您拖放的字段已存在，不能拖放。");return}if(b.chartJson.scol!=undefined&&b.chartJson.scol.id==c.id){msginfo("您拖放的字段已存在，不能拖放。");return}b.kpiJson[1]={kpi_id:c.id,alias:"c"+c.id,col_name:c.attributes.name,valType:c.attributes.type,tname:c.attributes.tname,kpi_name:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression,aggre:"count"};b.chartJson.ycol={type:"kpi"};$(this).html('<span title="聚合方式" onclick="chartAggreType(this, \'y2col\')" class="grouptype"></span><span class="charttxt" style="width:75px;">count('+c.text+')</span><span class="chartdel" title="配置" onclick="delChartCol(\'y2col\')"></span>');curTmpInfo.isupdate=true}if($(this).attr("id")=="y3col"){if(b.chartJson.xcol!=undefined&&b.chartJson.xcol.id==c.id){msginfo("您拖放的字段已存在，不能拖放。");return}if(b.chartJson.scol!=undefined&&b.chartJson.scol.id==c.id){msginfo("您拖放的字段已存在，不能拖放。");return}b.kpiJson[2]={kpi_id:c.id,alias:"c"+c.id,col_name:c.attributes.name,valType:c.attributes.type,tname:c.attributes.tname,kpi_name:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression,aggre:"count"};b.chartJson.ycol={type:"kpi"};$(this).html('<span title="聚合方式" onclick="chartAggreType(this, \'y3col\')" class="grouptype"></span><span class="charttxt" style="width:75px;">count('+c.text+')</span><span class="chartdel" title="配置" onclick="delChartCol(\'y3col\')"></span>');curTmpInfo.isupdate=true}if($(this).attr("id")=="xcol"){if(b.chartJson.scol!=undefined&&b.chartJson.scol.id==c.id){msginfo("您拖放的字段已存在于图例项中，不能拖放。");return}if(kpiExist(b.kpiJson,c.id)){msginfo("您拖放的字段已存，不能拖放。");return}b.chartJson.xcol={id:c.id,alias:"c"+c.id,colname:c.attributes.name,tname:c.attributes.tname,type:c.attributes.type,dimdesc:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression};$(this).html('<span class="charttxt">'+c.text+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'xcol\')"></span>');curTmpInfo.isupdate=true}if($(this).attr("id")=="scol"){if(b.chartJson.xcol!=undefined&&b.chartJson.xcol.id==c.id){msginfo("您拖放的字段已存，不能拖放。");return}if(kpiExist(b.kpiJson,c.id)){msginfo("您拖放的字段已存在，不能拖放。");return}b.chartJson.scol={id:c.id,alias:"c"+c.id,colname:c.attributes.name,tname:c.attributes.tname,type:c.attributes.type,dimdesc:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression};$(this).html('<span class="charttxt">'+c.text+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'scol\')"></span>');curTmpInfo.isupdate=true}if(b.chartJson.type=="scatter"){if(b.kpiJson[0]!=null&&b.kpiJson[1]!=null){chartview(b)}}if(b.chartJson.type=="bubble"){if(b.kpiJson[0]!=null&&b.kpiJson[1]!=null&&b.kpiJson[2]!=null){chartview(b)}}}})}function chartAggreType(b,d){var a=pageInfo.chart;$("#aggretypemenu").children().each(function(f,g){$("#aggretypemenu").menu("setIcon",{target:$(this),iconCls:"icon-blank"})});var e;if(d=="ycol"){e=0}else{if(d=="y2col"){e=1}else{e=2}}curTmpInfo.ycolIdx=e;$("#aggretypemenu").menu("setIcon",{target:$("#aggre_"+a.kpiJson[e].aggre),iconCls:"icon-ok"});var c=$(b).offset();$("#aggretypemenu").menu("show",{left:c.left,top:c.top+20})}function kpiAggreType(d){var b=pageInfo.chart;var a=b.kpiJson[curTmpInfo.ycolIdx].valType;if(d!="count"){if(a!="Int"&&a!="Double"){msginfo("字段类型不是数字类型， 不能进行 "+d+" 运算。");return}}var c=b.kpiJson[curTmpInfo.ycolIdx];c.aggre=d;$("#y"+(curTmpInfo.ycolIdx==0?"":curTmpInfo.ycolIdx+1)+"col span.charttxt").text(d+"("+(c.kpi_name==""?c.col_name:c.kpi_name)+")");chartview(b);curTmpInfo.isupdate=true}function chartview(b){if(!b||!b.kpiJson||b.kpiJson.length==0){return}if(b.chartJson.type=="scatter"&&(b.kpiJson.length<2||b.kpiJson[1]==null)){return}if(b.chartJson.type=="bubble"&&(b.kpiJson.length<3||b.kpiJson[2]==null)){return}var c=findDatasetById(b.datasetid);if(c==null){$("#T3 div.ctx").html("组件关联的数据集已经失效，请移除该组件。");return}var a={chartJson:b.chartJson,kpiJson:b.kpiJson,params:pageInfo.params,dset:c};__showLoading();$.ajax({type:"POST",url:"ChartView.action",dataType:"html",contentType:"application/json",data:JSON.stringify(a),success:function(d){__hideLoading();$("#T3 div.chartctx").css("height","auto");$("#T3 div.chartctx").html(d)},error:function(d){__hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function delChartCol(c){var b=pageInfo.chart;var a=3;if(c=="xcol"){b.chartJson.xcol={};$("#T"+a+" #xcol").html('<span class="charttip">将字段拖到这里</span>');curTmpInfo.isupdate=true;chartview(b,a)}if(c=="ycol"){b.chartJson.ycol={};if(b.kpiJson.length>1){b.kpiJson[0]=null}else{b.kpiJson=[]}$("#T"+a+" #ycol").html('<span class="charttip">将字段拖到这里</span>')}if(c=="y2col"){if(b.kpiJson.length>1){b.kpiJson[1]=null}else{b.kpiJson=[]}$("#T"+a+" #y2col").html('<span class="charttip">将字段拖到这里</span>')}if(c=="y3col"){b.kpiJson[2]=null;$("#T"+a+" #y3col").html('<span class="charttip">将字段拖到这里</span>')}if(c=="scol"){b.chartJson.scol={};$("#T"+a+" #scol").html('<span class="charttip">将字段拖到这里</span>');curTmpInfo.isupdate=true;chartview(b,a)}}function exchangexs(){var a=pageInfo.chart;if(!a){return}if(a.chartJson==undefined||(a.chartJson.xcol==undefined&&a.chartJson.scol==undefined)){msginfo("您还未选择维度。")}var c=a.chartJson.xcol;a.chartJson.xcol=a.chartJson.scol;a.chartJson.scol=c;var b=3;if(a.chartJson.xcol&&a.chartJson.xcol.id){var d=a.chartJson.xcol;$("#T"+b+" #xcol").html('<span class="charttxt">'+(a.chartJson.xcol.dimdesc!=""?a.chartJson.xcol.dimdesc:a.chartJson.xcol.colname)+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'xcol\')"></span>')}else{$("#T"+b+" #xcol").html('<span class="charttip">将维度拖到这里</span>')}if(a.chartJson.scol&&a.chartJson.scol.id){var d=a.chartJson.scol;$("#T"+b+" #scol").html('<span class="charttxt">'+(a.chartJson.scol.dimdesc!=""?a.chartJson.scol.dimdesc:a.chartJson.scol.colname)+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'scol\')"></span>')}else{$("#T"+b+" #scol").html('<span class="charttip">将维度拖到这里</span>')}curTmpInfo.isupdate=true;chartview(a)}if($==undefined){$=jQuery}function insertCross(b){if(!b&&pageInfo.cross){msginfo("透视表已经存在，请先删除再创建透视表。");return}var c=b?"":crtCrossTable();var a='<div id="T4" class="comp_table"><div class="ctx"> '+c+" </div></div>";$("#cross_div").html(a);if(b){crossView(pageInfo.cross)}else{initDropEvent();pageInfo.cross={kpiJson:[],cols:[],rows:[]}}}function crtCrossTable(){var a="<table class='d_table'><tr><td class='blank'></td><td><div id='d_colDims' class='tabhelpr'>将字段拖到此处作为列标签</div></td></tr><tr><td><div id='d_rowDims' class='tabhelpr'>将字段拖到此处<br>作为行标签</div></td><td><div id='d_kpi' class='tabhelpr'>将字段拖到此处<br>作为度量</div></td></tr></table>";return a}function initDropEvent(){var b=4;var a=false;$("#T"+b+" #d_colDims, #T"+b+" #d_rowDims, #T"+b+" #d_kpi").droppable({accept:"#selectdatatree .tree-node",onDragEnter:function(d,c){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$(this).css("border","1px solid #ff0000");d.cancelBubble=true;d.stopPropagation()},onDragLeave:function(d,c){$(c).draggable("proxy").find("span").addClass("tree-dnd-no");$(c).draggable("proxy").find("span").removeClass("tree-dnd-yes");$(this).css("border","none");d.cancelBubble=true;d.stopPropagation()},onDrop:function(h,g){var c=pageInfo.cross;h.cancelBubble=true;h.stopPropagation();$(this).css("border","none");var f=$("#selectdatatree").tree("getNode",g);var l=f.attributes.type;if($(this).attr("id")=="d_kpi"){if(l=="Int"||l=="Double"){}else{msginfo("只有小数(Double)、整数(Int)类型字段才能拖入度量区域！");return}}if(c.datasetid&&c.datasetid!=f.attributes.tid){msginfo("你拖入的字段"+f.text+"与透视表已有的内容不在同一个数据集中，拖放失败！");return}else{c.datasetid=f.attributes.tid}var d=function(n){var e=false;for(k=0;k<c.kpiJson.length;k++){if(c.kpiJson[k].kpi_id==n){e=true;return e}}for(k=0;k<c.cols.length;k++){if(c.cols[k].id==n){e=true;return e}}for(k=0;k<c.rows.length;k++){if(c.rows[k].id==n){e=true;return e}}return e};if(d(f.id)){msginfo("你拖入的字段"+f.text+"已经存在！");return}if($(this).attr("id")=="d_kpi"){c.kpiJson.push({kpi_id:f.id,kpi_name:"sum("+f.text+")",kpi_name:f.text,col_name:(f.attributes.expression?f.attributes.expression:f.attributes.name),dyna:(f.attributes.expression?"y":"n"),aggre:"sum",fmt:"",alias:f.attributes.name,unit:"",tname:f.attributes.tname})}if($(this).attr("id")=="d_colDims"){c.cols=[];c.cols.push({id:f.id,dimdesc:f.text,type:"frd",colname:(f.attributes.expression?f.attributes.expression:f.attributes.name),dyna:(f.attributes.expression?"y":"n"),alias:f.attributes.name,iscas:true,tableName:"",tableColKey:"",tableColName:"",dimord:"",grouptype:"",valType:f.attributes.type,endlvl:"",ordcol:"",tname:f.attributes.tname,issum:"n"})}if($(this).attr("id")=="d_rowDims"){c.rows=[];c.rows.push({id:f.id,dimdesc:f.text,type:"frd",colname:(f.attributes.expression?f.attributes.expression:f.attributes.name),dyna:(f.attributes.expression?"y":"n"),alias:f.attributes.name,iscas:true,tableName:"",tableColKey:"",tableColName:"",dimord:"",grouptype:"",valType:f.attributes.type,endlvl:"",ordcol:"",tname:f.attributes.tname,issum:"n"})}curTmpInfo.isupdate=true;crossView(c)}})}function crossView(b){if(!b||b.kpiJson==undefined){return}if(b.kpiJson.length==0&&b.cols&&b.cols.length==0&&b.rows&&b.rows.length==0){$("#T4 div.ctx").html(crtCrossTable());initDropEvent();return}var c=findDatasetById(b.datasetid);var a=JSON.stringify({cols:b.cols,rows:b.rows,kpiJson:b.kpiJson,params:pageInfo.params,dset:c});__showLoading();$.ajax({type:"POST",url:"CrossView.action",dataType:"html",data:a,contentType:"application/json",success:function(d){__hideLoading();$("#T4 div.ctx").html(d);initDropEvent()},error:function(d){__hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function setRdimInfo(b,d,a){var c=$(b).offset();curTmpInfo.ckid=d;curTmpInfo.pos="row";curTmpInfo.dimname=a;$("#dimoptmenu").menu("show",{left:c.left,top:c.top+20})}function setCdimInfo(b,d,a){var c=$(b).offset();curTmpInfo.ckid=d;curTmpInfo.pos="col";curTmpInfo.dimname=a;$("#dimoptmenu").menu("show",{left:c.left,top:c.top+20})}function setKpiInfo(a,c){var b=$(a).offset();curTmpInfo.ckid=c;$("#kpioptmenu").menu("show",{left:b.left,top:b.top+20})}function drillDim(n,g,l,c,d,b){var f=pageInfo.cross;var e=$(g).offset();var a=function(r){$("#drillmenu").remove();var q="<div id=\"drillmenu\"><div class='menu-line'></div>";var p=0;var s=function(v,w){var t=false;if(!w||w==null){return t}for(var u=0;u<w.length;u++){if(w[u].id==v){t=true;break}}return t};for(i=0;i<r.length;i++){if(r[i].type!="String"){continue}var o=i;if(s(o,f.cols)||s(o,f.rows)){continue}q=q+'<div id="'+o+'" onclick="drill(\''+o+"', '"+l+"', '"+c+"', '"+d+"', '"+b+'\')"><span style="color:#ccc">下钻</span>'+(r[i].dispName==""?r[i].name:r[i].dispName)+"</div>";p=p+1}q=q+"</div>";if(p==0){msginfo("已无钻取字段。");return}$(q).appendTo("body");$("#drillmenu").menu();$("#drillmenu").menu("show",{left:e.left,top:e.top+20})};var h=findDatasetById(f.datasetid);a(h.cols)}function drill(d,h,g,c,a){var b=pageInfo.cross;var e=findDatasetById(b.datasetid);var f=function(){var q=null;if(h=="row"){q=b.rows}else{q=b.cols}var l=null;var n=0;for(i=0;i<q.length;i++){if(q[i].id==a){n=i;q[i].vals=g}}var o=null;for(j=0;j<e.cols.length;j++){if(j==d){o=e.cols[j];break}}var p={id:o.idx-1,dimdesc:(o.dispName==""?o.name:o.dispName),type:"frd",colname:(o.expression?o.expression:o.name),alias:o.name,tname:o.tname,iscas:"y",tableName:"",tableColKey:"",tableColName:"",dimord:"",grouptype:"",valType:o.type,endlvl:"",ordcol:"",dyna:(o.expression?"y":"n")};q.splice(n+1,0,p);curTmpInfo.isupdate=true;crossView(b)};f()}function goupDim(d,e,g,c){var f=null;var b=pageInfo.cross;if(g=="row"){f=b.rows}else{f=b.cols}var a=0;for(i=0;i<f.length;i++){if(f[i].id==c){f[i].vals="";a=i;break}}f.splice(a+1,f.length-1);curTmpInfo.isupdate=true;crossView(b)}function changecolrow(){var a=pageInfo.cross;var b=a.rows;a.rows=a.cols;a.cols=b;crossView(a)}function delJsonKpiOrDim(f){var h=curTmpInfo.ckid;var b=pageInfo.cross;var g=curTmpInfo.pos;if(f=="kpi"){var d=b.kpiJson;var a=-1;for(var c=0;c<d.length;c++){if(d[c].kpi_id==h){a=c;break}}d.splice(a,1)}if(f=="dim"){var e=null;if(g=="col"){e=b.cols}else{e=b.rows}var a=-1;for(var c=0;c<e.length;c++){if(e[c].id==h){a=c;break}}e.splice(a,1)}curTmpInfo.isupdate=true;crossView(b)}function dimsort(e){var b=curTmpInfo.ckid;var f=curTmpInfo.pos;var a=pageInfo.cross;var d=null;if(f=="col"){d=a.cols}else{d=a.rows}for(var c=0;c<d.length;c++){if(d[c].id==b){d[c].dimord=e;break}}for(c=0;c<a.kpiJson.length;c++){a.kpiJson[c].sort=""}curTmpInfo.isupdate=true;crossView(a)}function kpisort(c){var b=curTmpInfo.ckid;var a=pageInfo.cross;for(i=0;i<a.kpiJson.length;i++){if(a.kpiJson[i].kpi_id==b){a.kpiJson[i].sort=c}else{a.kpiJson[i].sort=""}}curTmpInfo.isupdate=true;crossView(a)}function kpiset(){var c=curTmpInfo.ckid;var b=pageInfo.cross;var d=null;for(i=0;i<b.kpiJson.length;i++){if(b.kpiJson[i].kpi_id==c){d=b.kpiJson[i]}}var a='<div style=\'margin:10px;\'><span class="inputtext">显示名称：</span><input class="inputform2" id="dispName" value="'+d.kpi_name+'"><br/><span class="inputtext">计算方式：</span><select id="aggre" name="aggre" class="inputform2"><option value="sum">求和</option><option value="count">计数</option><option value="avg">平均</option><option value="max">最大</option><option value="min">最小</option><option value="var">方差</option><option value="sd">标准差</option><option value="middle">中位数</option></select><br/><span class="inputtext">格 式 化：</span><select id="fmt" class="inputform2" name="fmt"><option value=\'\'></option><option value="###,##0">整数</option><option value="###,##0.0">小数(保留1位)</option><option value="###,##0.00">小数(保留2位)</option><option value="0.00%">百分比</option></select></div>';$("#pdailog").dialog({title:"度量配置 - "+d.kpi_name,width:340,height:200,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){curTmpInfo.isupdate=true;var e=$("#pdailog #fmt").val();var g=$("#pdailog #aggre").val();var f=$("#pdailog #dispName").val();d.kpi_name=f;d.fmt=e;d.aggre=g;crossView(b);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #fmt").find("option[value='"+d.fmt+"']").attr("selected",true);$("#pdailog #aggre").find("option[value='"+d.aggre+"']").attr("selected",true)}function linkdetail(d){var c=pageInfo.cross;var e=findDatasetById().cols;var b='<table id="detailTable"></table>';$("#pdailog").dialog({title:"提取明细",width:660,height:400,closed:false,cache:false,modal:true,toolbar:null,content:b,buttons:[{text:"关闭",iconCls:"icon-ok",handler:function(){$("#pdailog").dialog("close")}}]});var a=[];for(i=0;i<e.length;i++){a.push({field:e[i].name,title:(e[i].dispName==""?e[i].name:e[i].dispName),width:"90"})}$("#detailTable").datagrid({fitColumns:true,pagination:true,columns:[a],singleSelect:true,pageSize:20,fit:true,loader:function(l,h,g){var f={pms:d,dset:findDatasetById(),page:l.page,rows:l.rows};$.ajax({type:"POST",url:"detail.action",dataType:"JSON",data:{json:JSON.stringify(f)},success:function(n){h(n)},error:function(n){$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}})}if($==undefined){$=jQuery}var dataType=["String","Int","Double","Date"];function initselectDataTree(){var a=false;var p=0;if(pageInfo.selectDs&&pageInfo.selectDs!=""){var q=pageInfo.selectDs.split(",");var e=[];for(i=0;i<q.length;i++){var n=findDatasetById();if(n==null){continue}a=true;var b={id:n.datasetid,text:n.name,iconCls:"icon-dataset2",attributes:{drag:"n"},children:[]};e.push(b);for(j=0;j<n.cols.length;j++){var l=n.cols[j];if(l.isshow){b.children.push({id:p,text:(l.dispName==""?l.name:l.dispName),iconCls:"icon-dscol",attributes:{name:l.name,tname:l.tname,type:l.type,dispName:l.dispName,tid:n.datasetid,fmt:l.fmt,expression:l.expression}});p++}}for(k=0;n.dynamic&&k<n.dynamic.length;k++){var g=n.dynamic[k];b.children.push({id:p,text:(g.dispName!=""?g.dispName:g.name),iconCls:"icon-dscol",attributes:{name:g.name,tname:g.tname,type:g.type,dispName:g.dispName,tid:n.datasetid,expression:g.expression,fmt:g.fmt}});p++}}var f=$(window).height()-175;$("#selectdatatree").css({height:f+"px"}).tree({dnd:true,lines:true,data:e,onBeforeDrag:function(c){if(c.attributes&&c.attributes.drag=="n"){return false}return true},onDragEnter:function(d,c){return false},onContextMenu:function(d,c){msginfo("拖拽字段到明细表进行数据查询。");d.preventDefault()}})}if(!a){var f=$(window).height()-175;$("#selectdatatree").css({height:f+"px"}).tree({dnd:false,data:[{id:"nodata",text:"您还未选择查询的数据集。",iconCls:"icon-no"}]})}}function showdropmenu(a){var b=$(a).offset();$("#selecttablemenu").menu("show",{left:b.left,top:b.top+30})}function fastmodel(){var a='<ul id="allTablesTree" style="overflow:hidden;"></ul>';$("#pdailog").dialog({title:"选择查询表",width:340,height:335,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var b=$("#allTablesTree").tree("getSelected");if(b==null){msginfo("请选择表。");return}location.href="Report.action?tableId="+b.id;$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$.ajax({type:"post",url:"../etl/listTables.action",dataType:"json",data:{t:Math.random()},success:function(c){var b=[];for(j=0;j<c.length;j++){var e=c[j];e.id=e.tableId;e.text=e.tableName+"("+e.tableNote+")";e.iconCls="icon-table";e.attributes={tid:e.tableId};b.push(e)}$("#allTablesTree").tree({data:c,fit:true})}})}function newdataset(){var a='<div id="crtdataset" class="easyui-tabs" data-options="fit:true,border:false,tabPosition:\'left\'"><div title="基本信息"><div class="textpanel"><span class="inputtext">数据集名称：</span><input type="text" id="datasetname" name="datasetname" class="inputform2"><br/><span class="inputtext">数据集说明：</span><input type="text" id="datasetnote"  name="datasetnote" class="inputform2"><br/><span class="inputtext" style="width:160px;">选择需要分析的表：</span><br/><div class="tablesleft"><div class="tabletitle">待选表</div><ul id="allTablesTree" style="height:220px; width:100%; overflow:auto"></ul></div><div class="tablescenter"><button id="left2right" class="btn btn-success btn-circle" type="button" style="margin-top:90px;" title="选择"><i class="fa fa-chevron-right"></i></button><br/><br/><button class="btn btn-success btn-circle" type="button" id="right2left" title="移除"><i class="fa fa-chevron-left"></i></button></div><div class="tablesright"><div class="tabletitle">已选表</div><ul id="selTablesTree" class="easyui-tree" style="height:220px; width:100%; overflow:auto"></ul></div></div></div><div title="表关联"><div class="textpanel"><div style="float:right"><button type="button" id="jointable" class="btn btn-primary btn-xs">关联</button> <br/> <button type="button" class="btn btn-primary btn-xs" id="unjointable">取消</button></div><span class="inputtext">主表： </span><select id="mastertable" class="inputform"></select><br/><ul class="easyui-tree" id="masterTableTree" style="margin-left:100px;border:1px solid #999; width:260px; height:320px; overflow:auto"></ul></div></div></div>';$("#pdailog").dialog({title:"创建数据集",width:680,height:450,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var e=$("#pdailog #datasetname").val();var d=$("#pdailog #dsid").val();var n=$("#pdailog #datasetnote").val();if(e==""){msginfo("请填写数据集名称。");$("#crtdataset").tabs("select",0);$("#datasetname").focus();return}var p=$("#selTablesTree").tree("getChildren");if(p==null||p.length==0){msginfo("您还未选择目标表。");return}if(!pageInfo.dataset){pageInfo.dataset=[]}var l={name:e,note:n,datasetid:newGuid()};var g=$("#mastertable").val().split(",");l.master=g[0];l.tid=g[1];var o=$("#masterTableTree").tree("getChildren");var f=[];for(i=0;i<o.length;i++){var h=o[i];if(h.iconCls=="icon-coljoin"){f.push({col:h.id,ref:h.attributes.ref,tid:h.attributes.tid,refKey:h.attributes.refKey})}}l.joininfo=f;pageInfo.dataset=[l];$.ajax({type:"post",async:false,url:"datasetMeta.action",dataType:"json",data:{dataset:JSON.stringify(l)},success:function(q){if(q.result==0){msginfo("出错了："+q.msg)}else{l.cols=q;pageInfo.selectDs=l.datasetid;initselectDataTree();curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}}})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});var c=function(d){$.ajax({type:"post",url:"../etl/listTables.action",dataType:"json",data:{t:Math.random()},success:function(f){var e=[];for(j=0;j<f.length;j++){var g=f[j];g.id=g.tableName;g.text=g.tableName+"("+g.tableNote+")";g.iconCls="icon-table";g.attributes={tid:g.tableId};e.push(g)}$("#allTablesTree").tree({data:f})}})};$("#pdailog #dsid").bind("change",function(){var d=$("#selTablesTree").tree("getChildren");for(i=0;i<d.length;i++){$("#selTablesTree").tree("remove",d[i].target)}$("#mastertable").html("");c($(this).val())});c($("#pdailog #dsid").val());$("#pdailog #left2right").bind("click",function(){var d=$("#allTablesTree").tree("getSelected");if(d==null||$(d.target).attr("hide")=="y"){msginfo("请先从左边选择表。");return}$("#selTablesTree").tree("append",{parent:null,data:[{id:d.id,text:d.text,attributes:{tid:d.attributes.tid},iconCls:d.iconCls}]});$(d.target).attr("hide","y").hide();var f=document.getElementById("mastertable");var e=f.selectedIndex;f.options.add(new Option(d.text,d.id+","+d.attributes.tid));if(e==-1){b(d.id)}});$("#pdailog #right2left").bind("click",function(){var f=$("#selTablesTree").tree("getSelected");if(f==null){msginfo("您还未选择需要移除的表。");return}var e=$("#allTablesTree").tree("getChildren");for(i=0;i<e.length;i++){if(e[i].id==f.id){$(e[i].target).attr("hide","n").show();break}}$("#selTablesTree").tree("remove",f.target);var h=document.getElementById("mastertable");var g=h.selectedIndex;var d=0;for(i=0;i<h.options.length;i++){if(h.options[i].value.split(",")[0]==f.id){d=i;break}}h.options.remove(d);if(g==d){if(h.selectedIndex!=-1){b(h.options[h.selectedIndex].value.split(",")[0])}else{b("")}}});var b=function(d){if(d==""){$("#masterTableTree").tree({data:[]});return}$.ajax({type:"post",url:"../etl/listTableColumns.action",dataType:"json",data:{tname:d},success:function(e){$("#masterTableTree").tree({data:e,onDblClick:function(f){jointableFunc()}})}})};$("#mastertable").bind("change",function(){b($(this).val().split(",")[0])});$("#pdailog #jointable").bind("click",function(){jointableFunc()});$("#unjointable").bind("click",function(){var d=$("#masterTableTree").tree("getSelected");if(d==null){msginfo("您还未从主表字段中选择需要删除关联的字段。");return}delete d.attributes.ref;delete d.attributes.refKey;$("#masterTableTree").tree("update",{target:d.target,text:d.id,iconCls:"icon-dscol"})})}function jointableFunc(){var f=$("#masterTableTree").tree("getSelected");if(f==null){msginfo("您还未从主表字段中选择需要关联的字段。");return}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var b="";var e=null;var d=$("#selTablesTree").tree("getChildren");for(i=0;i<d.length;i++){if(d[i].id!=$("#mastertable").val().split(",")[0]){b=b+'<option value="'+d[i].id+","+(d[i].attributes.tid)+'">'+d[i].text+"</option>";if(e==null){e=d[i].id}}}var c=function(g){var h="";if(e!=null){$.ajax({type:"post",async:false,url:"../etl/listTableColumns.action",dataType:"json",data:{tname:g},success:function(l){for(k=0;k<l.length;k++){h=h+'<option value="'+l[k].name+'">'+l[k].name+"</option>"}}})}return h};var a='<div class="textpanel">主表 <b>'+$("#mastertable").val()+"</b> 字段 <b>"+f.id+'</b> <br/> &nbsp; &nbsp; &nbsp; =>关联到=> <br/> 从表 <select id="slavetable" style="width:150px;">'+b+'</select> 字段 <select id="slavetablecol"  style="width:100px;">'+c(e)+"</select> </div>";$("#dsColumn_div").dialog({title:"关联维度表",width:350,height:200,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var g=$("#dsColumn_div #slavetable").val().split(",");f.attributes.ref=g[0];f.attributes.tid=g[1];f.attributes.refKey=$("#dsColumn_div #slavetablecol").val();$("#masterTableTree").tree("update",{target:f.target,text:f.text+" -> "+f.attributes.ref+"."+f.attributes.refKey,iconCls:"icon-coljoin"});$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#slavetable").bind("change",function(){var g=c($(this).val());$("#slavetablecol").html(g)})}function editdataset(){var dset=findDatasetById();if(dset==null){msginfo("当前表不存在。");return}dset=eval("("+JSON.stringify(dset)+")");curTmpInfo.curDset=dset;$("#pdailog").dialog({title:"编辑当前表",width:800,height:450,closed:false,cache:false,modal:true,toolbar:null,content:'<div id="datasettabs" ><div title="基本信息" ><div class="textpanel"><span class="inputtext">数据集名称：</span><input type="text" class="inputform2" name="datasetname" id="datasetname" value="'+dset.name+'"><br/><span class="inputtext">数据集说明：</span><input type="text" class="inputform2" name="datasetnote" id="datasetnote" value="'+(dset.note?dset.note:"")+'"><br/><span class="inputtext">已选分析表：</span><br/><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td width="70%" valign="top"><ul id="selectTables"></ul></td><td valign="top" align="right"><a id="addtable" href="#">添加表</a><br/><a id="deltable" href="#">删除表</a></td></tr></table></div></div><div title="表关联" ><div class="textpanel"><div style="float:right"><button type="button" id="jointable" class="btn btn-primary btn-xs">关联</button><br/><button type="button" id="deljointable" class="btn btn-primary btn-xs">删除</button></div><span class="inputtext">主表： </span><input type="text" class="inputform2" value="'+dset.master+'" style="width:300px;">(不可更改)<br/><ul id="masterTableTree" style="margin-left:100px;border:1px solid #999; width:300px; height:320px; overflow:auto"></ul></div></div><div title="字段信息"></div><div title="动态字段"></div><div title="数据筛选"></div><div title="数据预览"></div></div>',onLoad:function(){},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){dset.name=$("#datasetname").val();dset.note=$("#datasetnote").val();if(dset.name==""){msginfo("请填数据集名称。");$("#datasetname").focus();return}for(i=0;i<dset.joininfo.length;i++){var o=dset.joininfo[i];if(o.col==""){msginfo("表 "+o.ref+" 还未和主表关联。");return}}for(var i=0;i<pageInfo.dataset.length;i++){var d=pageInfo.dataset[i];if(d.datasetid==dset.datasetid){pageInfo.dataset[i]=dset;break}}initselectDataTree();curTmpInfo.isupdate=true;delete curTmpInfo.curDset;$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){delete curTmpInfo.curDset;$("#pdailog").dialog("close")}}]});var tbexist=function(tname,ttbs){var exist=false;for(j=0;j<ttbs.length;j++){if(ttbs[j].id==tname){exist=true;break}}return exist};var stbs=[];stbs.push({id:dset.master,text:dset.master+" (主表)",iconCls:"icon-table"});for(i=0;dset.joininfo&&i<dset.joininfo.length;i++){var ref=dset.joininfo[i].ref;if(!tbexist(ref,stbs)){stbs.push({id:ref,text:ref,iconCls:"icon-table"})}}$("#selectTables").tree({data:stbs});$("#pdailog #addtable").linkbutton({iconCls:"icon-add",plain:true}).bind("click",function(){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var ctx='<ul id="selectTablesTree"></ul>';$("#dsColumn_div").dialog({title:"添加表",width:350,height:280,closed:false,cache:false,modal:true,toolbar:null,content:ctx,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var nd=$("#dsColumn_div #selectTablesTree").tree("getSelected");if(nd==null){msginfo("请选择表。");return}var tname=nd.id;if(tname==dset.master){msginfo("您选择的表已经存在。");return}var exist=false;for(i=0;dset.joininfo&&i<dset.joininfo.length;i++){if(dset.joininfo[i].ref==tname){exist=true;break}}if(exist){msginfo("您选择的表已经存在。");return}dset.joininfo.push({col:"",tid:nd.attributes.tid,ref:tname,refKey:""});$("#pdailog #selectTables").tree("append",{parent:null,data:{id:tname,text:tname,iconCls:"icon-table"}});$.ajax({type:"post",async:false,url:"../etl/listTableColumns.action",dataType:"json",data:{tname:tname},success:function(dt){for(k=0;k<dt.length;k++){dt[k].tname=tname;dset.cols.push(dt[k])}}});curTmpInfo.isupdate=true;$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]});$.ajax({type:"post",url:"../etl/listTables.action",dataType:"json",data:{t:Math.random()},success:function(dt){var ndt=[];for(j=0;j<dt.length;j++){var d=dt[j];d.id=d.tableName;d.text=d.tableName+"("+d.tableNote+")";d.iconCls="icon-table";d.attributes={tid:d.tableId};ndt.push(d)}$("#selectTablesTree").tree({data:ndt})}})});$("#pdailog #deltable").linkbutton({iconCls:"icon-edit",plain:true}).bind("click",function(){var node=$("#pdailog #selectTables").tree("getSelected");if(node==null){msginfo("请选择表。");return}var tname=node.id;if(tname==dset.master){msginfo("不能删除主表");return}if(confirm("是否确认删除？")){var idx=-1;for(i=0;dset.joininfo&&i<dset.joininfo.length;i++){if(dset.joininfo[i].ref==tname){idx=i}}if(dset.joininfo){dset.joininfo.splice(idx,1)}var ncols=[];for(i=0;i<dset.cols.length;i++){var c=dset.cols[i];if(c.tname!=tname){ncols.push(c)}}dset.cols=ncols;$("#pdailog #selectTables").tree("remove",node.target)}});$("#pdailog #deljointable").click(function(){var node=$("#masterTableTree").tree("getSelected");var joininfo=null;for(i=0;i<dset.joininfo.length;i++){if(dset.joininfo[i].ref==node.attributes.ref){joininfo=dset.joininfo[i];break}}if(joininfo!=null){joininfo.col="";joininfo.refKey="";$("#masterTableTree").tree("update",{target:node.target,text:node.id,iconCls:"icon-dscol"})}});$("#pdailog #jointable").click(function(){var node=$("#masterTableTree").tree("getSelected");if(node==null){msginfo("您还未从主表字段中选择需要关联的字段。");return}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var tbs="";var tname=null;var cld=dset.joininfo;for(i=0;i<cld.length;i++){if(cld[i].col!=""){continue}tbs=tbs+'<option value="'+cld[i].ref+'">'+cld[i].ref+"</option>"}var getSlaveColumns=function(tn){if(!tn||tn==null){return""}var slavecols="";$.ajax({type:"post",async:false,url:"../etl/listTableColumns.action",dataType:"json",data:{tname:tn},success:function(dt){for(k=0;k<dt.length;k++){slavecols=slavecols+'<option value="'+dt[k].name+'">'+dt[k].name+"</option>"}}});return slavecols};var ctx='<div class="textpanel">主表 <b>'+dset.master+"</b> 字段 <b>"+node.id+'</b> <br/> &nbsp; &nbsp; &nbsp; =>关联到=> <br/> 从表 <select id="slavetable" style="width:150px;">'+tbs+'</select> 字段 <select id="slavetablecol"  style="width:100px;"></select> </div>';$("#dsColumn_div").dialog({title:"关联维度表",width:350,height:200,closed:false,cache:false,modal:true,toolbar:null,content:ctx,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var ref=$("#dsColumn_div #slavetable").val();var refkey=$("#dsColumn_div #slavetablecol").val();if(!ref||ref==null||ref==""){msginfo("请选择关联表。");return}var joininfo=null;for(i=0;i<dset.joininfo.length;i++){if(dset.joininfo[i].ref==ref){joininfo=dset.joininfo[i];break}}joininfo.col=node.id;joininfo.refKey=refkey;$("#masterTableTree").tree("update",{target:node.target,text:node.text+" -> "+ref+"."+refkey,iconCls:"icon-coljoin"});$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#slavetable").bind("change",function(){var s=getSlaveColumns($(this).val());$("#slavetablecol").html(s)});var s=getSlaveColumns($("#slavetable").val());$("#slavetablecol").html(s)});$("#datasettabs").tabs({border:false,fit:true,tabPosition:"left",plain:false,onLoad:function(){},onSelect:function(a,b){if(b==1){var isJoin=function(col){var ret=null;for(j=0;dset.joininfo&&j<dset.joininfo.length;j++){if(dset.joininfo[j].col==col){ret=dset.joininfo[j];break}}return ret};var mcols=[];for(i=0;i<dset.cols.length;i++){if(dset.cols[i].tname==dset.master){var r=isJoin(dset.cols[i].name);if(r==null){mcols.push({id:dset.cols[i].name,text:dset.cols[i].name,iconCls:"icon-dscol",attributes:{ref:""}})}else{mcols.push({id:dset.cols[i].name,text:dset.cols[i].name+" -> "+r.ref+"."+r.refKey,iconCls:"icon-coljoin",attributes:{ref:r.ref}})}}}$("#masterTableTree").tree({data:mcols})}if(b==2){var pp=$("#datasettabs").tabs("getSelected");var str='<table class="grid3" id="T_report54" cellpadding="0" cellspacing="0">';str=str+'<tr><th width="15%">字段名</th><th width="15%">显示名</th><th width="15%">类型</th><th width="15%">格式化</th><th width="10%">是否显示</th><th width="15%">来源表</th><th width="8%">操作</th></tr>';for(var i=0;i<dset.cols.length;i++){m=dset.cols[i];str=str+"<tr><td class='kpiData1 grid3-td' style='"+(!m.isshow?"text-decoration:line-through":"")+"'>"+m.name+"</td><td class='kpiData1 grid3-td'><div id=\""+m.tname+"_"+m.name+'_disp">'+(m.dispName==""?"&nbsp;":m.dispName)+"</div></td><td class='kpiData1 grid3-td'><div id=\""+m.tname+"_"+m.name+'_tp">'+m.type+'</div></td><td class="kpiData1 grid3-td"><div id="'+(m.tname+"_"+m.name+"_fmt")+'">'+(m.fmt?m.fmt:"")+'</div></td><td class=\'kpiData1 grid3-td\' align="center"><div id="'+m.tname+"_"+m.name+'_show">'+(m.isshow?"是":"否")+"</div></td><td class='kpiData1 grid3-td'>"+m.tname+"</td><td class='kpiData1 grid3-td' align='center'><button class=\"btn btn-primary btn-xs\" onclick=\"editDsColumn('"+m.name+"', '"+curTmpInfo.id+"', '"+m.tname+"', 'panel')\">编辑</button></td></tr>"}str=str+"</table>";$(pp).html(str)}if(b==3){reloadDynamicCol(dset)}if(b==4){reloadDatasetFilter(dset)}if(b==5){var pp=$("#datasettabs").tabs("getSelected");$(pp).html("加载中...");$(pp).load("queryData.action",{dataset:JSON.stringify(dset)},function(a,b,c){if(b=="error"){$(pp).html("SQL执行出错...")}})}}})}function editDsColumn(a,d,n,g){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var h=g=="panel"?curTmpInfo.curDset:findDatasetById();var e=null;for(var f=0;f<h.cols.length;f++){if(h.cols[f].name==a&&h.cols[f].tname==n){e=h.cols[f];break}}var b="";for(var f=0;f<dataType.length;f++){b=b+'<option value="'+dataType[f]+'" '+(e.type==dataType[f]?"selected":"")+">"+dataType[f]+"</option>"}var c=null;for(j=0;h.joininfo&&j<h.joininfo.length;j++){if(h.master==e.tname&&h.joininfo[j].col==e.name){c=h.joininfo[j];break}else{if(e.tname==h.joininfo[j].ref&&e.name==h.joininfo[j].refKey){c=h.joininfo[j];break}}}var l='<div class="textpanel"><span class="inputtext">字段名：</span>'+e.name+'<br/><span class="inputtext">显示名：</span><input type="text" name="coldispname" id="coldispname" value="'+e.dispName+'" class="inputform2"><br/><span class="inputtext">类型：</span><select id="coltype" class="inputform2">'+b+'</select><br/><span class="inputtext">是否显示：</span><select id="isshow" class="inputform2"><option value="1" '+(e.isshow==true?"selected":"")+'>是</option><option value="0" '+(e.isshow==false?"selected":"")+">否</option></select><br/><span class=\"inputtext\">格式化：</span><input type='text' class='inputform2' id='fmt' value=\""+(e.fmt?e.fmt:"")+'" placeholder="只对数字/日期起作用"><br/><span class="inputtext">来源表：</span>'+e.tname+'<br/><span class="inputtext">字段关联：</span>'+(c==null?"字段无关联":h.master+"."+c.col+" -> "+c.ref+"."+c.refKey)+"</div>";$("#dsColumn_div").dialog({title:"编辑字段信息",width:c==null?350:420,height:300,closed:false,cache:false,modal:true,toolbar:null,content:l,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){e.dispName=$("#dsColumn_div #coldispname").val();e.type=$("#dsColumn_div #coltype").val();var o=$("#dsColumn_div #isshow").val();e.isshow=Number(o)==1?true:false;e.fmt=$("#dsColumn_div #fmt").val();curTmpInfo.isupdate=true;if(g=="panel"){$("#datasettabs #"+e.tname+"_"+e.name+"_disp").text(e.dispName);$("#datasettabs #"+e.tname+"_"+e.name+"_tp").text(e.type);$("#datasettabs #"+e.tname+"_"+e.name+"_show").text(e.isshow?"是":"否");$("#datasettabs #"+e.tname+"_"+e.name+"_fmt").text(e.fmt);$("#datasettabs #"+e.tname+"_"+e.name+"_show").parents("tr").find("td:first").css("text-decoration",e.isshow?"none":"line-through")}curTmpInfo.isupdate=true;$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function reloadDatasetFilter(c){var d='<a href="javascript:newdatasetparam(false);" style="margin:3px;" id="ndatasetparam">新增</a><table class="grid3" id="T_report54" cellpadding="0" cellspacing="0">';d=d+"<tr><th>筛选字段</th><th>判断条件</th><th>筛选值</th><th>值类型</th><th>操作</th></tr>";for(var b=0;c.param&&b<c.param.length;b++){d=d+'<tr><td class="kpiData1 grid3-td">'+c.param[b].col+'</td><td class="kpiData1 grid3-td">'+c.param[b].type+'</td><td class="kpiData1 grid3-td">'+(c.param[b].val+(c.param[b].val2==""?"":"/"+c.param[b].val2))+'</td><td class="kpiData1 grid3-td">'+c.param[b].valuetype+'</td><td class="kpiData1 grid3-td"><button onclick="newdatasetparam(true,\''+c.param[b].id+'\');" class="btn btn-primary btn-xs"><i class="fa fa-edit"></i></button> <button onclick="delDatasetFilter(\''+c.param[b].id+'\');" class="btn btn-danger btn-xs"><i class="fa fa-remove"></i></button></td></tr>'}if(!c.param||c.param.length==0){d=d+'<tr><td class="kpiData1 grid3-td" align="center" colspan="5">无数据.</td></tr>'}d=d+"</table>";var a=$("#datasettabs").tabs("getSelected");$(a).html(d);$("#datasettabs #ndatasetparam").linkbutton({iconCls:"icon-add"})}function reloadDynamicCol(d){var f='<a href="javascript:;" style="margin:3px;" id="dynamiccol">新增</a><table class="grid3" id="T_report54" cellpadding="0" cellspacing="0">';f=f+'<tr><th width="15%">字段名</th><th width="15%">显示名</th><th width="30%">表达式</th><th width="15%">值类型</th><th width="12%">格式化</th><th width="12%">操作</th></tr>';for(var c=0;d.dynamic&&c<d.dynamic.length;c++){var e=d.dynamic[c];f=f+'<tr><td class="kpiData1 grid3-td">'+e.name+'</td><td class="kpiData1 grid3-td">'+e.dispName+'</td><td class="kpiData1 grid3-td">'+e.expression.replace(/@/g,"'")+'</td><td class="kpiData1 grid3-td">'+e.type+'</td><td class="kpiData1 grid3-td">'+(e.fmt?e.fmt:"")+'</td><td class="kpiData1 grid3-td"><button col="'+e.name+'" id="dynamiccolupdate" class="btn btn-primary btn-xs"><i class="fa fa-edit"></i></button> <button class="btn btn-danger btn-xs" col="'+e.name+'" id="dynamiccoldel"><i class="fa fa-remove"></i></button></td></tr>'}if(!d.dynamic||d.dynamic.length==0){f=f+'<tr><td class="kpiData1 grid3-td" align="center" colspan="6">无数据.</td></tr>'}f=f+"</table>";var a=$("#datasettabs").tabs("getSelected");$(a).html(f);var b=function(h){var n="";for(var l=0;l<dataType.length;l++){n=n+'<option value="'+dataType[l]+'" '+(h&&h.type==dataType[l]?"selected":"")+">"+dataType[l]+"</option>"}var g='<div class="textpanel"><span class="inputtext">字段名：</span><input type="text" id="colname" name="colname" class="inputform2" value="'+(h?h.name:"")+'" placeholder="添加后不能更改"><br/><span class="inputtext">显示名：</span><input type="text" id="dispname" name="dispname" class="inputform2" value="'+(h?h.dispName:"")+'"><br/><table cellspacing="0" cellpadding="0"><tbody><tr><td valign="top"><span class="inputtext">表 达 式：</span></td><td><textarea name="expression" id="expression" class="inputform2" style="height:52px;">'+(h?h.expression.replace(/@/g,"'"):"")+'</textarea></td></tr></tbody></table><span class="inputtext">值类型：</span><select id="valtype" class="inputform2">'+n+'</select><br/><span class="inputtext">格式化</span><input type="text" id="fmt" value="'+(h&&h.fmt?h.fmt:"")+'" class="inputform2" placeholder="只对数字/日期起作用"></div>';if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:h?"编辑动态字段":"添加动态字段",width:380,height:280,closed:false,cache:false,modal:true,toolbar:null,content:g,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){if(h){h.dispName=$("#dsColumn_div #dispname").val();h.name=$("#dsColumn_div #colname").val();h.type=$("#dsColumn_div #valtype").val();h.expression=$("#dsColumn_div #expression").val().replace(/'/g,"@");h.fmt=$("#dsColumn_div #fmt").val()}else{var o={dispName:$("#dsColumn_div #dispname").val(),name:$("#dsColumn_div #colname").val(),tname:d.master,type:$("#dsColumn_div #valtype").val(),expression:$("#dsColumn_div #expression").val().replace(/'/g,"@"),fmt:$("#dsColumn_div #fmt").val()};if(!d.dynamic){d.dynamic=[]}d.dynamic.push(o)}$("#dsColumn_div").dialog("close");reloadDynamicCol(d)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]})};$("#datasettabs #dynamiccoldel").bind("click",function(){if(!confirm("是否确认删除？")){return}var g=-1;var h=$(this).attr("col");for(c=0;c<d.dynamic.length;c++){if(d.dynamic[c].name==h){g=c;break}}d.dynamic.splice(g,1);reloadDynamicCol(d)});$("#datasettabs #dynamiccolupdate").bind("click",function(){var g=$(this).attr("col");var h=null;for(c=0;c<d.dynamic.length;c++){if(d.dynamic[c].name==g){h=d.dynamic[c];break}}b(h)});$("#datasettabs #dynamiccol").bind("click",function(){b()}).linkbutton({iconCls:"icon-add"})}function delDatasetFilter(b){if(confirm("是否确认删除？")){var c=curTmpInfo.curDset;var a=-1;for(i=0;i<c.param.length;i++){if(c.param[i].id==b){a=i}}c.param.splice(a,1);reloadDatasetFilter(c)}}function newdatasetparam(h,c){var e=curTmpInfo.curDset;var d=null;if(e.param){for(i=0;i<e.param.length;i++){if(e.param[i].id==c){d=e.param[i]}}}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var g='<select id="filtercolumn" name="filtercolumn" class="inputform2">';for(i=0;i<e.cols.length;i++){g=g+"<option value='"+e.cols[i].name+"@"+e.cols[i].tname+"' "+(d!=null&&d.col==e.cols[i].name&&d.tname==e.cols[i].tname?"selected":"")+">"+(e.cols[i].dispName==""?e.cols[i].name:e.cols[i].dispName)+"</option>"}g=g+"</select>";var b=["=",">",">=","<","<=","!=","between"];var f='<select id="filtertype" name="filtertype" class="inputform2">';for(i=0;i<b.length;i++){f=f+'<option value="'+b[i]+'" '+(d!=null&&d.type==b[i]?"selected":"")+">"+b[i]+"</option>"}f=f+"</select>";var a='<div class="textpanel"><span class="inputtext">筛选字段：</span>'+g+'<br/><span class="inputtext">判断条件：</span>'+f+'<br/><span class="inputtext">筛选值：</span><input type="text" name="filtervalue" id="filtervalue" value="'+(d!=null?d.val:"")+'" class="inputform2"><br><div style="'+(d!=null&&d.val2!=""?"":"display:none")+'"><span class="inputtext">筛选值2：</span><input type="text" name="filtervalue2" id="filtervalue2" value="'+(d!=null?d.val2:"")+'"  class="inputform2"></div><span class="inputtext">筛选值类型：</span><select name="valuetype" id="valuetype" class="inputform2"><option value="number" '+(d!=null&&d.valuetype=="number"?"selected":"")+'>数字类型</option><option value="string" '+(d!=null&&d.valuetype=="string"?"selected":"")+'>字符类型</option><option value="datetime" '+((d!=null&&d.valuetype=="datetime"?"selected":""))+">日期类型</option></select></div>";$("#dsColumn_div").dialog({title:(h==false?"添加筛选条件":"编辑筛选条件"),width:400,height:230,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){if(!e.param){e.param=[]}if($("#dsColumn_div #filterid").val()==""){msginfo("筛选标识是必填项！");$("#dsColumn_div #filterid").focus();return}if(h==true){var l=$("#dsColumn_div #filtercolumn").val().split("@");d.col=l[0];d.tname=l[1];d.type=$("#dsColumn_div #filtertype").val();d.val=$("#dsColumn_div #filtervalue").val();d.val2=$("#dsColumn_div #filtervalue2").val();d.valuetype=$("#dsColumn_div #valuetype").val()}else{var l=$("#dsColumn_div #filtercolumn").val().split("@");e.param.push({id:newGuid(),col:l[0],tname:l[1],type:$("#dsColumn_div #filtertype").val(),val:$("#dsColumn_div #filtervalue").val(),val2:$("#dsColumn_div #filtervalue2").val(),valuetype:$("#dsColumn_div #valuetype").val()})}reloadDatasetFilter(e);$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#dsColumn_div #filtertype").bind("change",function(){if($(this).val()=="between"){$("#dsColumn_div #filtervalue2").parent().css("display","block")}else{$("#dsColumn_div #filtervalue2").parent().css("display","none")}})}function cleanData(){var a=pageInfo.idx?pageInfo.idx:"1";if(a=="3"){delete pageInfo.chart;addChart("line")}else{if(a=="1"){delete pageInfo.grid;crtTable()}else{if(a=="2"){delete pageInfo.cross;insertCross()}}}}function findDatasetById(){if(pageInfo.dataset&&pageInfo.dataset.length>0){return pageInfo.dataset[0]}return null}if($==undefined){$=jQuery}function initpage(){initselectDataTree();initparam();if(pageInfo.cross){insertCross(true)}else{insertCross()}crtTable();if(pageInfo.grid&&pageInfo.grid.cols&&pageInfo.grid.cols.length>0){gridView(pageInfo.grid)}if(pageInfo.chart&&pageInfo.chart.kpiJson&&pageInfo.chart.kpiJson.length>0){var a=pageInfo.chart;addChart(a.chartJson.type,a)}else{addChart("line")}}function initparam(){if(pageInfo.params&&pageInfo.params.length>0){$("#p_param div.ptabhelpr").remove();$("#p_param").append("<b>参数： </b>");for(i=0;i<pageInfo.params.length;i++){var b=$("#p_param");var a=pageInfo.params[i];var c='<span class="pppp" id="pa_'+a.id+'"><span title="筛选" onclick="paramFilter(\''+a.id+"', '"+a.type+"', '"+(a.dispName!=""?a.dispName:a.name)+'\')" class="text">'+dispalyParamName(a)+'</span><button title="删除" class="btn btn-outline btn-danger btn-xs" onclick="deleteParam(\''+a.id+'\')"><i class="fa fa-times"></i></button></span>';b.append(c)}}$("#p_param").droppable({accept:"#selectdatatree .tree-node",onDragEnter:function(g,f){var d=$("#selectdatatree").tree("getNode",f);$(f).draggable("proxy").find("span").removeClass("tree-dnd-no");$(f).draggable("proxy").find("span").addClass("tree-dnd-yes");$(this).css("border","1px solid #ff0000");g.cancelBubble=true;g.stopPropagation()},onDragLeave:function(f,d){$(d).draggable("proxy").find("span").addClass("tree-dnd-no");$(d).draggable("proxy").find("span").removeClass("tree-dnd-yes");$(this).css("border","1px solid #d3d3d3");f.cancelBubble=true;f.stopPropagation()},onDrop:function(n,f){n.cancelBubble=true;n.stopPropagation();$(this).css("border","1px solid #d3d3d3");var d=$("#selectdatatree").tree("getNode",f);if(!pageInfo.params){pageInfo.params=[]}var o=pageInfo.params;var l=findParamById(d.id);if(l!=null){msginfo("参数"+d.text+"已经存在。");return}var h={id:d.id,name:d.attributes.name,tname:d.attributes.tname,type:d.attributes.type,dispName:d.attributes.dispName,datasetid:d.attributes.tid,expression:d.attributes.expression};o.push(h);var g=$(this);g.find("div.ptabhelpr").remove();if(g.find("b").size()==0){g.append("<b>参数： </b>")}g.append('<span class="pppp" id="pa_'+h.id+'"><span title="筛选" onclick="paramFilter(\''+h.id+"', '"+h.type+"','"+d.text+'\')" class="text">'+d.text+"(无)</span><button onclick=\"deleteParam('"+h.id+'\')" class="btn btn-outline btn-danger btn-xs"><i class="fa fa-times"></i></button></span>');paramFilter(h.id,h.type,d.text)}})}function deleteParam(c){$("#p_param #pa_"+c).remove();var a=-1;for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var b=pageInfo.params[i];if(b.id==c){a=i;break}}pageInfo.params.splice(a,1);if(pageInfo.params.length==0){$("#p_param").html('<div class="ptabhelpr">拖拽维度到此处作为页面参数</div>')}gridView(pageInfo.grid);chartview(pageInfo.chart);crossView(pageInfo.cross)}function paramFilter(l,e,c){var b=320;var d=200;var f=findParamById(l);var g=f.filter;var a="";if(e=="Double"||e=="Int"){a="<div style='margin:5px;'><br/><span class=\"inputtext\">"+c+'：</span><select id="ftype" class="inputform2"><option value=""></option><option value=">" '+(g&&g.filterType==">"?"selected":"")+'>大于</option><option value=">=" '+(g&&g.filterType==">="?"selected":"")+'>大于等于</option><option value="<" '+(g&&g.filterType=="<"?"selected":"")+'>小于</option><option value="<=" '+(g&&g.filterType=="<="?"selected":"")+'>小于等于</option><option value="=" '+(g&&g.filterType=="="?"selected":"")+'>等于</option><option value="!=" '+(g&&g.filterType=="!="?"selected":"")+'>不等于</option><option value="between" '+(g&&g.filterType=="between"?"selected":"")+'>区间</option></select><span class="inputtext"></span><input type="text" class="inputform2" id="startval" value="'+(g?g.val1:"")+'"><span id="endvalspan" style="display:'+(g&&g.filterType=="between"?"inline":"none")+'"> <span class="inputtext"></span>and <br/><span class="inputtext"></span><input type="text" id="endval" class="inputform2" value="'+(g?g.val2:"")+'"></span></div>'}else{if(e=="String"){a="<div style='margin:5px;'><br/> <span class=\"inputtext\">"+c+'</span><select id="ftype" class="inputform2"><option value=""></option><option value="=" '+(g&&g.filterType=="="?"selected":"")+'>等于</option><option value="!=" '+(g&&g.filterType=="!="?"selected":"")+'>不等于</option><option value="like" '+(g&&g.filterType=="like"?"selected":"")+'>包含</option></select> <span class="inputtext"></span><input type="text" id="val1" class="inputform2" value="'+(g?g.val1:"")+'"> </div>'}else{a="<div style='margin:5px;'><input type='hidden' id='ftype' value='between'><br/> 开始时间：  <input type=\"text\" id=\"stdt\"  readonly=\"true\" value=\""+(g&&g.stdt?g.stdt:"")+'" onclick="WdatePicker({dateFmt:\'yyyy-MM-dd\'})" class="Wdate inputform2"><br/><br/>  结束时间： <input type="text" id="enddt"  readonly="true" onclick="WdatePicker({dateFmt:\'yyyy-MM-dd\'})" class="Wdate inputform2" value="'+(g&&g.enddt?g.enddt:"")+'"><br/>  </div>'}}$("#pdailog").dialog({title:c+" - 参数值筛选",width:b,height:d,closed:false,cache:false,modal:true,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var s=$("#pdailog #ftype").val();if(s==""){msginfo("请选择筛选条件!");return}if(e=="Double"||e=="Int"){var n=$("#pdailog #startval").numberbox("getValue");var q=$("#pdailog #endval").numberbox("getValue");if(n==""){msginfo("请录入筛选值!");return}var p={filterType:s,val1:Number(n),val2:(q==""?0:Number(q))};f.filter=p}else{if(e=="String"){var r=$("#pdailog #val1").val();if(r==""){msginfo("请录入筛选值!");return}var p={filterType:s,val1:r};f.filter=p}else{if(e=="Date"||e=="Datetime"){var h=$("#pdailog #stdt").val();var o=$("#pdailog #enddt").val();if(h==""||o==""){msginfo("请选择开始时间及结束时间!");return}var p={filterType:"between",stdt:h,enddt:o};f.filter=p}}}$("#p_param #pa_"+f.id+" span").text(dispalyParamName(f));$("#pdailog").dialog("close");curTmpInfo.isupdate=true;gridView(pageInfo.grid);chartview(pageInfo.chart);crossView(pageInfo.cross)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #startval,#pdailog #endval").numberbox({height:28});$("#pdailog #ftype").bind("change",function(){var h=$(this);if(h.val()=="between"){$("#pdailog #endvalspan").css("display","inline")}else{$("#pdailog #endvalspan").css("display","none")}});$("#pdailog #clear").bind("click",function(){$("#pdailog #ftype").val("");$("#pdailog #startval").numberbox("clear");$("#pdailog #endval").numberbox("clear")})}function dispalyParamName(c){var b=c.type;var a=c.filter;if(!a){return c.dispName==""?c.name:c.dispName}if((b=="Int"||b=="Double")&&a.filterType=="between"){return((c.dispName==""?c.name:c.dispName)+"("+a.filterType+" "+a.val1+" and "+a.val2+" )")}else{if(b=="String"&&a.filterType=="like"){return((c.dispName==""?c.name:c.dispName)+"(包含 "+a.val1+")")}else{if(b=="Date"||b=="Datetime"){return((c.dispName==""?c.name:c.dispName)+"("+a.stdt+"到"+a.enddt+")")}else{return((c.dispName==""?c.name:c.dispName)+"("+a.filterType+a.val1+")")}}}}function savepage(c,b,e){if(curTmpInfo.view&&curTmpInfo.share=="y"){msginfo("您不能保存共享报表，请先另存报表后再修改。");return}var a=JSON.stringify(pageInfo);if(a=="{}"){msginfo("没有需要保存的内容！");return}var d=pageInfo.id;if(d==undefined||d==null){d=""}if(d==""){$.messager.prompt("提示信息","请输入您要保存的文件名称：",function(f){if(f){$.post("saveReport.action",{pageinfo:a,pagename:f},function(g){pageInfo.id=g.rows;if(b!=undefined){b()}msginfo("保存成功！","success");curTmpInfo.isupdate=false})}});$(".messager-input").focus()}else{$.post("saveReport.action",{pageinfo:a,pageId:d},function(f){if(b!=undefined){b()}else{}if(!e||e==false){msginfo("保存成功！","success")}curTmpInfo.isupdate=false})}}function saveas(b){var a=JSON.stringify(pageInfo);$.messager.prompt("提示信息","请输入您要另存的文件名称：",function(c){if(c){$.post("saveReport.action",{pageinfo:a,pageId:"",pagename:c},function(d){msginfo("保存成功！","success")})}});$(".messager-input").focus()}function openreport(b){var a='<div class="row"><div class="col-sm-4"><button style="margin:5px" class="btn btn-danger btn-xs" type="button" id="delreport">删除所选</button></div><div style=\'margin:5px;\' class="col-sm-7" align="right"><input id="subSearchBox" style="width:160px"></input></div></div><table id="reportlist" title="" ></div><thead><tr><th data-options="field:\'ck\',checkbox:true"></th><th data-options="field:\'pagename\',width:200">报表名称</th><th data-options="field:\'userName\',width:100,align:\'center\'">创建人</th><th data-options="field:\'crtdate\',width:90,align:\'center\'">创建时间</th></tr></thead></table>';$("#pdailog").dialog({title:"打开报表",width:440,height:360,content:a,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},onClose:function(){$("#pdailog").removeClass("hidebody")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var d=$("#reportlist").datagrid("getSelected");if(!d||d==null){msginfo("请至少选择一个报表！");return}$("#pdailog").dialog("close");var c="Report.action?pageId="+d.pageId;if(curTmpInfo.isupdate==true){if(confirm("页面还未保存\n是否保存当前页面？")){savepage(b,function(){location.href=c})}else{location.href=c}}else{location.href=c}}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog").addClass("hidebody");$("#reportlist").datagrid({singleSelect:true,collapsible:false,pagination:false,border:true,width:430,height:258,url:"listReports.action",method:"post",queryParams:{t:Math.random()}});$("#subSearchBox").searchbox({searcher:function(d,c){$("#pdailog #reportlist").datagrid("load",{keyword:d})},prompt:"请输入查询关键字."});$("#delreport").bind("click",function(){var c=$("#reportlist").datagrid("getSelected");if(!c||c==null){msginfo("请至少选择一个报表！");return}if(confirm("是否确认删除？")){$.ajax({type:"POST",url:"delReport.action",data:{pageId:c.pageId},dataType:"json",success:function(){$("#pdailog #reportlist").datagrid("load",{})}})}})}function newpage(){var a="Report.action";if(curTmpInfo.isupdate==true){if(confirm("页面还未保存\n是否保存当前页面？")){savepage(false,function(){location.href=a})}else{location.href=a}}else{location.href=a}}function openmyreport(){location.href="Report.action?pageId="+pageInfo.reportId}function deletemyreport(){if(confirm("是否确认删除？")){$.post("MyReport!delete.action",{reportId:pageInfo.reportId,view:curTmpInfo.view},function(b){var a=$("#myreporttree").tree("getSelected");$("#myreporttree").tree("remove",a.target)})}}function chgreportname(){var a=$("#myreporttree").tree("getSelected");$.messager.prompt("提示信息","请输入新文件名称：",function(b){if(b){$.post("MyReport!rename.action",{reportId:pageInfo.reportId,reportName:b,view:curTmpInfo.view},function(c){if(a){$("#myreporttree").tree("update",{target:a.target,text:b})}})}});$(".messager-input").val(a.text);$(".messager-input").select()}function crtTable(){var a='<div class="ctx"><table class="d_table"><tbody><tr><th><div class="tabhelpr" id="d_colDims2">将字段拖入此处查询</div></th></tr><tr><td class="onesel">  </td></tr><tr><td  class="onesel2">  </td></tr><tr><td class="onesel">  </td></tr><tr><td class="onesel2"> </td></tr><tr><td class="onesel"> </td></tr></tbody></table></div>';$("#T2").html(a);fireDropEvent()}function fireDropEvent(){$("#T2 #d_colDims2").droppable({accept:"#selectdatatree .tree-node",onDragEnter:function(b,a){$(a).draggable("proxy").find("span").removeClass("tree-dnd-no");$(a).draggable("proxy").find("span").addClass("tree-dnd-yes");$(this).css("border","1px solid #ff0000");b.cancelBubble=true;b.stopPropagation()},onDragLeave:function(b,a){$(a).draggable("proxy").find("span").addClass("tree-dnd-no");$(a).draggable("proxy").find("span").removeClass("tree-dnd-yes");$(this).css("border","none");b.cancelBubble=true;b.stopPropagation()},onDrop:function(f,d){$(this).css("border","none");f.cancelBubble=true;f.stopPropagation();var a=pageInfo.grid;if(!a){pageInfo.grid=a={cols:[]}}var c=$("#selectdatatree").tree("getNode",d);if(a.datasetid&&a.datasetid!=c.attributes.tid){msginfo("你拖入的字段"+c.text+"与表格已有的内容不在同一个数据集中，拖放失败！");return}else{a.datasetid=c.attributes.tid}var b=function(e){var g=false;for(j=0;j<a.cols.length;j++){if(a.cols[j].id==e){g=true;break}}return g};if(b(c.id)){msginfo("您拖拽的字段 "+c.text+" 已经存在。");return}a.cols.push({id:c.id,alias:"C"+c.id,name:c.attributes.name,tname:c.attributes.tname,type:c.attributes.type,dispName:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression});gridView(a);curTmpInfo.isupdate=true}})}function gridView(b){if(!b){return}if(!b.cols||b.cols.length==0){crtTable();return}var c=findDatasetById(b.datasetid);var a={cols:b.cols,params:pageInfo.params,dset:c};__showLoading();$.ajax({type:"POST",url:"GridView.action",dataType:"html",contentType:"application/json",data:JSON.stringify(a),success:function(d){__hideLoading();$("#T2 div.ctx").html(d);fireDropEvent()},error:function(d){__hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function tablePagination(b,a,e,g){b=b-1;var d=pageInfo.grid;d.pageSize=a;d.currPage=b;var f=findDatasetById(d.datasetid);var c={cols:d.cols,pageSize:a,currPage:b,params:pageInfo.params,dset:f};__showLoading();$.ajax({type:"POST",url:"GridView.action",contentType:"application/json",dataType:"html",data:JSON.stringify(c),success:function(h){__hideLoading();$("#T2 div.ctx").html(h);fireDropEvent()},error:function(h){__hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function optTableCol(b,d){var c=$(b).offset();curTmpInfo.colId=d;var a=findColById(d);if(a.sort&&a.sort=="asc"){$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord1")).target,iconCls:"icon-ok"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord2")).target,iconCls:"icon-blank"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord3")).target,iconCls:"icon-blank"})}else{if(a.sort&&a.sort=="desc"){$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord1")).target,iconCls:"icon-blank"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord2")).target,iconCls:"icon-ok"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord3")).target,iconCls:"icon-blank"})}else{$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord1")).target,iconCls:"icon-blank"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord2")).target,iconCls:"icon-blank"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord3")).target,iconCls:"icon-ok"})}}$("#gridoptmenu").menu("show",{left:c.left,top:c.top+19})}function gridColsort(b){var c=curTmpInfo.colId;var a=findColById(c);for(i=0;i<pageInfo.grid.cols.length;i++){delete pageInfo.grid.cols[i].sort}if(b!=""){a.sort=b}curTmpInfo.isupdate=true;gridView(pageInfo.grid)}function tableColmove(c){var d=curTmpInfo.colId;var b=pageInfo.grid.cols;if(b.length<=1){msginfo("无效移动。");return}for(var a=0;a<b.length;a++){if(b[a].alias==d){if(c=="left"){if(a<=0){msginfo("无效移动。");return}else{var c=b[a-1];b[a-1]=b[a];b[a]=c;curTmpInfo.isupdate=true;gridView(pageInfo.grid);return}}else{if(c=="right"){if(a>=b.length-1){msginfo("无效移动。");return}else{var c=b[a+1];b[a+1]=b[a];b[a]=c;curTmpInfo.isupdate=true;gridView(pageInfo.grid);return}}}break}}}function delTableCol(){var e=curTmpInfo.colId;var b=pageInfo.grid;var a=-1;for(i=0;i<b.cols.length;i++){var d=b.cols[i];if(d.alias==e){a=i;break}}b.cols.splice(a,1);gridView(b)}function shareReport(b){var a=$("#myreporttree").tree("getSelected");if(a.attributes.share=="y"&&b=="y"){return}if(a.attributes.share!="y"&&b=="n"){return}if(confirm("是否"+(b=="n"?"取消":"")+"共享？")){$.ajax({type:"post",dataType:"json",url:b=="y"?"MyReport!share.action":"MyReport!unshare.action",data:{reportId:a.id},success:function(c){}})}}function exportPage(tp){var ctx="<form name='expff' method='post' action=\"ReportExport.action\" id='expff'><input type='hidden' name='type' id='type'><input type='hidden' name='json' id='json'><input type='hidden' name='picinfo' id='picinfo'></form>";if($("#expff").size()==0){$(ctx).appendTo("body")}$("#expff #type").val(tp);var jstr=JSON.stringify(pageInfo);var njson=eval("("+jstr+")");var tabId=Number($("div.tabs-container li.active a").attr("idx"));if(tabId==1){delete njson.cross;delete njson.chart}else{if(tabId==2){delete njson.grid;delete njson.chart}else{if(tabId==3){delete njson.cross;delete njson.grid}}}$("#expff #json").val(JSON.stringify(njson));var strs="";if(tp=="pdf"||tp=="excel"||tp=="word"){$("div.chartUStyle").each(function(index,element){var id=$(this).attr("id");id=id.substring(1,id.length);var chart=echarts.getInstanceByDom(document.getElementById(id));var str=chart.getDataURL({type:"png",pixelRatio:1,backgroundColor:"#fff"});str=str.split(",")[1];str=$(this).attr("label")+","+str;strs=strs+str;if(index!=$("div.chartUStyle").size()-1){strs=strs+"@"}})}$("#expff #picinfo").val(strs);$("#expff").submit()}function findColById(b){var a=null;for(i=0;pageInfo.grid&&pageInfo.grid.cols&&i<pageInfo.grid.cols.length;i++){if(pageInfo.grid.cols[i].alias==b){a=pageInfo.grid.cols[i];break}}return a}function findParamById(a){var b=null;for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var c=pageInfo.params[i];if(c.id==a){b=c;break}}return b}function newGuid(){var a="";for(var b=1;b<=32;b++){var c=Math.floor(Math.random()*16).toString(16);a+=c}return a};