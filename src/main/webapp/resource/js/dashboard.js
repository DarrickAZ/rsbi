(function(e,c,a,g){var d="dashboard",f={version:"1.0"};function b(l,k){this.element=e(l);this.pageInfo=k&&k.cfg?k.cfg:{};this.editorEnable=k&&k.editorEnable?k.editorEnable:"1";this.title=k&&k.title?k.title:"";this._defaults=f;this._name=d;this.gridster=this.init();this.initComps();this.update=false;this.tmp=null;c.dashboard=this}b.prototype={init:function(){var m=this;e("#addAnalysis").click(function(){m.crtWidget()});e("#crtAnalysis").click(function(){m.crtAnalysis()});e("#addDashboard").click(function(){if(m.update){if(confirm("仪表盘还未保存，是否新建仪表盘？")){location.href="newDashboard.action"}}else{location.href="newDashboard.action"}});e("#saveDashboard").click(function(){m.savePage()});e("#openDashboard").click(function(){m.openDashboard()});e("#searchbtn").click(function(){m.search()});e("#ypbSet").click(function(){m.setDashboard()});m.initbigScreenStyle();m.addYbpHeader();var l=e(c).width();var k=this.element.gridster({widget_selector:"div.dashboard-box",widget_margins:[20,20],widget_base_dimensions:["auto",60],autogenerate_stylesheet:true,max_cols:10,resize:{enabled:m.editorEnable=="1"?true:false,stop:function(r,u,p){m.update=true;var n=e(p);var q=n.height()-35;var v=n.width();var x=e(p).attr("id");var t=m.pageInfo[x];if(t.type=="chart"){t.chartJson.height=q;t.chartJson.width=v;var n=a.getElementById("C"+x);if(n){var s=echarts.getInstanceByDom(n);e("#C"+x).height(q).width(v);s.resize("auto","auto")}}else{if(t.type=="box"){t.height=q;n.find(".boxcls").css("line-height",q+"px")}else{if(t.type=="table"){t.height=q-26;n.find(".lock-dg-body").animate({height:t.height+"px"})}else{if(t.type=="grid"){t.height=(q-25-(t.isnotfy=="true"?0:35));n.find(".lock-dg-body").animate({height:t.height+"px"})}else{if(t.type=="text"){t.height=q}}}}}}},draggable:{handle:"header",stop:function(){m.update=true}},serialize_params:function(o,n){return{id:e(o).attr("id"),col:n.col,row:n.row,size_x:n.size_x,size_y:n.size_y}}}).data("gridster");if(m.editorEnable=="0"){k.disable()}if(m.pageInfo.autoflash&&m.pageInfo.autoflash.length>0){m.autoFlashPage()}return k},crtAnalysis:function(){var k=this;e("#modelDiv .modal-title").html("新建分析图");e("#modelDiv .modal-body").html("<ul class=\"todo-list small-list ui-sortable\" style=\"font-size:16px;\"><div style=\"padding:10px;\">选择分析图类型：</div><li><i style=\"color:#969696\" class=\"fa fa-square-o\"></i> <a href='#' class='newfxt' tp='box'>数据块</a></li><li><i style=\"color:#969696\" class=\"fa fa-line-chart\"></i> <a href='#' class='newfxt' tp='chart'>图表</a></li><li><i style=\"color:#969696\" class=\"fa fa-table\"></i> <a href='#' class='newfxt' tp='grid'>表格</a></li><li><i style=\"color:#969696\" class=\"fa fa-list-alt\"></i> <a href='#' class='newfxt' tp='table'>交叉表</a></li></ul>");e("#modelDiv").modal("show");e("#saveEventbtn").unbind("click").hide();e("#modelDiv a.newfxt").click(function(){e("#modelDiv").modal("hide");var l="";k.setWidget(l,"dashboard",e(this).attr("tp"));k.tmp="dashboard"})},addYbpHeader:function(){var k=this.pageInfo.style=="bigscreen";if(!k){return}var l='<header class="'+(k?"ybpheader-bigscreen":"ybpheader")+'"><h3>'+this.title+"</h3></header>";e(l).insertBefore("#paramDiv")},autoFlashPage:function(){var k=this;var l=Number(k.pageInfo.autoflash)*60*1000;c.setInterval(function(){for(var n in k.pageInfo){var p=k.pageInfo[n];if(p.id&&p.id==n){var m=k.pageInfo[p.id];k.compView(m)}}},l)},initbigScreenStyle:function(){if(!this.pageInfo.style||this.pageInfo.style=="def"){return}e("body").removeClass("gray-bg").addClass("screem-bg")},initComps:function(){var m=this;if(m.pageInfo.layout&&m.pageInfo.layout.length>0){e(".gridster .helptxt").remove();for(i=0;i<m.pageInfo.layout.length;i++){var n=m.pageInfo.layout[i];var k=m.pageInfo[n.id];if(!k){continue}m.addWidget(k,false,n.size_x,n.size_y,n.col,n.row)}}for(i=0;m.pageInfo.params&&i<m.pageInfo.params.length;i++){var l=m.pageInfo.params[i];e("#paramDiv").append('<span class="label label-success dashboradparam" id="'+l.id+'">'+l.keyDesc+"("+l.valueDesc+')<button class="btn btn-link btn-xs paramdelbtn"><i class="fa fa-remove"></i></button></span>').show()}e("body div.gridster").on("click","a.rmwidget",function(){var o=e(this).parents(".dashboard-box").attr("id");m.removeWidget(o)});e("body div.gridster").on("click","a.setwidget",function(){var o=e(this).parents(".dashboard-box").attr("id");m.setWidget(o,"dashboard");m.tmp="dashboard"});e("#paramDiv").on("click","button.paramdelbtn",function(){var s=e(this).parents(".dashboradparam");var v=s.attr("id");var p=-1;var r="";for(i=0;m.pageInfo.params&&i<m.pageInfo.params.length;i++){if(m.pageInfo.params[i].id==v){r=m.pageInfo.params[i].tid;p=i}}if(p!=-1){m.pageInfo.params.splice(p,1)}s.remove();if(m.pageInfo.params&&m.pageInfo.params.length==0){e("#paramDiv").hide()}for(var t in m.pageInfo){var u=m.pageInfo[t];if(u.id&&u.id==t){var q=m.pageInfo[u.id];if(q.tid!=r){continue}q.dashboardParam=m.pageInfo.params;m.compView(q)}}})},editorSave:function(o,q,p){e("#compEditer").hide();var k=this.pageInfo.style=="bigscreen";var m=this.tmp;if(q&&m=="dashboard"){if(p){var l=h=3;if(o.type=="table"||o.type=="grid"){l=6}this.addWidget(o,true,l,h)}else{this.pageInfo[o.id]=o;var r=o.name;e("#"+o.id+" .ibox-title"+(k?"-screem":"")).contents().filter(function(n,s){if(s.nodeType==3){s.nodeValue=r}return s.nodeType==3});this.compView(o)}}else{if(q&&m=="comp"){e.post("share/update.action",{title:o.name,cfg:JSON.stringify(o),id:o.id},function(n){})}}this.tmp=null},setWidget:function(p,k,m){var n='<iframe width=\'100%\' height=\'100%\' frameborder="no" border="0" scrolling="no" ></iframe>';var o='<div id="compEditer">'+n+"</div>";if(e("#compEditer").size()==0){e(o).appendTo("body")}var l="../portal/CompEditer.action?from="+k+"&id="+p;if(m){l=l+"&compType="+m}e("#compEditer").css({top:e(a).scrollTop()+"px"});e("#compEditer iframe").attr("src",l);e("#compEditer").show()},openDashboard:function(){var k=this;e("#modelDiv .modal-title").html("选择已有仪表盘");e("#modelDiv").modal("show");e("#saveEventbtn").unbind("click").hide();e.ajax({type:"POST",url:"list.action",dataType:"JSON",data:{},success:function(m){var l='<ul class="todo-list small-list ui-sortable">';for(j=0;j<m.rows.length;j++){l=l+'<li style="font-size:14px;"><i style="color:#969696;font-size:16px;" class="fa fa-dashboard"></i> <a class="openreport" href="javascript:;" did="'+m.rows[j].id+'">'+m.rows[j].pageName+'</a><div class="compopt"><button type="button" class="btn btn-danger btn-xs ybpdel" did="'+m.rows[j].id+'">删除</button></div></li>'}l=l+"</ul>";e("#modelDiv .modal-body").html(l);e("#modelDiv a.openreport").bind("click",function(){var n=e(this).attr("did");if(k.update){if(confirm("仪表盘还未保存，是否打开选择的仪表盘？")){location.href="Index.action?id="+n}}else{location.href="Index.action?id="+n}});e("#modelDiv button.ybpdel").bind("click",function(){var o=e(this).attr("did");var n=this;if(confirm("是否确认删除？")){e.get("delete.action",{id:o},function(p){e(n).closest("li").remove()})}})}})},crtWidgetHtml:function(m,l){var k=this.pageInfo.style=="bigscreen";return'<div id="'+(m?m:this.newGuid())+'" class="'+(!k?"ibox":"xpanel")+' dashboard-box" style="margin-bottom:0px;"><header class="'+(!k?"ibox-title":"ibox-title-screem")+'" style="'+(this.editorEnable=="0"?"cursor:auto;":"")+'">'+(l?l:"_未命名")+"<div "+(this.editorEnable=="0"?'style="display:none;"':"")+' class="ibox-tools"><a href="javascript:;" class="setwidget" title="编辑"><i class="fa fa-wrench"></i></a> <a title="删除" href="javascript:;" class="rmwidget"><i class="fa fa-times"></i></a></div></header><div class="ibox-content'+(k?"-screem":"")+'" style="padding:2px;"> </div></div>'},removeWidget:function(k){if(confirm("是否确认删除？")){this.gridster.remove_widget(a.getElementById(k));this.update=true}delete this.pageInfo[k]},crtWidget:function(){var m=this;var l='<div style="margin-bottom:10px;" class="input-group"><input type="text" placeholder="搜索分析图" class="form-control" name="fxtkeyword" id="fxtkeyword"><span class="input-group-btn"><button id="fxtsearch" type="button" class="btn btn-default"><i class="fa fa-search"></i>搜索</button></span></div><div id="searchResult"></div>';e("#modelDiv .modal-title").html("添加分析图");e("#modelDiv .modal-body").html(l);e("#modelDiv").modal("show");e("#saveEventbtn").unbind("click").hide();var k=function(n){e.getJSON("share/list.action",{t:Math.random(),keyword:n},function(p){var o=[];o.push('<ul class="todo-list small-list ui-sortable">');if(!p.rows||p.rows.length==0){o.push("<li>无数据。</li>")}else{p.rows.forEach(function(q){o.push('<li cid="'+q.id+'" style="font-size:14px;"><i style="color:#969696" class="'+q.compIcon+'"></i> <a href="javascript:;" class="selComp">'+q.title+'</a> <div class="compopt"><button type="button" class="btn btn-primary btn-xs compedit">编辑</button> <button type="button" class="btn btn-danger btn-xs compdel">删除</button></div></li>')})}o.push("</ul>");e("#modelDiv #searchResult").html(o.join(""));e("#modelDiv .selComp").click(function(){var q=e(this).closest("li").attr("cid");m.selectComp(q);e("#modelDiv").modal("hide")});e("#modelDiv button.compedit").click(function(){var q=e(this).closest("li").attr("cid");m.setWidget(q,"comp");m.tmp="comp"});e("#modelDiv button.compdel").click(function(){var q=this;var r=e(q).closest("li").attr("cid");if(confirm("是否确认删除？")){e.post("share/delete.action",{id:r},function(s){e(q).closest("li").remove()})}})})};e("#modelDiv #fxtsearch").click(function(){var n=e("#modelDiv #fxtkeyword").val();k(n)});k()},selectComp:function(l){var k=this;e.getJSON("share/get.action",{id:l},function(m){m.useIn="dashboard";c.setTimeout(function(){var n=h=3;if(m.type=="table"||m.type=="grid"){n=6}k.addWidget(m,true,n,h)},100)})},addWidget:function(m,k,l,p,n,q){if(k&&this.pageInfo[m.id]){msginfo("分析图已经存在。");return}e(".gridster .helptxt").remove();this.pageInfo[m.id]=m;var o=this.crtWidgetHtml(m.id,m.name);this.gridster.add_widget(o,l,p,n,q);this.update=true;var p=e("#"+m.id).height()-35;if(m.type=="table"){p=p-25}else{if(m.type=="grid"){p=p-25-30}}if(m.type=="chart"){m.chartJson.height=p}else{m.height=p}this.compView(m)},compView:function(l){var m="";if(l.type=="box"){m="../portal/BoxView.action"}else{if(l.type=="chart"){m="../portal/ChartView.action"}else{if(l.type=="table"){m="../portal/TableView.action"}else{if(l.type=="grid"){m="../portal/GridView.action"}else{msginfo("组件类型错误。");return}}}}var k=this.pageInfo.style=="bigscreen";l.dashboardStyle=this.pageInfo.style;__showLoading();e.ajax({type:"POST",url:m,dataType:"html",contentType:"application/json",data:JSON.stringify(l),success:function(n){__hideLoading();e("#"+l.id+" div.ibox-content"+(k?"-screem":"")).html(n)},error:function(n){__hideLoading()}})},seriesClick:function(o,n,r,q,p,s,l,m,k){this.addParam(m,o,k,n,s)},tableRowClick:function(n,m,l,k,o){this.addParam(l,o,k,o,m)},addParam:function(y,x,k,q,z){if(!this.pageInfo.params){this.pageInfo.params=[]}var v=this.pageInfo[z];var u=null;if(v.type=="chart"){u=v.chartJson.xcol}else{if(v.type=="table"){u=v.rows[v.rows.length-1]}}var m=this.newGuid();var l={key:y,colname:u.colname,value:x,id:m,tid:v.tid,from:v.id,keyDesc:k,valueDesc:q,valType:u.valType,fromCol:u.fromCol};if(this.findParamById(m)!=null){return}var r=this.pageInfo.params;var t=-1;for(i=0;r&&i<r.length;i++){if(r[i].from==v.id&&r[i].key==y){e("#"+r[i].id).remove();t=i}}if(t!=-1){r.splice(t,1)}this.pageInfo.params.push(l);var A=' <span class="label label-success dashboradparam" id="'+m+'">'+k+"("+q+')<button class="btn btn-link btn-xs paramdelbtn"><i class="fa fa-remove"></i></button></span>';e("#paramDiv").append(A).show();for(var n in this.pageInfo){var w=this.pageInfo[n];if(w.id&&w.id==n){if(w.id==z){continue}if(w.tid!=v.tid){continue}var v=this.pageInfo[w.id];v.dashboardParam=this.pageInfo.params;this.compView(v)}}},findParamById:function(l){var k=null;for(i=0;this.pageInfo.params&&i<this.pageInfo.params.length;i++){if(this.pageInfo.params[i].id==l){k=this.pageInfo.params[i]}}return k},savePage:function(){var k=this.gridster.serialize();var n=function(q,o){var t=q.col;var r=q.row;var s=o.col;var p=o.row;if(r==p){return t-s}else{return r-p}};k=k.sort(n);this.pageInfo.layout=k;var m=this;if(!m.pageInfo.id){e("#modelDiv .modal-title").html("保存仪表盘");var l='<div class="form-group"><label class="col-sm-2 control-label" align="right">名 称：</label><div class="col-sm-8"><input id="ybpname" name="ybpname" class="form-control" type="text"></div></div>';e("#modelDiv .modal-body").html(l);e("#modelDiv").modal("show");e("#saveEventbtn").show().unbind("click").bind("click",function(){val=e("#modelDiv #ybpname").val();if(val==""){msginfo("请录入仪表盘名称");return}e.ajax({type:"POST",url:"save.action",dataType:"JSON",data:{pageName:val,pageInfo:JSON.stringify(m.pageInfo),id:m.pageInfo.id},success:function(o){m.update=false;if(!m.pageInfo.id){m.pageInfo.id=o.rows}e("#modelDiv").modal("hide")}})})}else{e.ajax({type:"POST",url:"save.action",dataType:"JSON",data:{pageInfo:JSON.stringify(m.pageInfo),id:m.pageInfo.id},success:function(o){m.update=false;if(!m.pageInfo.id){m.pageInfo.id=o.rows}msginfo("仪表盘保存成功！","success")}})}},setDashboard:function(){var l=this;var k=function(m){var n=['<form class="form-horizontal">','<div class="form-group" style="margin-right:0px;"><label class="col-sm-4 control-label">仪表盘名称：</label><div class="col-sm-8"><input id="ybpname" name="ybpname" class="form-control" type="text" value="'+m.pageName+'"></div></div>','<div class="form-group" style="margin-right:0px;"><label class="col-sm-4 control-label">禁用编辑模式：</label><div class="col-sm-8"><div class="checkbox checkbox-info"><input type="checkbox" value="y" id="noteditor" name="noteditor" '+(l.editorEnable=="0"?"checked":"")+'><label for="noteditor"></label></div></div></div>','<div class="form-group" style="margin-right:0px;"><label class="col-sm-4 control-label">设为默认仪表盘：</label><div class="col-sm-8"><div class="checkbox checkbox-info"><input type="checkbox" value="y" id="setmydashboard" name="setmydashboard"><label for="setmydashboard"></label></div></div></div>','<div class="form-group" style="margin-right:0px;"><label class="col-sm-4 control-label">风格：</label><div class="col-sm-8"><div class="radio radio-inline radio-info"><input name=\'ybpstyle\' id=\'ybpstyle1\' type=\'radio\' '+(!l.pageInfo.style||l.pageInfo.style=="def"?"checked='true'":"")+" value='def'><label for=\"ybpstyle1\">默认</label></div> <div class=\"radio radio-inline radio-info\"><input name='ybpstyle' id='ybpstyle2' type='radio' "+(l.pageInfo.style=="bigscreen"?"checked='true'":"")+" value='bigscreen'><label for=\"ybpstyle2\">大屏</label></div></div></div>",'<div class="form-group" style="margin-right:0px;"><label class="col-sm-4 control-label">自动刷新：</label><div class="col-sm-8"><select id="autoflash" class="form-control"><option value=\'\'>不启用</option><option value=\'1\'>间隔1分钟</option><option value=\'5\'>间隔5分钟</option><option value=\'10\'>间隔10分钟</option><option value=\'20\'>间隔20分钟</option></select></div></div>','<div class="form-group" style="margin-right:0px;"><div class="col-sm-offset-4 col-sm-8"><button type="button" class="btn btn-sm btn-outline btn-default" id="copyurl">复制仪表盘URL</button></div></div>',"</form>"];e("#modelDiv .modal-title").html("仪表盘设置");e("#modelDiv .modal-body").html(n.join(""));e("#modelDiv").modal("show");e("#autoflash").val(l.pageInfo.autoflash);e("#copyurl").unbind("click").bind("click",function(){if(!l.pageInfo.id){msginfo("请先保存仪表盘再复制URL。");return}e.ajax({url:"copyUrl.action",type:"POST",data:{id:l.pageInfo.id},dataType:"json",success:function(o){if(o.result==1){msginfo(o.rows,"success")}else{msginfo("错误信息："+o.msg)}}})});e("#modelDiv #saveEventbtn").unbind("click").bind("click",function(){var p=l.pageInfo.style||"def";var q=e("#setmydashboard").prop("checked");var s=e("#noteditor").prop("checked");var r=e("input[name='ybpstyle']:checked").val();var u=e("#ybpname").val();var o=e("#autoflash").val();l.pageInfo.autoflash=o;l.pageInfo.style=r;var t=JSON.stringify(l.pageInfo);e.post("setDashboard.action",{id:l.pageInfo.id,pageName:u,pageInfo:t,defDashboard:q,editorEnable:s?0:1},function(){e("#modelDiv").modal("hide")});e(".ybpheader-bigscreen h3").html(u);if(s==true){l.gridster.disable();l.editorEnable="0";e(".dashboard-box .ibox-tools").hide();c.setTimeout(500,function(){l.gridster.disable_resize()})}else{l.gridster.enable();l.editorEnable="1";e(".dashboard-box .ibox-tools").show();c.setTimeout(500,function(){l.gridster.enable_resize()})}if(p!=r){alert("风格发生改变，页面需要刷新才能生效，点击确定页面自动刷新。");location.href="Index.action?id="+l.pageInfo.id}}).show()};if(!l.pageInfo.id){msginfo("请先保存仪表盘再进行设置。");return}e.getJSON("get.action",{id:l.pageInfo.id},function(m){k(m)})},newGuid:function(){var k="";for(var l=1;l<=32;l++){var m=Math.floor(Math.random()*16).toString(16);k+=m}return k}};e.fn[d]=function(k){this.each(function(){var l=e(this);if(l.data(d)){l.data(d).remove()}l.data(d,new b(this,k))});return this}})(jQuery,window,document);