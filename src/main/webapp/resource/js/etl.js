if($==undefined){$=jQuery}function viewdata(){var b=$("#filepath").val();var l=window.sqlEditor?window.sqlEditor.getValue():"";var a=function(m){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:"数据预览",fit:true,closed:false,cache:false,modal:true,toolbar:null,content:m,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"关闭",iconCls:"icon-ok",handler:function(){$("#dsColumn_div").dialog("close")}}]})};var f;var e;var d=$("#impType").val();var g="";var h=0;if("csv"==d){f=$("#csvencode").combobox("getValue");g=$("#splitWord").combobox("getValue")}else{if("xls"==d){h=Number($("#sheetIndex").val())}else{if("hadoop"==d){e=$("#hdfsAddress").val();g=$("#splitWord").combobox("getValue");b=$("#path").val()}}}var c=null;__showLoading();$.ajax({type:"post",url:"showImpDatas.action",dataType:"html",contentType:"application/json",data:JSON.stringify({sql:l,impType:d,dsource:d=="db"?dsource:null,hdfsAddress:e,path:b,encode:f,splitWord:g,sheetIndex:h}),success:function(m){__hideLoading();a(m)},error:function(){__hideLoading()}})}function selectTable(){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var a="";$.ajax({type:"POST",async:false,url:"listTables.action",dataType:"json",data:{t:Math.random()},success:function(b){for(i=0;i<b.length;i++){a=a+'<div class="radio radio-info" style="margin-bottom:6px;"><input type="radio" id="T'+i+'" name="tableId" value="'+b[i].tableId+","+b[i].tableName+'"><label for="T'+i+'">'+b[i].tableName+"("+b[i].tableNote+")</label></div>"}}});$("#dsColumn_div").dialog({title:"选择表",width:420,height:300,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var b=$('input[name="tableId"]:checked').val();if(!b||b==null){$.messager.alert("出错了","请至少选择一个数据表！","error");return}var c=b.split(",");$("#targettableid").val(c[0]);$("#targettable").val(c[1]);getTableColumns(c[0],[],function(){automatch()});$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function newtable(){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var e=$("#impType").val();var d=$("#filepath").val();var g="";var b="";var a=0;if(e=="csv"){g=$("#csvencode").combobox("getValue");b=$("#splitWord").combobox("getValue")}else{if(e=="xls"){a=Number($("#sheetIndex").val())}}var c=$("#nameinhead").prop("checked");if(c){c="y"}else{c="n"}var f="";if(e=="db"){f=window.sqlEditor.getValue();if(f==""){$.messager.alert("出错了","请先录入SQL语句。","error");return}}__showLoading();$.ajax({type:"POST",url:"createTableColumns.action",dataType:"json",contentType:"application/json",data:JSON.stringify({dsource:e=="db"?dsource:null,sql:f,impType:e,path:d,encode:g,nameinhead:c,splitWord:b,sheetIndex:a}),success:function(n){for(i=0;i<n.length;i++){var l=n[i];l.idx=i+1;if(l.length==0){l.length=""}}var m=n;__hideLoading();h(m)},error:function(l){$.messager.alert("出错了","SQL语句错误。","error");__hideLoading()}});var h=function(n){if(!n){return}window.editIndex=undefined;var m=$("#impType").val();if("csv"==m){g=$("#csvencode").combobox("getValue")}var l="<div id='ntable'><div title='基本信息'><div class='textpanel'><span class=\"inputtext\">表名：</span><input type=\"text\" id=\"tablename\" name=\"tablename\" class=\"inputform\" placeholder=\"英文字符\"><br/><span class=\"inputtext\">中文名：</span><input type=\"text\" id=\"tablenote\" name=\"tablenote\" class=\"inputform\"><br/><span class=\"inputtext\">备注信息：</span><input type=\"text\" id=\"tdesc\" name=\"tdesc\" class=\"inputform\"></div></div><div title='表字段'><table id=\"tablecolumn\" style=\"width:530px;height:332px;\"><thead><tr><th data-options=\"field:'idx',width:60,align:'center'\">序号</th><th data-options=\"field:'name',width:120,editor:'text'\">字段名</th><th data-options=\"field:'type',width:80,formatter:fmtColumnType,editor:{type:'combobox',options:{data:[{value:'String',text:'字符串'},{value:'Int',text:'整数'},{value:'Double',text:'小数'},{value:'Date',text:'日期'},{value:'Datetime',text:'时间'}],onChange:selchange}}\">类型</th><th data-options=\"field:'length',width:80,editor:'numberbox'\">长度</th><th data-options=\"field:'scale',width:80,editor:'numberbox'\">精度(小数位)</th><th data-options=\"field:'dispName',width:130,editor:'text'\">说明</th></tr></thead></table></div><div title='数据预览'></div></div>";$("#dsColumn_div").dialog({title:"新建表",width:700,height:400,closed:false,cache:false,modal:true,toolbar:null,content:l,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var s=$("#dsColumn_div #tablename").val();if(s==""){$("#ntable").tabs("select",0);$.messager.alert("出错了","请填写表名。","error");return}if(ischinese(s)){$("#ntable").tabs("select",0);$.messager.alert("出错了","表名只能是英文字符。","error",function(){$("#dsColumn_div #tablename").select()});return}var r=/^[a-z|A-Z]/;var p=r.test(s);if(p==false){$("#ntable").tabs("select",0);$.messager.alert("出错了","表名必须以字母开始。","error",function(){$("#dsColumn_div #tablename").select()});return}if(containSpecial(s)){$("#ntable").tabs("select",0);$.messager.alert("出错了","表名包含特殊字符。","error",function(){$("#dsColumn_div #tablename").select()});return}var q;$.ajax({type:"POST",async:false,url:"tableExist.action",dataType:"json",data:{tableName:s},success:function(w){q=w.rows},error:function(w){q=-1}});if(q==-1){$.messager.alert("出错了","网络错误。","error");return}if(Number(q)>=1){$("#ntable").tabs("select",0);$.messager.alert("出错了","表名存在重复。","error",function(){$("#dsColumn_div #tablename").select()});return}var u=$("#dsColumn_div #tablenote").val();var v=$("#dsColumn_div #tdesc").val();if(window.editIndex!=undefined){$("#dsColumn_div #tablecolumn").datagrid("endEdit",window.editIndex)}var t=$("#dsColumn_div #tablecolumn").datagrid("getRows");if(t==null||t.length==0){$("#ntable").tabs("select",1);$.messager.alert("出错了","请添加表字段。","error");return}for(i=0;i<t.length;i++){if(!t[i].name||t[i].name==""){$("#ntable").tabs("select",1);$.messager.alert("出错了","第"+(i+1)+"行字段名未填写。","error");return}if(containSpecial(t[i].name)){$("#ntable").tabs("select",1);$.messager.alert("出错了","第"+(i+1)+"行字段名 "+t[i].name+" 包含特殊字符。","error");return}if(!t[i].type||t[i].type==""){$("#ntable").tabs("select",1);$.messager.alert("出错了","第"+(i+1)+"行类型未选择。","error");return}if((!t[i].length||t[i].length==""||Number(t[i].length)<=0)&&t[i].type!="Date"&&t[i].type!="Datetime"){$("#ntable").tabs("select",1);$.messager.alert("出错了","第"+(i+1)+"行长度未填写或不正确。","error");return}if((!t[i].scale||t[i].scale==""||Number(t[i].scale)<=0)&&t[i].type=="Double"){$("#ntable").tabs("select",1);$.messager.alert("出错了","第"+(i+1)+"行是小数类型，但精度未填写或不正确。","error");return}if(t[i].type=="Double"&&Number(t[i].scale)>=Number(t[i].length)){$("#ntable").tabs("select",1);$.messager.alert("出错了","第"+(i+1)+"行精度不能大于等于长度。","error");return}}__showLoading();$.ajax({type:"POST",url:"saveTableInfo.action",dataType:"json",contentType:"application/json",data:JSON.stringify({tableName:s,tableNote:u,tableDesc:v,cols:t}),success:function(w){__hideLoading();if(w.result==1){$.messager.alert("成功","表创建成功。","info");$("#dsColumn_div").dialog("close");$("#targettableid").val(w.rows.tableId);$("#targettable").val(w.rows.tableName);getTableColumns(w.rows.tableId,[],function(){automatch()})}else{$.messager.alert("出错了",w.msg,"error")}},error:function(){__hideLoading();$.messager.alert("出错了","系统异常。","error")}})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#ntable").tabs({fit:true,plain:false,border:false,tabPosition:"left",onSelect:function(r,p){if(p==2){var q=$("#ntable").tabs("getSelected");if($(q).html()==""){$.ajax({type:"POST",url:"showImpOneData.action",dataType:"html",contentType:"application/json",data:JSON.stringify({sql:f,impType:m,path:d,encode:g,nameinhead:c,dsource:m=="db"?dsource:null,splitWord:b,sheetIndex:a}),success:function(s){$(q).html(s)}})}}}});var o=$("#dsColumn_div #tablecolumn").datagrid({singleSelect:true,border:false,data:n,onClickCell:function(p,q){if(window.editIndex!=p){if(endEditing()){window.editIndex=p;$("#dsColumn_div #tablecolumn").datagrid("selectRow",p).datagrid("beginEdit",p)}else{setTimeout(function(){$("#dsColumn_div #tablecolumn").datagrid("selectRow",editIndex)},0)}}},onEndEdit:function(p,q){}})}}function endEditing(){if(window.editIndex==undefined){return true}if($("#dsColumn_div #tablecolumn").datagrid("validateRow",window.editIndex)){$("#dsColumn_div #tablecolumn").datagrid("endEdit",window.editIndex);window.editIndex=undefined;return true}else{return false}}function fmtColumnType(b,a){if(b=="String"){return"字符串"}else{if(b=="Int"){return"整数"}else{if(b=="Double"){return"小数"}else{if(b=="Date"){return"日期"}else{if(b=="Datetime"){return"时间"}}}}}}function selchange(d){var a=window.editIndex;var b=$("#tablecolumn").datagrid("getEditor",{index:a,field:"length"});var c=$("#tablecolumn").datagrid("getEditor",{index:a,field:"scale"});if(d=="String"){$(b.target).numberbox("setValue",50);$(c.target).numberbox("setValue","")}else{if(d=="Int"){$(b.target).numberbox("setValue",10);$(c.target).numberbox("setValue","")}else{if(d=="Double"){$(b.target).numberbox("setValue",12);$(c.target).numberbox("setValue",2)}else{if(d=="Date"||d=="Datetime"){$(b.target).numberbox("setValue","");$(c.target).numberbox("setValue","")}}}}}function getTableColumns(b,a,c){$.ajax({type:"GET",url:"getTableColumnsNotExpress.action",dataType:"json",data:{tableId:b,t:Math.random()},success:function(e){$("#tabletreepanel").panel({width:400,height:300,title:'目标表字段列表： <span style="width:180px;display: inline-block;"></span> <button type="button" style="margin-top:-3px;" class="btn btn-success btn-xs" onclick="automatch()">自动映射字段</button>',tools:[{iconCls:"icon-blank",handler:function(){automatch()}}]});var g=function(l){var h="";for(k=0;a&&k<a.length;k++){if(a[k].col==l){h=a[k].link;break}}return h};var d=[];for(i=0;i<e.length;i++){var f=g(e[i].colName);d.push({id:e[i].colName,text:e[i].colName+" -> "+(!f||f==""?"":"Field"+(Number(f)+1)),iconCls:"icon-dscol",attributes:{name:e[i].colName,type:e[i].colType,link:f}})}$("#tabletree").tree({data:d,onClick:function(m){var h=$("#filepath").val();var l=$("#impType").val();var n;if(l=="csv"){n=$("#csvencode").combobox("getValue")}if(l=="hadoop"){h=$("#path").val()}matchColumn(l,h,n)}});if(c){c()}},error:function(){$.messager.alert("出错了","系统异常。","error")}})}function automatch(){var e=$("#tabletree").tree("getChildren");if(e==null||e.length==0){$.messager.alert("出错了。","还未生成表字段。","error");return}var p="";var f="";var c=$("#filepath").val();var g=$("#impType").val();var m;var n;var l;var o=0;if(g=="csv"){m=$("#csvencode").combobox("getValue");n=$("#splitWord").combobox("getValue")}else{if(g=="xls"){o=Number($("#sheetIndex").val())}else{if(g=="hadoop"){l=$("#hdfsAddress").val();n=$("#splitWord").combobox("getValue");c=$("#path").val()}}}if("db"==g){p=window.sqlEditor.getValue()}var h;__showLoading();$.ajax({type:"post",url:"showImpColumns.action",contentType:"application/json",dataType:"json",async:false,data:JSON.stringify({impType:g,path:c,encode:m,hdfsAddress:l,nameinhead:"y",sql:p,dsource:(g=="db"?dsource:null),splitWord:n,sheetIndex:o}),success:function(q){__hideLoading();if(q.result==0){$.messager.alert("出错了","错误信息："+q.msg+"。","error")}else{h=q.rows}},error:function(){__hideLoading();$.messager.alert("出错了","执行错误，请先测试您的sql/csv/excel/hdfs文件是否正确。","error")}});if(!h){$.messager.alert("出错了","无数据，请先测试您的sql/csv/excel/hdfs文件是否正确。","error");return}var d=function(r){var q=null;for(j=0;j<h.length;j++){if(h[j].name.toUpperCase()==r.toUpperCase()){q=h[j];q.idx=j+"";break}}return q};for(k=0;k<e.length;k++){var b=e[k].id;var a=d(b);if(a!=null){e[k].attributes.link=a.idx;$("#tabletree").tree("update",{target:e[k].target,text:e[k].id+" -> Field"+(Number(a.idx)+1)})}}}function matchColumn(e,p,d){var b=$("#tabletree").tree("getSelected");var f=b.attributes.link;if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var a=function(q){$("#dsColumn_div").dialog({title:b.attributes.name+" - 对应的输入字段",width:400,height:300,closed:false,cache:false,modal:true,toolbar:null,content:q,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var t=$('#dsColumn_div input[name="columnId"]:checked').val();if(!t||t==null){$.messager.alert("出错了","请至少选择一个字段！","error");return}var s=$("#tabletree").tree("getSelected");s.attributes.link=t;$("#tabletree").tree("update",{target:s.target,text:s.id+" -> Field"+(Number(t)+1)});$("#dsColumn_div").dialog("close")}},{text:"删除对应",iconCls:"icon-remove",handler:function(){var r=$("#tabletree").tree("getSelected");delete r.attributes.link;$("#tabletree").tree("update",{target:r.target,text:r.id});$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]})};var o="";var c="";if("db"==e){o=window.sqlEditor.getValue()}var h;var l;var g;var m=0;if(e=="csv"){l=$("#splitWord").combobox("getValue");h=$("#csvencode").combobox("getValue")}else{if(e=="hadoop"){g=$("#hdfsAddress").val();l=$("#splitWord").combobox("getValue")}else{m=Number($("#sheetIndex").val())}}var n="";__showLoading();$.ajax({type:"post",url:"showImpColumns.action",dataType:"json",contentType:"application/json",data:JSON.stringify({impType:e,path:p,hdfsAddress:g,encode:d,splitWord:l,sheetIndex:m,encode:h,nameinhead:"y",sql:o,dsource:(e=="db"?dsource:null)}),success:function(q){__hideLoading();if(q.result==1){q=q.rows;for(i=0;i<q.length;i++){n=n+'<div class="radio radio-info" style="margin-bottom:6px;"><input type="radio" id="c'+i+'" name="columnId" '+(f&&Number(f)==i?"checked":"")+' value="'+i+'"><label for="c'+i+'">'+b.attributes.name+" -> Field"+(i+1)+"  (<span style='color:#cccccc;'>"+q[i].name+"</span>)</label></div>"}a(n)}else{$.messager.alert("出错了","错误信息："+q.msg,"error")}},error:function(){__hideLoading();$.messager.alert("出错了","执行错误，请先测试您的sql/csv/excel/hdfs文件是否正确。","error");n=""}})}function resumeConfig(e,d,f,c,h,b,a){if(d&&d!=""){dsource.linkType=d}if(f&&f!=""){dsource.ipAddress=f}if(c&&c!=""){dsource.ipPort=c}if(h&&h!=""){dsource.database=h}if(b&&b!=""){dsource.uname=b}if(a&&a!=""){dsource.psd=a}var g=e.sql;if(window.sqlEditor){window.sqlEditor.setValue(g)}$("#impType").val(e.impType);$("#targettableid").val(e.targettableid);$("#targettable").val(e.targettable);if(e.datelabel&&e.datelabel.length>0){$("#datelabel").attr("key",e.datelabel).text(e.datelabel)}if(e.truncate){$("input[name='truncate']:checkbox").attr("checked","checked")}if(e.nameinhead){$("input[name='nameinhead']:checkbox").attr("checked","checked")}if(e.csvencode){$("#csvencode").combobox("setValue",e.csvencode)}if(e.splitWord){$("#splitWord").combobox("setValue",e.splitWord)}if(e.sheetIndex){$("#sheetIndex").val(e.sheetIndex)}if(e.hdfsAddress){$("#hdfsAddress").val(e.hdfsAddress)}if(e.path){$("#path").val(e.path)}getTableColumns(e.targettableid,e.cols)}function savecfg(){var f=$("#cfgid").val();if(f==""){var d=$("#targettableid").val();var a={impid:"t"+d,dsource:($("#impType").val()=="db"?dsource:""),impType:$("#impType").val(),sql:window.sqlEditor?window.sqlEditor.getValue():"",targettableid:$("#targettableid").val(),targettable:$("#targettable").val(),truncate:($("input[name='truncate']:checkbox:checked").size()>0?true:false),datelabel:$("#datelabel").attr("key"),cols:[]};if(a.impType=="csv"){a.csvencode=$("#csvencode").combobox("getValue");a.splitWord=$("#splitWord").combobox("getValue");a.filepath=$("#filepath").val();a.nameinhead=$("input[name='nameinhead']:checkbox:checked").size()>0?true:false}if(a.impType=="xls"){a.filepath=$("#filepath").val();a.nameinhead=$("input[name='nameinhead']:checkbox:checked").size()>0?true:false;a.sheetIndex=Number($("#sheetIndex").val())}if(a.impType=="hadoop"){a.hdfsAddress=$("#hdfsAddress").val();a.path=$("#path").val()}try{var h=$("#tabletree").tree("getRoots");for(i=0;h&&h!=null&&i<h.length;i++){var l=h[i].attributes.link;var c=h[i].attributes.type;var b=h[i].id;a.cols.push({col:b,type:c,link:l})}}catch(g){}$.messager.prompt("保存配置","请输入配置名称：",function(e){if(e){$.ajax({type:"POST",url:"saveCfg.action",contentType:"application/json",data:JSON.stringify({cfgContent:JSON.stringify(a),cfgName:e,impType:$("#impType").val(),fileId:$("#fileId").val()}),dataType:"json",success:function(m){$("#cfgid").val(m.rows);$.messager.alert("提示信息","保存配置成功！","info")}})}})}else{var d=$("#targettableid").val();var a={cfgid:f,impid:"t"+d,dsource:($("#impType").val()=="db"?dsource:""),impType:$("#impType").val(),sql:window.sqlEditor?window.sqlEditor.getValue():"",targettableid:$("#targettableid").val(),targettable:$("#targettable").val(),truncate:($("input[name='truncate']:checkbox:checked").size()>0?true:false),datelabel:$("#datelabel").attr("key"),cols:[]};if(a.impType=="csv"){a.csvencode=$("#csvencode").combobox("getValue");a.splitWord=$("#splitWord").combobox("getValue");a.filepath=$("#filepath").val();a.nameinhead=$("input[name='nameinhead']:checkbox:checked").size()>0?true:false}if(a.impType=="xls"){a.filepath=$("#filepath").val();a.nameinhead=$("input[name='nameinhead']:checkbox:checked").size()>0?true:false;a.sheetIndex=Number($("#sheetIndex").val())}var h=$("#tabletree").tree("getRoots");for(i=0;h&&h!=null&&i<h.length;i++){var l=h[i].attributes.link;var c=h[i].attributes.type;var b=h[i].id;a.cols.push({col:b,type:c,link:l})}if(a.impType=="hadoop"){a.hdfsAddress=$("#hdfsAddress").val();a.path=$("#path").val()}$.ajax({type:"POST",url:"updateCfg.action",contentType:"application/json",dataType:"json",data:JSON.stringify({cfgContent:JSON.stringify(a),cfgid:f,fileId:$("#fileId").val()}),success:function(e){$.messager.alert("提示信息","更新配置成功！","info")}})}}function startimp(){var n=$("#targettableid").val();if(n==""){$.messager.alert("出错了","您还未选择数据导入的目标表。","error");return}var b=$("#targettable").val();var l=$("#tabletree").tree("getRoots");if(l==null||l.length==0){$.messager.alert("出错了","您还未选择数据导入的目标表。","error");return}var f=false;for(i=0;i<l.length;i++){var m=l[i].attributes.link;if(m){f=true;break}}if(f==false){$.messager.alert("出错了","目标表字段未关联到输入字段！","error");return}var r=$("#impType").val();var c;var s;var d;var h=0;var p=$("#filepath").val();if(r=="csv"){c=$("#csvencode").combobox("getValue");s=$("#splitWord").combobox("getValue")}else{if(r=="xls"){h=$("#sheetIndex").val();h=Number($("#sheetIndex").val())}else{if(r=="hadoop"){d=$("#hdfsAddress").val();s=$("#splitWord").combobox("getValue");p=$("#path").val()}}}var q=$("#nameinhead").prop("checked");if(q){q="y"}else{q="n"}var o;var t="";if(r=="db"){o=dsource;t=window.sqlEditor.getValue()}var a=($("input[name='truncate']:checkbox:checked").size()>0?true:false);var u={impid:"t"+n,impType:r,targettableid:n,hdfsAddress:d,targettable:b,sheetIndex:h,encode:c,splitWord:s,path:p,nameinhead:q,truncate:a,cols:[],dsource:o,sql:t,datelabel:$("#datelabel").attr("key")};for(i=0;i<l.length;i++){var m=l[i].attributes.link;var e=l[i].attributes.type;var g=l[i].id;u.cols.push({col:g,type:e,link:m})}if(confirm("是否确认？")){showProcPanel(u.impid,true);$.ajax({type:"post",url:"runDataLoad.action",contentType:"application/json",dataType:"JSON",data:JSON.stringify(u),success:function(v){closeProcPanel();if(v.result==1){$.messager.alert("提示信息",v.rows+"条数据导入成功。","info",function(){})}else{$.messager.alert("出错了。",v.msg,"error")}},error:function(){closeProcPanel();$.messager.alert("出错了。","输入导入出错，请联系管理员。","error")}})}}function query_data(){var b=$("#targettableid").val();if(b==""){$.messager.alert("出错了。","请先导入数据，再分析数据。","error");return}var a='<iframe id="detailinfo" width="100%" height="100%" src="../detail/Report.action?tableId='+b+'" frameborder="0"></iframe>';$("#pdailog").dialog({title:"分析数据",top:0,left:0,fit:true,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"关闭",iconCls:"icon-ok",handler:function(){$("#pdailog").dialog("close")}}]})}function setsjc(){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var b='<div style="margin:3px;">';var e=window.sqlEditor.getValue();var d;var c=$("#datelabel").attr("key");__showLoading();$.ajax({type:"post",url:"showImpColumns.action",dataType:"json",async:false,contentType:"application/json",data:JSON.stringify({impType:"db",sql:e,dsource:dsource}),success:function(f){__hideLoading();d=f.rows},error:function(){__hideLoading();$.messager.alert("出错了","SQL执行错误，请检查您填写的查询SQL.","error")}});if(!d){return}var a=false;for(i=0;i<d.length;i++){if(d[i].type=="Date"||d[i].type=="Datetime"){b=b+'<div class="radio radio-info" style="margin-bottom:6px;"><input type="radio" id="dl'+d[i].name+'" '+(c&&c==d[i].name?"checked":"")+' name="datelabel" value="'+d[i].name+"\"><label for='dl"+d[i].name+"'>"+d[i].name+"</label></div>";a=true}}b=b+"</div>";if(a==false){$.messager.alert("出错了","输入数据无时间类型字段，不能设置时间戳.","error");return}$("#dsColumn_div").dialog({title:"选择时间戳字段",width:280,height:220,closed:false,cache:false,modal:true,toolbar:null,content:b,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var f=$('#dsColumn_div input[name="datelabel"]:checked').val();if(!f||f==null){$.messager.alert("出错了。","请至少选择一个字段！","error");return}$("#datelabel").attr("key",f).text(f);$("#dsColumn_div").dialog("close")}},{text:"删除时间戳",handler:function(){$("#datelabel").attr("key","").text("未设置");$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function viewjobs(b){var f="";$.ajax({type:"POST",data:{id:b},dataType:"Json",async:false,url:"getJob.action",success:function(o){job=o}});for(k=0;job.nodes&&k<job.nodes.length;k++){var d=job.nodes[k];if(k!=0){f=f+'<div class="jobline"></div>'}var m=fmttpname(d.type);f=f+'<button type="button" style="width:200px;" class="btn btn-w-m btn-default">'+(m)+"-"+d.name+"</button>"}var g=job.hour;var e=job.minute;var c=job.week;var l=job.day;var h=job.period=="day"?"每天":(job.period=="week"?"每周":(job.period=="hour"?"每小时":"每月"));var n='<div id="jobstabs"><div title="基本信息"><div class="textpanel"><span class="inputtext">任务名称：</span>'+(job?job.name:"")+'<br/><span class="inputtext">执行周期：</span>'+h+'<div id="hourdiv" class="periodstyle"><span class="inputtext"></span>间隔'+job.hourstep+'小时</div><div id="weekdiv" class="periodstyle"><span class="inputtext"></span>星期'+c+'</div><div id="daydiv" class="periodstyle"><span class="inputtext"></span>'+l+'号</div><div id="timediv" class="periodstyle"><span class="inputtext"></span>'+g+"点："+e+'分</div><br/></div></div><div title="执行流程"><div class="textpanel" align="center">'+f+"</div></div></div>";$("#pdailog").dialog({title:"任务查看",width:580,height:400,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:n,buttons:[{text:"关闭",iconCls:"icon-ok",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #jobstabs").tabs({fit:true,border:false,tabPosition:"left"});var a=function(o){if(o=="day"){$("#pdailog #weekdiv").hide();$("#pdailog #daydiv").hide();$("#pdailog #hourdiv").hide();$("#pdailog #timediv").show()}else{if(o=="month"){$("#pdailog #weekdiv").hide();$("#pdailog #hourdiv").hide();$("#pdailog #daydiv").show();$("#pdailog #timediv").show()}else{if(o=="week"){$("#pdailog #weekdiv").show();$("#pdailog #daydiv").hide();$("#pdailog #hourdiv").hide();$("#pdailog #timediv").show()}else{if(o=="hour"){$("#pdailog #weekdiv").hide();$("#pdailog #daydiv").hide();$("#pdailog #hourdiv").show();$("#pdailog #timediv").hide()}else{$("#pdailog #weekdiv").hide();$("#pdailog #daydiv").hide();$("#pdailog #hourdiv").hide();$("#pdailog #timediv").hide()}}}}};a(job.period)}function savejobs(q,c){var g="";var e;if(q){$.ajax({type:"POST",data:{id:c},dataType:"Json",async:false,url:"getJob.action",success:function(o){e=o}});for(k=0;e.nodes&&k<e.nodes.length;k++){var d=e.nodes[k];if(k!=0){g=g+'<div class="jobline"></div>'}var n=fmttpname(d.type);g=g+'<div class="oneproc" oid="'+d.id+'" oname="'+d.name+'" otype="'+d.type+'"><button style="width:200px;" class="btn btn-w-m btn-default" type="button">'+(n)+"-"+d.name+'</button><button class="btn btn-default btn-circle" onclick="removenode(\''+d.id+'\')"><i href="javascript:;" class="fa fa-times"></i></button></div>'}}var h="";for(i=0;i<=23;i++){h=h+'<option value="'+i+'" '+(e&&e.hour==i?"selected":"")+">"+i+"</option>"}var f="";for(i=0;i<60;i++){f=f+'<option value="'+i+'" '+(e&&e.minute==i?"selected":"")+">"+i+"</option>"}var b="";for(i=0;i<=6;i++){b=b+'<option value="'+(i+1)+'" '+(e&&e.week==(i+1)?"selected":"")+">"+(i==0?"日":i)+"</option>"}var l="";for(i=1;i<=31;i++){l=l+'<option value="'+i+'" '+(e&&e.day==i?"selected":"")+">"+i+"</option>"}var m="";for(i=1;i<=24;i++){m=m+'<option value="'+i+'" '+(e&&e.hourstep==i?"selected":"")+">"+i+"</option>"}var p='<div id="jobstabs"><div title="基本信息"><div class="textpanel"><span class="inputtext">任务名称：</span><input type="text" id="name" name="name" class="inputform" value="'+(e?e.name:"")+'"><br/><span class="inputtext">执行周期：</span><select id="period" name="period" class="inputform"><option value=""></option><option value="hour" '+(e&&e.period=="hour"?"selected":"")+'>每小时</option><option value="day" '+(e&&e.period=="day"?"selected":"")+'>每天</option><option value="week" '+(e&&e.period=="week"?"selected":"")+'>每周</option><option value="month" '+(e&&e.period=="month"?"selected":"")+'>每月</option></select><div id="hourdiv" class="periodstyle"><span class="inputtext"></span>间隔<select id="hourstep" name="hourstep">'+m+'</select>小时</div><div id="weekdiv" class="periodstyle"><span class="inputtext"></span>星期<select id="week" name="week">'+b+'</select></div><div id="daydiv" class="periodstyle"><span class="inputtext"></span><select id="day" name="day">'+l+'</select>号</div><div id="timediv" class="periodstyle"><span class="inputtext"></span><select id="hour" name="hour">'+h+'</select>点：<select id="minute" name="minute">'+f+'</select>分</div><br/></div></div><div title="执行流程"><div class="textpanel" align="center"><div align="left"><a href="javascript:;" id="crtnode">添加节点</a></div><div id="lines">'+g+"</div></div></div></div>";$("#pdailog").dialog({title:q?"编辑任务":"创建任务",width:580,height:400,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:p,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var o=$("#pdailog #name").val();var r=$("#pdailog #lines div.oneproc");if(o==""){$("#pdailog #jobstabs").tabs("select",0);$.messager.alert("出错了","请录入任务名称。","error",function(){$("#pdailog #name").focus()});return}var w=$("#pdailog #period").val();if(w==""){$("#pdailog #jobstabs").tabs("select",0);$.messager.alert("出错了","请设置执行周期。","error",function(){$("#pdailog #period").focus()});return}if(r==null||r.size()==0){$("#pdailog #jobstabs").tabs("select",1);$.messager.alert("出错了","请创建任务执行流程。","error");return}var u=$("#pdailog #hour").val();var t=$("#pdailog #minute").val();var s=$("#pdailog #week").val();var x=$("#pdailog #day").val();var v=$("#pdailog #hourstep").val();var y=null;if(q){y=e;y.name=o;y.period=w;y.hour=u;y.minute=t;y.week=s;y.day=x;y.hourstep=v;y.nodes=[]}else{e={id:newGuid(),name:o,period:w,hour:u,minute:t,week:s,day:x,hourstep:v,state:1,nodes:[]}}r.each(function(z,A){e.nodes.push({name:$(A).attr("oname"),id:$(A).attr("oid"),type:$(A).attr("otype")})});if(q){$.ajax({type:"POST",data:{cfg:JSON.stringify(e),name:o,id:c},dataType:"json",url:"updateJob.action",success:function(z){$("#tablegrid").bootstrapTable("refresh",{t:Math.random()})}})}else{$.ajax({type:"POST",data:{cfg:JSON.stringify(e),state:1,name:o},dataType:"json",url:"saveJob.action",success:function(z){$("#tablegrid").bootstrapTable("refresh",{t:Math.random()})}})}$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #jobstabs").tabs({fit:true,border:false,tabPosition:"left"});$("#pdailog #crtnode").click(function(){var s=function(A,y){var x=false;var w=$("#pdailog #lines div.oneproc");for(k=0;k<w.size();k++){var z=$(w.get(k));if(z.attr("oid")==A&&z.attr("otype")==y){x=true;break}}return x};var r;$.ajax({type:"POST",data:{},dataType:"Json",async:false,url:"listJobsteps.action",success:function(w){r=w}});var u='<option value=""></option>';for(i=0;r&&i<r.length;i++){var t=r[i];if(s(t.cfgid,t.type)){continue}var o=fmttpname(t.type);u=u+'<option value="'+t.cfgname+","+t.cfgid+","+t.type+'">'+(o)+"-"+t.cfgname+"</option>"}var v='<div class="textpanel"><span class="inputtext">选择过程：</span><select id="nodename" name="nodename" class="inputform">'+u+"</select></div>";if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:"添加节点",width:320,height:160,closed:false,cache:false,modal:true,toolbar:null,content:v,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var x=$("#dsColumn_div #nodename").val();if(x==""){$.messager.alert("出错了","请选择需要添加的过程。","error");return}var z=x.split(",");var y=z[0];var B=z[1];var A=z[2];if($("#pdailog #lines button").size()>0){$("#pdailog #lines").append('<div class="jobline"></div>')}var w=fmttpname(A);$("#pdailog #lines").append('<div class="oneproc" oid="'+B+'" oname="'+y+'" otype="'+A+'"><button style="width:200px;" class="btn btn-w-m btn-default" type="button">'+(w)+"-"+y+'</button><button class="btn btn-default btn-circle" onclick="removenode(\''+B+'\')"><i href="javascript:;" class="fa fa-times"></i></button></div>');$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]})}).linkbutton({plain:false,iconCls:"icon-add"});var a=function(o){if(o=="day"){$("#pdailog #weekdiv").hide();$("#pdailog #daydiv").hide();$("#pdailog #hourdiv").hide();$("#pdailog #timediv").show()}else{if(o=="month"){$("#pdailog #weekdiv").hide();$("#pdailog #hourdiv").hide();$("#pdailog #daydiv").show();$("#pdailog #timediv").show()}else{if(o=="week"){$("#pdailog #weekdiv").show();$("#pdailog #hourdiv").hide();$("#pdailog #daydiv").hide();$("#pdailog #timediv").show()}else{if(o=="hour"){$("#pdailog #weekdiv").hide();$("#pdailog #daydiv").hide();$("#pdailog #hourdiv").show();$("#pdailog #timediv").hide()}else{$("#pdailog #weekdiv").hide();$("#pdailog #hourdiv").hide();$("#pdailog #daydiv").hide();$("#pdailog #timediv").hide()}}}}};$("#pdailog #period").change(function(){var o=$(this).val();a(o)});if(q){a(e.period)}else{a("")}}function removenode(c){if(confirm("是否确认删除？")==false){return}var b=$("#pdailog div[oid='"+c+"']");var a=false;if(b.prev().size()>0&&b.prev().hasClass("jobline")){b.prev().remove();a=true}if(a==false){if(b.next().size()>0&&b.next().hasClass("jobline")){b.next().remove();a=true}}b.remove()}function newGuid(){var a="";for(var b=1;b<=32;b++){var c=Math.floor(Math.random()*16).toString(16);a+=c}return a}function showProcPanel(b,c){var a='<div align="center" style="margin:10px;"><img src=\'../ext-res/image/large-loading.gif\'></div><div align="center">任务进行中，请稍后...'+(c?'已导入<span id="loaddatacnt">0/0</span>条数据。':"")+"</div>";$("#pdailog").dialog({title:"",width:440,height:160,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"取消任务",handler:function(){closeProcPanel();$.ajax({type:"GET",url:"stopLoad.action",dataType:"json",data:{impid:b},success:function(){}})}}]});if(c){window.inter=window.setInterval(function(){$.ajax({type:"get",url:"getLoadState.action",dataType:"json",data:{impid:b,t:Math.random()},success:function(d){$("#loaddatacnt").text(d.rows.curCnt+"/"+d.rows.cnt)}})},1500)}}function closeProcPanel(){$("#pdailog").dialog("close");if(window.inter){window.clearInterval(window.inter)}}function testconn(){var e=$("#ff").form("enableValidation").form("validate");if(e==false){$.messager.alert("出错了","请录入必要的信息。","error");return}var d=$("#linktype").val();var g=$("#ipaddress").val();var c=$("#port").val();var h=$("#dbname").val();var b=$("#uname").val();var a=$("#psd").val();var f={linkType:d,ipAddress:g,ipPort:c,database:h,uname:b,psd:a};__showLoading();$.ajax({type:"post",url:"testDataSource.action",dataType:"json",data:f,success:function(l){__hideLoading();if(l.result==1){$.messager.alert("提示信息","测试成功！","info");$("#connstate").val("y")}else{$.messager.alert("失败了","<br/>"+decodeURIComponent(l.msg).replace(/\+/g," "),"error")}},error:function(){__hideLoading()}})}function selectconn(){var a='<table id="connlist" title="" ><thead><tr><th data-options="field:\'ck\',checkbox:true"><th data-options="field:\'name\',width:80">名称</th><th data-options="field:\'linkType\',width:80">数据库类型</th><th data-options="field:\'ipAddress\',width:100">地址</th><th data-options="field:\'ipPort\',width:60">端口</th><th data-options="field:\'database\',width:100">数据库</th><th data-options="field:\'uname\',width:60">用户名</th></tr></thead></table>';$("#pdailog").dialog({title:"选择已有连接",width:530,height:340,closed:false,cache:false,modal:true,toolbar:[{text:"删除",iconCls:"icon-remove",handler:function(){var b=$("#connlist").datagrid("getSelected");if(b==null){$.messager.alert("提示信息","请勾选数据！","error");return}if(confirm("是否确认删除？")){$.ajax({type:"post",url:"deleteDataSource.action",dataType:"json",data:{id:b.id},success:function(){$("#connlist").datagrid("load",{t:Math.random()})}})}}}],content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var b=$("#connlist").datagrid("getSelected");if(b==null){$.messager.alert("提示信息","请勾选数据！","error");return}$("#linktype").val(b.linkType);$("#ipaddress").textbox("setValue",b.ipAddress);$("#port").textbox("setValue",b.ipPort);$("#dbname").textbox("setValue",b.database);$("#uname").textbox("setValue",b.uname);$("#psd").textbox("setValue",b.psd);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#connlist").datagrid({singleSelect:true,collapsible:false,pagination:false,fit:true,border:false,url:"listDataSource.action",method:"post",queryParams:{t:Math.random()}})}function saveconn(){var a=$("#connstate").val();if("y"!=a){$.messager.alert("提示信息","请先测试连接，再保存信息！","error");return}$.messager.prompt("连接保存","请输入连接名称？",function(h){if(h){var e=h;var d=$("#linktype").val();var f=$("#ipaddress").val();var l=$("#port").val();var g=$("#dbname").val();var c=$("#uname").val();var b=$("#psd").val();$.ajax({type:"post",url:"saveDataSource.action",dataType:"json",data:{name:e,linkType:d,ipAddress:f,ipPort:l,database:g,uname:c,psd:b},success:function(){$.messager.alert("提示信息","连接保存成功！","info")}})}})}function nextpage(){var a=$("#connstate").val();if("y"!=a){$.messager.alert("提示信息","请先测试连接，成功后再进行下一步！","error");return}$("#ff").submit()}function testsql(){var a=window.sqlEditor.getValue();if(a==""){$.messager.alert("提示信息","请输入正确的sql语句！","error",function(){});return}viewdata()}function deltable(){var a=$("#tablegrid").bootstrapTable("getSelections");if(a.length==0){$.messager.alert("出错了","请先选择数据。","error");return}a=a[0];if(confirm("是否确认删除？")){$.ajax({type:"post",url:"delTable.action",dataType:"json",data:{tableId:a.tableId},success:function(){$("#tablegrid").bootstrapTable("refresh",{t:Math.random()})},error:function(){$.messager.alert("出错了。","删除数据出错，请联系管理员。","error")}})}}function chgcolumntype(){var a=$("#dsColumn_div #coltype").val();if(a=="Date"||a=="Datetime"){$("#collength").val("");$("#collength").attr("readOnly","readOnly")}else{if(a=="String"){$("#collength").val("50")}else{if(a=="Double"){$("#collength").val("12")}else{if(a=="Int"){$("#collength").val("10")}}}}}function mxsearch(b){var d;if(b==1){d=$("#tablegrid").bootstrapTable("getSelections")}else{if(b==2){d=$("#tablegrid2").bootstrapTable("getSelections")}else{if(b==3){d=$("#tablegrid3").bootstrapTable("getSelections")}else{if(b==4){d=$("#tablegrid4").bootstrapTable("getSelections")}else{if(b==5){d=$("#tablegrid5").bootstrapTable("getSelections")}}}}}if(d.length==0){$.messager.alert("出错了。","您还未勾选数据。","error");return}d=d[0];var c=d.tableId;if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var a='<iframe id="detailinfo" width="100%" height="100%" src="../detail/Report.action?tableId='+c+'" frameborder="0"></iframe>';$("#dsColumn_div").dialog({title:"数据查询",fit:true,closed:false,cache:false,modal:true,toolbar:null,content:a,onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"关闭",iconCls:"icon-ok",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function fmtcolname(b,c,a){if(c.expression==null||c.expression==""){return b}else{return b+"<span style='color:#9A9696'>(表达式)</span>"}}function addColumn(g,b,d){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var a;if(d){$.ajax({type:"GET",url:"../etl/getTableColumn.action",async:false,dataType:"JSON",data:{tableId:b.tableId,colId:d},success:function(h){a=h.rows}})}var e=[{value:"String",text:"字符串"},{value:"Int",text:"整数"},{value:"Double",text:"小数"},{value:"Date",text:"日期"},{value:"Datetime",text:"时间"}];var f="<option value=''></option>";for(i=0;i<e.length;i++){f=f+"<option value='"+e[i].value+"' "+(a&&a.colType==e[i].value?"selected":"")+">"+e[i].text+"</option>"}var c="<div class='textpanel'><span class=\"inputtext\">字段名：</span><input type='text' id='colname' name='colname' class='inputform' value=\""+(a?a.colName:"")+'" '+(d?"readOnly":"")+" placeholder=\"添加后不能更改\"><br/><span class=\"inputtext\">字段类型：</span><select id='coltype' name='coltype' class='inputform' onchange='chgcolumntype()'>"+f+"</select><br/><span class=\"inputtext\">字段长度：</span><input type='text' id='collength' name='collength' class=\"inputform\" value=\""+(a?a.colLength:"")+"\"><br/><span class=\"inputtext\">精度(小数位)：</span><input type='text' id='colScale' name='colScale' class=\"inputform\" value=\""+(a&&a.colScale?a.colScale:"")+"\"><br/><span class=\"inputtext\">备注：</span><input type='text' id='note' name='note' class='inputform' value=\""+(a?(a.colNote==null?"":a.colNote):"")+'"></div>';$("#dsColumn_div").dialog({title:d?"编辑字段":"添加字段",width:420,height:250,closed:false,cache:false,modal:true,toolbar:null,content:c,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var m=$("#dsColumn_div #colname").val();var o=$("#dsColumn_div #coltype").val();var h=$("#dsColumn_div #collength").val();var n=$("#dsColumn_div #colScale").val();var l=$("#dsColumn_div #note").val();if(m==""){$.messager.alert("出错了","请录入字段名。","error",function(){$("#dsColumn_div #colname").focus()});return}if(containSpecial(m)){$.messager.alert("出错了","字段名包含特殊字符。","error",function(){$("#dsColumn_div #colname").focus()});return}if(o==""){$.messager.alert("出错了","请选择字段类型。","error",function(){$("#dsColumn_div #coltype").focus()});return}if(h==""&&o!="date"){$.messager.alert("出错了","请录入字段长度。","error",function(){$("#dsColumn_div #collength").focus()});return}__showLoading();if(d){$.ajax({type:"post",url:"updateTableColumn.action",dataType:"json",data:{tableId:g.tableId,tableName:b.tableName,colName:m,colType:o,colLength:h,colScale:n,colNote:l,colId:d},success:function(p){__hideLoading();if(p.result==1){$("#tablemeta").datagrid("load",{t:Math.random()})}else{$.messager.alert("出错了",p.msg,"error")}},error:function(){__hideLoading();$.messager.alert("出错了","系统出错，请查看后台日志。","error")}})}else{$.ajax({type:"post",url:"addTableColumn.action",dataType:"json",data:{tableId:g.tableId,tableName:b.tableName,colName:m,colType:o,colLength:h,colScale:n,colNote:l},success:function(p){__hideLoading();if(p.result==1){$("#tablemeta").datagrid("load",{t:Math.random()})}else{$.messager.alert("出错了",p.msg,"error")}},error:function(){__hideLoading();$.messager.alert("出错了","系统出错，请查看后台日志。","error")}})}$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function viewtable(b){var c;if(b==1){c=$("#tablegrid").bootstrapTable("getSelections")}else{if(b==2){c=$("#tablegrid2").bootstrapTable("getSelections")}else{if(b==3){c=$("#tablegrid3").bootstrapTable("getSelections")}else{if(b==4){c=$("#tablegrid4").bootstrapTable("getSelections")}else{if(b==5){c=$("#tablegrid5").bootstrapTable("getSelections")}}}}}if(c.length==0){$.messager.alert("出错了","请先选择数据。","error");return}c=c[0];var a=function(e){var g="";var h="<option value=''></option>";for(i=0;i<e.metaCols.length;i++){g=g+'<option value="'+e.metaCols[i].colName+"@"+e.metaCols[i].colType+'">'+e.metaCols[i].colName+"</option>";h=h+'<option value="'+e.metaCols[i].colName+'" '+(e.dataControlCol==e.metaCols[i].colName?"selected":"")+">"+e.metaCols[i].colName+"</option>"}var d="<div id='ntable'><div title='基本信息'><div class='textpanel'><span class=\"inputtext\">表名：</span>"+e.tableName+'<br/><span class="inputtext">中文名：</span><input type="text" class="inputform" value="'+e.tableNote+'" id="table_note"><br/><span class="inputtext">备注信息：</span><input type="text" class="inputform" value="'+(e.tableDesc==null?"":e.tableDesc)+'" id="desc"></div></div><div title=\'表字段\'><table id="tablemeta"><thead><tr><th data-options="field:\'x\',checkbox:true"></th><th data-options="field:\'colName\',width:110,align:\'left\',formatter:fmtcolname">字段名</th><th data-options="field:\'colType\',width:70,align:\'center\'">类型</th><th data-options="field:\'colLength\',width:60,align:\'center\'">长度</th><th data-options="field:\'colScale\',width:60,align:\'center\'">精度(小数位)</th><th data-options="field:\'expression\',width:140,align:\'center\'">表达式</th><th data-options="field:\'colNote\',width:100,align:\'center\'">备注</th></tr></thead></table></div><div title="数据权限"><div class="textpanel"><span class="inputtext">数据权限：</span><label><input type="radio" value="y" name="datacontrol" id="datacontrol1" '+(e.dataControlCol==null||e.dataControlCol==""?"":"checked")+'>启用</label> &nbsp; <label><input type="radio" value="n" name="datacontrol" id="datacontrol2" '+(e.dataControlCol==null||e.dataControlCol==""?"checked":"")+'>禁用</label><div id="datacontroldiv"><span class="inputtext">映射字段：</span><select class="inputform" id="dataControlCol">'+h+'</select><br/><p class="text-warning">(数据权限通过此字段过滤数据)</p></div></div></div><div title="数据预览" href=\'queryTableData.action?tableId='+e.tableId+"'></div></div>";$("#pdailog").dialog({title:"表信息查看",width:750,height:400,modal:true,content:d,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var o=$("#pdailog #table_note").val();var l=$("#pdailog #desc").val();var n=c.tableId;var m=$('input[name="datacontrol"]:checked').val();var p=$("#dataControlCol").val();__showLoading();$.ajax({type:"post",url:"updateTableInfo.action",dataType:"json",contentType:"application/json",data:JSON.stringify({tableId:n,tableNote:o,tableDesc:l,dataControlCol:m=="n"?"":p}),success:function(q){__hideLoading();if(b==1){$("#tablegrid").bootstrapTable("refresh")}else{if(b==2){$("#tablegrid2").bootstrapTable("refresh")}else{if(b==3){$("#tablegrid3").bootstrapTable("refresh")}else{if(b==4){$("#tablegrid4").bootstrapTable("refresh")}else{if(b==5){$("#tablegrid5").bootstrapTable("refresh")}}}}}},error:function(){__hideLoading()}});$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#ntable").tabs({fit:true,plain:false,border:false,tabPosition:"left"});var f=null;if(b==1){f=[{iconCls:"icon-add",text:"添加字段",handler:function(){addColumn(c,e)}},{iconCls:"icon-add2",text:"添加动态字段",handler:function(){createDyna(false,c.tableId)}},{iconCls:"icon-edit",text:"编辑字段",handler:function(){var l=$("#tablemeta").datagrid("getSelected");if(l==null){$.messager.alert("出错了","请先选择数据。","error");return}if(l.expression!=null){createDyna(true,c.tableId,l.colId)}else{addColumn(c,e,l.colId)}}},{iconCls:"icon-remove",text:"删除字段",handler:function(){var l=$("#tablemeta").datagrid("getSelected");if(l==null){$.messager.alert("出错了","请先选择数据。","error");return}dyna=l.expression==null||l.expression==""?"n":"y";if(confirm("是否确认删除？")){__showLoading();$.ajax({type:"post",url:"delTableColumn.action",dataType:"json",data:{tableId:e.tableId,colId:l.colId},success:function(m){__hideLoading();if(m.result==1){$("#tablemeta").datagrid("load",{t:Math.random()})}else{$.messager.alert("出错了",m.msg,"error")}}})}}}]}$("#tablemeta").datagrid({singleSelect:true,url:"getTableColumns.action?tableId="+c.tableId,toolbar:f,height:332});$("#pdailog input[name='datacontrol']:radio").click(function(){if($(this).val()=="y"){$("#datacontroldiv").show("fast")}else{$("#datacontroldiv").hide("fast")}});if(e.dataControlCol==null||e.dataControlCol==""){$("#datacontroldiv").hide()}else{$("#datacontroldiv").show()}};__showLoading();$.ajax({type:"POST",url:"getTableInfo.action",dataType:"json",data:{tableId:c.tableId},success:function(d){__hideLoading();a(d)}})}function createDyna(g,d,a){var f=d;var h;$.ajax({type:"GET",url:"../etl/getTableColumnsNotExpress.action",async:false,dataType:"JSON",data:{tableId:f},success:function(o){h=o}});var b;if(g){$.ajax({type:"GET",url:"../etl/getTableColumn.action",async:false,dataType:"JSON",data:{tableId:d,colId:a},success:function(o){b=o.rows}})}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var m='<div class="actColumn">';var e=h;for(i=0;i<e.length;i++){if(e[i].type!="String"){m=m+'<button class="btn btn-primary btn-xs" name="'+e[i].colName+'">'+e[i].colName+"</button> "}}var l="";var c=["String","Int","Double","Date","Datetime"];for(i=0;i<c.length;i++){l=l+'<option value="'+c[i]+'" '+(b&&b.colType==c[i]?"selected":"")+">"+c[i]+"</option>"}m=m+"</div>";var n='<div class="textpanel"><span class="inputtext">字段名：</span><input type="text" id="colname" name="colname" class="inputform" value="'+(b?b.colName:"")+'" '+(b?"readOnly":"")+' placeholder="添加后不能更改"><br/><span class="inputtext">备注：</span><input type="text" id="note" name="note" class="inputform" value="'+(b?b.colNote:"")+'"><br/><span class="inputtext">字段类型：</span><select id="ctype" name="ctype" class="inputform" value="">'+l+'</select><br/><table cellspacing="0" cellpadding="0"><tbody><tr><td valign="top"><span class="inputtext">表 达 式<a href=\'javascript:helpbdsinfo();\'> <i class=\'fa fa-question-circle\'></i></a>：</span></td><td><textarea name="expression" id="expression" cols="40" class="inputform" style="height:68px;line-height:18px;">'+(b?b.expression:"")+"</textarea></td><td valign='top'> <buttton class='btn btn-default btn-sm' style='margin-left:5px;' id=\"testDynacolBtn\">测试</button></td></tr></tbody></table>"+m+"</div>";$("#dsColumn_div").dialog({title:!g?"创建动态字段":"修改动态字段",width:440,height:320,closed:false,cache:false,modal:true,toolbar:null,content:n,onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var r=$("#colname").val();var q=$("#note").val();var s=$("#expression").val();var p=$("#ctype").val();if(r==""){$.messager.alert("出错了","字段名是必填项。","error",function(){$("#colname").focus()});return}if(ischinese(r)){$.messager.alert("出错了","字段名必须是英文字符。","error",function(){$("#colname").focus()});return}if(s==""){$.messager.alert("出错了","表达式是必填项。","error",function(){$("#expression").focus()});return}var o=function(){if(g){$.ajax({type:"POST",url:"../etl/updateTableDyna.action",dataType:"json",data:{tableId:f,colName:r,colNote:q,expression:s,colType:p,colId:b.colId},success:function(t){$("#dsColumn_div").dialog("close");$.getJSON("getTableColumns.action",{tableId:f},function(u){$("#tablemeta").datagrid("loadData",u)})}})}else{$.ajax({type:"POST",url:"../etl/createTableDyna.action",dataType:"json",data:{tableId:f,colName:r,colNote:q,expression:s,colType:p},success:function(t){$("#dsColumn_div").dialog("close");$.getJSON("getTableColumns.action",{tableId:f},function(u){$("#tablemeta").datagrid("loadData",u)})}})}};$.ajax({type:"POST",url:"../etl/testDynaColumn.action",dataType:"json",data:{expression:escape(s),tid:f,mustAgg:false},success:function(t){if(t.result==1){o()}else{$.messager.alert("表达式错误",t.msg,"error")}}})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#dsColumn_div .actColumn .btn").bind("click",function(){var o=$(this).attr("name");textSelect(document.getElementById("expression"),o+" ")});$("#testDynacolBtn").unbind("click").bind("click",function(){var o=$("#expression").val();if(o==""){$.messager.alert("出错了","请录入表达式。","error");return}$.ajax({type:"POST",url:"../etl/testDynaColumn.action",dataType:"json",data:{expression:escape(o),tid:f,mustAgg:false},success:function(p){if(p.result==1){$.messager.alert("成功了","表达式测试成功。","info")}else{$.messager.alert("出错了",p.msg,"error")}}})})}function textSelect(e,f){e.focus();if(document.selection){var d=document.selection.createRange();d.text=f}else{if(typeof e.selectionStart=="number"&&typeof e.selectionEnd=="number"){var c=e.selectionStart,b=e.selectionEnd,g=c,a=e.value;e.value=a.substring(0,c)+""+f+a.substring(b,a.length);g+=f.length;e.selectionStart=e.selectionEnd=g}else{e.value+=f}}}function helpbdsinfo(){openModelDailog("表达式说明","<div style='line-height:30px;'>表达式是一句SQL片段，用来提高系统灵活性。<li>通过表达式来对字段进行运算；</li>字段相加：<div class=\"mycode\"> a+ b</div><li>对字段进行case when 转换；</li><div class=\"mycode\">case when a=1 then '是' when a=2 then '否' else '未知' end</div><p class=\"text-warning\">请注意：此处表达式请勿使用sum/avg/max/min/count等聚合函数。<p></div>")}function fmttpname(b){var a="";if(b=="dataLoad"){a="导入"}else{if(b=="aggre"){a="关联"}else{if(b=="sql"){a="脚本"}else{if(b=="r2c"){a="行转列"}else{if(b=="es"){a="同步"}}}}}return a}function insertText2focus(a,b){b=b+" ";if(window.sqlEditor){window.sqlEditor.replaceSelection(b)}else{textSelect(a,b)}}function ischinese(b){if(/[\u4E00-\u9FA5]/i.test(b)){return true}else{return false}}function containSpecial(a){var b=RegExp(/[(\ )(\~)(\!)(\@)(\#)(\$)(\%)(\^)(\&)(\*)(\()(\))(\-)(\+)(\=)(\[)(\])(\{)(\})(\|)(\\)(\;)(\:)(\')(\")(\,)(\.)(\/)(\<)(\>)(\?)(\)]+/);return(b.test(a))}if($==undefined){$=jQuery}var dataType=["String","Int","Double","Date","Datetime"];function newtransform(n,a,f){var c={};var e="";var g="";if(n){$.ajax({type:"POST",async:false,url:"getTf.action",dataType:"json",data:{id:a},success:function(o){c=o}});e=e+"<li data-options=\"id:'"+c.master+"',iconCls:'icon-table'\"><span>"+c.master+"</span></li>";g=g+'<option value="'+c.master+'" selected>'+c.master+"</option>";var b=[];for(i=0;c.joininfo&&i<c.joininfo.length;i++){var l=c.joininfo[i].ref;if(b.indexOf(l)==-1){b.push(l);e=e+"<li data-options=\"id:'"+l+"',iconCls:'icon-table'\"><span>"+l+"</span></li>"}else{continue}}}var h='<div id="crtdataset"><div title="基本信息"><div class="textpanel"><span class="inputtext">步骤名称：</span><input type="text" id="name" name="name" value="'+(c.name?c.name:"")+'" class="inputform"><br/><span class="inputtext" style="width:120px;">选择表：</span><br/><div class="tablesleft"><div class="tabletitle">待选表</div><ul id="allTablesTree" style="height:270px; width:100%; overflow:auto"></ul></div><div class="tablescenter"><button type="button" id="left2right" style="margin-top:120px;" class="btn btn-success btn-circle"><i class="fa fa-chevron-right"></i></button><br/><br/><button type="button" id="right2left" class="btn btn-success btn-circle"><i class="fa fa-chevron-left"></i></button></div><div class="tablesright"><div class="tabletitle">已选表</div><ul id="selTablesTree" class="easyui-tree" style="height:270px; width:100%; overflow:auto">'+e+'</ul></div></div></div><div title="表关联"><div class="textpanel"><div style="float:right"><button type="button" class="btn btn-primary btn-xs" id="jointable">关联</button> <br/> <button type="button" id="unjointable" class="btn btn-primary btn-xs">取消</button></div><span class="inputtext">主表： </span><select id="mastertable" class="inputform" style="width:300px;" '+(n?"disabled":"")+">"+g+"</select>"+(n?"<font color='#999'>(禁止更改)</font>":"")+'<br/><ul class="easyui-tree" id="masterTableTree" style="margin-left:100px;border:1px solid #999; width:300px; height:320px; overflow:auto"></ul></div></div><div title="动态字段"></div><div title="数据聚合">'+buildCube(c)+'</div><div title="目标表"><div class="textpanel"><span class="inputtext">输出目标表：</span><input type="text" class="inputform" placeholder="英文字符" name="tartable" value="'+(c.tartable?c.tartable:"")+'" id="tartable" '+(n?"readOnly='true'":"")+">"+(n?"(表名不可更改)":"")+'<br/><span class="inputtext">目标表中文名：</span><input type="text" class="inputform" name="tartablename" value="'+(c.tartablename?c.tartablename:"")+'" id="tartablename"><br/><span class="inputtext">存储方式：</span> <label><input type="radio" name="savetype" value="view" '+(!c||!c.savetype||c.savetype=="view"?"checked":"")+'>视图</lable> &nbsp; <label><input type="radio" name="savetype" value="temptable" '+(c&&c.savetype=="temptable"?"checked":"")+'>临时表</label> &nbsp; <label><input type="radio" name="savetype" value="sql" '+(c&&c.savetype=="sql"?"checked":"")+">SQL片段</label></div></div>"+(n?'<div title="数据预览" href="queryTableData.action?tableId='+f+'"></div>':"")+"</div>";$("#pdailog").dialog({title:n?"编辑表关联":"创建表关联",width:680,height:450,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:h,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var o=$("#pdailog #name").val();var v=$("#pdailog #tartable").val();var s=$("#pdailog #tartablename").val();if(o==""){msginfo("请录入步骤名称。");$("#pdailog #crtdataset").tabs("select",0);$("#pdailog #name").focus();return}var u=$("#selTablesTree").tree("getChildren");if(u==null||u.length==0){msginfo("请选择需要进行转换的表。");$("#pdailog #crtdataset").tabs("select",0);return}if(u.length>1&&(!c.joininfo||c.joininfo.length==0)){msginfo("请建立表关联。");$("#pdailog #crtdataset").tabs("select",1);return}var t=$("#cuberighttree").tree("find","cubewd");var y=$("#cuberighttree").tree("getChildren",t.target);var A=$("#cuberighttree").tree("find","cubedl");var z=$("#cuberighttree").tree("getChildren",A.target);if(v==""){msginfo("请录入数据输出目标表。");$("#pdailog #crtdataset").tabs("select",4);$("#pdailog #tartable").focus();return}if(ischinese(v)){$("#pdailog #crtdataset").tabs("select",4);msginfo("目标表只能是英文字符。",function(){$("#pdailog #tartable").focus()});return}var p=/^[a-z|A-Z]/;var r=p.test(v);if(r==false){$("#pdailog #crtdataset").tabs("select",4);msginfo("目标表必须以字符开始。",function(){$("#pdailog #tartable").focus()});return}var q=$("#pdailog input[name='savetype']:checked").val();c.name=o;c.tartable=v;c.tartablename=s;c.savetype=q;c.dims=[];c.kpis=[];for(i=0;y!=null&&i<y.length;i++){var x=y[i].attributes;c.dims.push({tname:x.tname,col:x.col,alias:x.alias,expression:unescape(x.expression),vtype:x.vtype})}for(i=0;z!=null&&i<z.length;i++){var x=z[i].attributes;c.kpis.push({tname:x.tname,col:x.col,alias:x.alias,expression:unescape(x.expression),vtype:x.vtype,aggre:x.aggre})}var w;$.ajax({type:"POST",async:false,url:"tableExist.action",dataType:"json",data:{tableName:v},success:function(B){w=B},error:function(B){w=-1}});if(w==-1){$.messager.alert("出错了","网络错误。","error");return}if(!n&&Number(w)>=1){$.messager.alert("出错了","表名存在重复。","error",function(){$("#pdailog #crtdataset").tabs("select",4);$("#pdailog #tartable").focus()});return}__showLoading();$.ajax({type:"POST",async:false,url:n?"updateTf.action":"saveTf.action",dataType:"json",data:{cfg:JSON.stringify(c),primaryTable:c.master,targetTable:c.tartablename,name:c.name,id:a,tableMetaId:f,saveType:q},success:function(B){$("#cfglist1").bootstrapTable("refresh",{t:Math.random()});$("#pdailog").dialog("close");__hideLoading()},error:function(B){msginfo("系统出错，请联系管理员。");__hideLoading()}})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #crtdataset").tabs({fit:true,border:false,tabPosition:"left",onSelect:function(u,t){if(t==2){reloadDynamicCol(c)}if(t==3){var r="";var p=$("#selTablesTree").tree("getChildren");if(p!=null&&p.length>0){$.ajax({type:"post",url:"listDatasetColumns.action",dataType:"json",async:false,data:{transform:JSON.stringify(c)},success:function(D){if(D.result==0){msginfo("系统出错:"+D.msg);return}var B=D.rows;r=r+"<li data-options=\"iconCls:'icon-table'\"><span>"+c.master+"</span><ul>";for(i=0;i<B.length;i++){if(B[i].tname==c.master){r=r+"<li data-options=\"id:'"+B[i].tname+B[i].name+"',iconCls:'icon-dscol',attributes:{tp:'node', tname:'"+B[i].tname+"', vtype:'"+B[i].type+"', col:'"+B[i].name+"', dyna:false}\"><span>"+B[i].name+"</span></li>"}}r=r+"</ul></li>";var A=function(F){var E=[];for(k=0;k<B.length;k++){if(B[k].tname==F){E.push(B[k])}}return E};var x=[];for(i=0;c.joininfo&&i<c.joininfo.length;i++){var z=c.joininfo[i].ref;if(x.indexOf(z)==-1){x.push(z)}}for(i=0;i<x.length;i++){r=r+"<li data-options=\"iconCls:'icon-table'\"><span>"+x[i]+"</span><ul>";var y=A(x[i]);for(j=0;j<y.length;j++){var C=y[j];r=r+"<li data-options=\"id:'"+C.tname+C.name+"',iconCls:'icon-dscol',attributes:{tp:'node', tname:'"+C.tname+"', vtype:'"+C.type+"', col:'"+C.name+"', dyna:false}\"><span>"+C.name+"</span></li>"}r=r+"</ul></li>"}r=r+"<li data-options=\"iconCls:'icon-table'\"><span>动态字段</span><ul>";for(i=0;c.dynamic&&i<c.dynamic.length;i++){var z=c.dynamic[i];r=r+"<li data-options=\"id:'"+z.tname+z.name+"',iconCls:'icon-dscol',attributes:{tp:'node', tname:'"+z.tname+"', vtype:'"+z.type+"', col:'"+z.name+"', expression:'"+escape(z.expression)+"', dyna:true}\"><span>"+z.name+"</span></li>"}r=r+"</ul></li>"}})}var q="<li data-options=\"iconCls:'icon-dataset2',attributes:{tp:'root'}\"><span>表字段</span><ul>"+r+"</ul></li>";$("#pdailog div.cubeleft #cubelefttree").remove();$("#pdailog div.cubeleft").append('<ul id="cubelefttree">'+q+"</ul>");$("#pdailog #cubelefttree").tree({});var w=$("#pdailog #cubelefttree").tree("getChildren");var v=$("#pdailog #cuberighttree").tree("getChildren");var s=function(y){var x=false;for(k=0;k<v.length;k++){if(v[k].id&&v[k].id==y){x=true;break}}return x};for(j=0;j<w.length;j++){var o=w[j].id;if(o&&s(o)){$(w[j].target).attr("hide","y").hide()}}}}});var m=function(o){$.ajax({type:"post",url:"listTables.action",dataType:"json",data:{},success:function(v){var s=[];for(q=0;q<v.length;q++){var r=v[q];s.push({id:r.tableName,text:r.tableName,attributes:{id:r.tableId+"",note:r.tableNote},iconCls:"icon-table"})}$("#allTablesTree").tree({data:s});if(n){var p=$("#allTablesTree").tree("find",c.master);$(p.target).attr("hide","y").hide();for(k=0;c.joininfo&&k<c.joininfo.length;k++){var q=c.joininfo[k];var u=$("#allTablesTree").tree("find",q.ref);$(u.target).attr("hide","y").hide()}}}})};m();$("#pdailog #left2right").bind("click",function(){var o=$("#allTablesTree").tree("getSelected");if(o==null||$(o.target).attr("hide")=="y"){msginfo("请先从左边选择表。");return}$("#selTablesTree").tree("append",{parent:null,data:[{id:o.id,text:o.text,iconCls:o.iconCls}]});$(o.target).attr("hide","y").hide();var q=document.getElementById("mastertable");var p=q.selectedIndex;q.options.add(new Option(o.text,o.id));if(p==-1){d(o.text);c.master=o.id;c.tid=o.attributes.id}});$("#pdailog #right2left").bind("click",function(){var q=$("#selTablesTree").tree("getSelected");if(q==null){msginfo("您还未选择需要移除的表。");return}if(n&&q.id==c.master){msginfo("不能移除主表。");return}var p=$("#allTablesTree").tree("getChildren");for(i=0;i<p.length;i++){if(p[i].id==q.id){$(p[i].target).attr("hide","n").show();break}}$("#selTablesTree").tree("remove",q.target);if(!n){var s=document.getElementById("mastertable");var r=s.selectedIndex;var o=0;for(i=0;i<s.options.length;i++){if(s.options[i].value==q.id){o=i;break}}s.options.remove(o);if(r==o){d(s.options[s.selectedIndex].value);c.master=s.options[s.selectedIndex].value}}});$("#unjointable").bind("click",function(){var p=$("#masterTableTree").tree("getSelected");if(p==null){msginfo("您还未从主表字段中选择需要删除关联的字段。");return}delete p.attributes.ref;delete p.attributes.refKey;$("#masterTableTree").tree("update",{target:p.target,text:p.id,iconCls:"icon-dscol"});var o=-1;for(j=0;j<c.joininfo.length;j++){if(c.joininfo[j].col==p.id){o=j}}c.joininfo.splice(o,1)});$("#pdailog #jointable").click(function(){jointableFunc(c)});var d=function(o){$.ajax({type:"post",url:"listTableColumns.action",dataType:"json",data:{tname:o},success:function(q){var s=[];for(k=0;k<q.length;k++){var r={id:q[k].id,text:q[k].text,iconCls:"icon-dscol",attributes:{name:q[k].name}};if(n){var p=findJoinInfoById(c,q[k].name);if(p!=null){r.iconCls="icon-coljoin";r.attributes.ref=p.ref;r.attributes.refKey=p.refKey;r.attributes.tid=p.tid;r.text=q[k].name+" -> "+p.ref+"."+p.refKey}}s.push(r)}$("#masterTableTree").tree({data:s,onDblClick:function(t){jointableFunc(c)}})}})};$("#mastertable").bind("change",function(){d($(this).val());c.master=$(this).val();var o=$("#allTablesTree").tree("getRoots");for(k=0;k<o.length;k++){if(o[k].id==c.master){c.tid=o[k].attributes.id;break}}});if(n){d(c.master)}$("#cuberighttree").tree({onDblClick:function(){editDimorKpi()}});$("#editdimkpi").click(function(){editDimorKpi()}).linkbutton({});$("#deldimkpi").click(function(){cube2ds()}).linkbutton({})}function buildCube(b){var h='<div class="textpanel" style="">';var e="";var a="";var g="";var c="";if(b.dims&&b.dims.length>0){g=g+"<ul>";for(i=0;i<b.dims.length;i++){var f=b.dims[i];g=g+"<li data-options=\"id:'"+f.tname+f.col+"',iconCls:'icon-dim',attributes:{tp:'dim',drag:true,col:'"+f.col+"',tname:'"+f.tname+"',expression:'"+(f.expression?escape(f.expression):"")+"',vtype:'"+f.vtype+"', alias:'"+(f.alias?f.alias:"")+"'}\"><span>"+f.tname+"."+f.col+"</span></li>"}g=g+"</ul>"}if(b.kpis&&b.kpis.length>0){c=c+"<ul>";for(i=0;i<b.kpis.length;i++){var f=b.kpis[i];c=c+"<li data-options=\"id:'"+f.tname+f.col+"',iconCls:'icon-kpi',attributes:{tp:'kpi',drag:true,col:'"+f.col+"',tname:'"+f.tname+"',expression:'"+(f.expression?escape(f.expression):"")+"',vtype:'"+f.vtype+"', aggre:'"+f.aggre+"', alias:'"+(f.alias?f.alias:"")+"'}\"><span>"+f.aggre+"("+f.tname+"."+f.col+")</span></li>"}c=c+"</ul>"}a=a+"<ul id=\"cuberighttree\"><li data-options=\"iconCls:'icon-cube'\"><span>数据立方体</span><ul><li data-options=\"iconCls:'icon-dim',id:'cubewd'\"><span>维度</span>"+g+"</li><li data-options=\"iconCls:'icon-kpi',id:'cubedl'\"><span>度量</span>"+c+"</li></ul></li></ul>";h=h+'<div class="cubeleft"><div class="cubetitle">待选数据字段：</div></div><div class="cubecenter"><p style="height:120px;"></p><button onclick="ds2cube()" class="btn btn-success btn-circle"><i class="fa fa-chevron-right"></i></button><br/><br/><button onclick="cube2ds()" class="btn btn-success btn-circle"><i class="fa fa-chevron-left"></i></button></div><div class="cuberight"><div class="cubetitle">聚合后字段：</div>'+a+'</div><div style="width:56px;" class="cubecenter"><a href="javascript:;" id="editdimkpi" data-options="iconCls:\'icon-edit\',plain:true">编辑</a><br/><a href="javascript:;" id="deldimkpi" data-options="iconCls:\'icon-cancel\',plain:true">删除</a></div>';h=h+"</div>";return h}function editDimorKpi(){var e=$("#cuberighttree").tree("getSelected");if(e==null||!e.attributes){msginfo("请选择需要编辑的维度或指标。");return}var b=e.attributes;var d=["sum","avg","count","max","min"];var c="";for(i=0;i<d.length;i++){c=c+'<option value="'+d[i]+'" '+(b&&d[i]==b.aggre?"selected":"")+">"+d[i]+"</option>"}var a='<div class="textpanel"><span class="inputtext">字段名：</span>'+b.col+'<br/><span class="inputtext">所属表：</span>'+b.tname+'<br/><span class="inputtext">类型：</span>'+(b.tp=="dim"?"维度":"度量")+'<br/><span class="inputtext">别名：</span><input type="text" value="'+(b.alias?b.alias:"")+'" class="inputform2" name="alias" id="alias"><br/>'+(b.tp=="kpi"?('<span class="inputtext">计算方式：</span><select id="kpiaggre" name="kpiaggre" class="inputform2">'+c+"</select><br/>"):"")+"</div>";if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:"编辑字段",width:360,height:240,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var f=$("#dsColumn_div #alias").val();if(f!=""&&ischinese(f)){msginfo("别名只能是英文字符。");$("#dsColumn_div #alias").select();return}var g=$("#dsColumn_div #kpiaggre").val();e.attributes.alias=f;if(e.attributes.tp=="kpi"){e.attributes.aggre=g;$("#cuberighttree").tree("update",{target:e.target,text:g+"("+e.attributes.tname+"."+e.attributes.col+")"})}$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function ds2cube(){var c=$("#cubelefttree").tree("getSelected");if(c==null||!c.attributes){msginfo("您还未从左边选择字段。");return}if($(c.target).attr("hide")=="y"){return}var a=$("#cuberighttree").tree("getSelected");if(a==null){msginfo("您还未选择右边度量或维度。");return}var b=$("#cuberighttree").tree("getParent",a.target);if(a.text=="度量"||b.text=="度量"){var e=c.id;var d={id:e,text:"sum("+c.attributes.tname+"."+c.text+")",attributes:{tp:"kpi",drag:true,aggre:"sum",col:c.attributes.col,tname:c.attributes.tname,vtype:c.attributes.vtype,expression:c.attributes.expression?c.attributes.expression:""},iconCls:"icon-kpi"};if(a.text=="度量"){$("#cuberighttree").tree("append",{parent:a.target,data:d})}else{$("#cuberighttree").tree("insert",{after:a.target,data:d})}$(c.target).attr("hide","y").hide()}else{if(a.text=="维度"||b.text=="维度"||b.attributes.tp=="group"){var e=c.id;var d={id:e,text:c.attributes.tname+"."+c.text,attributes:{tp:"dim",drag:true,col:c.attributes.col,tname:c.attributes.tname,vtype:c.attributes.vtype,expression:(c.attributes.expression?c.attributes.expression:"")},iconCls:"icon-dim"};if(a.text=="维度"||(b.text=="维度"&&a.attributes.tp=="group")){$("#cuberighttree").tree("append",{parent:a.target,data:d})}else{$("#cuberighttree").tree("insert",{after:a.target,data:d})}$(c.target).attr("hide","y").hide()}}}function cube2ds(){var b=$("#cuberighttree").tree("getSelected");if(b==null||!b.attributes){msginfo("您还未选择需要删除的度量或维度。");return}if(b.attributes.tp=="group"){if($("#cubelefttree").tree("getChildren",b.target).length>0){msginfo("您要删除的分组含有维度，不能删除。");return}}if(b.attributes.tp!="group"){var d=b.attributes.tname+b.attributes.col;var a=$("#cubelefttree").tree("getRoot");var c=$("#cubelefttree").tree("getChildren",a.target);for(i=0;i<c.length;i++){if(c[i].id==d){$(c[i].target).attr("hide","n").show();break}}}$("#cuberighttree").tree("remove",b.target)}function reloadDynamicCol(c){var f='<a href="javascript:;" style="margin:3px;" id="dynamiccol">新增</a><table class="grid3" id="T_report54" cellpadding="0" cellspacing="0">';f=f+'<tr><th width="15%">字段名</th><th width="40%">表达式</th><th width="15%">值类型</th><th width="15%">操作</th></tr>';for(var d=0;c.dynamic&&d<c.dynamic.length;d++){var e=c.dynamic[d];f=f+'<tr><td class="kpiData1 grid3-td">'+e.name+'</td><td class="kpiData1 grid3-td">'+e.expression.replace(/@/g,"'")+'</td><td class="kpiData1 grid3-td">'+e.type+'</td><td class="kpiData1 grid3-td"><button col="'+e.name+'" id="dynamiccolupdate" class="btn btn-info btn-xs"><i class="fa fa-paste"></i></button> <button col="'+e.name+'" class="btn btn-danger btn-xs" id="dynamiccoldel"><i class="fa fa-remove"></i></button></td></tr>'}if(!c.dynamic||c.dynamic.length==0){f=f+'<tr><td class="kpiData1 grid3-td" align="center" colspan="4">无数据.</td></tr>'}f=f+"</table>";var a=$("#pdailog #crtdataset").tabs("getSelected");$(a).html(f);var b=function(h){if(!c.master){msginfo("还未选择表，请先选择表。");return}var m="";for(var l=0;l<dataType.length;l++){m=m+'<option value="'+dataType[l]+'" '+(h&&h.type==dataType[l]?"selected":"")+">"+dataType[l]+"</option>"}var n="";$.ajax({type:"post",async:false,url:"listTableColumns.action",dataType:"json",data:{tname:c.master},success:function(o){for(k=0;k<o.length;k++){n=n+'<button name="'+o[k].name+'" class="btn btn-primary btn-xs">'+o[k].name+"</button> "}}});var g='<div class="textpanel"><span class="inputtext">字段名：</span><input type="text" id="colname" name="colname" class="inputform" value="'+(h?h.name:"")+'" placeholder="英文字符"><br/><table cellspacing="0" cellpadding="0"><tbody><tr><td valign="top"><span class="inputtext">表 达 式：</span></td><td><textarea class="inputform" name="expression" id="expression" cols="40" style="height:70px; line-height:20px;">'+(h?h.expression.replace(/@/g,"'"):"")+'</textarea></td></tr></tbody></table><div class="actColumn" style="margin-top:12px;">'+n+'</div><span class="inputtext">值类型：</span><select id="valtype" class="inputform">'+m+"</select></div>";if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:h?"编辑动态字段":"添加动态字段",width:420,height:300,closed:false,cache:false,modal:true,toolbar:null,content:g,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var o=$("#dsColumn_div #colname").val();var q=$("#dsColumn_div #expression").val().replace(/'/g,"@");if(o==""){msginfo("请录入字段名!",function(){$("#dsColumn_div #colname").focus()});return}if(ischinese(o)){msginfo("字段名必须是英文字符。");$("#dsColumn_div #colname").focus();return}if(q==""){msginfo("请录入表达式!",function(){$("#dsColumn_div #expression").focus()});return}if(h){h.name=o;h.type=$("#dsColumn_div #valtype").val();h.expression=q}else{var p={name:o,tname:c.master,type:$("#dsColumn_div #valtype").val(),expression:q};if(!c.dynamic){c.dynamic=[]}c.dynamic.push(p)}$("#dsColumn_div").dialog("close");reloadDynamicCol(c)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#dsColumn_div .actColumn button.btn").bind("click",function(){var o=$(this).attr("name");insertText2focus(document.getElementById("expression"),o)})};$("#crtdataset #dynamiccoldel").bind("click",function(){if(!confirm("是否确认删除？")){return}var g=-1;var h=$(this).attr("col");for(d=0;d<c.dynamic.length;d++){if(c.dynamic[d].name==h){g=d;break}}c.dynamic.splice(g,1);reloadDynamicCol(c)});$("#crtdataset #dynamiccolupdate").bind("click",function(){var g=$(this).attr("col");var h=null;for(d=0;d<c.dynamic.length;d++){if(c.dynamic[d].name==g){h=c.dynamic[d];break}}b(h)});$("#crtdataset #dynamiccol").bind("click",function(){b()}).linkbutton({iconCls:"icon-add"})}function jointableFunc(d){var g=$("#masterTableTree").tree("getSelected");if(g==null){msginfo("您还未从主表字段中选择需要关联的字段。");return}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var b="";var f=null;var e=$("#selTablesTree").tree("getChildren");for(i=0;i<e.length;i++){if(e[i].id!=$("#mastertable").val()){b=b+'<option value="'+e[i].id+'" '+(e[i].id==g.attributes.ref?"selected":"")+">"+e[i].text+"</option>";if(f==null){f=e[i].id}}}var c=function(h){var l="";if(f!=null){$.ajax({type:"post",async:false,url:"listTableColumns.action",dataType:"json",data:{tname:h},success:function(m){for(k=0;k<m.length;k++){l=l+'<option value="'+m[k].name+'" '+(m[k].name==g.attributes.refKey?"selected":"")+">"+m[k].name+"</option>"}}})}return l};var a='<div class="textpanel">主表 <b>'+$("#mastertable").val()+"</b> 字段 <b>"+g.id+'</b> <br/> &nbsp; &nbsp; &nbsp; =>关联到=> <br/><span class="inputtext">从表：</span><select id="slavetable" class="inputform2">'+b+'</select><span class="inputtext">字段：</span><select id="slavetablecol"  class="inputform2">'+c(f)+"</select> </div>";$("#dsColumn_div").dialog({title:"关联维度表",width:350,height:220,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var l=$("#dsColumn_div #slavetable").val();var m=$("#dsColumn_div #slavetablecol").val();if(l==null||l==""){$.messager.alert("出错了","请选择关联表。","error");return}if(m==null||m==""){$.messager.alert("出错了","请选择关联字段。","error");return}g.attributes.ref=l;g.attributes.refKey=m;var h=$("#allTablesTree").tree("getRoots");for(j=0;j<h.length;j++){if(h[j].id==l){g.attributes.tid=h[j].attributes.id;break}}$("#masterTableTree").tree("update",{target:g.target,text:g.attributes.name+" -> "+g.attributes.ref+"."+g.attributes.refKey,iconCls:"icon-coljoin"});if(!d.joininfo){d.joininfo=[]}d.joininfo.push({col:g.id,ref:g.attributes.ref,refKey:g.attributes.refKey,tid:g.attributes.tid});$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#slavetable").bind("change",function(){var h=c($(this).val());$("#slavetablecol").html(h)})}function runtransform(a){showProcPanel(false);$.ajax({type:"post",url:"runTf.action",dataType:"json",data:{id:a},success:function(b){closeProcPanel();if(b.result==1){$.messager.alert("成功了","表关联执行成功！","info")}else{$.messager.alert("出错了",b.msg,"error")}},error:function(){closeProcPanel();$.messager.alert("出错了。","表关联执行出错，请查看后台日志。","error")}})}function runr2c(a){showProcPanel(false);$.ajax({type:"post",url:"runR2C.action",dataType:"json",data:{id:a},success:function(b){closeProcPanel();if(b.result==1){$.messager.alert("成功了","行转列执行成功！","info")}else{$.messager.alert("出错了",b.msg,"error")}},error:function(){closeProcPanel();$.messager.alert("出错了。","行转列执行出错，请查看后台日志。","error")}})}function runt2es(a){showProcPanel(false);$.ajax({type:"post",url:"elastic/run.action",dataType:"json",data:{id:a},success:function(b){closeProcPanel();if(b.result==1){$("#cfglist4").bootstrapTable("refresh",{query:{t:Math.random()}});$.messager.alert("成功了","数据已成功同步到ElasticSearch！","info")}else{$.messager.alert("出错了",b.msg,"error")}},error:function(){closeProcPanel();$.messager.alert("出错了。","数据同步执行出错，请查看后台日志。","error")}})}function runsql(a){showProcPanel(false);$.ajax({type:"post",url:"runSql.action",dataType:"json",data:{id:a},success:function(b){closeProcPanel();if(b.result==1){$.messager.alert("成功了","SQL执行成功！","info")}else{$.messager.alert("出错了",b.msg,"error")}},error:function(){closeProcPanel();$.messager.alert("出错了。","SQL执行出错，请查看后台日志。","error")}})}function newsql(f,d,c){var e;if(f){$.ajax({type:"POST",async:false,url:"getTf.action",dataType:"json",data:{id:d},success:function(g){e=g}})}var a='<div id="crtsql"><div title="SQL脚本"><div class="textpanel" style="line-height:inherit;"><span class="inputtext">步骤名称：</span><input type="text" class="inputform" value="'+(e?e.name:"")+'" name="name" id="name"><br/><span style="width:120px;" class="inputtext">SQL脚本：</span><br/><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td  valign="top"><textarea id="sql" name="sql">'+(e?e.sql:"select \n from")+' </textarea></td><td  valign="top"><ul id="alltables" style="height:235px; width: 190px; overflow:auto;"></ul></td></tr></table></div></div><div title="目标表"><div class="textpanel"><span class="inputtext">输出目标表：</span><input type="text" class="inputform" name="tartable" placeholder="英文字符" value="'+(e&&e.tartable?e.tartable:"")+'" id="tartable" '+(f?"readOnly='true'":"")+">"+(f?"(表名不可更改)":"")+'<br/><span class="inputtext">目标表中文名：</span><input type="text" class="inputform" name="tartablename" value="'+(e&&e.tartablename?e.tartablename:"")+'" id="tartablename"><br/><span class="inputtext">存储方式：</span> <label><input type="radio" name="savetype" value="view" '+(!e||!e.savetype||e.savetype=="view"?"checked":"")+'>视图</lable> &nbsp; <label><input type="radio" name="savetype" value="temptable" '+(e&&e.savetype=="temptable"?"checked":"")+'>临时表</label> &nbsp; <label><input type="radio" name="savetype" value="sql" '+(e&&e.savetype=="sql"?"checked":"")+">SQL片段</label></div></div>"+(f?'<div title="数据预览" href="queryTableData.action?tableId='+c+'"></div>':"")+"</div>";$("#pdailog").dialog({title:f?"修改SQL脚本":"创建SQL脚本",width:780,height:400,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var m=$("#pdailog #name").val();var p=window.sqlEditor.getValue();var l=$("#pdailog #tartable").val();var o=$("#pdailog #tartablename").val();var h=$("#pdailog input[name='savetype']:checked").val();if(m==""){$("#pdailog #crtsql").tabs("select",0);msginfo("请填写步骤名称。");return}if(p==""){$("#pdailog #crtsql").tabs("select",0);msginfo("请填写SQL脚本。");return}if(l==""){$("#pdailog #crtsql").tabs("select",1);msginfo("请填写目标表名称。");return}if(ischinese(l)){$("#pdailog #crtsql").tabs("select",1);msginfo("表名必须是英文字符。",function(){$("#pdailog #tartable").select()});return}var n=/^[a-z|A-Z]/;var g=n.test(l);if(g==false){$("#pdailog #crtsql").tabs("select",1);msginfo("表名必须是以字母开始。",function(){$("#pdailog #tartable").select()});return}$.ajax({type:"POST",url:"testSql.action",dataType:"JSON",data:{sql:escape(p),t:Math.random()},success:function(s){if(s.result==0){$("#pdailog #crtsql").tabs("select",0);msginfo("SQL脚本执行错误："+s.msg)}else{var r;$.ajax({type:"POST",async:false,url:"tableExist.action",dataType:"json",data:{tableName:l},success:function(t){r=t.rows},error:function(t){r=-1}});if(r==-1){$.messager.alert("出错了","网络错误。","error");return}if(!f&&Number(r)>=1){$.messager.alert("出错了","表名存在重复。","error",function(){$("#pdailog #crtsql").tabs("select",1);$("#pdailog #tartable").focus()});return}var q={tartable:l,tartablename:o,sql:p,name:m,savetype:h};__showLoading();$.ajax({type:"POST",url:f?"updateSql.action":"saveSql.action",dataType:"json",data:{cfg:JSON.stringify(q),targetTable:l,name:m,id:d,tableMetaId:c,saveType:h},success:function(t){__hideLoading();if(t.result==1){$("#cfglist3").bootstrapTable("refresh",{t:Math.random()});$("#pdailog").dialog("close")}else{msginfo("系统出错，"+t.msg)}},error:function(t){__hideLoading();msginfo("系统出错，请联系管理员。")}});$("#pdailog").dialog("close")}}})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #crtsql").tabs({fit:true,border:false,tabPosition:"left"});var b=CodeMirror.fromTextArea(document.getElementById("sql"),{mode:"text/x-sql",indentWithTabs:true,smartIndent:true,lineNumbers:true,matchBrackets:true,autofocus:false,lineWrapping:true});window.sqlEditor=b;$.ajax({type:"post",url:"../etl/listTables.action",dataType:"json",data:{t:Math.random()},success:function(g){for(i=0;i<g.length;i++){g[i].state="closed";g[i].iconCls="icon-table";g[i].id=g[i].tableName;g[i].text=g[i].tableName+"("+g[i].tableNote+")";g[i].attributes={siteId:g[i].siteId}}$("#pdailog #alltables").tree({data:g,url:"listTableColumns.action",onBeforeLoad:function(h,l){if(h==null){return false}l.tname=h.id},onClick:function(l){var h=l.id;if(l.iconCls=="icon-dscol"){h=h+", "}else{h=h}insertText2focus(document.getElementById("sql"),h)}});$("#sql").focus()}})}function newR2C(e,b,d){var c;if(e){$.ajax({type:"POST",async:false,url:"getTf.action",dataType:"json",data:{id:b},success:function(f){c=f}})}else{c={}}var a='<div id="crtdataset"><div title="基本信息"><div class="textpanel"><span class="inputtext">步骤名称：</span><input type="text" id="name" name="name" value="'+(c.name?c.name:"")+'" class="inputform"><br/><span class="inputtext" style="width:120px;">选择表：</span><div class="tablesleft" style="margin-left:100px;float:inherit;width:260px;"><ul id="allTablesTree" style="height:295px; width:100%; overflow:auto"></ul></div></div></div><div title="转换设置"></div><div title="聚合字段"></div><div title="目标表"><div class="textpanel"><span class="inputtext">输出目标表：</span><input type="text" class="inputform" placeholder="英文字符" name="tartable" value="'+(c.tartable?c.tartable:"")+'" id="tartable" '+(e?"readOnly='true'":"")+">"+(e?"(表名不可更改)":"")+'<br/><span class="inputtext">目标表中文名：</span><input type="text" class="inputform" name="tartablename" value="'+(c.tartablename?c.tartablename:"")+'" id="tartablename"><br/><span class="inputtext">存储方式：</span> <label><input type="radio" name="savetype" value="view" '+(!c||!c.savetype||c.savetype=="view"?"checked":"")+'>视图</lable> &nbsp; <label><input type="radio" name="savetype" value="temptable" '+(c&&c.savetype=="temptable"?"checked":"")+'>临时表</label> &nbsp; <label><input type="radio" name="savetype" value="sql" '+(c&&c.savetype=="sql"?"checked":"")+">SQL片段</label></div></div>"+(e?'<div title="数据预览" href="queryTableData.action?tableId='+d+'"></div>':"")+"</div>";$("#pdailog").dialog({title:e?"编辑行转列":"创建行转列",width:680,height:450,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var l=$("#pdailog #name").val();var h=$("#pdailog #tartable").val();var p=$("#pdailog #tartablename").val();if(l==""){msginfo("请录入步骤名称。");$("#pdailog #crtdataset").tabs("select",0);$("#pdailog #name").focus();return}var o=$("#pdailog #allTablesTree").tree("getSelected");if(o==null){msginfo("请选择表。");$("#pdailog #crtdataset").tabs("select",0);return}if(!c.groups||c.groups.length==0){msginfo("请选择聚合字段。");$("#pdailog #crtdataset").tabs("select",2);return}if(!c.tfcols||c.tfcols.length==0){msginfo("请新增转换设置。");$("#pdailog #crtdataset").tabs("select",1);return}if(ischinese(h)){$("#pdailog #crtdataset").tabs("select",3);msginfo("目标表只能是英文字符。",function(){$("#pdailog #tartable").focus()});return}var n=/^[a-z|A-Z]/;var g=n.test(h);if(g==false){$("#pdailog #crtdataset").tabs("select",3);msginfo("目标表必须以字符开始。",function(){$("#pdailog #tartable").focus()});return}var f=$("#pdailog input[name='savetype']:checked").val();c.name=l;c.tartable=h;c.tartablename=p;c.savetype=f;c.primaryTable=o.text;var m;$.ajax({type:"POST",async:false,url:"tableExist.action",dataType:"json",data:{tableName:h},success:function(q){m=q},error:function(q){m=-1}});if(m==-1){$.messager.alert("出错了","网络错误。","error");return}if(!e&&Number(m)>=1){$.messager.alert("出错了","表名存在重复。","error",function(){$("#pdailog #crtdataset").tabs("select",4);$("#pdailog #tartable").focus()});return}__showLoading();$.ajax({type:"POST",async:false,url:e?"updateR2C.action":"saveR2C.action",dataType:"json",data:{cfg:JSON.stringify(c),primaryTable:c.primaryTable,targetTable:c.tartablename,name:c.name,id:b,tableMetaId:d,saveType:f},success:function(q){$("#cfglist2").bootstrapTable("refresh",{t:Math.random()});$("#pdailog").dialog("close");__hideLoading()},error:function(q){msginfo("系统出错，请联系管理员。");__hideLoading()}})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #crtdataset").tabs({fit:true,border:false,tabPosition:"left",onSelect:function(g,f){if(f==1){var l='<div class="textpanel"><button id="newTfbtn" type="button" class="btn btn-primary btn-xs">新增转换</button><div id="tfcolsdiv"></div></div>';var h=$("#pdailog #crtdataset").tabs("getSelected");$(h).html(l);$("#pdailog #newTfbtn").bind("click",function(){newR2CCol(false,c)});reloadTf(c)}else{if(f==2){var m=$("#pdailog #allTablesTree").tree("getSelected");if(m==null){msginfo("请先选择表。");$("#pdailog #crtdataset").tabs("select",0);return}$.ajax({type:"post",url:"getTableColumns.action",dataType:"json",data:{tableId:m.attributes.id},success:function(p){var q=function(t,u){var s=false;for(var r=0;u&&r<u.length;r++){if(u[r].col==t){s=true;break}}return s};var o='<div class="textpanel"><ul class="todo-list small-list ui-sortable">';for(i=0;i<p.length;i++){o=o+'<li><label><input type="checkbox" value="'+p[i].colName+","+p[i].colType+'" '+(q(p[i].colName,c.groups)==true?"checked":"")+' id="cb" name="cb"><span class="m-l-sm">'+p[i].colName+"</span></label></li>"}o=o+"</ul></div>";var n=$("#pdailog #crtdataset").tabs("getSelected");$(n).html(o);$("#pdailog input[type='checkbox']").bind("click",function(){var t=$(this).val().split(",");if(this.checked){if(!c.groups){c.groups=[]}c.groups.push({col:t[0],type:t[1]})}else{var r=-1;for(var s=0;s<c.groups.length;s++){if(t==c.groups[s]){r=s;break}}c.groups.splice(r,1)}})}})}}}});$.ajax({type:"post",url:"listTables.action",dataType:"json",data:{},success:function(h){var g=[];for(j=0;j<h.length;j++){var f=h[j];g.push({id:f.tableName,text:f.tableName,attributes:{id:f.tableId+"",note:f.tableNote},iconCls:"icon-table"})}$("#pdailog #allTablesTree").tree({data:g});if(e){$("#pdailog #allTablesTree").tree("select",$("#pdailog #allTablesTree").tree("find",c.primaryTable).target)}}})}function reloadTf(b){var a="";for(i=0;b.tfcols&&i<b.tfcols.length;i++){var c=b.tfcols[i];a=a+'<div class="tfcolslist"><button class="tfcbtn btn btn-white btn-xs" cid="'+c.id+'" use="del" type="button"><i class="fa fa-close"></i></button> <button class="tfcbtn btn btn-white btn-xs" type="button" use="mod" cid="'+c.id+'"><i class="fa fa-edit"></i></button>'+c.aggre+"(case when "+c.col+" "+c.logic+" "+c.val+" then "+c.kpicol+" else 0 end) as "+c.alias+"</div>"}$("#tfcolsdiv").html(a);$("#tfcolsdiv button").bind("click",function(){var e=$(this).attr("use");var f=$(this).attr("cid");if("del"==e){var d=-1;for(j=0;j<b.tfcols.length;j++){if(b.tfcols[j].id==f){d=j;break}}b.tfcols.splice(d,1);reloadTf(b)}else{if("mod"==e){newR2CCol(true,b,f)}}})}function newR2CCol(f,d,c){var a=function(h,g){$.ajax({type:"post",url:"getTableColumns.action",dataType:"json",data:{tableId:h},success:function(l){g(l)}})};var e;if(f){for(j=0;j<d.tfcols.length;j++){if(d.tfcols[j].id==c){e=d.tfcols[j];break}}}var b=$("#pdailog #allTablesTree").tree("getSelected");if(b==null){msginfo("请先选择表。");$("#pdailog #crtdataset").tabs("select",0);return}a(b.attributes.id,function(o){var n='<select id="col" name="col" class="inputform2">';var m='<select id="kpicol" name="kpicol" class="inputform2">';for(i=0;i<o.length;i++){n=n+'<option value="'+o[i].colName+'" '+(e&&e.col==o[i].colName?"selected":"")+">"+o[i].colName+"</option>";m=m+'<option value="'+o[i].colName+'" '+(e&&e.kpicol==o[i].colName?"selected":"")+">"+o[i].colName+"</option>"}n=n+"</select>";m=m+"</select>";var l=["sum","avg","count","max","min"];var g=[">","<","=","!=",">=","<=","in"];var q="<select id='aggre' class='inputform2'>";for(j=0;j<l.length;j++){q=q+"<option value='"+l[j]+"' "+(e&&e.aggre==l[j]?"selected":"")+">"+l[j]+"</option>"}q=q+"</select>";var h="<select id=\"logic\" class='inputform2'>";for(i=0;i<g.length;i++){h=h+"<option value='"+g[i]+"' "+(e&&e.logic==g[i]?"selected":"")+">"+g[i]+"</option>"}h=h+"</select>";var p='<div class="textpanel"><span class="inputtext">当字段：</span>'+n+'<br/><span class="inputtext"></span>'+h+'<br/><span class="inputtext">值：</span><input type="text" id="val" value="'+(e?e.val:"")+'" name="val" class="inputform2">时<br/><span class="inputtext">取字段：</span>'+m+'<br/><span class="inputtext">别名为：</span><input type="text" id="alias" name="alias" class="inputform2" value="'+(e?e.alias:"")+'"><br/><span class="inputtext">聚合方式：</span>'+q+"<br/><span class=\"inputtext\">值类型：</span><select id=\"valtype\" class='inputform2'><option value='String' "+(e&&e.valtype=="String"?"selected":"")+">字符</option><option value='Double' "+(e&&e.valtype=="Double"?"selected":"")+">数字</option></select></div>";if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:"创建转换列",width:330,height:320,closed:false,cache:false,modal:true,toolbar:null,content:p,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var u=$("#dsColumn_div #col").val();var t=$("#dsColumn_div #logic").val();var y=$("#dsColumn_div #val").val();var s=$("#dsColumn_div #kpicol").val();var v=$("#dsColumn_div #alias").val();var x=$("#dsColumn_div #aggre").val();var r=$("#dsColumn_div #valtype").val();if(y==""){msginfo("请填写值。");return}if(v==""){msginfo("请填写别名。");return}if(f){e.col=u;e.logic=t;e.val=y;e.kpicol=s;e.alias=v;e.aggre=x;e.valtype=r}else{var w={col:u,logic:t,val:y,valtype:r,kpicol:s,alias:v,aggre:x,id:newGuid()};if(!d.tfcols){d.tfcols=[]}d.tfcols.push(w)}reloadTf(d);$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]})})}function newCustom(){var a=function(d){var b='<ul id="tablestree"></ul>';$("#pdailog").dialog({title:"注册已有表",width:500,height:320,closed:false,cache:false,modal:true,toolbar:null,content:b,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var g=$("#tablestree").tree("getSelected");if(g==null||g.attributes){msginfo("请勾选表名");return}var l=null;$.ajax({type:"post",url:"currSchema.action",dataType:"json",async:false,data:{t:Math.random()},success:function(m){l=$.trim(m.rows)}});var h=$("#tablestree").tree("getParent",g.target);var e=$.trim(h.id);var f=(l==e?"":e+".")+g.id;$.ajax({type:"post",url:"regSchemaTable.action",dataType:"json",data:{tableName:f},success:function(m){if(m.result==0){msginfo(m.msg);return}$("#cfglist").bootstrapTable("refresh",{t:Math.random()});$("#pdailog").dialog("close")}})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});var c=[];for(j=0;j<d.length;j++){c.push({id:d[j],text:d[j],attributes:{tp:"schema"},state:"closed"})}$("#tablestree").tree({url:"listTablesBySchema.action",onBeforeLoad:function(e){if(!e||e==null){return false}},data:c})};$.ajax({type:"GET",url:"listSchema.action",dataType:"json",data:{t:Math.random()},success:function(b){a(b)}})}function newT2ES(e){var c;if(e){var d=$("#cfglist4").bootstrapTable("getSelections");if(d.length==0){$.messager.alert("出错了。","您还未勾选数据。","error");return}d=d[0];$.ajax({type:"POST",async:false,url:"getTf.action",dataType:"json",data:{id:d.id},success:function(f){c=f}});c.id=d.id}else{c={}}var b='<div class="textpanel"><span class="inputtext">步骤名称：</span><input type="text" id="name" name="name" value="'+(c.name?c.name:"")+'" class="inputform"><br/><span class="inputtext">选择表：</span><select id="allTables" class="inputform"></select><br/><span class="inputtext">同步方式：</span><select id="loadtype" class="inputform" name="loadtype"><option value="ql" '+(c.loadtype=="ql"?"selected":"")+'>全量同步</option><option value="zl" '+(c.loadtype=="zl"?"selected":"")+'>增量同步</option></select><br/><span class="inputtext">时间戳字段：</span><select id="sjc" name="sjc" class="inputform"></select></div>';$("#pdailog").dialog({title:e?"编辑数据同步":"创建数据同步",width:480,height:300,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:b,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var h=$("#pdailog #name").val();var n=$("#pdailog #allTables").val();var g=$("#pdailog #loadtype").val();var m=$("#pdailog #sjc").val();if(h==""){msginfo("请填写步骤名称。");return}if(n==""){msginfo("请选择表。");return}if(g=="zl"&&m==""){msginfo("请设置时间戳字段。");return}var f=n.split(",");var l={name:h,tableId:f[0],tableName:f[1],loadtype:g,sjc:m};$.ajax({type:"post",url:e?"elastic/update.action":"elastic/save.action",dataType:"json",data:{name:h,primaryTable:f[1],targetTable:f[1],tableMetaId:f[0],cfg:JSON.stringify(l),id:c.id},success:function(o){if(o.result==0){msginfo(o.msg)}else{$("#pdailog").dialog("close");$("#cfglist4").bootstrapTable("refresh",{t:Math.random()})}}})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});if(e){$("#allTables").html("<option value='"+c.tableId+","+c.tableName+"'>"+c.tableName+"</option>")}else{$.ajax({type:"post",url:"listTables.action",dataType:"json",data:{},success:function(h){var l="<option value=''></option>";var g=[];for(j=0;j<h.length;j++){var f=h[j];l=l+"<option value='"+f.tableId+","+f.tableName+"' "+(c.tableId==f.tableId?"selected":"")+">"+f.tableName+"</option>"}$("#allTables").html(l)}})}var a=function(f){$.ajax({type:"post",url:"getTableColumns.action",dataType:"json",data:{tableId:f},success:function(h){var g="<option value=''></option>";for(j=0;j<h.length;j++){if(h[j].colType=="Datetime"){g=g+"<option value='"+h[j].colName+"' "+(h[j].colName==c.sjc?"selected":"")+">"+h[j].colName+"</option>"}}$("#pdailog #sjc").html(g)}})};$("#allTables").unbind("change").bind("change",function(){var f=$(this).val();f=f.split(",")[0];a(f)});if(e){a(c.tableId)}}function msginfo(b,a){$.messager.alert("出错了",b,"error",function(){if(a){a()}})}function findJoinInfoById(c,b){var a=null;for(i=0;c.joininfo&&i<c.joininfo.length;i++){if(c.joininfo[i].col==b){a=c.joininfo[i];break}}return a};