if($==undefined){$=jQuery}var layout={};layout.l1_json={tr1:[{colspan:1,rowspan:1,width:100,height:100,id:1}]};layout.l2_json={tr1:[{colspan:1,rowspan:1,width:50,height:100,id:1},{colspan:1,rowspan:1,width:50,height:100,id:2}]};layout.l3_json={tr1:[{colspan:2,rowspan:1,width:100,height:50,id:1}],tr2:[{colspan:1,rowspan:1,width:50,height:50,id:2},{colspan:1,rowspan:1,width:50,height:50,id:3}]};layout.l4_json={tr1:[{colspan:2,rowspan:1,width:100,height:33,id:1}],tr2:[{colspan:1,rowspan:1,width:50,height:33,id:2},{colspan:1,rowspan:1,width:50,height:33,id:3}],tr3:[{colspan:2,rowspan:1,width:100,height:33,id:4}]};layout.l5_json={tr1:[{colspan:2,rowspan:1,width:100,height:20,id:1}],tr2:[{colspan:1,rowspan:1,width:50,height:20,id:2},{colspan:1,rowspan:1,width:50,height:20,id:3}],tr3:[{colspan:2,rowspan:1,width:100,height:20,id:4}],tr4:[{colspan:1,rowspan:1,width:50,height:20,id:5},{colspan:1,rowspan:1,width:50,height:20,id:6}],tr5:[{colspan:2,rowspan:1,width:100,height:20,id:7}]};function backpage(){if(curTmpInfo.compEdit){if(window.parent.dashboard){var b=curTmpInfo.comps[0];window.parent.dashboard.editorSave(b,curTmpInfo.isupdate,curTmpInfo.isAddybp)}return}if(curTmpInfo.isupdate==true){if(confirm("您已对页面进行了修改，是否保存再退出？")){var a=function(){if(pageInfo.id&&pageInfo.id!=""){if(curTmpInfo.is3g=="y"){location.href="../report/PushManager.action"}else{location.href="show.action?pageId="+pageInfo.id}}else{if(curTmpInfo.is3g=="y"){location.href="../report/PushManager.action"}else{location.href="PortalIndex.action"}}};savepage(a)}else{if(pageInfo.id&&pageInfo.id!=""){if(curTmpInfo.is3g=="y"){location.href="../report/PushManager.action"}else{location.href="show.action?pageId="+pageInfo.id}}else{if(curTmpInfo.is3g=="y"){location.href="../report/PushManager.action"}else{location.href="PortalIndex.action"}}}}else{if(pageInfo.id&&pageInfo.id!=""){if(curTmpInfo.is3g=="y"){location.href="../report/PushManager.action"}else{location.href="show.action?pageId="+pageInfo.id}}else{if(curTmpInfo.is3g=="y"){location.href="../report/PushManager.action"}else{location.href="PortalIndex.action"}}}}function resetComppos(){for(var d=1;true;d++){var f=pageInfo.body["tr"+d];if(!f||f==null){break}for(var c=0;c<f.length;c++){var g=f[c];g.children=[];var e=$("#layout_"+g.id).children();if(e&&e.size()>0){var a=e;for(var b=0;a&&b<a.size();b++){g.children.push(findCompById(a[b].id.replace("c_","")))}}}}}function savepage(a){resetComppos();var c=pageInfo.id;if(c==undefined||c==null){c=""}if(curTmpInfo.is3g=="y"){if(c==""){var b='<div style="margin:5px 20px 5px 20px;"><span style="display:inline-block;width:60px;"> 名 称： </span><input type="text" style="width:187px;" id="pageName"><div style="margin-top:5px;"><table cellspacing="0" cellpadding="0"><tr><td valign="top"><span style="display:inline-block;width:60px;"> 目 录：</span></td><td><ul id="reportcatalist"></ul></td></tr></table></div></div>';$("#pdailog").dialog({title:"保存报表",width:330,height:260,closed:false,cache:false,modal:true,toolbar:null,content:b,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var e=$("#pdailog #pageName").val();if(e==""){msginfo("您还未录报表名称。");$("#pdailog #pageName").focus();return}var f=$("#reportcatalist").tree("getSelected");if(f==null||f.id=="0"){msginfo("您还未选择报表目录。");return}$.post("save.action",{pageInfo:JSON.stringify(pageInfo),pageName:e,cataId:f.id,is3g:"y"},function(g){pageInfo.id=g.rows;msginfo("保存成功！","suc");curTmpInfo.isupdate=false;if(a){a()}curTmpInfo.isupdate=false;$("#pdailog").dialog("close")})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #reportcatalist").tree({url:"listMobileTypes.action",dnd:false,data:[{id:"0",text:"报表目录",state:"closed"}],onBeforeLoad:function(e){if(!e||e==null){return false}}});$("#reportcatalist").tree("expand",$("#reportcatalist").tree("getRoot").target)}else{$.post("save.action",{pageInfo:JSON.stringify(pageInfo),pageId:c},function(e){msginfo("保存成功！","suc");curTmpInfo.isupdate=false;if(a){a()}})}}else{if(c==""){var d="";$.ajax({type:"GET",url:"listTypes.action",dataType:"json",data:{income:"pc"},async:false,success:function(e){for(i=0;i<e.length;i++){d=d+'<option value="'+e[i].id+'">'+e[i].text+"</option>"}}});var b='<div class="textpanel"><span class="inputtext">报表名称：</span><input type="text" class="inputform2" id="name"><br/><span class="inputtext">所属分类：</span><select class="inputform2" id="rtype">'+d+"</select></div>";$("#pdailog").dialog({title:"报表保存",width:320,height:180,closed:false,cache:false,modal:true,toolbar:null,content:b,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var e=$("#pdailog #name").val();var f=$("#pdailog #rtype").val();if(e==""){$.messager.alert("出错了","名称必须填写。","error",function(){$("#pdailog #name").focus()});return}$.ajax({type:"POST",url:"save.action",dataType:"json",data:{pageInfo:JSON.stringify(pageInfo),pageName:e,cataId:f},success:function(g){pageInfo.id=g.rows;msginfo("保存成功！","suc");curTmpInfo.isupdate=false;if(a){a()}},error:function(){}});$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}else{$.post("save.action",{pageInfo:JSON.stringify(pageInfo),pageId:c},function(e){msginfo("保存成功！","suc");curTmpInfo.isupdate=false;if(a){a()}})}}}function regCompTree(){$("#comp_tree").tree({dnd:true,onBeforeDrag:function(a){return true},onDragEnter:function(b,a){return false},onStartDrag:function(a){resetWindows("min")},onStopDrag:function(a){$(".indicator").hide();resetWindows("max")}})}function helper(){var a='<div class="window_ctx">您可以通过拖拽的方式，定义自己的数据报表，报表支持图形、表格、文本、日历、地图等多种展现方式。<br/>1.选择数据。<br/><img src="../resource/img/ybp1.gif"><br/>2.选择组件。<br/><img src="../resource/img/ybp2.gif"><br/>3.配置组件数据。<br/><img src="../resource/img/ybp3.gif"></div>';$("#pdailog").dialog({title:"帮助",width:730,height:440,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:a,buttons:[{text:"关闭",iconCls:"icon-ok",handler:function(){$("#pdailog").dialog("close")}}]})}function printpage(){resetComppos();var c=JSON.stringify(pageInfo);var d="about:blank";var b="printwindow";window.open(d,b);var a="<form name='prtff' method='post' target='printwindow' action=\"print.action\" id='expff'><input type='hidden' name='pageInfo' id='ppageInfo'></form>";var e=$(a).appendTo("body");$("#ppageInfo").val(c);e.submit().remove()}function exportPage(){var a="<form name='expff' method='post' action=\"export.action\" id='expff'><input type='hidden' name='type' id='type'><input type='hidden' name='json' id='json'><input type='hidden' name='picinfo' id='picinfo'><div class='exportpanel'><span class='exptp select' tp='html'><img src='../resource/img/export-html.gif'><br>HTML</span><span class='exptp' tp='csv'><img src='../resource/img/export-csv.gif'><br>CSV</span><span class='exptp' tp='excel'><img src='../resource/img/export-excel.gif'><br>EXCEL</span><span class='exptp' tp='word'><img src='../resource/img/export-word.gif'><br>WORD</span><span class='exptp' tp='pdf'><img src='../resource/img/export-pdf.gif'><br>PDF</span></div></form>";$("#pdailog").dialog({title:"导出数据",width:376,height:200,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){resetComppos();var c=curTmpInfo.expType;$("#expff #type").val(c);var b="";if(c=="pdf"||c=="excel"||c=="word"){$("div.chartUStyle").each(function(d,e){var h=$(this).attr("id");h=h.substring(1,h.length);var f=echarts.getInstanceByDom(document.getElementById(h));var g="";if(f){g=f.getDataURL({type:"png",pixelRatio:1,backgroundColor:"#fff"});g=g.split(",")[1];g=$(this).attr("label")+","+g+","+$("#"+h).width();b=b+g;if(d!=$("div.chartUStyle").size()-1){b=b+"@"}}})}$("#expff #picinfo").val(b);$("#expff #json").val(JSON.stringify(pageInfo));$("#expff").submit();$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});curTmpInfo.expType="html";$(".exportpanel span.exptp").click(function(b){$(".exportpanel span.exptp").removeClass("select");$(this).addClass("select");curTmpInfo.expType=$(this).attr("tp")})}function selectdataset(){$("#pdailog").dialog({title:"选择数据模型(立方体)",width:620,height:388,closed:false,cache:false,modal:true,toolbar:null,content:'<div style="margin:5px;">数据分类： <input id="subjectCubeSelect" style="width:200px;"></div><table id="subjectlist" title="" ><thead><tr><th data-options="field:\'ck\',checkbox:true"><th data-options="field:\'tDesc\',width:160">名称</th><th data-options="field:\'typeName\',width:100">分类</th><th data-options="field:\'tNote\',width:300">说明</th></tr></thead></table>',buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var a=$("#subjectlist").datagrid("getChecked");if(a==null||a.length==0){msginfo("请勾选数据。");return}pageInfo.selectDs=a[0].tid;$("#pdailog").dialog("close");curTmpInfo.isupdate=true;reloadDatasetTree();$("#comp_tab").tabs("select",(!curTmpInfo.compEdit?1:0))}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#subjectCubeSelect").combotree({url:"../model/listSubjectType.action",height:25,onClick:function(a){$("#subjectlist").datagrid("load",{typeId:a.id,t:Math.random()})}});$("#subjectlist").datagrid({singleSelect:true,collapsible:false,pagination:true,pageSize:20,height:283,border:true,url:"../model/listAuthSubject.action",method:"post",queryParams:{t:Math.random()}})}function reloadDatasetTree(){if(!pageInfo.selectDs||pageInfo.selectDs==""){$("#datasettree").tree({data:[{id:"root",text:"您还未选择数据立方体!",iconCls:"icon-no"}],lines:false,onContextMenu:function(b,a){b.preventDefault()}})}else{$("#datasettree").tree({url:"../model/cubeTree.action?t="+Math.random()+"&selectDsIds="+(pageInfo.selectDs?pageInfo.selectDs:""),dnd:true,lines:false,onBeforeDrag:function(a){if(!a.attributes||a.attributes.tp=="root"){return false}return true},onDragEnter:function(b,a){return false},onContextMenu:function(b,a){b.preventDefault()}})}}function resetWindows(c){for(var b=0;curTmpInfo.comps&&b<curTmpInfo.comps.length;b++){var a=curTmpInfo.comps[b].id;if(c=="min"){$("#c_"+a+" div.cctx").hide()}else{$("#c_"+a+" div.cctx").show()}}}function setlayout(){var ctx='<div class="textpanel"><br/>';for(var i=1;i<=6;i++){ctx=ctx+'<span class="rlayout"><div class="onelayout" tp="'+i+'"><label for="lay'+i+'"><img src="../resource/img/layout/l'+i+'.png"></lable><br/><input id="lay'+i+'" type="radio" name="sellayout" value="'+i+'" '+(i==pageInfo.layout?"checked":"")+" ></div></span>"}ctx=ctx+"</div>";$("#pdailog").dialog({title:"设置报表布局",width:430,height:340,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:ctx,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var comps=curTmpInfo.comps;var s=$('input[name="sellayout"]:checked').val();pageInfo.layout=Number(s);var json=null;if(s==1){json=layout.l1_json}else{if(s==2){json=layout.l2_json}else{if(s==3){json=layout.l3_json}else{if(s==4){json=layout.l4_json}else{if(s==5){json=layout.l5_json}else{if(s==6){$("#pdailog").dialog("close");autoLayout();return}}}}}}pageInfo.body=json=eval("("+JSON.stringify(json)+")");var ids=[];for(i=0;comps&&i<comps.length;i++){ids.push(comps[i])}json.tr1[0].children=ids;crtLayoutHTML(json,true);curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("span.rlayout div.onelayout").click(function(){var tp=$(this).attr("tp");var s=$('input[name="sellayout"][value="'+tp+'"]');s.attr("checked","checked")})}function autoLayout(){var b=function(q){var o='<table border="0" cellspacing="0" cellpadding="0" class="r_layout" id="autoLayoutTable">';for(var p=1;true;p++){var r=q["tr"+p];if(!r||r==null){break}o=o+"<tr>";for(var h=0;h<r.length;h++){var t=r[h];o=o+'<td class="laytd" height="'+t.height+'%" width="'+t.width+'%" colspan="'+t.colspan+'" rowspan="'+t.rowspan+'" ">';o=o+"&nbsp; </td>"}o=o+"</tr>"}o=o+"</table>";return o};var c=pageInfo.body;var a=b(c);$("#pdailog").dialog({title:"自定义布局",width:600,height:400,closed:false,cache:false,modal:true,toolbar:[{text:"插入行",handler:function(h){var p=$("#autoLayoutTable td.tdselect");if(p.size()==0){msginfo("请先选择单元格。");return}curTmpInfo.curtabtd=p[0];lyt_insertRow();curTmpInfo.curtabtd=null}},{text:"插入列",handler:function(h){var p=$("#autoLayoutTable td.tdselect");if(p.size()==0){msginfo("请先选择单元格。");return}curTmpInfo.curtabtd=p[0];lyt_insertCol();curTmpInfo.curtabtd=null}},{text:"删除行",handler:function(h){var p=$("#autoLayoutTable td.tdselect");if(p.size()==0){msginfo("请先选择单元格。");return}curTmpInfo.curtabtd=p[0];lyt_deleteRow();curTmpInfo.curtabtd=null}},{text:"删除列",handler:function(h){var p=$("#autoLayoutTable td.tdselect");if(p.size()==0){msginfo("请先选择单元格。");return}curTmpInfo.curtabtd=p[0];lyt_deleteCol();curTmpInfo.curtabtd=null}},{text:"合并",handler:function(h){var p=$("#autoLayoutTable td.tdselect");if(p.size()==0){msginfo("请先选择单元格。");return}lyt_mergeCell()}},{text:"取消合并",handler:function(h){var p=$("#autoLayoutTable td.tdselect");if(p.size()==0){msginfo("请先选择单元格。");return}curTmpInfo.curtabtd=p[0];lyt_unmergeCell();curTmpInfo.curtabtd=null}}],onLoad:function(){},content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var r={};var w=document.getElementById("autoLayoutTable").rows;var t=0;for(var q=0;q<w.length;q++){var v=w[q].cells;var p=[];r["tr"+(q+1)]=p;for(var h=0;h<v.length;h++){var u=$(v[h]);var o={};o.colspan=u.attr("colspan")?u.attr("colspan"):"1";o.rowspan=(u.attr("rowspan")?u.attr("rowspan"):"1");o.height=Number(u.attr("height").replace("%",""));o.width=Number(u.attr("width").replace("%",""));o.id=t;t=t+1;p.push(o)}}pageInfo.body=json=r;for(var q=0;curTmpInfo.comps&&q<curTmpInfo.comps.length;q++){if(!json.tr1[0].children){json.tr1[0].children=[]}json.tr1[0].children.push(curTmpInfo.comps[q])}initlayout(false);curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});updateHeightWidth();var f=function(h){$("#autoLayoutTable td").removeClass("tdselect");$(h).addClass("tdselect")};var e=function(q,h){$("#autoLayoutTable td").removeClass("tdselect");var p=$(q).attr("pos").split(",");var o=$(h).attr("pos").split(",");if(p[0]>o[0]||p[1]>o[1]){tmp=p;p=o;o=tmp}for(i=p[0];i<=o[0];i++){for(j=p[1];j<=o[1];j++){$("#autoLayoutTable td[pos='"+(i+","+j)+"']").addClass("tdselect")}}};var d=false;var g=null;$("#autoLayoutTable").on("click","td.laytd",function(){if(!d){f(this)}}).on("mousedown","td.laytd",function(h){d=true;g=this}).on("mouseup","td.laytd",function(h){d=false}).on("mousemove","td.laytd",function(h){if(d){e(g,this)}}).on("contextmenu","td.laytd",function(h){d=false;h.preventDefault();h.stopPropagation();curTmpInfo.curtabtd=this;if($("#autoLayoutTable td.tdselect").size()<=1){f(this)}if($(this).attr("colspan")>1||$(this).attr("rowspan")>1){$("#autolayoutmenu").menu("enableItem",$("#lyt_unmergeCell"))}else{$("#autolayoutmenu").menu("disableItem",$("#lyt_unmergeCell"))}$("#autolayoutmenu").menu("show",{left:h.pageX,top:h.pageY})})}function lyt_mergeCell(){var e=null;var c=null;var a=$("#autoLayoutTable td.tdselect").size();if(a<=1){return}var d=null;$("#autoLayoutTable td.tdselect").each(function(g,h){if(g==0){e=$(this).attr("pos").split(",")}if(g==a-1){c=$(this).attr("pos").split(",");d=$(this)}if(g>0){$(this).remove()}});var f=d.attr("colspan")?Number(d.attr("colspan")):1;var b=d.attr("rowspan")?Number(d.attr("rowspan")):1;$("#autoLayoutTable td.tdselect").attr("rowspan",Math.abs(e[0]-c[0]+(b-1))+1).attr("colspan",Math.abs(e[1]-c[1]+(f-1))+1);updateHeightWidth(true)}function lyt_unmergeCell(){var g=$(curTmpInfo.curtabtd);var f=g.attr("colspan")?Number(g.attr("colspan")):1;var d=g.attr("rowspan")?Number(g.attr("rowspan")):1;g.attr("colspan",1);g.attr("rowspan",1);for(i=1;i<=d;i++){var e="";for(j=1;j<(i==1?f:f+1);j++){e=e+'<td class="laytd"></td>'}if(i==1){g.after(e)}else{var a=g.attr("pos").split(",");var b=$("#autoLayoutTable td[pos='"+((Number(a[0])+i-1)+","+(Number(a[1])-1))+"']");if(b.size()==0){b=$("#autoLayoutTable td[pos='"+((Number(a[0])+i-1)+","+(Number(a[1])+f))+"']");if(b.size()>0){b.before(e)}else{var c=g.parent();for(k=1;k<=i-1;k++){c=c.next()}c.append(e)}}else{b.after(e)}}}updateHeightWidth()}function lyt_insertRow(){var e=curTmpInfo.curtabtd;var h=function(x,c){var r=null;$("#autoLayoutTable td").each(function(y,z){var C=$(z).attr("pos").split(",");var A=$(z).attr("rowspan")?Number($(z).attr("rowspan")):1;var B=$(z).attr("colspan")?Number($(z).attr("colspan")):1;if(A>1){if(x>Number(C[0])&&x<=Number(C[0])+A&&c>=Number(C[1])&&c<Number(C[1])+B){r=$(z)}}});return r};var u=0;var v=document.getElementById("autoLayoutTable").rows[0].cells;for(i=0;i<v.length;i++){var d=$(v[i]).attr("colspan")?Number($(v[i]).attr("colspan")):1;u=u+d}var t=$(e).attr("pos").split(",");var w=Number(t[0])+1;var f=$(e).attr("rowspan")?Number($(e).attr("rowspan")):1;w=w+f-1;var q="<tr>";for(i=0;i<u;i++){var b=$("#autoLayoutTable td[pos='"+w+","+i+"']");if(b.size()==0){var g=h(w,i);if(g!=null){var a=Number(g.attr("rowspan"))+1;g.attr("rowspan",a);var p=Number(g.attr("colspan"));if(p>1){i=i+p-1}continue}}q=q+'<td class="laytd">';q=q+"</td>"}q=q+"</tr>";var o=$(e).parent();for(i=1;i<f;i++){o=o.next()}o.after(q);updateHeightWidth()}function lyt_insertCol(){var g=curTmpInfo.curtabtd;var o=function(y,c){var r=null;$("#autoLayoutTable td").each(function(z,A){var D=$(A).attr("pos").split(",");var C=$(A).attr("colspan")?Number($(A).attr("colspan")):1;var B=$(A).attr("rowspan")?Number($(A).attr("rowspan")):1;if(C>1){if(y>=Number(D[0])&&y<Number(D[0])+B&&c>Number(D[1])&&c<=Number(D[1])+C){r=$(A)}}});return r};var x=document.getElementById("autoLayoutTable").rows;var t=$(g).attr("pos").split(",");var v=Number(t[1]);var f=$(g).attr("colspan")?Number($(g).attr("colspan")):1;if(f>1){v=v+f-1}var b=[];for(i=0;i<x.length;i++){var u=null;var d=$("#autoLayoutTable td[pos='"+i+","+(v)+"']");if(d.size()==0){var h=o(i,v);if(h!=null){var a=Number(h.attr("colspan"))+1;h.attr("colspan",a);var q=Number(h.attr("rowspan"));if(q>1){i=i+q-1}continue}}else{var a=d.attr("colspan")?Number(d.attr("colspan")):1;var q=Number(d.attr("rowspan"));if(q>1){i=i+q-1}if(a>1){d.attr("colspan",a+1);continue}u=d}var w=u.attr("rowspan")?Number(u.attr("rowspan")):1;var e=u.attr("colspan")?Number(u.attr("colspan")):1;var p='<td class="laytd" rowspan="'+w+'" colspan="'+e+'"></td>';b.push({obj:u,str:p})}for(i=0;i<b.length;i++){b[i].obj.after(b[i].str)}updateHeightWidth()}function lyt_deleteCol(){var d=$(curTmpInfo.curtabtd);var t=document.getElementById("autoLayoutTable").rows;var f=function(u,c){var r=null;$("#autoLayoutTable td").each(function(v,w){var z=$(w).attr("pos").split(",");var y=$(w).attr("colspan")?Number($(w).attr("colspan")):1;var x=$(w).attr("rowspan")?Number($(w).attr("rowspan")):1;if(y>1){if(u>=Number(z[0])&&u<Number(z[0])+x&&c>Number(z[1])&&c<=Number(z[1])+y){r=$(w)}}});return r};var g=Number(d.attr("pos").split(",")[1]);var q=[];var p=d.attr("colspan")?Number(d.attr("colspan")):1;for(k=0;k<p;k++){var o=g+k;for(i=0;i<t.length;i++){var b=$("#autoLayoutTable td[pos='"+i+","+(o)+"']");if(b.attr("pos")==d.attr("pos")){q.push(b);var h=Number(b.attr("rowspan"));if(h>1){i=i+h-1}continue}if(b.size()==0){var e=f(i,o);if(e!=null){var a=Number(e.attr("colspan"))-1;e.attr("colspan",a);var h=Number(e.attr("rowspan"));if(h>1){i=i+h-1}continue}}else{var a=b.attr("colspan")?Number(b.attr("colspan")):1;var h=b.attr("rowspan")?Number(b.attr("rowspan")):1;if(h>1){i=i+h-1}if(a>1){b.attr("colspan",a-1);continue}}q.push(b)}}for(i=0;i<q.length;i++){$(q[i]).remove()}updateHeightWidth()}function lyt_deleteRow(){var f=$(curTmpInfo.curtabtd);var x=0;var y=document.getElementById("autoLayoutTable").rows[0].cells;for(i=0;i<y.length;i++){var d=$(y[i]).attr("colspan")?Number($(y[i]).attr("colspan")):1;x=x+d}var p=function(A,c){var r=null;$("#autoLayoutTable td").each(function(B,C){var F=$(C).attr("pos").split(",");var D=$(C).attr("rowspan")?Number($(C).attr("rowspan")):1;var E=$(C).attr("colspan")?Number($(C).attr("colspan")):1;if(D>1){if(A>Number(F[0])&&A<=Number(F[0]+D)&&c>=Number(F[1])&&c<Number(F[1])+E){r=$(C)}}});return r};var h=[];var v=$(f).attr("pos").split(",");var g=Number(v[0]);var w=f.attr("rowspan")?Number(f.attr("rowspan")):1;for(n=0;n<w;n++){for(i=0;i<x;i++){var z=g+n;var b=$("#autoLayoutTable td[pos='"+z+","+i+"']");if(b.size()==0){var o=p(z,i);if(o!=null){var a=Number(o.attr("rowspan"))-1;o.attr("rowspan",a);var u=Number(o.attr("colspan"));if(u>1){i=i+u-1}}}else{if(Number(b.attr("rowspan"))>1){b.attr("rowspan",Number(b.attr("rowspan"))-1);var t=false;var e=i-1;while(e>=0){var q=$("#T"+compId+" td[pos='"+(z+1)+","+(e)+"']");if(q.size()>0){q.after(b);t=true;break}e=e-1}if(t==false){e=i+1;while(e<x){var q=$("autoLayoutTable td[pos='"+(z+1)+","+(e)+"']");if(q.size()>0){q.before(b);t=true;break}e=e+1}}}var u=Number(b.attr("colspan"));if(u>1){i=i+u-1}}}h.push($("#autoLayoutTable tr").get(z))}for(i=0;i<h.length;i++){$(h[i]).remove()}updateHeightWidth()}function updateHeightWidth(h){var r=document.getElementById("autoLayoutTable").rows[0].cells;var o=0;for(i=0;i<r.length;i++){o=o+Number(($(r[i]).attr("colspan")?$(r[i]).attr("colspan"):1))}var p={};var t=document.getElementById("autoLayoutTable").rows;var d=t.length;for(j=0;j<d;j++){r=t[j].cells;var c=0;for(i=0;i<r.length;i++){var a=$(r[i]).attr("colspan")?Number($(r[i]).attr("colspan")):1;var f=$(r[i]).attr("rowspan")?Number($(r[i]).attr("rowspan")):1;var b=((100/o)*a);var g=((100/d)*f);$(r[i]).attr({width:Math.round(b)+"%",height:Math.round(g)+"%"});if(h&&h==true){continue}if(f>1){for(k=1;k<f;k++){var q="before";for(m=0;m<i;m++){var e=($(r[m]).attr("rowspan")?Number($(r[m]).attr("rowspan")):1)-1;if(e<k){q="after";break}}p[(j+k)+","+(q=="before"?c:c-1)+q]=a}}for(l=c-1;i==0&&l<o;l++){if(p[j+","+(c)+"before"]){c=c+p[j+","+(c)+"before"]}else{break}}$(r[i]).attr({pos:j+","+c});c=c+1;if(a>1){c=c+(a-1)}for(l=c-1;l<o;l++){if(p[j+","+(l)+"after"]){c=c+p[j+","+(l)+"after"]}else{break}}}}}function initPortalLayout(){var json=pageInfo.body;var cps=[];var ret='<table border="0" style="width:1020px;" cellspacing="0" cellpadding="0" class="r_layout" id="layout_table">';for(var i=1;true;i++){var tr=json["tr"+i];if(!tr||tr==null){break}ret=ret+"<tr>";for(var j=0;j<tr.length;j++){var td=tr[j];ret=ret+'<td class="laytd2" height="'+td.height+'%" width="'+td.width+'%" colspan="'+td.colspan+'" rowspan="'+td.rowspan+'" >';if(td.children){for(var k=0;k<td.children.length;k++){var comp=findTCompById(td.children[k]);var str=compStr(comp,false);ret=ret+str;cps.push(comp)}}ret=ret+"</td>"}ret=ret+"</tr>"}ret=ret+"</table>";$("#optarea").html(ret);for(var i=0;i<cps.length;i++){var comp=cps[i];var url="../"+comp.url;var param=comp.dayParam&&comp.dayParam!=""?"({"+comp.dayParam+":'"+curDt+"'})":"({})";$("#c_"+comp.id+" div.cctx").html("<div style='padding:5px;'>加载中...</div>").load(url,eval(param),function(){})}}function initlayout(){var c=pageInfo.layout;var b=pageInfo.body;crtLayoutHTML(b,true);$(window).on("resizeend",function(d){resetCharts()});$("#Jlayout").layout({onAdd:function(d){if(d=="east"){window.setTimeout(function(){resetCharts()},200);resetCharts()}},onRemove:function(d){if(d=="east"){window.setTimeout(function(){resetCharts()},200)}}});if(curTmpInfo.compEdit){if(curTmpInfo.comps.length==0){}else{var a=curTmpInfo.comps[0];if(a.type=="grid"){pageInfo.table={tid:a.tid,tname:a.tname,tnote:""};initTableTree();$("#comp_tab").tabs("select",1)}else{pageInfo.selectDs=a.tid;reloadDatasetTree()}}}}function resetCharts(){for(i=0;i<curTmpInfo.comps.length;i++){var e=curTmpInfo.comps[i];var d=e.id;if(e.type=="chart"){var b=document.getElementById("C"+d);if(!b){continue}var a=echarts.getInstanceByDom(b);a.resize($("#C"+d).width(),$("#C"+d).height())}}}function crtLayoutHTML(p,o){var e=[];var f='<table border="0"  style="width:'+(curTmpInfo.is3g=="y"?"560px":"100%")+';" cellspacing="0" cellpadding="0" class="r_layout" id="layout_table">';for(var d=1;true;d++){var h=p["tr"+d];if(!h||h==null){break}f=f+"<tr>";for(var c=0;c<h.length;c++){var a=h[c];f=f+'<td class="laytd" height="'+a.height+'%" width="'+a.width+'%" colspan="'+a.colspan+'" rowspan="'+a.rowspan+'" id="layout_'+a.id+'">';if(a.children){for(var b=0;b<a.children.length;b++){var g=addComp(a.children[b],a.id,false);f=f+g;e.push(a.children[b])}}f=f+"</td>"}f=f+"</tr>"}f=f+"</table>";curTmpInfo.comps=e;$("#optarea").html(f);if(o){for(d=0;d<e.length;d++){bindCompEvent(e[d]);bindResizeEvent(e[d].id,e[d].type);if(e[d].type=="table"){tableView(e[d],e[d].id)}else{if(e[d].type=="chart"){chartview(e[d],e[d].id)}else{if(e[d].type=="input"&&e[d].pcol){loadParamData(e[d])}else{if(e[d].type=="grid"){gridView(e[d])}else{if(e[d].type=="box"){boxView(e[d])}}}}}}}$("#layout_table td.laytd").droppable({accept:"div.ibox, #comp_tree .tree-node",onDragEnter:function(u,r){var t=$(this);if(t.children().size()==0){$(".indicator").css({display:"block",left:t.offset().left,top:t.offset().top-3})}else{var q=t.children().last();if(q.attr("id")==$(r).attr("id")){q=q.prev()}if(q.size()==0){$(".indicator").css({display:"block",left:t.offset().left,top:t.offset().top-10})}else{curTmpInfo.id=q.attr("id");curTmpInfo.tp="after";$(".indicator").css({display:"block",left:q.offset().left,top:q.offset().top+q.height()})}}$(r).draggable("proxy").find("span").removeClass("tree-dnd-no");$(r).draggable("proxy").find("span").addClass("tree-dnd-yes")},onDragLeave:function(r,q){$(q).draggable("proxy").find("span").addClass("tree-dnd-no");$(q).draggable("proxy").find("span").removeClass("tree-dnd-yes");delete curTmpInfo.id,curTmpInfo.tp},onDrop:function(v,u){$(".indicator").hide();if($(u).hasClass("ibox")){if(!curTmpInfo.mouseOnDiv){$(this).append(u)}else{if(curTmpInfo.tp=="before"){$("#"+curTmpInfo.id).before(u)}else{$("#"+curTmpInfo.id).after(u)}}window.setTimeout(function(){var A=$(u).attr("id").replace("c_","");var y=findCompById(A);if(y.type=="chart"){var z=echarts.getInstanceByDom(document.getElementById("C"+y.id));z.resize($("#C"+y.id).width(),$("#C"+y.id).height())}},200)}else{var t=$("#comp_tree").tree("getNode",u);var q=$(this).attr("id").split("_")[1];var x=t.attributes.tp;if(x=="text"){insertText("insert",q,"",curTmpInfo.id,curTmpInfo.tp)}else{if(x=="table"){var r={id:newGuid(),name:"交叉表",type:"table"};var w=addComp(r,q,true);if(!curTmpInfo.id){$("#layout_"+q).append(w)}else{if(curTmpInfo.tp=="before"){$("#"+curTmpInfo.id).before(w)}else{$("#"+curTmpInfo.id).after(w)}}bindCompEvent(r);bindResizeEvent(r.id,"table");window.setTimeout(function(){$("#optarea").scrollTop($("#c_"+r.id).offset().top)},500)}else{if(x=="chart"){setcharttype(true,q,curTmpInfo.id,curTmpInfo.tp)}else{if(x=="grid"){var r={id:newGuid(),name:"表格",type:"grid"};var w=addComp(r,q,true);if(!curTmpInfo.id){$("#layout_"+q).append(w)}else{if(curTmpInfo.tp=="before"){$("#"+curTmpInfo.id).before(w)}else{$("#"+curTmpInfo.id).after(w)}}bindCompEvent(r);bindResizeEvent(r.id,"grid");window.setTimeout(function(){$("#optarea").scrollTop($("#c_"+r.id).offset().top)},500)}else{if(x=="box"){var r={id:newGuid(),name:"数据块",type:"box"};var w=addComp(r,q,true);if(!curTmpInfo.id){$("#layout_"+q).append(w)}else{if(curTmpInfo.tp=="before"){$("#"+curTmpInfo.id).before(w)}else{$("#"+curTmpInfo.id).after(w)}}bindCompEvent(r);bindResizeEvent(r.id,"box")}else{if(x=="pic"){var r={id:newGuid(),name:"图片",type:"pic"};var w=addComp(r,q,true);if(!curTmpInfo.id){$("#layout_"+q).append(w)}else{if(curTmpInfo.tp=="before"){$("#"+curTmpInfo.id).before(w)}else{$("#"+curTmpInfo.id).after(w)}}bindCompEvent(r);bindResizeEvent(r.id,"pic");window.setTimeout(function(){$("#optarea").scrollTop($("#c_"+r.id).offset().top)},1000)}}}}}}}delete curTmpInfo.tp;delete curTmpInfo.id;delete curTmpInfo.mouseOnDiv;curTmpInfo.isupdate=true}})}function compevent(q){if(!q){q=curTmpInfo.compId}var g=findCompById(q);if(g.type=="chart"||g.type=="table"){}else{return}var b;var e;if(g.type=="chart"&&g.chartJson){b=g.chartJson.link;e=g.chartJson.linkAccept}else{if(g){b=g.link;e=g.linkAccept}}var h="";for(i=0;i<curTmpInfo.comps.length;i++){var c=curTmpInfo.comps[i];if(c.type=="chart"||c.type=="table"){if(c.id!=q){h=h+'<div class="checkbox checkbox-info"><input id="cc'+i+'" type="checkbox" name="linkcomp" value="'+c.id+'" '+(b&&b.target.indexOf(c.id)>=0?"checked":"")+'><label for="cc'+i+'">'+c.name+"</label></div>"}}}var p=null;var d=function(t){var o="";$.ajax({type:"post",url:"../model/cubeInfo.action",data:{tableId:t},dataType:"json",async:false,success:function(u){p=u=u.dims;for(k=0;k<u.length;k++){o=o+'<option value="'+u[k].id+'" '+(e&&e.id==u[k].id?"selected":"")+">"+u[k].dimdesc+"("+(u[k].tableColKey!=null&&u[k].tableColKey!=""?u[k].tableColKey:u[k].colname)+")</option>"}}});return o};var a=function(t){var o=null;for(i=0;p!=null&&i<p.length;i++){if(p[i].id==t){o=p[i];break}}return o};var f='<select id="acceptCol" name="acceptCol" class="inputform2"><option value=""></option>';f=f+d(g.tid);f=f+"</select>";var r='<div id="compevent_tab" style="height:auto; width:auto;"><div title="事件发起"><div style="padding:10px;"><span class="inputtext">联动组件：</span><br/>'+h+'<button class="btn btn-info btn-sm" id="cleanPostEvent">清除事件发起</button></div></div><div title="事件接收"><div class="textpanel"><span class="inputtext">接收字段：</span>'+f+'<br/><br/><button id="cleanAcceptEvent" class="btn btn-info btn-sm">清除事件接收</button></div></div></div>';$("#pdailog").dialog({title:"组件联动事件设置",width:360,height:(g.type=="table"?290:250),closed:false,cache:false,modal:true,toolbar:null,content:r,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var v=$("#pdailog #compevent_tab").tabs("getSelected");var B=$("#pdailog #compevent_tab").tabs("getTabIndex",v);if(B==0){var C=$("#pdailog input[name='linkcomp']:checkbox:checked");if(C.length>0){var A={};if(g.type=="chart"){g.chartJson.link=A}else{g.link=A}var z="";var y="";C.each(function(D,o){var F=$(this).val();var E=findCompById(F);z=z+F+",";y=y+(E.type=="table"?"cross":E.type)+","});z=z.substring(0,z.length-1);y=y.substring(0,y.length-1);A.target=z;A.type=y;A.paramName="p"+Math.floor(Math.random()*100)}else{if(g.type=="chart"){delete g.chartJson.link}else{delete g.link}}}else{var w=$("#compevent_tab #acceptCol").val();var u="";if(w==""&&u==""){curTmpInfo.isupdate=true;$("#pdailog").dialog("close");return}var x=a(w);var t={id:x.id,col:x.colname,tableColKey:x.tableColKey,alias:x.alias,type:x.type,dftval:u,valType:x.valType,calc:x.calc,fromCol:x.fromCol};if(g.type=="chart"){g.chartJson.linkAccept=t}else{if(g){g.linkAccept=t}else{msginfo("组件还未定义数据，不能定义事件。")}}}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #compevent_tab").tabs({border:false,fit:true});$("#compevent_tab #cleanPostEvent").bind("click",function(){var o=$("#pdailog input[name='linkcomp']:checkbox");for(i=0;o&&i<o.length;i++){$(o[i]).prop("checked",false)}if(g.type=="chart"){delete g.chartJson.link}else{delete g.link}});$("#compevent_tab #cleanAcceptEvent").bind("click",function(){$("#compevent_tab #acceptCol").val("");$("#compevent_tab #dftval").val("");$("#compevent_tab #valtype").val("");if(g.type=="chart"){delete g.chartJson.linkAccept}else{delete g.linkAccept}})}function pushpage(){if(!pageInfo.id||pageInfo.id==""){msginfo("请先保存报表再发布报表。");return}var a='<div style="padding:10px;"><span class="inputtext">名称：</span><input type="text" id="name" class="inputform2"><br/><span class="inputtext">排序：</span><input type="text" id="ord" class="inputform2" value="1"><br/><span class="inputtext">图标：</span><input type="text" id="avatar" class="inputform2"><table><tr><td valign="top"><span class="inputtext">上级菜单：</span></td><td><ul id="ggcatatree" style="width:100%"></ul></td></tr></table></div>';$("#pdailog").dialog({title:"发布报表到菜单",width:380,height:300,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var f=$("#pdailog #name").val();var c=$("#pdailog #ord").val();if(f==""){msginfo("名称必须填写。");return}if(c==""){msginfo("排序必须填写。");return}if(isNaN(c)){msginfo("排序必须是数字类型。");return}var g=$("#pdailog #ggcatatree").tree("getSelected");if(g==null){msginfo("请选择上级菜单。");return}var e=$("#pdailog #avatar").combobox("getValue");var p=$("#pdailog #ggcatatree").tree("getParent",g.target);if(p!=null){var o=$("#pdailog #ggcatatree").tree("getParent",p.target);if(o!=null){var h=$("#pdailog #ggcatatree").tree("getParent",o.target);if(h!=null&&h.id=="0"){$.messager.alert("出错了。","菜单只能建3级","error");return}}}var d="../portal/show.action?income=menu&pageId="+pageInfo.id;$.ajax({type:"POST",url:"../auth/menu/save.action",data:{menuName:f,menuDesc:"",menuOrder:c,menuUrl:d,menuPid:g.id,avatar:e,urls:"portal/export.action,portal/print.action,portal/view.action"},dataType:"json",success:function(){msginfo("菜单推送成功。","suc")},error:function(){msginfo("系统出错。")}});$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#ggcatatree").tree({url:"../auth/menu/loadData.action",dnd:false,animate:true,data:[{id:"0",text:"系统菜单",state:"closed",iconCls:"icon-earth"}],onBeforeLoad:function(c){if(!c||c==null){return false}}});$("#pdailog #avatar").combobox({url:"../resource/fonts/menu-icons.json",valueField:"cls",textField:"text",height:25,formatter:function(c){return'<i class="'+c.cls+'"></i> '+c.text}});var b=$("#ggcatatree").tree("getRoot");$("#ggcatatree").tree("expand",b.target)}function setpagestyle(){var b=pageInfo.stylename;var a="<div style='margin:10px;'><br/><span class='rlayout'><div class='pagestyle' tp=\"def\" style='background-color:#eeeeee;'> &nbsp; </div><input type=\"radio\" "+(b&&b=="def"?"checked":"")+' value="def" name="selstyle">默认</span><span class=\'rlayout\'><div class=\'pagestyle\' tp="black" style=\'background-color:#000000;\'> &nbsp; </div><input type="radio" value="black" '+(b&&b=="black"?"checked":"")+' name="selstyle">黑色</span><span class=\'rlayout\'><div class=\'pagestyle\' style=\'background-color:#00F;\' tp="blue"> &nbsp; </div><input type="radio"  value="blue" name="selstyle" '+(b&&b=="blue"?"checked":"")+">蓝色</span><span class='rlayout'><div class='pagestyle' style='background-color:#F00;' tp=\"red\"> &nbsp; </div><input type=\"radio\" "+((b&&b=="red"?"checked":""))+'  value="red" name="selstyle">红色</span><span class=\'rlayout\'><div class=\'pagestyle\' style=\'background-color:#FF3;\' tp="yellow"> &nbsp; </div><input type="radio" value="yellow" name="selstyle" '+((b&&b=="yellow"?"checked":""))+">黄色</span></div>";$("#pdailog").dialog({title:"报表样式设置",width:430,height:320,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},buttons:[{text:"确定",handler:function(){var c=$('input[name="selstyle"]:checked').val();pageInfo.stylename=c;curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("span.rlayout div.pagestyle").click(function(){var d=$(this).attr("tp");var c=$('input[name="selstyle"][value="'+d+'"]');c.attr("checked","checked")})}function msginfo(a,c){var b=null;if(c&&c=="suc"){b="<div class='msginfo msgsuc'>"+a+"</div>"}else{b="<div class='msginfo msgerr'>"+a+"</div>"}$.messager.show({title:(c&&c=="suc")?"成功了":"出错了",msg:b,showType:"fade",timeout:2000,style:{right:"",top:document.body.scrollTop+document.documentElement.scrollTop+10,bottom:""}})}function tableUpdateComp(a){}function chartComp_Link(){}function findLayoutById(a){var c=null;for(var d=1;true;d++){var e=pageInfo.body["tr"+d];if(!e||e==null){break}for(var b=0;b<e.length;b++){var f=e[b];if(f.id==a){c=f;break}}}return c}if($==undefined){$=jQuery}function insertChart(h,b,f,c,p,r,e){var o=b?b:"line";curTmpInfo.charttype=o;var q=newGuid();var a="图表";var d={id:q,name:a,type:"chart"};d.chartJson={type:o,maparea:c,mapAreaName:p,typeIndex:f,xcol:{},ycol:{},scol:{},params:[],height:o=="map"?"400":"250"};if(curTmpInfo.is3g=="y"){d.chartJson.width="100%"}else{d.chartJson.width=o=="pie"||o=="gauge"?"360":"600"}d.kpiJson=[null,null,null];var g=addComp(d,h,true);if(!r){$("#layout_"+h).append(g)}else{if(e=="before"){$("#"+r).before(g)}else{$("#"+r).after(g)}}bindCompEvent(d);bindResizeEvent(d.id,"chart");window.setTimeout(function(){$("#optarea").scrollTop($("#c_"+q).offset().top)},500)}function editChartData(q,h){if($("#dataProperty").size()==0){$("#Jlayout").layout("add",{region:"south",id:"dataProperty",split:false,collapsible:false,height:120,title:"编辑图形数据",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","south")}}]})}else{$("#Jlayout").layout("panel","south").panel("setTitle","编辑图形数据")}$("#comp_tab").tabs("select",(!curTmpInfo.compEdit?1:0));var f=findCompById(q);var o=charttype=f.chartJson.type;var d=false;var p=false;var c=false;var t=false;d=o=="pie"||o=="gauge"||o=="wordcloud"||o=="funnel"||o=="treeMap";p=o=="bubble"||o=="scatter";c=o=="bubble";t=o=="map";isnesting=o=="pie"&&f.chartJson&&f.chartJson.typeIndex=="3";isMulti=f.mkpi==true||f.mkpi=="true";multi=f.chartJson.typeIndex=="1"&&(o=="line"||o=="column"||o=="bar"||o=="area"||o=="radar");var b="";if(isMulti&&multi){for(i=0;f.mkpiJson&&i<f.mkpiJson.length;i++){var e=f.mkpiJson[i];b=b+'<div id="y'+e.kpi_id+'"><span class="mcharttxt" title="'+e.kpi_name+'">'+e.kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+e.kpi_id+",'ycols','"+e.kpi_name+"','"+q+"')\"></span></div>"}}var a="";if(f.kpiJson[1]!=null){a='<span title="'+f.kpiJson[1].kpi_name+'" class="charttxt">'+(f.kpiJson[1].kpi_name)+'</span><span onclick="chartmenu(this, '+f.kpiJson[1].kpi_id+",'y2col','"+f.kpiJson[1].kpi_name+"','"+q+'\')" title="配置" class="charticon"></span>'}else{a='<span class="charttip">将度量拖到这里</span>'}var g='<div class="tsbd">'+(p?'<div class="ts_h">'+(d?"观察维度":"横轴")+'：<div id="y2col" class="h_ctx">'+(f.kpiJson[1]!=null?'<span title="'+f.kpiJson[1].kpi_name+'" class="charttxt">'+(f.kpiJson[1].kpi_name)+'</span><span onclick="chartmenu(this, '+f.kpiJson[1].kpi_id+",'y2col','"+f.kpiJson[1].kpi_name+"','"+q+'\')" title="配置" class="charticon"></span>':'<span class="charttip">将度量拖到这里</span>')+"</div></div>":'<div class="ts_h">'+(d?"观察维度":(t?"地域维度":"横轴"))+'：<div id="xcol" class="h_ctx">'+(f.chartJson.xcol&&f.chartJson.xcol.id?'<span class="charttxt" title="'+f.chartJson.xcol.dimdesc+'">'+f.chartJson.xcol.dimdesc+'</span><span onclick="chartmenu(this, '+f.chartJson.xcol.id+",'xcol', '"+f.chartJson.xcol.dimdesc+"','"+q+'\')" title="配置" class="charticon"></span>':'<span class="charttip">'+(t?"将地域拖到这里":"将维度拖到这里")+"</span>")+"</div></div>")+(isnesting?'<div class="ts_h">外环维度：<div id="scol" class="h_ctx">'+(f.chartJson.scol&&f.chartJson.scol.id?'<span class="charttxt" title="'+f.chartJson.scol.dimdesc+'">'+f.chartJson.scol.dimdesc+'</span><span onclick="chartmenu(this,'+f.chartJson.scol.id+", 'scol', '"+f.chartJson.scol.dimdesc+"','"+q+'\')" title="配置" class="charticon"></span>':'<span class="charttip">将维度拖到这里</span>')+"</div></div>":"")+(isMulti&&multi?"":'<div class="ts_h">'+(d||t?"度量":"纵轴")+'：<div id="ycol" class="h_ctx">'+(f.kpiJson[0]!=null?'<span class="charttxt" title="'+f.kpiJson[0].kpi_name+'">'+(f.kpiJson[0].kpi_name)+'</span><span onclick="chartmenu(this, '+f.kpiJson[0].kpi_id+",'ycol','"+f.kpiJson[0].kpi_name+"','"+q+'\')" title="配置" class="charticon"></span>':'<span class="charttip">将度量拖到这里</span>')+"</div></div>")+(isMulti&&multi?'<div class="ts_h">纵轴：<div id="ycols" class="h_ctx_multi">'+b+"</div></div>":"")+(c?'<div class="ts_h">气泡大小：<div id="y3col" class="h_ctx">'+(f.kpiJson[2]!=null?'<span title="'+f.kpiJson[2].kpi_name+'" class="charttxt">'+(f.kpiJson[2].kpi_name)+'</span><span onclick="chartmenu(this, '+f.kpiJson[2].kpi_id+",'y3col','"+f.kpiJson[2].kpi_name+"','"+q+'\')" title="配置" class="charticon"></span>':'<span class="charttip">将度量拖到这里</span>')+"</div></div>":"")+(p?'<div class="ts_h">观察维度：<div id="xcol" class="h_ctx">'+(f.chartJson.xcol&&f.chartJson.xcol.id?'<span class="charttxt" title="'+f.chartJson.xcol.dimdesc+'">'+f.chartJson.xcol.dimdesc+'</span><span onclick="chartmenu(this, '+f.chartJson.xcol.id+",'xcol', '"+f.chartJson.xcol.dimdesc+"','"+q+'\')" title="配置" class="charticon"></span>':'<span class="charttip">将维度拖到这里</span>')+"</div></div>":"")+(c||t||(isMulti&&multi)?"":'<div class="ts_h" '+(d?'style="display:none"':"")+'>图例：<div id="scol" class="h_ctx">'+(f.chartJson.scol&&f.chartJson.scol.id?'<span class="charttxt" title="'+f.chartJson.scol.dimdesc+'">'+f.chartJson.scol.dimdesc+'</span><span onclick="chartmenu(this,'+f.chartJson.scol.id+", 'scol', '"+f.chartJson.scol.dimdesc+"','"+q+'\')" title="配置" class="charticon"></span>':'<span class="charttip">将维度拖到这里</span>')+"</div></div>")+((charttype=="column"||charttype=="line")&&(f.chartJson.typeIndex=="2"||f.chartJson.typeIndex=="4")?'<div class="ts_h">第二纵轴：<div class="h_ctx" id="y2col">'+a+"</div></div>":"")+"</div>";var r='<div style="margin:3px;"><div class="chartDatasty" id="chartData">'+g+"</div></div>";$("#dataProperty").html(r);initChartKpiDrop(q)}function initChartKpiDrop(a){$("#chartData #xcol, #chartData #ycol, #chartData #ycols, #chartData #y2col, #chartData #y3col, #chartData #scol").droppable({accept:"#datasettree .tree-node",onDragEnter:function(f,d){var c=$("#datasettree").tree("getNode",d);var g=c.attributes.col_type;var b=$(this).attr("id");if(g==1&&(b=="xcol"||b=="scol")){$(d).draggable("proxy").find("span").removeClass("tree-dnd-no");$(d).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#chartData #"+b).css("border-color","#ff0000")}if(g==2&&(b=="ycol"||b=="ycols"||b=="y2col"||b=="y3col")){$(d).draggable("proxy").find("span").removeClass("tree-dnd-no");$(d).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#chartData #"+b).css("border-color","#ff0000")}f.cancelBubble=true;f.stopPropagation()},onDragLeave:function(c,b){$(b).draggable("proxy").find("span").addClass("tree-dnd-no");$(b).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#chartData #"+$(this).attr("id")).css("border-color","#7F9DB9");c.cancelBubble=true;c.stopPropagation()},onDrop:function(h,b){var q=findCompById(a);$("#chartData #"+$(this).attr("id")).css("border-color","#7F9DB9");var d=$("#datasettree").tree("getNode",b);h.cancelBubble=true;h.stopPropagation();if(q.tid!=undefined){if(q.tid!=d.attributes.tid){msginfo("您拖入的"+(d.attributes.col_type==2?"度量":"维度")+"与组件已有的内容不在同一个数据表中，拖放失败。");return}}if(q.chartJson.type=="map"&&d.attributes.col_type==1&&$(this).attr("id")=="xcol"){if(!(d.attributes.dim_type=="prov"||d.attributes.dim_type=="city")){msginfo("只能拖放地域维度到横轴!");return}var f=q.chartJson.maparea;if(f=="china"){if(d.attributes.dim_type=="city"&&q.chartJson.typeIndex!="3"){msginfo("只能把省份维度拖放到全国地图上!");return}}else{if(d.attributes.dim_type=="prov"&&q.chartJson.typeIndex!="3"){msginfo("只能把地市维度拖放到 "+q.chartJson.mapAreaName+" 地图上!");return}}}q.tid=d.attributes.tid;q.tname=d.attributes.tname;var p=$(this).attr("id");var g=q.chartJson&&q.chartJson.type=="pie"&&q.chartJson.typeIndex=="3";if(d.attributes.col_type==2&&(p=="ycol"||p=="y2col"||p=="y3col")){var o={kpi_id:d.attributes.col_id,kpi_name:d.text,ydispName:d.text,col_name:d.attributes.col_name,aggre:d.attributes.aggre,fmt:d.attributes.fmt,alias:d.attributes.alias,tid:q.tid,unit:d.attributes.unit,rate:d.attributes.rate,fromCol:d.attributes.fromCol};if(p=="ycol"){q.kpiJson[0]=o}else{if(p=="y2col"){q.kpiJson[1]=o}else{q.kpiJson[2]=o}}q.chartJson.ycol={type:"kpi"};$(this).html('<span class="charttxt" title="'+d.text+'">'+d.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+d.attributes.col_id+",'"+p+"','"+d.text+"','"+q.id+"')\"></span>");curTmpInfo.isupdate=true;chartview(q,a)}else{if(d.attributes.col_type==2&&p=="ycols"){var o={kpi_id:d.attributes.col_id,kpi_name:d.text,ydispName:d.text,col_name:d.attributes.col_name,aggre:d.attributes.aggre,fmt:d.attributes.fmt,alias:d.attributes.alias,tid:q.tid,unit:d.attributes.unit,rate:d.attributes.rate,fromCol:d.attributes.fromCol};if(!q.mkpiJson){q.mkpiJson=[]}q.mkpiJson.push(o);q.chartJson.ycol={type:"kpi"};$(this).append('<div id="y'+d.attributes.col_id+'"><span class="mcharttxt" title="'+d.text+'">'+d.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+d.attributes.col_id+",'"+p+"','"+d.text+"','"+q.id+"')\"></span></div>");chartview(q,a)}else{if(d.attributes.col_type==1&&p=="xcol"){if(q.chartJson.scol!=undefined&&q.chartJson.scol.id==d.attributes.col_id){msginfo("您拖放的维度已存在于图例项中，不能拖放。");return}var c=d.attributes.grouptype;if(c!=null&&c!=""&&!g){if(q.chartJson.scol!=undefined&&q.chartJson.scol.grouptype==c){msginfo("您拖放的维度与此图形中已有维度分组相同，不能拖放。");return}}q.chartJson.xcol={id:d.attributes.col_id,dimdesc:d.text,xdispName:d.text,type:d.attributes.dim_type,colname:d.attributes.col_name,tid:q.tid,iscas:d.attributes.iscas,tableName:d.attributes.tableName,tableColKey:d.attributes.tableColKey,tableColName:d.attributes.tableColName,dimord:d.attributes.dimord,dim_name:d.attributes.dim_name,grouptype:d.attributes.grouptype,valType:d.attributes.valType,ordcol:d.attributes.ordcol,dateformat:d.attributes.dateformat,alias:d.attributes.alias,fromCol:d.attributes.fromCol};$(this).html('<span class="charttxt" title="'+d.text+'">'+d.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+d.attributes.col_id+",'xcol', '"+d.text+"','"+q.id+"')\"></span>");curTmpInfo.isupdate=true;chartview(q,a)}}}if(d.attributes.col_type==1&&p=="scol"){if(q.chartJson.xcol!=undefined&&q.chartJson.xcol.id==d.attributes.col_id){msginfo("您拖放的维度已存在于横轴中，不能拖放。");return}var c=d.attributes.grouptype;if(c!=null&&c!=""&&!g){if(q.chartJson.xcol!=undefined&&q.chartJson.xcol.grouptype==c){msginfo("您拖放的维度与此图形中已有维度分组相同，不能拖放。");return}}q.chartJson.scol={id:d.attributes.col_id,dimdesc:d.text,type:d.attributes.dim_type,colname:d.attributes.col_name,tid:q.tid,iscas:d.attributes.iscas,tableName:d.attributes.tableName,tableColKey:d.attributes.tableColKey,tableColName:d.attributes.tableColName,dimord:d.attributes.dimord,dim_name:d.attributes.dim_name,grouptype:d.attributes.grouptype,valType:d.attributes.valType,ordcol:d.attributes.ordcol,alias:d.attributes.alias,dateformat:d.attributes.dateformat,fromCol:d.attributes.fromCol};$(this).html('<span class="charttxt" title="'+d.text+'">'+d.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this,'+d.attributes.col_id+", 'scol', '"+d.text+"','"+q.id+"')\"></span>");curTmpInfo.isupdate=true;chartview(q,a)}}})}function setcharttype(h,e,g,d){if(!e){e=curTmpInfo.layoutId}var c;var a;var o;var b;var f;if(!h){c=findCompById(curTmpInfo.compId);a=c.chartJson.type;o=c.chartJson.typeIndex;b=c.chartJson.maparea;f=c.chartJson.mapAreaName}if($("#cpdailog").size()==0){$('<div id="cpdailog"></div>').appendTo("body")}$("#cpdailog").dialog({title:"选择图表类型",width:550,height:460,closed:false,cache:false,modal:true,toolbar:null,href:"ChartType.action",onLoad:function(){var p;if(h){p=1;o="1";b="china";f="全国"}else{var p=1;if(a=="line"){p=1}else{if(a=="column"){p=2}else{if(a=="pie"){p=3}else{if(a=="radar"){p=5}else{if(a=="gauge"){p=4}else{if(a=="scatter"){p=6}else{if(a=="bubble"){p=7}else{if(a=="bar"){p=8}else{if(a=="area"){p=9}else{if(a=="map"){p=10}else{if(a=="wordcloud"){p=11}else{if(a=="funnel"){p=12}else{if(a=="treeMap"){p=13}}}}}}}}}}}}}o=c.chartJson.typeIndex;if(!o){o="1"}}$(".chartselect .selleft ul li[cid='"+p+"']").addClass("select");$(".chartselect .selright .one").css("display","none");$("#cpdailog #schart"+p).css("display","block");$("#cpdailog #schart"+p+" span[index='"+o+"']").addClass("select");$(".chartselect .selleft ul li").bind("click",function(){var r=$(this).attr("cid");$(".chartselect .selleft ul li").removeClass("select");$(this).addClass("select");$(".chartselect .selright .one").css("display","none");$("#cpdailog #schart"+r).css("display","block");$(".chartselect .selright .one span.charttype").removeClass("select");$("#cpdailog #schart"+r+" span[index='1']").addClass("select");var q=$("#cpdailog #schart"+r).attr("tp");a=q;o="1"});$(".chartselect .selright .one span.charttype").bind("click",function(){$(".chartselect .selright .one span.charttype").removeClass("select");$(this).addClass("select");o=$(this).attr("index")});$("#cpdailog #maparea").val(b+","+f).bind("change",function(){var q=$(this).val().split(",");b=q[0];f=q[1]})},onClose:function(){$("#cpdailog").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){$("#cpdailog").dialog("close");if(h){insertChart(e,a,o,b,f,g,d)}else{c.chartJson.type=a;c.chartJson.typeIndex=o;if(a=="bubble"||a=="pie"||a=="gauge"||(a=="line"&&o=="2")||(a=="column"&&o=="2")){c.chartJson.scol={}}if(a!="bubble"&&a!="scatter"){c.kpiJson[1]=null;c.kpiJson[2]=null}if(a=="map"){c.chartJson.maparea=b;c.chartJson.mapAreaName=f}else{delete c.chartJson.maparea;delete c.chartJson.mapAreaName}$("#Jlayout").layout("remove","east");$("#Jlayout").layout("remove","south");delete c.colors;chartview(c,c.id)}curTmpInfo.isupdate=true}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#cpdailog").dialog("close")}}]})}function resetchart(a){$("#c_"+a+" div.cctx div.ccctx").html('<div align="center" class="tipinfo">(点击<i class="fa fa-wrench"></i>按钮设置图形)</div>')}function chartview(b,a){if((!b.mkpi||b.mkpi==false||b.mkpi=="false")&&b.kpiJson[0]==null){resetchart(a);return}if((b.mkpi==true||b.mkpi=="true")&&(b.mkpiJson&&b.mkpiJson.length==0)){resetchart(a);return}if(b.chartJson.type=="scatter"&&b.kpiJson[1]==null){resetchart(a);return}if(b.chartJson.type=="bubble"&&b.kpiJson[2]==null){resetchart(a);return}__showLoading();var b=JSON.stringify({chartJson:b.chartJson,mkpi:b.mkpi,kpiJson:b.kpiJson,mkpiJson:b.mkpiJson,tid:b.tid,id:a,colors:b.colors,compParams:b.compParams,portalParams:pageInfo.params});$.ajax({type:"POST",url:"ChartView.action",dataType:"html",data:b,contentType:"application/json",success:function(c){__hideLoading();$("#c_"+a+" div.cctx div.ccctx").html(c)},error:function(c){__hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function setChartProperty(a){if($("#compSet").size()==0){$("#Jlayout").layout("add",{region:"east",split:false,width:240,title:"图形属性设置",collapsible:false,id:"compSet",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","east")}}]})}else{$("#Jlayout").layout("panel","east").panel("setTitle","图形属性设置")}if(!a.style){a.style={}}s=a.style;var d=a.chartJson.type;var b=[];b.push({name:"图形标题",col:"title",value:(a.name?a.name:""),group:"图形属性",editor:"text"});if(d!="gauge"){b.push({name:"是否显示图例",col:"showLegend",value:(a.chartJson.showLegend?a.chartJson.showLegend:"true"),group:"图形属性",editor:{type:"checkbox",options:{on:true,off:false}}});b.push({name:"图例位置",col:"legendpos",value:(a.chartJson.legendpos?a.chartJson.legendpos:""),group:"图形属性",editor:{type:"combobox",options:{data:[{text:"右上",value:"righttop"},{text:"中上",value:"centertop"},{text:"中下",value:"centerbottom"}]}}})}if(d!="gauge"){b.push({name:"排列方式",col:"legendLayout",value:(a.chartJson.legendLayout?a.chartJson.legendLayout:""),group:"图形属性",editor:{type:"combobox",options:{data:[{text:"垂直",value:"vertical"},{text:"水平",value:"horizontal"}]}}})}if(d=="line"||d=="area"||d=="radar"){b.push({name:"是否禁用描点",col:"markerEnabled",value:(a.chartJson.markerEnabled?a.chartJson.markerEnabled:""),group:"图形属性",editor:{type:"checkbox",options:{on:true,off:false}}})}if(d=="pie"||d=="gauge"||d=="radar"||d=="map"){}else{b.push({name:"左间距",col:"marginLeft",value:(a.chartJson.marginLeft?a.chartJson.marginLeft:"65"),group:"图形属性",editor:{type:"numberspinner",options:{min:10,max:100,increment:5}}});b.push({name:"右间距",col:"marginRight",value:(a.chartJson.marginRight?a.chartJson.marginRight:"10"),group:"图形属性",editor:{type:"numberspinner",options:{min:10,max:100,increment:5}}})}if(d=="line"||d=="column"||d=="area"||d=="bar"||d=="scatter"||d=="bubble"){b.push({name:"是否显示值",col:"dataLabel",value:(a.chartJson.dataLabel?a.chartJson.dataLabel:""),group:"图形属性",editor:{type:"checkbox",options:{on:true,off:false}}})}var c=a.chartJson.typeIndex=="1"&&(d=="line"||d=="column"||d=="bar"||d=="area"||d=="radar");if(c){b.push({name:"启用多指标查询",col:"mkpi",value:(a.mkpi||a.mkpi=="true"||a.mkpi==true?a.mkpi:"false"),group:"图形属性",editor:{type:"checkbox",options:{on:true,off:false}}})}b.push({name:"数据集",col:"tname",value:(a.tname),group:"图形属性"});if(d=="pie"||d=="wordcloud"||d=="gauge"||d=="scatter"||d=="bubble"||d=="radar"||d=="map"){}else{b.push({name:"标题",col:"xdispName",value:(a.chartJson.xcol?a.chartJson.xcol.xdispName:""),group:"横轴",editor:"text"})}if(d=="pie"||d=="wordcloud"||d=="gauge"||d=="scatter"||d=="bubble"||d=="radar"||d=="map"){}else{b.push({name:"显示间隔",col:"tickInterval",value:(a.chartJson.xcol&&a.chartJson.xcol.tickInterval?a.chartJson.xcol.tickInterval:""),group:"横轴",editor:{type:"numberspinner",options:{min:0,max:20,increment:1}}})}if(d=="pie"||d=="wordcloud"||d=="gauge"||d=="scatter"||d=="bubble"||d=="radar"||d=="map"){}else{b.push({name:"旋转角度",col:"routeXaxisLable",value:(a.chartJson.xcol&&a.chartJson.xcol.routeXaxisLable?a.chartJson.xcol.routeXaxisLable:""),group:"横轴",editor:{type:"numberspinner",options:{min:0,max:360,increment:5}}})}if(d=="gauge"||d=="scatter"||d=="bubble"||d=="radar"||d=="map"){}else{b.push({name:"取Top",col:"top",value:(a.chartJson.xcol.top?a.chartJson.xcol.top:""),group:"横轴",editor:{type:"numberspinner",options:{min:1,max:100,increment:5}}})}if(d=="scatter"||d=="bubble"){b.push({name:"标题",col:"y2dispName",value:(a.kpiJson[1]!=null?a.kpiJson[1].ydispName:""),group:"横轴",editor:"text"});b.push({name:"单位",col:"unit2",value:(a.kpiJson[1]!=null?a.kpiJson[1].unit:""),group:"横轴",editor:"text"});b.push({name:"格式化",col:"fmt2",value:(a.kpiJson[1]!=null?a.kpiJson[1].fmt:""),group:"横轴",editor:{type:"combobox",options:{data:fmtJson}}});b.push({name:"度量比例",col:"rate2",value:(a.kpiJson[1]!=null?a.kpiJson[1].rate:""),group:"横轴",editor:{type:"combobox",options:{data:kpirate}}})}if(d!="pie"){b.push({name:"标题",col:"ydispName",value:(a.kpiJson[0]!=null?a.kpiJson[0].ydispName:""),group:"纵轴",editor:"text"})}b.push({name:"单位",col:"unit",value:(a.kpiJson[0]!=null?a.kpiJson[0].unit:""),group:"纵轴",editor:"text"});b.push({name:"格式化",col:"fmt",value:(a.kpiJson[0]!=null?a.kpiJson[0].fmt:""),group:"纵轴",editor:{type:"combobox",options:{data:fmtJson}}});if(d=="pie"||d=="wordcloud"||d=="scatter"||d=="bubble"||d=="map"||d=="radar"){}else{b.push({name:"最小值",col:"min",value:(a.kpiJson[0]!=null?a.kpiJson[0].min:""),group:"纵轴",editor:{type:"numberspinner",options:{increment:10}}})}if(d=="gauge"){b.push({name:"最大值",col:"max",value:(a.kpiJson[0]!=null?a.kpiJson[0].max:""),group:"纵轴",editor:{type:"numberspinner",options:{increment:10}}})}b.push({name:"度量比例",col:"rate",value:(a.kpiJson[0]!=null?a.kpiJson[0].rate:""),group:"纵轴",editor:{type:"combobox",options:{data:kpirate}}});if(d=="pie"||d=="map"){b.push({name:"是否显示标签",col:"dataLabel",value:(a.chartJson.dataLabel?a.chartJson.dataLabel:""),group:"图形属性",editor:{type:"checkbox",options:{on:true,off:false}}});if(d=="pie"){b.push({name:"标签显示内容",col:"labelType",value:(a.chartJson.labelType?a.chartJson.labelType:""),group:"图形属性",editor:{type:"combobox",options:{data:[{text:"名称",value:"n"},{text:"名称+值",value:"nv"},{text:"名称+比例",value:"np"}]}}})}}if((d=="column"||d=="line")&&(a.chartJson.typeIndex=="2"||a.chartJson.typeIndex=="4")){b.push({name:"标题",col:"y2dispName",value:(a.kpiJson[1]!=null?a.kpiJson[1].ydispName:""),group:"第二纵轴",editor:"text"});b.push({name:"单位",col:"unit2",value:(a.kpiJson[1]!=null?a.kpiJson[1].unit:""),group:"第二纵轴",editor:"text"});b.push({name:"格式化",col:"fmt2",value:(a.kpiJson[1]!=null?a.kpiJson[1].fmt:""),group:"第二纵轴",editor:{type:"combobox",options:{data:fmtJson}}});b.push({name:"度量比例",col:"rate2",value:(a.kpiJson[1]!=null?a.kpiJson[1].rate:""),group:"第二纵轴",editor:{type:"combobox",options:{data:kpirate}}});b.push({name:"合并数据",col:"mergeData",value:(a.kpiJson[1]!=null?a.kpiJson[1].mergeData:""),group:"第二纵轴",editor:{type:"checkbox",options:{on:true,off:false}}})}$("#compSet").propertygrid({showGroup:true,border:false,showHeader:false,fitColumns:false,scrollbarSize:0,onAfterEdit:function(q,g,f){var p=g.value;var e=g.col;if(e=="showLegend"||e=="legendLayout"||e=="legendpos"||e=="labelType"||e=="dataLabel"||e=="markerEnabled"||e=="marginLeft"||e=="marginRight"){if(a.chartJson[e]==undefined){a.chartJson[e]=""}if(a.chartJson[e]==p){return}a.chartJson[e]=p;chartview(a,a.id)}else{if(e=="tickInterval"||e=="routeXaxisLable"||e=="xdispName"||e=="top"){if(a.chartJson.xcol[e]==undefined){a.chartJson.xcol[e]=""}if(a.chartJson.xcol[e]==p){return}a.chartJson.xcol[e]=p;chartview(a,a.id)}else{if(e=="ydispName"||e=="unit"||e=="fmt"||e=="min"||e=="max"||e=="rate"){var h=a.kpiJson[0];if(h[e]==undefined){h[e]=""}if(h[e]==p){return}h[e]=p;chartview(a,a.id)}else{if(e=="y2dispName"||e=="unit2"||e=="fmt2"||e=="rate2"||e=="mergeData"){var h=a.kpiJson[1];if(e=="y2dispName"){if(h.ydispName==p){return}h.ydispName=p}else{if(e=="unit2"){if(h.unit==p){return}h.unit=p}else{if(e=="fmt2"){if(h.fmt==p){return}h.fmt=p}else{if(e=="rate2"){if(h.rate==p){return}h.rate=p}else{if(e=="mergeData"){if(h.mergeData==p){return}h.mergeData=p}}}}}chartview(a,a.id)}else{if(e=="mkpi"){if(a.mkpi==p){return}a.mkpi=p;chartview(a,a.id)}else{if(e=="title"){a.name=p;$("#c_"+a.id+" .ibox-title").contents().filter(function(o,r){if(r.nodeType==3){r.nodeValue=p}})}else{s[e]=p}}}}}}curTmpInfo.isupdate=true},data:b})}function chartmenu(c,f,e,a,b){var d=$(c).offset();curTmpInfo.ckid=f;curTmpInfo.tp=e;curTmpInfo.compId=b;curTmpInfo.dimname=a;if(e=="ycol"||e=="y2col"||e=="y3col"){$("#chartoptmenu").menu("enableItem",$("#m_set"))}else{$("#chartoptmenu").menu("disableItem",$("#m_set"))}$("#chartoptmenu").menu("show",{left:d.left,top:d.top-120})}function delChartKpiOrDim(){var e=curTmpInfo.tp;var d=curTmpInfo.compId;var f=curTmpInfo.ckid;var c=findCompById(d);if(e=="xcol"){c.chartJson.xcol={};$("#chartData #xcol").html('<span class="charttip">将维度拖到这里</span>');curTmpInfo.isupdate=true;chartview(c,d)}else{if(e=="ycol"){c.chartJson.ycol={};if(c.kpiJson.length>1){c.kpiJson[0]=null}else{c.kpiJson=[]}$("#chartData #ycol").html('<span class="charttip">将度量拖到这里</span>')}else{if(e=="y2col"){if(c.kpiJson.length>1){c.kpiJson[1]=null}else{c.kpiJson=[]}if(c.chartJson.type=="line"||c.chartJson.type=="column"){chartview(c,d)}$("#chartData #y2col").html('<span class="charttip">将度量拖到这里</span>')}else{if(e=="y3col"){c.kpiJson[2]=null;$("#chartData #y3col").html('<span class="charttip">将度量拖到这里</span>')}else{if(e=="scol"){c.chartJson.scol={};$("#chartData #scol").html('<span class="charttip">将维度拖到这里</span>');curTmpInfo.isupdate=true;chartview(c,d)}else{if(e=="ycols"){$("#chartData #ycols #y"+f).remove();var a=-1;for(i=0;i<c.mkpiJson.length;i++){var b=c.mkpiJson[i];if(b.kpi_id==f){a=i;break}}c.mkpiJson.splice(a,1);chartview(c,d)}}}}}}}function chartsort(e){var d=curTmpInfo.tp;var c=curTmpInfo.compId;var f=curTmpInfo.ckid;var b=findCompById(c);if(d=="xcol"){delete b.kpiJson[0].sort;b.chartJson.xcol.dimord=e}else{if(d=="ycol"){b.kpiJson[0].sort=e}else{if(d=="scol"){delete b.kpiJson[0].sort;b.chartJson.scol.dimord=e}else{if(d=="ycols"){for(var a=0;a<b.mkpiJson.length;a++){delete b.mkpiJson[a].sort}var a=findKpiById(f,b.mkpiJson);a.sort=e}}}}curTmpInfo.isupdate=true;chartview(b,c)}function chartfilterDims(){var g=curTmpInfo.tp;var f=curTmpInfo.ckid;var h=curTmpInfo.compId;var b=curTmpInfo.dimname;var e=findCompById(h);var d=null;if(g=="xcol"){d=e.chartJson.xcol}else{if(g=="scol"){d=e.chartJson.scol}else{if(g=="ycols"){return kpiFilter("chart",true)}else{return kpiFilter("chart")}}}$("#pdailog").dialog({title:b+" - 维度筛选",width:300,height:345,closed:false,cache:false,modal:true,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var t=$("#dimfiltertab").tabs("getSelected");var r=$("#dimfiltertab").tabs("getTabIndex",t);if("day"==d.type&&r==0){var q=$("#dimfiltertab #dft2").val();var p=$("#dimfiltertab #dft1").val();if(Number(q.replace(/-/g,""))>Number(p.replace(/-/g,""))){msginfo("您选择的开始日期不能大于结束日期。");return}d.startdt=q;d.enddt=p;d.filtertype=1;delete d.vals}else{if("month"==d.type&&r==0){var q=$("#dimfiltertab #dfm2").val();var p=$("#dimfiltertab #dfm1").val();if(Number(q)>Number(p)){msginfo("您选择的开始月份不能大于结束月份。");return}d.startmt=q;d.endmt=p;d.filtertype=1;delete d.vals}else{var u="";var v=$("#pdailog input[name='dimval']:checkbox:checked");v.each(function(x,w){u=u+$(this).val();if(x!=v.size()-1){u=u+","}});d.vals=u;d.filtertype=2;delete d.startmt;delete d.endmt;delete d.startdt;delete d.enddt}}curTmpInfo.isupdate=true;chartview(e,h);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});var c=d.type;var o=d;var a="../bireport/DimFilter.action?tid="+e.tid+"&id="+f+"&dateformat="+d.dateformat+"&vals="+d.vals;if(c=="month"){a=a+"&st="+(o.startmt==undefined?"":o.startmt);a=a+"&end="+(o.endmt==undefined?"":o.endmt)}if(c=="day"){a=a+"&st="+(o.startdt==undefined?"":o.startdt);a=a+"&end="+(o.enddt==undefined?"":o.enddt)}$("#pdailog").dialog("refresh",a)}function kpiFilter(g,a){var e=curTmpInfo.ckid;var h=curTmpInfo.compId;var d=findCompById(h);var f=findKpiById(e,a?d.mkpiJson:d.kpiJson);var b=f.filter;var c="";if(f.rate==1000){c="千"}else{if(f.rate==10000){c="万"}else{if(f.rate==1000000){c="百万"}else{if(f.rate==100000000){c="亿"}}}}var o="<div style='margin:5px;'><br/> "+f.kpi_name+' &nbsp; <select id="ftype" class="inputform2" style="width:80px;"><option value=""></option><option value=">" '+(b&&b.filterType==">"?"selected":"")+'>大于</option><option value="<" '+(b&&b.filterType=="<"?"selected":"")+'>小于</option><option value="=" '+(b&&b.filterType=="="?"selected":"")+'>等于</option><option value="between" '+(b&&b.filterType=="between"?"selected":"")+'>区间</option></select> &nbsp; <input type="text" id="startval" size="5" value="'+(b?b.val1:"")+'"><span id="endvalspan" style="display:'+(b&&b.filterType=="between"?"inline":"none")+'"> - <input type="text" id="endval" size="5" value="'+(b?b.val2:"")+'"></span>'+c+f.unit+'<br/><button id="clear" class="btn btn-info btn-xs">清除筛选</button></div>';$("#pdailog").dialog({title:"度量筛选",width:330,height:180,closed:false,cache:false,modal:true,toolbar:null,content:o,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var t=$("#pdailog #ftype").val();var p=$("#pdailog #startval").val();var r=$("#pdailog #endval").val();if(t==""||p==""){delete f.filter}else{var q={kpi:f.kpi_id,filterType:t,val1:Number(p),val2:(r==""?0:Number(r))};f.filter=q}$("#pdailog").dialog("close");curTmpInfo.isupdate=true;if(g=="table"){tableView(d,h)}else{if(g=="chart"){chartview(d,h)}}}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #startval,#pdailog #endval").numberbox({width:80,height:30});$("#pdailog #ftype").bind("change",function(){var p=$(this);if(p.val()=="between"){$("#pdailog #endvalspan").css("display","inline")}else{$("#pdailog #endvalspan").css("display","none")}});$("#pdailog #clear").bind("click",function(){$("#pdailog #ftype").val("");$("#pdailog #startval").numberbox("clear");$("#pdailog #endval").numberbox("clear")})}function setChartKpi(){var g=curTmpInfo.tp;if(g=="xcol"||g=="scol"){return}var c=curTmpInfo.ckid;var e=curTmpInfo.compId.replace("T","");var d=curTmpInfo.dimname;var b=findCompById(e);var f=null;if(g=="ycol"){f=b.kpiJson[0]}else{if(g=="y2col"){f=b.kpiJson[1]}else{if(g=="y3col"){f=b.kpiJson[2]}}}var a="<div style='line-height:25px; margin:5px;'><span class=\"inputtext\">度量名称：</span>"+f.kpi_name+'<br><span class="inputtext">所 属 表： </span>'+b.tname+"<br><span class=\"inputtext\">度量单位：</span><select id=\"kpiunit\" name=\"kpiunit\" class=\"inputform2\"><option value='1'></option><option value='1000'>千</option><option value='10000'>万</option><option value='1000000'>百万</option><option value='100000000'>亿</option></select>"+f.unit+'<br><span class="inputtext">格 式 化：</span><select id="fmt" name="fmt" class="inputform2"><option value=""></option><option value="#,###,##0">整数</option><option value="###,##0.0">小数</option><option value="0.00%">百分比</option></select></div>';$("#pdailog").dialog({title:"度量属性",width:340,height:260,closed:false,cache:false,modal:true,content:a,toolbar:null,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){f.fmt=$("#pdailog #fmt").val();f.rate=Number($("#pdailog #kpiunit").val());$("#pdailog").dialog("close");curTmpInfo.isupdate=true;chartview(b,e)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #fmt").find("option[value='"+f.fmt+"']").attr("selected",true);$("#pdailog #kpiunit").find("option[value='"+f.rate+"']").attr("selected",true)}function findDimById(c,d){var a=null;if(!d||d==null){return a}for(var b=0;b<d.length;b++){if(d[b].id==c){a=d[b];break}}return a}function uploadImage(c,d){var b=findCompById(c);var a='<div class="textpanel"><form enctype="multipart/form-data"  action="ImgUpload.action" target="imgframe" method="post" onsubmit="if(this.file.value==\'\'){alert(\'请选择文件\');return false;}"><input type="hidden" name="compId" value="'+c+'"><span class=\'inputtext\'>网络图片：</span><input type="text" class="inputform" placeholder="录入图片完整地址" id="picurl"><br/> ->或-><br/><input type="file" id="file" name="file"><input type="submit" value="上传"></form><iframe  name="imgframe" width="100%" height="20" frameborder="0"></iframe></div>';$("#pdailog").dialog({title:"添加图片",width:490,height:240,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var e=$("#pdailog #picurl").val();if(e==""){msginfo("请录入图片完整地址。");return}b.picurl=e;b.picType="net";$("#c_"+c+" div.ccctx").html("<img id='pic"+c+"' src='"+e+"'>");window.setTimeout(function(){var f=document.getElementById("pic"+c);var o=f.width;var g=f.height;b.width=o;b.height=g},500);curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}function readPicPath(c,b){var a=findCompById(b);a.picurl=c;a.picType="local";$("#c_"+b+" div.ccctx").html("<img id='pic"+b+"' src='img/"+a.picurl+".action'>");window.setTimeout(function(){var d=document.getElementById("pic"+b);var f=d.width;var e=d.height;a.width=f;a.height=e;curTmpInfo.isupdate=true;$("#pdailog").dialog("close")},500)}function setPicProperty(a){if($("#compSet").size()==0){$("#Jlayout").layout("add",{region:"east",split:false,width:240,title:"图片属性配置",collapsible:false,id:"compSet",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","east")}}]})}else{$("#Jlayout").layout("panel","east").panel("setTitle","图片属性配置")}$("#compSet").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,fitColumns:false,onAfterEdit:function(f,d,c){var e=d.value;var b=d.col;curTmpInfo.isupdate=true;a[b]=e;if(b=="name"){a.name=e;$("#c_"+a.id+" .ibox-title").contents().filter(function(g,h){if(h.nodeType==3){h.nodeValue=e}})}},data:[{name:"是否显示标题",col:"showtitle",value:(a.showtitle?a.showtitle:"true"),group:"图片属性",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"标题",col:"name",value:(a.name?a.name:""),group:"图片属性",editor:"text"}]})}function setSeriesColor(g,f,r,q,p,o){var h=findCompById(o);if(h.chartJson.type=="pie"||h.chartJson.type=="map"||h.chartJson.type=="treeMap"){return}$.getJSON("chartColors.action",{},function(b){var c=[];for(i=0;i<b.length;i++){if(h.colors&&i+1==h.colors[q]){c.push('<span class="selcolor">')}c.push('<span style="background-color:'+b[i]+';" idx="'+(i+1)+'" class="seriesColor"></span>');if(h.colors&&i+1==h.colors[q]){c.push("</span>")}}var a=c.join(" ")+'<br/><button class="btn btn-info btn-sm">使用默认色</button>';$("#pdailog").dialog({title:q+" - 设置系列颜色",width:380,height:240,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog .seriesColor").click(function(){var d=$(this).attr("idx");if(!h.colors){h.colors={}}h.colors[q]=d;curTmpInfo.isupdate=true;$("#pdailog").dialog("close");chartview(h,o)});$("#pdailog button").click(function(){if(h.colors){delete h.colors[q];$("#pdailog").dialog("close");chartview(h,o)}})})}if($==undefined){$=jQuery}var fmtJson=[{text:"整数",value:"#,##0"},{text:"小数(保留一位)",value:"#,##0.0"},{text:"小数(保留两位)",value:"#,##0.00"},{text:"小数(保留四位)",value:"#,##0.0000"},{text:"百分比",value:"#,##0.00%"}];var kpirate=[{text:"1",value:"1"},{text:"千",value:"1000"},{text:"万",value:"10000"},{text:"百万",value:"1000000"},{text:"亿",value:"100000000"}];var colorJson=[{text:"无",value:""},{text:"黑色",value:"#000000"},{text:"白色",value:"#FFFFFF"},{text:"红色",value:"#FF0000"},{text:"鲜绿色",value:"#00FF00"},{text:"蓝色",value:"#0000FF"},{text:"黄色",value:"#FFFF00"},{text:"粉红色",value:"#FF00FF"},{text:"青绿色",value:"#00FFFF"},{text:"深红色",value:"#800000"},{text:"绿色",value:"#008000"},{text:"深蓝色",value:"#000080"},{text:"深黄色",value:"#808000"},{text:"紫罗兰",value:"#800080"},{text:"青色",value:"#008080"},{text:"灰－25％",value:"#C0C0C0"},{text:"灰－50％",value:"#808080"},{text:"海螺色",value:"#9999FF"},{text:"梅红色",value:"#993366"},{text:"象牙色",value:"#FFFFCC"},{text:"浅青绿",value:"#CCFFFF"},{text:"深紫色",value:"#660066"},{text:"珊瑚红",value:"#FF8080"},{text:"海蓝色",value:"#0066CC"},{text:"冰蓝",value:"#CCCCFF"},{text:"深蓝色",value:"#000080"},{text:"粉红色",value:"#FF00FF"},{text:"黄色",value:"#FFFF00"},{text:"青绿色",value:"#00FFFF"},{text:"紫罗兰",value:"#800080"},{text:"深红色",value:"#800000"},{text:"青色",value:"#008080"},{text:"蓝色",value:"#0000FF"},{text:"天蓝色",value:"#00CCFF"},{text:"浅青绿",value:"#CCFFFF"},{text:"浅绿色",value:"#CCFFCC"},{text:"浅黄色",value:"#FFFF99"},{text:"淡蓝色",value:"#99CCFF"},{text:"玫瑰红",value:"#FF99CC"},{text:"淡紫色",value:"#CC99FF"},{text:"茶色",value:"#FFCC99"},{text:"浅蓝色",value:"#3366FF"},{text:"水绿色",value:"#33CCCC"},{text:"酸橙色",value:"#99CC00"},{text:"金色",value:"#FFCC00"},{text:"浅橙色",value:"#FF9900"},{text:"橙色",value:"#FF6600"},{text:"蓝－灰",value:"#666699"},{text:"灰－40％",value:"#969696"},{text:"深青",value:"#003366"},{text:"海绿",value:"#339966"},{text:"深绿",value:"#003300"},{text:"橄榄色",value:"#333300"},{text:"褐色",value:"#993300"},{text:"梅红色",value:"#993366"},{text:"靛蓝色",value:"#333399"},{text:"灰－80％",value:"#333333"}];function flushPage(){for(var a=0;curTmpInfo.comps&&a<curTmpInfo.comps.length;a++){var b=curTmpInfo.comps[a].type;if(b=="table"){tableView(curTmpInfo.comps[a],curTmpInfo.comps[a].id)}else{if(b=="chart"){chartview(curTmpInfo.comps[a],curTmpInfo.comps[a].id)}else{if(b=="box"){boxView(curTmpInfo.comps[a])}else{if(b=="grid"){gridView(curTmpInfo.comps[a])}}}}}}function insertText(d,a,c,f,e){$("#pdailog").dialog({title:"请输入文本内容 - 文本框",width:490,height:240,closed:false,cache:false,modal:true,toolbar:null,content:'<div class="textpanel"><textarea name="txtctx" id="txtctx" style="width:450px;height:145px;line-height:20px;"></textarea></div>',buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){if(d=="insert"){var g=$("#txtctx").val();var o={id:newGuid(),type:"text",name:"文本",desc:g};var p=addComp(o,a,true);p=p.replace(/\n/g,"<br>");if(!f){$("#layout_"+a).append(p)}else{if(e=="before"){$("#"+f).before(p)}else{$("#"+f).after(p)}}$("#optarea").scrollTop($("#c_"+o.id).offset().top);bindCompEvent(o);bindResizeEvent(o.id,"text")}if(d=="update"){var g=$("#txtctx").val();var h=findCompById(c);h.desc=g;$("#c_"+c+" div.cctx").html(g.replace(/\n/g,"<br>"))}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});if(d=="update"){var b=findCompById(c);$("#txtctx").val(b.desc)}$("#txtctx").focus()}function addComp(c,f,h){var o=c;var b=findLayoutById(f);if(h){if(!b.children){b.children=[]}b.children.push(o);if(!curTmpInfo.comps){curTmpInfo.comps=[]}curTmpInfo.comps.push(o)}var g="";if(o.style){var a=o.style;if(o.style.talign&&o.style.talign!=""&&o.type!="input"){g=g+"text-align:"+o.style.talign+";"}if(o.style.tfontsize&&o.style.tfontsize!=""){g=g+"font-size:"+o.style.tfontsize+"px;"}if(o.style.tfontcolor&&o.style.tfontcolor!=""){g=g+"color:"+o.style.tfontcolor+";"}if(a.tfontweight&&a.tfontweight=="true"){g=g+"font-weight:bold;"}if(a.titalic&&a.titalic=="true"){g=g+"font-style:italic;"}if(a.tunderscore&&a.tunderscore=="true"){g=g+"text-decoration: underline;"}if(a.tbgcolor&&a.tbgcolor!=""){g=g+"background-color:"+a.tbgcolor+";"}if(a.tlineheight&&a.tlineheight!=""){g=g+"line-height:"+a.tlineheight+"px;"}}g=g+"padding:3px;";if(o.type=="box"&&o.bgcolor&&o.bgcolor!=""){g=g+"background-color:"+o.bgcolor+";"}if((o.type=="box"||o.type=="text"||o.type=="pic")&&o.height){g=g+"height:"+(o.height+8)+"px;"}var e='<div class="ibox" id="c_'+o.id+'"><div class="ibox-title">'+o.name+'<div class="ibox-tools"> <button class="btn btn-outline btn-success btn-xs" onclick="showcompmenu(this,\''+f+"','"+c.id+'\')" title="设置组件" ><i class="fa fa-wrench"></i></button> '+(curTmpInfo.compEdit?"":'<button class="btn btn-outline btn-danger btn-xs" onclick="deletecomp(\''+f+"', '"+c.id+'\');" title="删除组件" cid="'+o.id+'"><i class="fa fa-times"></i></button>')+'</div></div><div class="cctx ibox-content" style="'+g+'"><div class="ccctx">';if(o.type=="text"){e=e+c.desc.replace(/\n/g,"<br>")}else{if(o.type=="table"){var d='<div align="center" class="tipinfo">(点击<i class="fa fa-wrench"></i>按钮设置交叉表)</div>';e=e+d}else{if(o.type=="chart"){var d='<div align="center" class="tipinfo">(点击<i class="fa fa-wrench"></i>按钮设置图形)</div>';e=e+d}else{if(o.type=="grid"){var d='<div align="center" class="tipinfo">(点击<i class="fa fa-wrench"></i>按钮设置表格)</div>';e=e+d}else{if(o.type=="box"){var d='<div align="center" class="tipinfo">(点击<i class="fa fa-wrench"></i>按钮设置数据块)</div>';e=e+d}else{if(o.type=="pic"){var d=null;if(o.picType){d='<img src="'+(o.picType=="local"?"img/"+o.picurl+".action":o.picurl)+'" id="pic'+o.id+'" style="'+(o.height?"height:"+o.height+"px;":"")+(o.width?"width:"+o.width+"px;":"")+'">'}else{d='<div align="center" class="tipinfo">(点击<i class="fa fa-wrench"></i>按钮添加图片)</div>'}e=e+d}}}}}}e=e+'</div><div class="win-size-grip"></div></div></div>';return e}function showcompmenu(e,a,d){var f=$(e).offset();var b="";var c=findCompById(d);if(c.type=="chart"){b="chart_menu"}else{if(c.type=="table"){b="table_menu"}else{if(c.type=="text"){b="text_menu"}else{if(c.type=="grid"){b="grid_menu"}else{if(c.type=="box"){b="box_menu"}else{if(c.type=="pic"){b="pic_menu"}}}}}}curTmpInfo.layoutId=a;curTmpInfo.compId=d;$("#"+b).menu("show",{left:f.left,top:f.top+25})}function bindResizeEvent(a,b){if(curTmpInfo.compEdit){return}$("#c_"+a+" .cctx").myresizable({handleSelector:"> .win-size-grip",resizeWidth:false,resizeHeight:true,resizeHeightFrom:"bottom",onDrag:function(f,d,c){if(b=="box"){d.find(".boxcls").css("line-height",d.height()+"px")}},onDragEnd:function(r,v,p,d,f){var u=findCompById(a);var q=Math.round((v.height())/10)*10;v.animate({height:(q+8)+"px"});if(u.type=="chart"){u.chartJson.height=q;var g=document.getElementById("C"+a);if(g){var t=echarts.getInstanceByDom(g);$("#C"+a).height((q)+"px");t.resize("auto","auto")}}else{if(u.type=="box"){u.height=q}else{if(u.type=="table"){u.height=q-26;$("#c_"+a+" .lock-dg-body").animate({height:u.height+"px"})}else{if(u.type=="grid"){u.height=(q-25-(u.isnotfy=="true"?0:35));$("#c_"+a+" .lock-dg-body").animate({height:u.height+"px"})}else{if(u.type=="text"){u.height=q}else{if(u.type=="pic"){if(u.height&&u.width){u.width=Math.round(u.width*q/u.height)}u.height=q;$("#c_"+a+" .cctx img").animate({height:(u.height)+"px",width:u.width})}}}}}}curTmpInfo.isupdate=true}})}function bindCompEvent(a){$("#c_"+a.id).draggable({revert:true,handle:$("#c_"+a.id+" div.ibox-title"),delay:180,proxy:function(d){var c=$(d).width();var b=$(d).height();var e=$('<div style="border:1px solid #999999;background-color:#cccccc; opacity:0.8; filter:alpha(opacity=50); width:'+c+"px; height:"+b+'px;">'+a.name+"</div>");e.appendTo("body");return e},onStartDrag:function(b){resetWindows("min");$(this).hide()},onStopDrag:function(b){$(".indicator").hide();resetWindows("max");$(this).show()}});$("#c_"+a.id).droppable({accept:"div.ibox, #comp_tree .tree-node",onDragEnter:function(c,b){curTmpInfo.mouseOnDiv=true;curTmpInfo.id=$(this).attr("id");curTmpInfo.tp="before";$(".indicator").css({display:"block",left:$(this).offset().left,top:$(this).offset().top-10});c.cancelBubble=true;c.stopPropagation()},onDragLeave:function(f,c){curTmpInfo.mouseOnDiv=false;var d=$(this).parent();var b=d.children().last();if(b.attr("id")==$(c).attr("id")){b=b.prev()}if(b.size()==0){$(".indicator").css({display:"block",left:d.offset().left,top:d.offset().top-10})}else{curTmpInfo.id=b.attr("id");curTmpInfo.tp="after";$(".indicator").css({display:"block",left:b.offset().left,top:b.offset().top+b.height()})}f.cancelBubble=true;f.stopPropagation()},onDrop:function(c,b){c.cancelBubble=true;c.stopPropagation()}})}function shareComp(){var b=curTmpInfo.compId;if(!b){msginfo("分析图为空");return}var a=findCompById(b);var c="";if(a.type=="box"){c="fa fa-square-o"}else{if(a.type=="chart"){c="fa fa-line-chart";delete a.chartJson.link;delete a.chartJson.linkAccept}else{if(a.type=="table"){c="fa fa-table";delete a.link;delete a.linkAccept}else{if(a.type=="grid"){c="fa fa-list-alt"}}}}$.ajax({type:"POST",url:"../dashboard/share/save.action",data:{cfg:JSON.stringify(a),compIcon:c,title:a.name,id:a.id},dataType:"json",success:function(d){if(d.result==1){msginfo("分析图保存成功！您可以在添加已有分析图中看到保存的分析图。","suc")}else{msginfo(d.msg)}}})}function editComp(a,c){if(!a){a=curTmpInfo.layoutId}if(!c){c=curTmpInfo.compId}$("#Jlayout").layout("remove","east");var b=findCompById(c);if(b.type=="text"){insertText("update",a,c)}else{if(b.type=="table"){editTableData(c)}else{if(b.type=="chart"){editChartData(c,a)}else{if(b.type=="input"){editInputData(b)}else{if(b.type=="grid"){editGridData(c)}else{if(b.type=="box"){editBoxData(c)}else{if(b.type=="pic"){uploadImage(c,"insert")}}}}}}}}function setComp(a,c){if(!a){a=curTmpInfo.layoutId}if(!c){c=curTmpInfo.compId}$("#Jlayout").layout("remove","south");var b=findCompById(c);if(b.type=="text"){setTextProperty(b)}else{if(b.type=="table"){setTableProperty(b)}else{if(b.type=="chart"){setChartProperty(b)}else{if(b.type=="input"){setInputProperty(b)}else{if(b.type=="grid"){setGridProperty(b)}else{if(b.type=="box"){setBoxProperty(b)}else{if(b.type=="pic"){setPicProperty(b)}}}}}}}}function editTableData(e){if($("#dataProperty").size()==0){$("#Jlayout").layout("add",{region:"south",id:"dataProperty",split:false,collapsible:false,height:120,title:"编辑交叉表数据",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","south")}}]})}else{$("#Jlayout").layout("panel","south").panel("setTitle","编辑交叉表数据")}$("#comp_tab").tabs("select",(!curTmpInfo.compEdit?1:0));var c=findCompById(e);var g="";for(var d=0;c&&c.rows&&d<c.rows.length;d++){g=g+'<span id="d_'+c.rows[d].id+'" class="dimcol"><span class="text">'+c.rows[d].dimdesc+'</span><div class="ibox-tools"><button class="btn btn-outline btn-success btn-xs" onclick="setRdimInfo(this, '+c.rows[d].id+", '"+c.rows[d].dimdesc+"','"+e+'\')"><i class="fa fa-wrench"></i></button></div></span>'}for(var d=0;c.kpiJson&&d<c.kpiJson.length;d++){g=g+'<span id="k_'+c.kpiJson[d].kpi_id+'" class="col"><span class="text">'+c.kpiJson[d].kpi_name+'</span><div class="ibox-tools"><button class="btn btn-outline btn-success btn-xs" onclick="setKpiInfo(this,'+c.kpiJson[d].kpi_id+",'"+e+'\');"><i class="fa fa-wrench"></i></button></div></span>'}if(g==""){g='<div class="tipinfo">拖拽立方体维度或度量到此处作为交叉表的字段</div>'}else{g='<span id="tabRows"><b>交叉表字段：</b>'+g+"</span>"}var b="";for(var d=0;c&&c.cols&&d<c.cols.length;d++){var f=c.cols[d];b=b+'<span id="d_'+f.id+'" class="dimcol"><span class="text">'+f.dimdesc+'</span><div class="ibox-tools"><button class="btn btn-outline btn-success btn-xs" onclick="setCdimInfo(this, '+f.id+", '"+f.dimdesc+"','"+e+'\')"><i class="fa fa-wrench"></i></button></div></span>'}if(b!=""){b='<span id="tabCols"> &nbsp; &nbsp; <b>列字段：</b>'+b+"</span>"}var a='<div style="margin:10px;"><div class="tableDatasty" id="tableData">'+g+b+"</div></div>";$("#dataProperty").html(a);$("#tableData").droppable({accept:"#datasettree .tree-node",onDragEnter:function(p,o){var h=$("#datasettree").tree("getNode",o);var q=h.attributes.col_type;$(o).draggable("proxy").find("span").removeClass("tree-dnd-no");$(o).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#tableData").css("border","1px solid #ff0000");p.cancelBubble=true;p.stopPropagation()},onDragLeave:function(o,h){$(h).draggable("proxy").find("span").addClass("tree-dnd-no");$(h).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#tableData").css("border","1px dotted #666");o.cancelBubble=true;o.stopPropagation()},onDrop:function(r,p){var u=e;var h=findCompById(u);r.cancelBubble=true;r.stopPropagation();$("#tableData").css("border","1px dotted #666");var o=$("#datasettree").tree("getNode",p);if(h.tid!=undefined){if(h.tid!=o.attributes.tid){msginfo("您拖入的"+(o.attributes.col_type==2?"度量":"维度")+"与组件已有的内容不在同一个数据表中，拖放失败。");return}}h.tid=o.attributes.tid;h.tname=o.attributes.tname;h.ttype=o.attributes.ttype;if(h.kpiJson==undefined){h.kpiJson=[]}if(h.cols==undefined){h.cols=[]}if(!h.rows){h.rows=[]}if(o.attributes.col_type==2){if(!kpiExist(o.attributes.col_id,h.kpiJson)){h.kpiJson.push({kpi_id:o.attributes.col_id,kpi_name:o.text,col_name:o.attributes.col_name,aggre:o.attributes.aggre,fmt:o.attributes.fmt,alias:o.attributes.alias,tid:h.tid,unit:o.attributes.unit,rate:o.attributes.rate,fromCol:o.attributes.fromCol})}else{msginfo("度量已经存在。");return}var t='<span id="k_'+o.attributes.col_id+'" class="col"><span class="text">'+o.text+'</span><div class="ibox-tools"><button class="btn btn-outline btn-success btn-xs" onclick="setKpiInfo(this,'+o.attributes.col_id+",'"+h.id+'\');"><i class="fa fa-wrench"></i></button></div></span>';var q=$("#tableData");if(q.find("#tabRows").size()==0){q.html('<span id="tabRows"><b>交叉表字段：</b>'+t+"</span>")}else{if($("#tableData #tabRows").find("span.col").size()==0){$("#tableData #tabRows").append(t)}else{$("#tableData #tabRows").find("span.col").last().after(t)}}curTmpInfo.isupdate=true;tableView(h,u)}if(o.attributes.col_type==1){if(!dimExist(o.attributes.col_id,h.rows)&&!dimExist(o.attributes.col_id,h.cols)){h.rows.push({id:o.attributes.col_id,dimdesc:o.text,type:o.attributes.dim_type,colname:o.attributes.col_name,tid:h.tid,iscas:o.attributes.iscas,tableName:o.attributes.tableName,tableColKey:o.attributes.tableColKey,tableColName:o.attributes.tableColName,dimord:o.attributes.dimord,dim_name:o.attributes.dim_name,grouptype:o.attributes.grouptype,valType:o.attributes.valType,ordcol:o.attributes.ordcol,alias:o.attributes.alias,fromCol:o.attributes.fromCol})}else{msginfo("维度已经存在。");return}var t='<span id="d_'+o.attributes.col_id+'" class="dimcol"><span class="text">'+o.text+'</span><div class="ibox-tools"><button class="btn btn-outline btn-success btn-xs" onclick="setRdimInfo(this, '+o.attributes.col_id+", '"+o.text+"','"+h.id+'\')"><i class="fa fa-wrench"></i></button></div></span>';var q=$("#tableData");if(q.find("#tabRows").size()==0){q.html('<span id="tabRows"><b>交叉表字段：</b>'+t+"</span>")}else{if($("#tableData #tabRows").find("span.dimcol").size()==0){$("#tableData #tabRows").find("b").after(t)}else{$("#tableData #tabRows").find("span.dimcol").last().after(t)}}curTmpInfo.isupdate=true;tableView(h,u)}}})}function delJsonKpiOrDim(e){var a=curTmpInfo.ckid;var o=curTmpInfo.compId;var c=findCompById(o);var d=curTmpInfo.pos;if(e=="kpi"){var h=c.kpiJson;var g=-1;for(var b=0;b<h.length;b++){if(h[b].kpi_id==a){g=b;break}}h.splice(g,1);$("#tableData #k_"+a).remove()}if(e=="dim"){var f=null;if(d=="col"){f=c.cols}else{f=c.rows}var g=-1;for(var b=0;b<f.length;b++){if(f[b].id==a){g=b;break}}f.splice(g,1);$("#tableData #d_"+a).remove();if(d=="col"){if(f.length==0){$("#tableData #tabCols").remove()}}else{if(d=="row"){if(f.length==0){}}}}curTmpInfo.isupdate=true;tableView(c,o)}function setTableProperty(a){if($("#compSet").size()==0){$("#Jlayout").layout("add",{region:"east",split:false,width:240,title:"交叉表属性配置",collapsible:false,id:"compSet",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","east")}}]})}else{$("#Jlayout").layout("panel","east").panel("setTitle","交叉表属性配置")}if(!a.style){a.style={}}if(!a.cols){a.cols=[]}if(!a.rows){a.rows=[]}var b=a.style;$("#compSet").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,fitColumns:false,onAfterEdit:function(g,e,d){var f=e.value;var c=e.col;curTmpInfo.isupdate=true;if(c=="name"){a.name=f;$("#c_"+a.id+" .ibox-title").contents().filter(function(h,o){if(o.nodeType==3){o.nodeValue=f}})}else{if(c=="showtitle"){a.showtitle=f}else{if(c=="height"){a[c]=f;tableView(a,a.id)}}}},data:[{name:"交叉表标题",col:"name",value:(a.name?a.name:""),group:"交叉表属性",editor:"text"},{name:"是否显示标题",col:"showtitle",value:(a.showtitle?a.showtitle:"true"),group:"交叉表属性",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"交叉表下钻",col:"xxx",value:'<div align="center"><button class="btn btn-success btn-xs" onclick="crossdrill(\''+a.id+'\')"><i class="fa fa-wrench"></i>设置</button></div>',group:"交叉表属性"},{name:"数据集",col:"tname",value:(a.tname),group:"交叉表属性"}]})}function crossdrill(d){var c=findCompById(d);if(c.rows.length!=1){msginfo("交叉表行标签只有一个维度的时候才能配置交叉表钻取。");return}var a;if(!c.drillDim){c.drillDim=[]}else{a=c.drillDim[0]}var g=null;var e='<option value="">--不启用--</option>';$.ajax({type:"post",url:"../model/cubeInfo.action",data:{tableId:c.tid},dataType:"json",async:false,success:function(q){g=q.dims;for(k=0;k<g.length;k++){var o=g[k].dimdesc;var r=g[k].colname;var p=g[k].alias;e=e+'<option value="'+p+'" '+(a&&a.code==p?"selected":"")+">"+o+"</option>"}}});var h=function(q){var o=null;for(k=0;k<g.length;k++){var p=g[k];if(p.alias==q){o=p;break}}return o};var f=c.rows[0];var b='<div class="textpanel">当前交叉表行维度：'+f.dimdesc+'<br/> <span class="inputtext">钻取维度：</span><select id="drillDim" name="drillDim" class="inputform2">'+e+"</select></div>";$("#pdailog").dialog({title:"交叉表钻取配置",width:330,height:200,closed:false,cache:false,modal:true,content:b,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var o=$("#pdailog #drillDim").val();if(o==""){delete c.drillDim}else{var p=h(o);c.drillDim[0]={name:p.dimdesc,code:p.alias,type:p.type,tableColKey:p.tableColKey,tableColName:p.tableColName,dimord:p.dimord,colname:p.colname,fromCol:p.fromCol}}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}function setTextProperty(a){if($("#compSet").size()==0){$("#Jlayout").layout("add",{region:"east",split:false,width:240,title:"文本属性配置",collapsible:false,id:"compSet",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","east")}}]})}else{$("#Jlayout").layout("panel","east").panel("setTitle","文本属性配置")}if(!a.style){a.style={}}s=a.style;$("#compSet").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,fitColumns:false,onAfterEdit:function(g,d,c){var f=d.value;var b=d.col;curTmpInfo.isupdate=true;if(b=="name"){a.name=f;$("#c_"+a.id+" .ibox-title").contents().filter(function(h,o){if(o.nodeType==3){o.nodeValue=f}})}else{if(b=="showtitle"){a.showtitle=f}else{a.style[b]=f;var e=$("#c_"+a.id+" .cctx");if(b=="tfontsize"){if(f==""){e.css("font-size","inherit")}else{e.css("font-size",f+"px")}}else{if(b=="talign"){e.css("text-align",f)}else{if(b=="tfontcolor"){e.css("color",f)}else{if(b=="tfontweight"){if(f=="true"){e.css("font-weight","bold")}else{e.css("font-weight","normal")}}else{if(b=="titalic"){if(f=="true"){e.css("font-style","italic")}else{e.css("font-style","normal")}}else{if(b=="tunderscore"){if(f=="true"){e.css("text-decoration","underline")}else{e.css("text-decoration","inherit")}}else{if(b=="tbgcolor"){if(f==""){e.css("background-color","inherit")}else{e.css("background-color",f)}}else{if(b=="tlineheight"){if(f==""||f==null){e.css("line-height","inherit")}else{e.css("line-height",f+"px")}}}}}}}}}}}},data:[{name:"是否显示标题",col:"showtitle",value:(a.showtitle?a.showtitle:"true"),group:"文本属性",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"标题",col:"name",value:(a.name?a.name:""),group:"文本属性",editor:"text"},{name:"位置",col:"talign",value:(s.talign?s.talign:""),group:"文本属性",editor:{type:"combobox",options:{data:[{value:"left",text:"left"},{value:"center",text:"center"},{value:"right",text:"right"}]}}},{name:"背景颜色",col:"tbgcolor",value:(s.tbgcolor?s.tbgcolor:""),group:"文本属性",editor:{type:"combobox",options:{data:colorJson,formatter:function(b){return'<div style="background-color:'+b.value+'">'+b.text+"</div>"}}}},{name:"行高(lineHeight)",col:"tlineheight",value:(s.tlineheight?s.tlineheight:""),group:"文本属性",editor:{type:"numberspinner",options:{min:10,max:100,increment:5}}},{name:"字体大小",col:"tfontsize",value:(s.tfontsize?s.tfontsize:""),group:"文本字体",editor:{type:"numberspinner",options:{min:9,max:100,increment:5}}},{name:"字体颜色",col:"tfontcolor",value:(s.tfontcolor?s.tfontcolor:""),group:"文本字体",editor:{type:"combobox",options:{data:colorJson,formatter:function(b){return'<div style="background-color:'+b.value+'">'+b.text+"</div>"}}}},{name:"是否粗体",col:"tfontweight",value:(s.tfontweight?s.tfontweight:""),group:"文本字体",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"是否斜体",col:"titalic",value:(s.titalic?s.titalic:""),group:"文本字体",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"是否下划线",col:"tunderscore",value:(s.tunderscore?s.tunderscore:""),group:"文本字体",editor:{type:"checkbox",options:{on:true,off:false}}}]})}function tableView(c,b){if(c.kpiJson==undefined){return}if(c.kpiJson.length==0&&c.cols.length==0&&c.rows.length==0){$("#T"+b+" div.ctx").html('<div align="center" class="tipinfo">(点击编辑按钮配置交叉表的列)</div>');return}var a=JSON.stringify({cols:c.cols,height:c.height,rows:c.rows,kpiJson:c.kpiJson,compId:c.compId,compParams:c.compParams,tid:c.tid,portalParams:pageInfo.params});__showLoading();$.ajax({type:"POST",url:"TableView.action",dataType:"html",contentType:"application/json",data:a,success:function(d){__hideLoading();$("#c_"+b+" div.cctx div.ccctx").html(d)},error:function(d){__hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function dimsort(g){var b=curTmpInfo.ckid;var e=curTmpInfo.compId;var h=curTmpInfo.pos;var c=curTmpInfo.dimname;var a=findCompById(e);var f=null;if(h=="col"){f=a.cols}else{f=a.rows}for(var d=0;d<f.length;d++){if(f[d].id==b){f[d].dimord=g;break}}for(d=0;d<a.kpiJson.length;d++){a.kpiJson[d].sort=""}curTmpInfo.isupdate=true;tableView(a,e)}function kpisort(d){var c=curTmpInfo.ckid;var b=curTmpInfo.compId;var a=findCompById(b);for(i=0;i<a.kpiJson.length;i++){if(a.kpiJson[i].kpi_id==c){a.kpiJson[i].sort=d}else{a.kpiJson[i].sort=""}}curTmpInfo.isupdate=true;tableView(a,b)}function aggreDim(){var f=curTmpInfo.ckid;var h=curTmpInfo.compId;var e=curTmpInfo.pos;var a=curTmpInfo.dimname;var d=findCompById(h);var g=null;if(e=="col"){g=d.cols}else{g=d.rows}var c=null;for(var b=0;b<g.length;b++){if(g[b].id==f){c=g[b]}}if(c.issum=="y"){c.issum="n";delete c.aggre;curTmpInfo.isupdate=true;tableView(d,h);return}var o='<div style=\'margin:20px 5px 5px 10px;\'><div class="checkbox checkbox-info checkbox-inline"><input value=\'auto\' id=\'autoaggre\' name=\'autoaggre\' type=\'checkbox\'><label for="autoaggre">自动聚合</label></div> (设置后，聚合方式的选择功能既无效)<br/><span class="inputtext">聚合方式：</span><select id="dimaggre" name="dimaggre" class="inputform2"><option value="sum">求和</option><option value="count">计数</option><option value="avg">平均</option><option value="max">最大</option><option value="min">最小</option><option value="var">方差</option><option value="sd">标准差</option><option value="middle">中位数</option></select></div>';$("#pdailog").dialog({title:"维度聚合",width:340,height:200,closed:false,cache:false,modal:true,toolbar:null,content:o,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){if(c.issum=="y"){c.issum="n";delete c.aggre}else{var p=$("#pdailog input[name='autoaggre']:checked").size();if(p==1){c.aggre="auto"}else{c.aggre=$("#pdailog #dimaggre").val()}c.issum="y"}curTmpInfo.isupdate=true;tableView(d,h);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog input[name='autoaggre']").click(function(){var p=$(this).attr("checked");if(p){$("#pdailog #dimaggre").attr("disabled","true")}else{$("#pdailog #dimaggre").removeAttr("disabled")}})}function kpiwarning(){var c=curTmpInfo.ckid;var b=curTmpInfo.compId;var a=findCompById(b);var e=findKpiById(c,a.kpiJson);var f=e.warning;var d='<div style=\'margin:10px;\'><span class="inputtext">图片样式：</span><select id="wctype" class="inputform2" style="width:90px;"><option value="1" '+(f&&f.pictype=="1"?"selected":"")+'>交通灯</option><option value="2" '+(f&&f.pictype=="2"?"selected":"")+'>箭头</option></select> <div class="checkbox checkbox-inline"><input type="checkbox" value="y" id="fztp" name="fztp" '+(f&&f.reverse=="y"?"checked":"")+'><label for="fztp">反转图片</label></div><br/>';d=d+'<span id="w1" class="'+(f?f.pic1:"warning6")+'"></span> <span class="inputtext">当前值</span> <select id="logic1" name="logic1" class="inputform2" style="width:50px;"><option value=">=" '+(f&&f.logic1==">="?"selected":"")+'>&gt;=</option><option value=">" '+(f&&f.logic1==">"?"selected":"")+'>&gt;</option></select> <input type="text" id="val1" name="val1" idx="1" value="'+(f?f.val1:"")+'"> <br/><span id="w2" class="'+(f?f.pic2:"warning5")+'"></span> <span class="inputtext">当前值 &lt; <span id="and1">'+(f?f.val1:"X")+'</span> 且 </span> <select id="logic2" name="logic2" class="inputform2" style="width:50px;"><option value=">=" '+(f&&f.logic2==">="?"selected":"")+'>&gt;=</option><option value=">" '+(f&&f.logic2=="="?"selected":"")+'>&gt;</option></select> <input type="text" name="val2" idx="2" id="val2" value="'+(f?f.val2:"")+'"><br/> <span id="w3" class="'+(f?f.pic3:"warning4")+'"></span> <span class="inputtext"> 当前值 &lt;  <span id="and2">'+(f?f.val2:"X")+'</span></span> <br/><div class="checkbox checkbox-info"><input type="checkbox" value="y" id="clear" name="clear" ><label for="clear">清除预警信息</label></div></div>';$("#pdailog").dialog({title:"指标预警",width:380,height:260,closed:false,cache:false,modal:true,toolbar:null,content:d,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var u=$("#pdailog #wctype").val();var p=$('#pdailog input[name="fztp"]:checked').val();if(!p){p="n"}var r=$("#pdailog #logic1").val();var o=$("#pdailog #val1").val();var q=$("#pdailog #logic2").val();var h=$("#pdailog #val2").val();var g=$("#pdailog #w1").attr("class");var v=$("#pdailog #w2").attr("class");var t=$("#pdailog #w3").attr("class");if(o==""||h==""){delete e.warning;tableView(a,b);$("#pdailog").dialog("close");return}e.warning={pictype:u,reverse:p,logic1:r,val1:o,logic2:q,val2:h,pic1:g,pic2:v,pic3:t};tableView(a,b);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #val1,#pdailog #val2").numberbox({width:100,height:28,onChange:function(o,h){var g=$(this).attr("idx");$("#pdailog #and"+g).text(o)}});$("#pdailog #wctype").change(function(){if($(this).val()==1){$("#pdailog #w1").attr("class","warning6");$("#pdailog #w2").attr("class","warning5");$("#pdailog #w3").attr("class","warning4")}else{if($(this).val()==2){$("#pdailog #w1").attr("class","warning3");$("#pdailog #w2").attr("class","warning2");$("#pdailog #w3").attr("class","warning1")}}});$("#pdailog #fztp").change(function(){if(this.checked){if($("#pdailog #wctype").val()==1){$("#pdailog #w1").attr("class","warning4");$("#pdailog #w2").attr("class","warning5");$("#pdailog #w3").attr("class","warning6")}else{if($("#pdailog #wctype").val()==2){$("#pdailog #w1").attr("class","warning1");$("#pdailog #w2").attr("class","warning2");$("#pdailog #w3").attr("class","warning3")}}}else{if($("#pdailog #wctype").val()==1){$("#pdailog #w1").attr("class","warning6");$("#pdailog #w2").attr("class","warning5");$("#pdailog #w3").attr("class","warning4")}else{if($("#pdailog #wctype").val()==2){$("#pdailog #w1").attr("class","warning3");$("#pdailog #w2").attr("class","warning2");$("#pdailog #w3").attr("class","warning1")}}}});$("#pdailog #clear").change(function(){if(this.checked){$("#pdailog #val1").numberbox("clear");$("#pdailog #val2").numberbox("clear")}})}function filterDims(){var o=curTmpInfo.ckid;var q=curTmpInfo.compId;var g=curTmpInfo.pos;var b=curTmpInfo.dimname;var e=findCompById(q);var p=null;if(g=="col"){p=e.cols}else{p=e.rows}$("#pdailog").dialog({title:b+" - 维度筛选",width:306,height:341,closed:false,cache:false,modal:true,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var A=null;for(var w=0;w<p.length;w++){if(p[w].id==o){A=p[w];break}}var x=$("#dimfiltertab").tabs("getSelected");var v=$("#dimfiltertab").tabs("getTabIndex",x);if("day"==A.type&&v==0){var u=$("#dimfiltertab #dft2").val();var t=$("#dimfiltertab #dft1").val();if(Number(u.replace(/-/g,""))>Number(t.replace(/-/g,""))){msginfo("您选择的开始日期不能大于结束日期。");return}A.startdt=u;A.enddt=t;A.filtertype=1;delete A.vals}else{if("month"==A.type&&v==0){var u=$("#dimfiltertab #dfm2").val();var t=$("#dimfiltertab #dfm1").val();if(Number(u)>Number(t)){msginfo("您选择的开始月份不能大于结束月份。");return}A.startmt=u;A.endmt=t;A.filtertype=1;delete A.vals}else{var y="";var z=$("#pdailog input[name='dimval']:checkbox:checked");z.each(function(C,B){y=y+$(this).val();if(C!=z.size()-1){y=y+","}});A.vals=y;A.filtertype=2;delete A.startmt;delete A.endmt;delete A.startdt;delete A.enddt}}curTmpInfo.isupdate=true;tableView(e,q);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});var h="";var c="";var f="";var r=null;for(var d=0;d<p.length;d++){if(p[d].id==o){h=p[d].vals?p[d].vals:"";c=p[d].type;f=p[d].filtertype==undefined?"":p[d].filtertype;r=p[d];break}}var a="../bireport/DimFilter.action?tid="+e.tid+"&id="+o+"&vals="+h;if(c=="month"){a=a+"&st="+(r.startmt==undefined?"":r.startmt);a=a+"&end="+(r.endmt==undefined?"":r.endmt)}if(c=="day"){a=a+"&st="+(r.startdt==undefined?"":r.startdt);a=a+"&end="+(r.enddt==undefined?"":r.enddt)}$("#pdailog").dialog("refresh",a)}function searchDims(g,c){var f=$("#dimfiltertab").tabs("getSelected");var b=curTmpInfo.ckid;var e=curTmpInfo.compId.replace("T","");var a=findCompById(e);var d="../bireport/paramSearch.action?id="+b+"&tid="+a.tid;$.ajax({type:"POST",url:d,data:{keyword:g,vals:c},dataType:"HTML",success:function(h){$("#dimfiltertab").tabs("update",{tab:f,options:{content:h}})}})}function dimkpimove(g){var b=curTmpInfo.ckid;var e=curTmpInfo.compId;var h=curTmpInfo.pos;var c=curTmpInfo.dimname;var a=findCompById(e);var f=null;if(h=="col"){f=a.cols}else{if(h=="row"){f=a.rows}else{if(h=="kpi"){f=a.kpiJson}}}if(f.length<=1){msginfo("无效移动。");return}for(var d=0;d<f.length;d++){if((h=="kpi"?f[d].kpi_id:f[d].id)==b){if(g=="left"){if(d<=0){msginfo("无效移动。");return}else{var g=f[d-1];f[d-1]=f[d];f[d]=g;$("#tableData #"+(h=="kpi"?"k":"d")+"_"+b).prev().before($("#tableData #"+(h=="kpi"?"k":"d")+"_"+b));curTmpInfo.isupdate=true;tableView(a,e);return}}else{if(g=="right"){if(d>=f.length-1){msginfo("无效移动。");return}else{var g=f[d+1];f[d+1]=f[d];f[d]=g;$("#tableData #"+(h=="kpi"?"k":"d")+"_"+b).next().after($("#tableData #"+(h=="kpi"?"k":"d")+"_"+b));curTmpInfo.isupdate=true;tableView(a,e);return}}}break}}}function dimexchange(){var h=curTmpInfo.ckid;var r=curTmpInfo.compId;var g=curTmpInfo.pos;var a=curTmpInfo.dimname;var e=findCompById(r);if(g=="col"){var q=0;var d=null;var p=e.cols;for(var c=0;c<p.length;c++){if(p[c].id==h){q=c;d=p[c];break}}e.cols.splice(q,1);e.rows.push(d);$("#tableData #d_"+h).remove();var b='<span id="d_'+d.id+'" class="dimcol"><span class="text">'+d.dimdesc+'</span><div class="ibox-tools"><button class="btn btn-outline btn-success btn-xs" onclick="setRdimInfo(this, '+d.id+", '"+d.dimdesc+"','"+r+'\')"><i class="fa fa-wrench"></i></button></div></span>';if($("#tableData #tabRows span.dimcol").size()>0){$("#tableData #tabRows span.dimcol").last().after(b)}else{$("#tableData #tabRows b").after(b)}if(e.cols.length==0){$("#tableData #tabCols").remove()}}if(g=="row"){var q=0;var d=null;var p=e.rows;for(var c=0;c<p.length;c++){if(p[c].id==h){q=c;d=p[c];break}}e.rows.splice(q,1);e.cols.push(d);$("#tableData #d_"+h).remove();var f=e.cols;if(f.length==1){$("#tableData").append('<span id="tabCols"> &nbsp; &nbsp; <b>列字段：</b></span>')}$("#tableData #tabCols").append('<span id="d_'+d.id+'" class="dimcol"><span class="text">'+d.dimdesc+'</span><div class="ibox-tools"><button class="btn btn-outline btn-success btn-xs" onclick="setCdimInfo(this, '+d.id+", '"+d.dimdesc+"','"+r+'\')"><i class="fa fa-wrench"></i></button></div></span>')}curTmpInfo.isupdate=true;tableView(e,r)}function kpiproperty(){var d=curTmpInfo.ckid;var c=curTmpInfo.compId;var b=findCompById(c);var e=findKpiById(d,b.kpiJson);var a='<div id="table_cell_tab" style="height:auto; width:auto;"><div title="基本信息"><div style=\'line-height:25px; margin:10px;\'><span class="inputtext">度量名称：</span><input type="text" id="name" name="name" class="inputform2" value="'+(e.kpi_name)+'"><br><span class="inputtext">所 属 表：</span> '+b.tname+'<br><span class="inputtext">对应字段：</span>'+e.col_name+"<br><span class=\"inputtext\">度量单位：</span><select id=\"kpiunit\" name=\"kpiunit\" class=\"inputform2\"><option value='1'></option><option value='1000'>千</option><option value='10000'>万</option><option value='1000000'>百万</option><option value='100000000'>亿</option></select>"+e.unit+'<br><span class="inputtext">格 式 化：</span><select id="fmt" name="fmt" class="inputform2"><option value=""></option><option value="###,##0">整数</option><option value="###,##0.0">小数(保留1位)</option><option value="###,##0.00">小数(保留2位)</option><option value="0.00%">百分比</option></select><br/><span class="inputtext">表头排序：</span><div class="checkbox checkbox-info checkbox-inline" style="line-height:20px;"><input type="checkbox" id="headsort" name="headsort" '+(e.order&&e.order=="y"?"checked":"")+'><label for="headsort"> </label></div></div></div><div title="回调函数"><div class="textpanel">function <input type="text" id="funcname" name="funcname" style="width:120px;" class="inputform2" value="'+(e.funcname?e.funcname:"")+'">(<b>value</b>, <b>col</b>, <b>row</b>, <b>data</b>){<br/><textarea id="code" name="code" cols="50" rows="5">'+(e.code?unescape(e.code):"")+'</textarea><br/>}<br/><a target="_blank" href="../helper/callback.html" id="helper">帮助</a></div></div>';$("#pdailog").dialog({title:"度量属性",width:400,height:320,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){e.fmt=$("#pdailog #fmt").val();e.rate=Number($("#pdailog #kpiunit").val());e.kpi_name=$("#pdailog #name").val();var h=$("#pdailog input[name='headsort']:checked").size();if(h==0){e.order="n"}else{e.order="y"}var f=$("#table_cell_tab #funcname").val();var g=$("#table_cell_tab #code").val();if(f==""&&g==""){delete e.funcname;delete e.code}else{if(f==""){$("#pdailog #table_cell_tab").tabs("select",1);msginfo("函数名是必填项！");$("#table_cell_tab #funcname").focus();return}if(g==""){$("#pdailog #table_cell_tab").tabs("select",1);msginfo("函数内容是必填项！");$("#table_cell_tab #code").focus();return}e.funcname=f;e.code=escape(g)}$("#pdailog").dialog("close");curTmpInfo.isupdate=true;tableView(b,c)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #table_cell_tab").tabs({border:false,fit:true});$("#pdailog #table_cell_tab #helper").linkbutton({iconCls:"icon-tip"});$("#pdailog #fmt").find("option[value='"+e.fmt+"']").attr("selected",true);$("#pdailog #kpiunit").find("option[value='"+e.rate+"']").attr("selected",true);$("#pdailog #aggreType").find("option[value='"+e.aggre+"']").attr("selected",true)}function setKpiInfo(c,f,b){var e=$(c).offset();curTmpInfo.ckid=f;curTmpInfo.compId=b;curTmpInfo.pos="kpi";var a=findCompById(b);var d=findKpiById(f,a.kpiJson);if(d.sort=="asc"){$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-ok"});$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-blank"});$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-blank"})}else{if(d.sort=="desc"){$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-blank"});$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-ok"});$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-blank"})}else{$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-blank"});$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-blank"});$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-ok"})}}$("#kpioptmenu").menu("show",{left:e.left,top:e.top-95})}function setCdimInfo(h,b,a,p){var d=$(h).offset();curTmpInfo.ckid=b;curTmpInfo.compId=p;curTmpInfo.pos="col";curTmpInfo.dimname=a;var f=false;var g=findCompById(p);var o=g.cols;for(var e=0;e<o.length;e++){if(o[e].id==b){if(o[e].issum=="y"){f=true;break}}}if(f){var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"取消聚合"})}else{var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"聚合..."})}var c=$("#dimoptmenu").menu("getItem",$("#m_moveto"));$("#dimoptmenu").menu("setText",{target:c.target,text:"移至行字段"});$("#dimoptmenu").menu("show",{left:d.left,top:d.top-140})}function setRdimInfo(h,b,a,p){var d=$(h).offset();curTmpInfo.ckid=b;curTmpInfo.compId=p;curTmpInfo.pos="row";curTmpInfo.dimname=a;var f=false;var g=findCompById(p);var o=g.rows;for(var e=0;e<o.length;e++){if(o[e].id==b){if(o[e].issum=="y"){f=true;break}}}if(f){var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"取消聚合"})}else{var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"聚合"})}$("#dimoptmenu").menu("setText",{target:$("#m_moveto"),text:"移至列字段"});$("#dimoptmenu").menu("show",{left:d.left,top:d.top-140})}function isExistDateDim(a,d){var b=false;if(d=="table"){if(!a||!a.cols){return b}for(var c=0;c<a.cols.length;c++){if(a.cols[c].grouptype=="date"){b=true;break}}if(!a||!a.rows){return b}for(var c=0;c<a.rows.length;c++){if(a.rows[c].grouptype=="date"){b=true;break}}}if(d=="chart"){if(!a.chartJson||!a.chartJson.params){return b}for(var c=0;c<a.chartJson.params.length;c++){if(a.chartJson.params[c].grouptype=="date"){b=true;break}}if(!a.chartJson||!a.chartJson.xcol){return b}if(a.chartJson.xcol.grouptype=="date"){b=true}}return b}function kpiExist(d,c){var a=false;if(!c||c==null){return a}for(var b=0;b<c.length;b++){if(c[b].kpi_id==d){a=true;break}}return a}function dimExist(c,d){var a=false;if(!d||d==null){return a}for(var b=0;b<d.length;b++){if(d[b].id==c){a=true;break}}return a}function deletecomp(b,e){if(!confirm("是否确认删除组件？")){return}var f=findLayoutById(b);var c=-1;for(var d=0;d<f.children.length;d++){if(f.children[d].id==e){c=d;break}}f.children.splice(c,1);var a=findCompById(e,true);curTmpInfo.comps.splice(a,1);$("#c_"+e).remove();$("#Jlayout").layout("remove","south");$("#Jlayout").layout("remove","east");curTmpInfo.isupdate=true}function findCompById(e,b){var a=-1;var c=null;for(var d=0;curTmpInfo.comps&&d<curTmpInfo.comps.length;d++){if(curTmpInfo.comps[d].id==e){c=curTmpInfo.comps[d];a=d;break}}if(b&&b==true){return a}else{return c}}function findParamById(a){var b=null;for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var c=pageInfo.params[i];if(c.id==a){b=c;break}}return b}function findKpiById(d,c){var a=null;if(!c||c==null){return a}for(var b=0;b<c.length;b++){if(c[b].kpi_id==d){a=c[b];break}}return a}function newGuid(){var a="";for(var b=1;b<=32;b++){var c=Math.floor(Math.random()*16).toString(16);a+=c}return a}if($==undefined){$=jQuery}function initParams(){$("#param_tree").tree({dnd:true,onBeforeDrag:function(c){return true},onDragEnter:function(d,c){return false}});$("#optparam").droppable({accept:"#param_tree .tree-node",onDragEnter:function(d,c){$("#optparam").css("border","1px solid #ff0000");$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes")},onDragLeave:function(d,c){$("#optparam").css("border","1px solid #d3d3d3");$(c).draggable("proxy").find("span").addClass("tree-dnd-no");$(c).draggable("proxy").find("span").removeClass("tree-dnd-yes")},onDrop:function(f,d){$("#optparam").css("border","1px solid #d3d3d3");var c=$("#param_tree").tree("getNode",d);newparam("insert",c.attributes.tp)}});var a="";for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var b=pageInfo.params[i];a=a+'<span id="p'+b.id+'" class="pppp"><span class="text" onclick="newparam(\'update\',\''+b.type+"','"+b.id+'\')" title="编辑">'+b.name+"("+getParamTypeDesc(b.type)+')</span><div class="ibox-tools" style="margin-top:3px;"><button onclick="optParam(this,\''+b.id+"', '"+b.type+'\')" title="设置" class="btn btn-outline btn-success btn-xs"><i class="fa fa-wrench"></i></button> <button onclick="deleteParam(\''+b.id+'\')" title="删除" class="btn btn-outline btn-danger btn-xs"><i class="fa fa-times"></i></button></div></span>'}if(a!=""){$("#optparam").html(a)}}function moveparam(e){var b=curTmpInfo.paramId;var a=findParamById(b,true);if(a==0&&e=="left"){msginfo("参数已在最左边，无法移动。");return}else{if(a==pageInfo.params.length-1&&e=="right"){msginfo("参数已在最右边，无法移动。");return}}var c=pageInfo.params;if(e=="left"){var d=c[a-1];c[a-1]=c[a];c[a]=d;$("#optparam #p"+b).prev().before($("#optparam #p"+b));curTmpInfo.isupdate=true}else{if(e=="right"){var d=c[a+1];c[a+1]=c[a];c[a]=d;$("#optparam #p"+b).next().after($("#optparam #p"+b));curTmpInfo.isupdate=true}}}function newparam(h,a,f){var d=null;if(!a){a=curTmpInfo.paramType}if(!f){f=curTmpInfo.paramId}curTmpInfo.paramvals=[];if(h=="update"){d=findParamById(f);if(d.values){curTmpInfo.paramvals=d.values}}var g="";var t="";if(a=="dateselect"){t="now表示默认当前日期";var b=["yyyyMMdd","yyyy-MM-dd","yyyy年MM月dd日"];var c="<option></option>";for(i=0;i<b.length;i++){c=c+"<option value='"+b[i]+"' "+(d!=null&&b[i]==d.dtformat?"selected":"")+">"+b[i]+"</option>"}g="<br/><span class=\"inputtext\">日期格式：</span><select id='dtformat' name='dtformat' class='inputform2'>"+c+'</select><br/><span class="inputtext">最小值：</span><input type="text" class="inputform2" name="minval" id="minval" value="'+(d==null?"":d.minval)+'" ><br/><span class="inputtext">最大值：</span><input type="text" class="inputform2" name="maxval" id="maxval" value="'+(d==null?"":d.maxval)+'" >'}if(a=="monthselect"){t="now表示默认当前月份";var b=["yyyyMM","yyyy-MM","yyyy年MM月"];var c="<option></option>";for(i=0;i<b.length;i++){c=c+"<option value='"+b[i]+"' "+(d!=null&&b[i]==d.dtformat?"selected":"")+">"+b[i]+"</option>"}g="<br/><span class=\"inputtext\">月份格式：</span><select id='dtformat' name='dtformat' class='inputform2'>"+c+'</select><br/><span class="inputtext">最小值：</span><input type="text" class="inputform2" name="minval" id="minval" value="'+(d==null?"":d.minval)+'" ><br/><span class="inputtext">最大值：</span><input type="text" class="inputform2" name="maxval" id="maxval" value="'+(d==null?"":d.maxval)+'" >'}if(a=="yearselect"){t="now表示默认当前年份";var b=["yyyy","yyyy年"];var c="<option></option>";for(i=0;i<b.length;i++){c=c+"<option value='"+b[i]+"' "+(d!=null&&b[i]==d.dtformat?"selected":"")+">"+b[i]+"</option>"}g="<br/><span class=\"inputtext\">年份格式：</span><select id='dtformat' name='dtformat' class='inputform2'>"+c+'</select><br/><span class="inputtext">最小值：</span><input type="text" class="inputform2" name="minval" id="minval" value="'+(d==null?"":d.minval)+'" ><br/><span class="inputtext">最大值：</span><input type="text" class="inputform2" name="maxval" id="maxval" value="'+(d==null?"":d.maxval)+'" >'}var e="";if(a=="checkbox"||a=="radio"){$.ajax({type:"post",url:"../model/listSubjectNoPage.action",data:{t:Math.random()},dataType:"json",async:false,success:function(u){for(k=0;k<u.length;k++){e=e+"<option value='"+u[k].tid+"@"+u[k].tName+"' "+(d!=null&&d.option&&u[k].tid==d.option.tableId?"selected":"")+">"+u[k].tDesc+"("+u[k].tName+")</option>"}}})}var r="";if(d!=null&&d.option&&d.valtype=="dynamic"&&d.option.tableId&&d.option.tableId!=""){$.ajax({type:"post",url:"../model/cubeInfo.action",data:{tableId:d.option.tableId},dataType:"json",async:false,success:function(w){w=w.dims;for(k=0;k<w.length;k++){var u=w[k].dimdesc;var x=w[k].id;var v=w[k].alias;r=r+'<option value="'+x+"@"+v+'" '+(v==d.option.alias?"selected":"")+">"+u+"</option>"}}})}var o=reloadParamVals(true);var q='<div class="textpanel"><span class="inputtext">参数标识：</span><input type="text" class="inputform2" name="paramid" id="paramid" value="'+(d==null?"":d.paramid)+'" '+(h=="insert"?"":"readonly")+' placeholder="创建后不能更改"><br/><span class="inputtext">显示名称：</span><input type="text" class="inputform2" name="paramname" id="paramname" value="'+(d==null?"":d.name)+'"><br/><span class="inputtext">长度：</span><input type="text" size="5" name="size" class="inputform2" id="size" value="'+(d!=null&&d.size?d.size:"")+'" placeholder="取值5-30"><br/><span class="inputtext">默认值：</span><input type="text" size="15" name="defvalue" id="defvalue" value="'+(d==null?"":d.defvalue)+'" class="inputform2" placeholder="'+t+'">'+g+"<br/><span class=\"inputtext\">隐藏参数：</span><div class=\"checkbox checkbox-info checkbox-inline\" style=\"line-height:20px;\"><input type='checkbox' id='hiddenprm' name='hiddenprm' value='y' "+(d!=null&&d.hiddenprm=="y"?"checked":"")+'><label for="hiddenprm">隐藏参数不会在页面中显示</label></div>'+(a=="radio"||a=="checkbox"?"<div id=\"values\"><fieldset><legend>值列表</legend><div style='margin:0px 3px 3px 3px;'><div class=\"radio radio-info radio-inline\" style=\"line-height:20px;\"><input type='radio' id='valtype1' name='valtype' value=\"static\" "+(d==null||d.valtype=="static"?"checked":"")+'><label for="valtype1">静态值</label></div> <div class="radio radio-info radio-inline" style="line-height:20px;"><input type=\'radio\' id=\'valtype2\' name=\'valtype\' value="dynamic" '+(d!=null&&d.valtype=="dynamic"?"checked":"")+'><label for="valtype2">动态值</label></div></div><div class="param_left" style="display:'+(d==null||d.valtype=="static"?"block":"none")+'"><table cellspacing="0" cellpadding="0" class="grid3"><tr><th width=\'33%\'>Value</th><th width=\'33%\'>Text</th><th width=\'33%\'>操作</th></tr>'+o+'</table></div><div style="display:'+(d==null||d.valtype=="static"?"block":"none")+'" class="param_right"><a href="javascript:newparamval(false);"><img src=\'../resource/img/edit_add.png\' border=\'0\' title=\'新增\'></a><br/></div><div id="dynamic_div" style="display:'+(d!=null&&d.valtype=="dynamic"?"block":"none")+'"><span class="inputtext">数据：</span><select id="dataset" name="dataset" class="inputform2"><option vlaue=\'\'></option>'+e+'</select><br/><span class="inputtext">映射字段：</span><select id="param_option_val" name="param_option_val" class="inputform2">'+r+"</select></div></fieldset></div>":"")+"</div>";var p=getParamTypeDesc(a);$("#pdailog").dialog({title:(h=="insert"?"创建参数":"编辑参数")+" - "+p,width:410,height:a=="dateselect"||a=="monthselect"||a=="yearselect"?340:(a=="text"?240:490),closed:false,cache:false,modal:true,toolbar:null,content:q,onLoad:function(){},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var x=$("#pdailog #paramid").val();if(x==""){msginfo("请填写参数标识!");$("#pdailog #paramid").focus();return}if(ischinese($("#pdailog #paramid").val())){msginfo("参数标识必须是英文字符!");$("#pdailog #paramid").select();return}var w=$("#pdailog #paramname").val();if(w==""){msginfo("请输入参数显示名称!");$("#pdailog #paramname").select();return}var H=$("#pdailog #defvalue").val();var G=$("#pdailog #size").val();var F=getParamTypeDesc(a);if(isNaN(G)){msginfo("长度必须是数字!");$("#pdailog #size").select();return}if(G!=""){if(G<5||G>30){msginfo("长度取值5-30!");$("#pdailog #size").select();return}}if(a=="dateselect"||a=="monthselect"||a=="yearselect"){if($("#pdailog #dtformat").val()==""){msginfo("请设置"+getParamTypeDesc(a).substring(0,2)+"格式!");$("#pdailog #dtformat").select();return}}if(h=="insert"){var E=findParamById(x);if(E!=null){msginfo("参数标识存在重复。");$("#pdailog #paramid").select();return}}var B=$('#pdailog input[name="hiddenprm"]:checked').val();if(a=="radio"||a=="checkbox"){var u=$('#pdailog input[name="valtype"]:checked').val();if(u=="static"){if(!curTmpInfo.paramvals||curTmpInfo.paramvals.length==0){msginfo("您还未设置参数值。");return}}else{if($("#pdailog #dataset").val()==""||$("#pdailog #param_option_val").val()==""||$("#pdailog #param_option_text").val()==""){msginfo("您的参数还未绑定到数据。");return}}}var u=$('#pdailog input[name="valtype"]:checked').val();if(h=="insert"){if($("#optparam span.charttip").size()>0){$("#optparam span.charttip").remove()}var A={id:newGuid(),type:a,paramid:x,name:w,defvalue:H,size:G,hiddenprm:B};if(a=="dateselect"||a=="monthselect"||a=="yearselect"){A.maxval=$("#pdailog #maxval").val();A.minval=$("#pdailog #minval").val();A.dtformat=$("#pdailog #dtformat").val()}if(a=="radio"||a=="checkbox"){A.valtype=u;if(u=="static"){A.values=curTmpInfo.paramvals}else{var z=$("#pdailog #param_option_val").val();var v=z.split("@");var C=$("#pdailog #dataset").val();var y=C.split("@");A.option={tableId:y[0],tname:y[1],dimId:v[0],alias:v[1]}}}var D='<span id="p'+A.id+'" class="pppp"><span class="text" onclick="newparam(\'update\',\''+a+"','"+A.id+"')\" >"+w+"("+F+')</span><div class="ibox-tools" style="margin-top:3px;"><button class="btn btn-outline btn-success btn-xs"  onclick="optParam(this,\''+A.id+"', '"+A.type+'\')" title="设置"><i class="fa fa-wrench"></i></button> <button class="btn btn-outline btn-danger btn-xs" onclick="deleteParam(\''+A.id+'\')" title="删除"><i class="fa fa-times"></i></button></div></span>';$("#optparam").append(D);if(!pageInfo.params){pageInfo.params=[]}pageInfo.params.push(A)}else{d.name=w;d.defvalue=H;d.size=G;d.hiddenprm=B;if(a=="dateselect"||a=="monthselect"||a=="yearselect"){d.maxval=$("#pdailog #maxval").val();d.minval=$("#pdailog #minval").val();d.dtformat=$("#pdailog #dtformat").val()}if(a=="radio"||a=="checkbox"){d.valtype=u;if(u=="static"){d.values=curTmpInfo.paramvals;delete d.option}else{var z=$("#pdailog #param_option_val").val();var v=z.split("@");var C=$("#pdailog #dataset").val();var y=C.split("@");d.option={tableId:y[0],tname:y[1],dimId:v[0],alias:v[1]};delete d.values}}$("#p"+d.id+" span.text").text(w+"("+F+")")}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #valtype1,#pdailog #valtype2").bind("click",function(){var u=$(this).val();if(u=="static"){$("#pdailog #dynamic_div").css("display","none");$("#pdailog .param_left").css("display","block");$("#pdailog .param_right").css("display","block")}else{$("#pdailog #dynamic_div").css("display","block");$("#pdailog .param_left").css("display","none");$("#pdailog .param_right").css("display","none")}});$("#pdailog #dataset").bind("change",function(){var u="param_option_val";document.getElementById(u).options.length=0;var x=$(this).attr("id");var w=$(this).val();if(w==""){return}var v=w.split("@")[0];$.ajax({type:"post",url:"../model/cubeInfo.action",data:{tableId:v},dataType:"json",success:function(z){z=z.dims;for(k=0;k<z.length;k++){var y=new Option(z[k].dimdesc+"("+z[k].alias+")",z[k].id+"@"+z[k].alias);document.getElementById(u).options.add(y)}}})})}function optParam(b,a,d){var c=$(b).offset();curTmpInfo.paramId=a;curTmpInfo.paramType=d;$("#param_menu").menu("show",{left:c.left,top:c.top+25})}function reloadParamVals(b){$("#pdailog #values table tr").each(function(f,e){if(f>0){$(this).remove()}});var d="";for(var a=0;a<curTmpInfo.paramvals.length;a++){var c=curTmpInfo.paramvals[a];d=d+'<tr><td  class="kpiData1 grid3-td">'+c.value+'</td><td  class="kpiData1 grid3-td">'+c.text+'</td><td class="kpiData1 grid3-td"><a href="javascript:newparamval(true,\''+c.value+"');\"><img title='编辑' src='../resource/img/pencil.png' border='0'></a> &nbsp; <a href=\"javascript:paramdelvals('"+c.value+"');\"><img title='删除' src='../resource/img/closeme.png' border='0'></a></td></tr>"}for(var a=curTmpInfo.paramvals.length;a<5;a++){d=d+"<tr>";for(j=0;j<3;j++){d=d+'<td class="kpiData1 grid3-td"> &nbsp; </td>'}d=d+"</tr>"}if(b==true){return d}else{$(d).insertAfter("#pdailog #values table tr")}}function paramdelvals(c){var a=-1;for(var b=0;b<curTmpInfo.paramvals.length;b++){if(curTmpInfo.paramvals[b].value==c){a=b;break}}curTmpInfo.paramvals.splice(a,1);reloadParamVals()}function delallparamval(){curTmpInfo.paramvals=[];reloadParamVals();curTmpInfo.isupdate=true}function newparamval(e,d){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var c=null;if(e&&d){for(var b=0;b<curTmpInfo.paramvals.length;b++){if(curTmpInfo.paramvals[b].value==d){c=curTmpInfo.paramvals[b];break}}}var a='<div class="textpanel"><span class="inputtext">Value：</span><input type="text"  id="val" name="val" class="inputform2" value="'+(c==null?"":c.value)+'"><span class="inputtext">Text：</span><input type="text"  id="txt" name="txt" class="inputform2" value="'+(c==null?"":c.text)+'"></div>';$("#dsColumn_div").dialog({title:(e==false?"添加值":"编辑值"),width:350,height:170,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var g=$("#dsColumn_div #val").val();var f=$("#dsColumn_div #txt").val();if(g==""||f==""){msginfo("Value 和 Text 是必填项。");return}if(e){c.value=g;c.text=f}else{curTmpInfo.paramvals.push({value:g,text:f})}reloadParamVals();$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function getParamTypeDesc(b){var a="";if(b=="text"){a="输入框"}else{if(b=="radio"){a="单选框"}else{if(b=="checkbox"){a="多选框"}else{if(b=="dateselect"){a="日历框"}else{if(b=="monthselect"){a="月份框"}else{if(b=="yearselect"){a="年份框"}}}}}}return a}function deleteParam(b){if(!confirm("是否确认删除？")){return}var a=findParamById(b,true);if(a!=null){pageInfo.params.splice(a,1)}$("#p"+b).remove();if($("#optparam span.pppp").size()==0){$("#optparam").html('<span style="font-size:14px; text-align:center;" class="charttip">查询条件区域<br>把参数放入此处作为报表查询条件</span>')}curTmpInfo.isupdate=true}function paramevent(c){var b=findCompById(c);var d=function(h){var g=false;for(k=0;b.link&&k<b.link.length;k++){if(b.link[k]==h){g=true;break}}return g};var f="";for(i=0;i<curTmpInfo.comps.length;i++){var e=curTmpInfo.comps[i];if(e.type=="chart"||e.type=="table"){if(e.id!=c){f=f+"<input type='checkbox' id='obj"+i+"' name='linkcomp' value=\""+e.id+'" '+(d(e.id)?"checked":"")+" ><label for='obj"+i+"'>"+e.name+"</label><br/>"}}}var a='<div class="textpanel"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tr><td width="10%" valign="top"><span class="inputtext">联动组件：</span></td><td>'+f+"</td></tr></table></div>";$("#pdailog").dialog({title:"参数事件设置",width:300,height:250,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",handler:function(){var g=[];$('#pdailog input[name="linkcomp"]:checked').each(function(o,h){g.push($(h).val())});b.link=g;curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]})}function editInputData(b){if($("#dataProperty").size()==0){$("#Jlayout").layout("add",{region:"south",id:"dataProperty",split:false,collapsible:false,height:120,title:"配置参数数据",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","south")}}]})}else{$("#Jlayout").layout("panel","south").panel("setTitle","配置参数数据")}var c="";if(b.pcol){c='<b>参数字段：</b><span id="d_'+b.pcol.id+'" class="dimcol"><span class="text">'+b.pcol.name+"</span></span>"}else{c='<div class="tipinfo">拖拽维度到此处作为页面参数字段</div>'}var a='<div style="margin:10px;"><div class="tableDatasty" id="tableData">'+c+"</div></div>";$("#dataProperty").html(a);$("#tableData").droppable({accept:"#datasettree .tree-node",onDragEnter:function(g,f){var d=$("#datasettree").tree("getNode",f);var h=d.attributes.col_type;if(h==1){$(f).draggable("proxy").find("span").removeClass("tree-dnd-no");$(f).draggable("proxy").find("span").addClass("tree-dnd-yes");$(this).css("border","1px solid #ff0000")}g.cancelBubble=true;g.stopPropagation()},onDragLeave:function(f,d){$(d).draggable("proxy").find("span").addClass("tree-dnd-no");$(d).draggable("proxy").find("span").removeClass("tree-dnd-yes");$(this).css("border","1px dotted #666");f.cancelBubble=true;f.stopPropagation()},onDrop:function(h,f){h.cancelBubble=true;h.stopPropagation();$(this).css("border","1px dotted #666");var d=$("#datasettree").tree("getNode",f);var o=d.attributes.col_type;if(o==1){if(b.ctp=="dateselect"&&d.attributes.dim_type!="day"){msginfo("拖入日历控件的字段必须是日期类型。");return}else{if(b.ctp!="dateselect"&&d.attributes.dim_type=="day"){msginfo("字段不能是日期类型。");return}}var q=d.attributes.col_id;var g={id:q,name:d.text,type:d.attributes.dim_type,colname:d.attributes.col_name,tid:d.attributes.tid,valType:d.attributes.valType,tableName:d.attributes.tableName,tableColKey:d.attributes.tableColKey,tableColName:d.attributes.tableColName,dimord:d.attributes.dimord,ordcol:d.attributes.ordcol,alias:d.attributes.alias,tname:d.attributes.tname};b.pcol=g;$("#tableData").html('<b>参数字段：</b><span id="d_'+d.attributes.col_id+'" class="dimcol"><span class="text">'+d.text+"</span></span>");loadParamData(b)}}})}function setcompfilter(d){if(!d){d=curTmpInfo.compId}var a=findCompById(d);var f='<div style="margin:5px;"><button style="margin-bottom:5px;" class="btn btn-primary btn-sm" onclick="newdatasetparam(false, \'\', \''+d+'\');">新增筛选条件</button><table class="grid3" id="T_report54" cellpadding="0" cellspacing="0">';f=f+"<tr><th width='30%'>筛选字段</th><th width='15%'>判断条件</th><th width='20%'>筛选值</th><th width='15%'>值类型</th><th width='20%'>操作</th></tr>";var c=a.compParams;for(var b=0;c&&b<c.length;b++){var e=c[b];f=f+'<tr><td class="kpiData1 grid3-td">'+(a.type=="grid"?e.col:e.colname)+"/"+e.col+'</td><td class="kpiData1 grid3-td">'+e.type+'</td><td class="kpiData1 grid3-td">'+(e.usetype!="param"?(e.val+(e.val2==""?"":"/"+e.val2)):"连接到参数")+'</td><td class="kpiData1 grid3-td">'+e.valuetype+'</td><td class="kpiData1 grid3-td"><button onclick="newdatasetparam(true,\''+e.id+"','"+d+'\');" class="btn btn-info btn-xs">编辑</button> <button onclick="delDatasetFilter(\''+e.id+"', '"+d+'\');" class="btn btn-danger btn-xs">删除</button></td></tr>'}f=f+"</table></div>";$("#pdailog").dialog({title:"组件筛选",width:680,height:400,closed:false,cache:false,modal:true,toolbar:null,content:f,onLoad:function(){},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){if(a.type=="table"){tableView(a,a.id)}else{if(a.type=="chart"){chartview(a,a.id)}}$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}function delDatasetFilter(c,d){var b=findCompById(d);if(confirm("是否确认删除？")){var a=-1;for(i=0;b.compParams&&i<b.compParams.length;i++){if(b.compParams[i].id==c){a=i}}b.compParams.splice(a,1);setcompfilter(d);curTmpInfo.isupdate=true}}function newdatasetparam(z,c,u){var p=findCompById(u);var y=null;if(p.compParams){for(i=0;p.compParams&&i<p.compParams.length;i++){if(p.compParams[i].id==c){y=p.compParams[i]}}}var a;var x;if(p.type=="grid"){if(!p.tid||p.tid==""){msginfo("组件还未绑定数据。");return}$.ajax({type:"POST",url:"../etl/getTableColumns.action",dataType:"JSON",async:false,data:{tableId:p.tid},success:function(o){x=o}})}else{if(!p.tid||p.tid==""){msginfo("组件还未绑定数据。");return}$.ajax({type:"POST",url:"../model/cubeInfo.action",dataType:"JSON",async:false,data:{tableId:p.tid},success:function(o){a=o}})}var e=function(t){var o=null;for(k=0;k<x.length;k++){if(x[k].colName==t){o=x[k];break}}return o};if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var r='<select id="filtercolumn" name="filtercolumn" class="inputform2"><option value=\'\'></option>';if(p.type=="grid"){for(i=0;i<x.length;i++){r=r+'<option value="'+x[i].colName+'" '+(y!=null&&y.alias==x[i].colName?"selected":"")+">"+(x[i].colName)+"</option>"}}else{for(i=0;i<a.dims.length;i++){var b=a.dims[i];r=r+'<option value="'+b.alias+"@"+(b.tableColKey==null||b.tableColKey==""?b.colname:b.tableColKey)+"@"+b.dimdesc+"@dim@"+b.fromCol+'" '+(y!=null&&y.alias==b.alias?"selected":"")+">"+(b.dimdesc+"("+(b.tableColKey==null||b.tableColKey==""?b.colname:b.tableColKey)+")")+"</option>"}}r=r+"</select>";var h=["=",">",">=","<","<=","!=","between","in","like"];var w='<select id="filtertype" name="filtertype" class="inputform2">';for(i=0;i<h.length;i++){w=w+'<option value="'+h[i]+'" '+(y!=null&&y.type==h[i]?"selected":"")+">"+h[i]+"</option>"}w=w+"</select>";var g='<select id="linkparam" name="linkparam" class="inputform2" '+(y==null||y.usetype=="gdz"?'style="display:none"':"")+">";for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){if(pageInfo.params[i].type=="casca"){var f=pageInfo.params[i];for(k=0;k<f.children.length;k++){var q=f.children[k];g=g+'<option value="'+q.paramid+'" '+(y!=null&&q.paramid==y.linkparam?"selected":"")+">"+q.name+"</option>"}}else{g=g+'<option value="'+pageInfo.params[i].paramid+'" '+(y!=null&&pageInfo.params[i].paramid==y.linkparam?"selected":"")+">"+pageInfo.params[i].name+"</option>"}}g=g+"</select>";var d='<select id="linkparam2" name="linkparam2" class="inputform2" '+(y==null||y.usetype=="gdz"?'style="display:none"':"")+">";for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){if(pageInfo.params[i].type=="casca"){var f=pageInfo.params[i];for(k=0;k<f.children.length;k++){var q=f.children[k];d=d+'<option value="'+q.paramid+'" '+(y!=null&&q.paramid==y.linkparam2?"selected":"")+">"+q.name+"</option>"}}else{d=d+'<option value="'+pageInfo.params[i].paramid+'" '+(y!=null&&pageInfo.params[i].paramid==y.linkparam2?"selected":"")+">"+pageInfo.params[i].name+"</option>"}}d=d+"</select>";var v='<div class="textpanel"><span class="inputtext">筛选字段：</span>'+r+'<br/><span class="inputtext">判断条件：</span>'+w+'<br/><span class="inputtext">筛选值：</span><input type="text" name="filtervalue" id="filtervalue" '+(y!=null&&y.usetype=="param"?'style="display:none"':"")+' value="'+(y!=null?y.val:"")+'" class="inputform2">'+g+'<span class="link_param icon-param" tp="'+(y!=null&&y.usetype=="param"?"param":"gdz")+'" title="链接到参数" onclick="chglinkparam(this, 1)"></span><div id="selval2" style="'+(y!=null&&(y.type=="between")?"display:block":"display:none")+'"><span class="inputtext">筛选值2：</span><input type="text" name="filtervalue2" id="filtervalue2" value="'+(y!=null?y.val2:"")+'" '+(y!=null&&y.usetype=="param"?'style="display:none"':"")+' class="inputform2">'+d+'<span class="link_param icon-param" tp="'+(y!=null&&y.usetype=="param"?"param":"gdz")+'" title="链接到参数" onclick="chglinkparam(this, 2)"></span></div><span class="inputtext">筛选值类型：</span><select name="valuetype" id="valuetype" class="inputform2"><option value="string" '+(y!=null&&y.valuetype=="string"?"selected":"")+'>字符类型</option><option value="number" '+(y!=null&&y.valuetype=="number"?"selected":"")+">数字类型</option></select></div>";$("#dsColumn_div").dialog({title:(z==false?"添加筛选条件":"编辑筛选条件"),width:380,height:270,closed:false,cache:false,modal:true,toolbar:null,content:v,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){if(!p.compParams){p.compParams=[]}var A=$("#dsColumn_div #filtercolumn").val();if(!A||A==""){msginfo("请选择筛选字段。");return}if(z==true){if(p.type=="grid"){y.col=A;y.alias=A;var t=e(A);y.expression=t.expression;y.fromCol=t.fromCol}else{var B=A.split("@");y.col=B[1];y.alias=B[0];y.colname=B[2];y.nodetype=B[3];y.fromCol=B[4]}y.type=$("#dsColumn_div #filtertype").val();y.val=$("#dsColumn_div #filtervalue").val();y.val2=$("#dsColumn_div #filtervalue2").val();y.valuetype=$("#dsColumn_div #valuetype").val();y.linkparam=$("#dsColumn_div #linkparam").val()==null?"":$("#dsColumn_div #linkparam").val();y.linkparam2=$("#dsColumn_div #linkparam2").val()==null?"":$("#dsColumn_div #linkparam2").val();y.usetype=$("#dsColumn_div .link_param").attr("tp")}else{var C={id:newGuid(),type:$("#dsColumn_div #filtertype").val(),val:$("#dsColumn_div #filtervalue").val(),val2:$("#dsColumn_div #filtervalue2").val(),valuetype:$("#dsColumn_div #valuetype").val(),linkparam:($("#dsColumn_div #linkparam").val()==null?"":$("#dsColumn_div #linkparam").val()),linkparam2:($("#dsColumn_div #linkparam2").val()==null?"":$("#dsColumn_div #linkparam2").val()),usetype:$("#dsColumn_div .link_param").attr("tp")};if(p.type=="grid"){C.col=A;C.alias=A;var t=e(A);C.expression=t.expression;C.fromCol=t.fromCol}else{var B=A.split("@");C.col=B[1];C.alias=B[0];C.colname=B[2];C.nodetype=B[3];C.fromCol=B[4]}p.compParams.push(C)}setcompfilter(u);$("#dsColumn_div").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#dsColumn_div #filtertype").change(function(){var o=$(this).val();if(o=="between"){$("#dsColumn_div #selval2").css("display","block")}else{$("#dsColumn_div #selval2").css("display","none")}})}function chglinkparam(a,c){var b=$(a).attr("tp");if(b=="gdz"){$(a).attr("tp","param").attr("title","固定值");$("#dsColumn_div #linkparam"+(c==2?"2":"")).css("display","inline-block");$("#dsColumn_div #filtervalue"+(c==2?"2":"")).css("display","none")}else{$(a).attr("tp","gdz").attr("title","链接到参数");$("#dsColumn_div #filtervalue"+(c==2?"2":"")).css("display","inline-block");$("#dsColumn_div #linkparam"+(c==2?"2":"")).css("display","none")}}function findParamById(d,b){var a=null;for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var c=pageInfo.params[i];if(c.id==d||c.paramid==d){if(b){a=i}else{a=c}}}return a}function ischinese(b){if(/[\u4E00-\u9FA5]/i.test(b)){return true}else{return false}}if($==undefined){$=jQuery}function selecttable(){$("#pdailog").dialog({title:"选择数据表",width:420,height:351,closed:false,cache:false,modal:true,toolbar:null,content:'<div style="margin:5px;">表分类： <select id="tableType" class="inputform"><option value=""></option><option value="etl">导入表</option><option value="tf">聚合表</option><option value="sql">SQL表</option><option value="dw">填报表</option><option value="custom">自定义</option></select></div><ul id="targettables" style="height:240px;overflow:auto;"></ul>',onLoad:function(){},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var b=$("#targettables").tree("getSelected");if(b==null){msginfo("请选择表!");return}pageInfo.table={tid:b.attributes.tid,tname:b.attributes.tname,tnote:b.attributes.tnote};$("#comp_tab").tabs("select",(!curTmpInfo.compEdit?2:1));initTableTree();curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});var a=function(b){$.getJSON("../etl/listTables.action",{t:Math.random(),income:b},function(c){for(i=0;i<c.length;i++){c[i].id=c[i].tableId;c[i].text=c[i].tableName+"("+c[i].tableNote+")";c[i].iconCls="icon-table";c[i].attributes={tid:c[i].tableId,tname:c[i].tableName,tnote:c[i].tableNote}}$("#targettables").tree({data:c,ines:true})})};a();$("#tableType").change(function(){a($(this).val())})}function initTableTree(){if(!pageInfo.table||!pageInfo.table.tid){$("#tabletree").tree({lines:false,data:[{id:"nodata",text:"您还未选择数据表!",iconCls:"icon-no"}]})}else{var a=pageInfo.table;var b={id:a.tid,text:a.tname+"("+a.tnote+")",iconCls:"icon-table",children:[]};$.getJSON("../etl/getTableColumns.action",{tableId:a.tid,t:Math.random()},function(c){for(i=0;i<c.length;i++){b.children.push({id:c[i].colName,text:c[i].colName,iconCls:"icon-dscol",attributes:{id:c[i].colName,name:c[i].colName,tid:a.tid,tname:a.tname,type:c[i].colType,expression:c[i].expression}})}$("#tabletree").tree({lines:false,dnd:true,data:[b],onBeforeDrag:function(d){if(!d.attributes||d.attributes.tp=="root"){return false}return true},onDragEnter:function(e,d){return false},onContextMenu:function(f,d){f.preventDefault()}})})}}function editGridData(d){if($("#dataProperty").size()==0){$("#Jlayout").layout("add",{region:"south",id:"dataProperty",split:false,collapsible:false,height:120,title:"编辑表格数据",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","south")}}]})}else{$("#Jlayout").layout("panel","south").panel("setTitle","编辑表格数据")}$("#comp_tab").tabs("select",(!curTmpInfo.compEdit?2:1));var b=findCompById(d);var f="";for(var c=0;b.cols&&c<b.cols.length;c++){var e=b.cols[c];f=f+'<span id="d_'+e.id+'" class="dimcol"><span class="text">'+e.name+'</span><div class="ibox-tools"><button class="btn btn-outline btn-success btn-xs" onclick="setGridCol(this, \''+e.id+"', '"+e.name+"','"+d+'\')"><i class="fa fa-wrench"></i></button></div></span>'}if(f==""){f='<div class="tipinfo">拖拽数据表字段到此处作为表格的列字段</div>'}else{f='<span id="tabRows"><b>表格字段：</b>'+f+"</span>"}var a='<div style="margin:10px;"><div class="tableDatasty" id="gridData">'+f+"</div></div>";$("#dataProperty").html(a);$("#gridData").droppable({accept:"#tabletree .tree-node",onDragEnter:function(h,g){$(g).draggable("proxy").find("span").removeClass("tree-dnd-no");$(g).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#gridData").css("border","1px solid #ff0000");h.cancelBubble=true;h.stopPropagation()},onDragLeave:function(h,g){$(g).draggable("proxy").find("span").addClass("tree-dnd-no");$(g).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#gridData").css("border","1px dotted #666");h.cancelBubble=true;h.stopPropagation()},onDrop:function(r,p){var g=findCompById(d);r.cancelBubble=true;r.stopPropagation();$("#gridData").css("border","1px dotted #666");var o=$("#tabletree").tree("getNode",p);if(g.tid&&g.tid!=o.attributes.tid){msginfo("你拖入的字段"+o.text+"与表格已有的内容不在同一个表中，拖放失败！");return}else{g.tid=o.attributes.tid;g.tname=o.attributes.tname}if(!g.cols){g.cols=[]}var h=function(u){var v=false;for(j=0;j<g.cols.length;j++){if(g.cols[j].id==u){v=true;break}}return v};if(h(o.id)){msginfo("您拖拽的字段 "+o.text+" 已经存在。");return}g.cols.push({id:o.id,name:o.attributes.name,tname:o.attributes.tname,type:o.attributes.type,expression:o.attributes.expression});var t='<span id="d_'+o.id+'" class="dimcol"><span class="text">'+o.text+'</span><div class="ibox-tools"><button class="btn btn-outline btn-success btn-xs"  onclick="setGridCol(this, \''+o.id+"', '"+o.text+"','"+d+'\')"><i class="fa fa-wrench"></i></button></div></span>';var q=$("#gridData");if(q.find("#tabRows").size()==0){q.html('<span id="tabRows"><b>表格字段：</b>'+t+"</span>")}else{$("#gridData #tabRows").find("span.dimcol").last().after(t)}curTmpInfo.isupdate=true;gridView(g)}})}function gridView(grid){if(!grid){return}if(!grid.cols||grid.cols.length==0){return}var json=eval("("+JSON.stringify(grid)+")");__showLoading();$.ajax({type:"POST",url:"GridView.action",dataType:"html",data:JSON.stringify(json),contentType:"application/json",success:function(resp){__hideLoading();$("#c_"+grid.id+" div.cctx div.ccctx").html(resp)},error:function(resp){__hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function setGridCol(e,g,c,d){var f=$(e).offset();curTmpInfo.ckid=g;curTmpInfo.compId=d;curTmpInfo.dimname=c;var a=findCompById(d);var b=findColById(g,a);if(b.sort=="asc"){$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord1")).target,iconCls:"icon-ok"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord2")).target,iconCls:"icon-blank"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord3")).target,iconCls:"icon-blank"})}else{if(b.sort=="desc"){$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord1")).target,iconCls:"icon-blank"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord2")).target,iconCls:"icon-ok"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord3")).target,iconCls:"icon-blank"})}else{$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord1")).target,iconCls:"icon-blank"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord2")).target,iconCls:"icon-blank"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord3")).target,iconCls:"icon-ok"})}}$("#gridoptmenu").menu("show",{left:f.left,top:f.top-95})}function gridColsort(d){var e=curTmpInfo.ckid;var c=curTmpInfo.compId;var a=findCompById(c);var b=findColById(e,a);for(i=0;i<a.cols.length;i++){delete a.cols[i].sort}if(d!=""){b.sort=d}curTmpInfo.isupdate=true;gridView(a)}function setGridColProp(){var f=curTmpInfo.ckid;var d=curTmpInfo.compId;var b=findCompById(d);var c=findColById(f,b);var e="";if(c.type=="Double"||c.type=="Int"){e='<span class=\'inputtext\'>格 式 化：</span><select id="fmt" name="fmt" class="inputform2"><option value=""></option><option value="###,##0" '+(c.fmt=="###,##0"?"selected":"")+'>整数</option><option value="###,##0.0" '+(c.fmt=="###,##0.0"?"selected":"")+'>小数(保留1位)</option><option value="###,##0.00" '+(c.fmt=="###,##0.00"?"selected":"")+'>小数(保留2位)</option><option value="0.00%" '+(c.fmt=="0.00%"?"selected":"")+">百分比</option></select><br/>"}if(c.type=="Date"||c.type=="Datetime"){e="<span class='inputtext'>格 式 化：</span><input type='text' id='fmt' name='fmt' class='inputform2' value=\""+(c.fmt?c.fmt:"")+'"><br/>'}var a='<div class="textpanel"><span class=\'inputtext\'>显示名称：</span><input type="text" id="dispName" name="dispName" class="inputform2" value="'+(c.dispName?c.dispName:"")+"\"><br><span class='inputtext'>所 属 表： </span>"+c.tname+"<br><span class='inputtext'>对应字段：</span> "+c.name+"<br>"+e+'<span class=\'inputtext\'>位置：</span><select id="palign" name="palign" class="inputform2"><option value=""></option><option value="left" '+(c.align=="left"?"selected":"")+'>居左</option><option value="center" '+(c.align=="center"?"selected":"")+'>居中</option><option value="right" '+(c.align=="right"?"selected":"")+">居右</option></select></div>";$("#pdailog").dialog({title:"表格字段属性",width:350,height:270,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var h=$("#pdailog #dispName").val();var g=$("#pdailog #fmt").val();var o=$("#pdailog #palign").val();c.dispName=h;c.fmt=g;c.align=o;$("#pdailog").dialog("close");curTmpInfo.isupdate=true;gridView(b)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}function tableColmove(e){var f=curTmpInfo.ckid;var c=curTmpInfo.compId;var a=findCompById(c);var d=a.cols;if(d.length<=1){msginfo("无效移动。");return}for(var b=0;b<d.length;b++){if(d[b].id==f){if(e=="left"){if(b<=0){msginfo("无效移动。");return}else{var e=d[b-1];d[b-1]=d[b];d[b]=e;$("#gridData #d_"+f).prev().before($("#gridData #d_"+f));curTmpInfo.isupdate=true;gridView(a);return}}else{if(e=="right"){if(b>=d.length-1){msginfo("无效移动。");return}else{var e=d[b+1];d[b+1]=d[b];d[b]=e;$("#gridData #d_"+f).next().after($("#gridData #d_"+f));curTmpInfo.isupdate=true;gridView(a);return}}}break}}}function delGridCol(){var e=curTmpInfo.ckid;var c=curTmpInfo.compId;var b=findCompById(c);if(b.cols.length==1){msginfo("表格至少需要含有一个字段。");return}var a=-1;for(i=0;i<b.cols.length;i++){var d=b.cols[i];if(d.id==e){a=i;break}}b.cols.splice(a,1);$("#gridData #d_"+e).remove();curTmpInfo.isupdate=true;gridView(b)}function setGridProperty(a){if($("#compSet").size()==0){$("#Jlayout").layout("add",{region:"east",split:false,width:240,title:"表格属性配置",collapsible:false,id:"compSet",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","east")}}]})}else{$("#Jlayout").layout("panel","east").panel("setTitle","表格属性配置")}$("#compSet").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,fitColumns:false,onAfterEdit:function(f,d,c){var e=d.value;var b=d.col;curTmpInfo.isupdate=true;if(b=="name"){a.name=e;$("#c_"+a.id+" .ibox-title").contents().filter(function(g,h){if(h.nodeType==3){h.nodeValue=e}})}else{if(a[b]==e){return}a[b]=e}if(b=="height"||b=="isnotfy"||b=="pageSize"){gridView(a)}},data:[{name:"表格标题",col:"name",value:(a.name?a.name:""),group:"表格属性",editor:"text"},{name:"是否显示标题",col:"showtitle",value:(a.showtitle?a.showtitle:"true"),group:"表格属性",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"禁用分页",col:"isnotfy",value:(a.isnotfy?a.isnotfy:""),group:"表格属性",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"每页显示条数",col:"pageSize",value:(a.pageSize?a.pageSize:"10"),group:"表格属性",editor:{type:"numberspinner",options:{min:1,max:100,increment:5}}},{name:"数据集",col:"tname",value:(a.tname),group:"表格属性"}]})}function setBoxProperty(a){if($("#compSet").size()==0){$("#Jlayout").layout("add",{region:"east",split:false,width:240,title:"数据块属性配置",collapsible:false,id:"compSet",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","east")}}]})}else{$("#Jlayout").layout("panel","east").panel("setTitle","数据块属性配置")}$("#compSet").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,fitColumns:false,onAfterEdit:function(f,d,c){var e=d.value;var b=d.col;curTmpInfo.isupdate=true;if(b=="name"){a.name=e;$("#c_"+a.id+" .ibox-title").contents().filter(function(g,h){if(h.nodeType==3){h.nodeValue=e}})}else{if(b=="bgcolor"){a[b]=e;if(e==""){$("#c_"+a.id+" div.ibox-content").css("background-color","inherit")}else{$("#c_"+a.id+" div.ibox-content").css("background-color",e)}}else{if(b=="showtitle"){a[b]=e}else{if(a.kpiJson[b]==e){return}a.kpiJson[b]=e;boxView(a)}}}},data:[{name:"标题",col:"name",value:(a.name?a.name:""),group:"数据块属性",editor:"text"},{name:"单位",col:"unit",value:(a.kpiJson&&a.kpiJson!=null?a.kpiJson.unit:""),group:"数据块属性",editor:"text"},{name:"格式化",col:"fmt",value:(a.kpiJson&&a.kpiJson!=null?a.kpiJson.fmt:""),group:"数据块属性",editor:{type:"combobox",options:{data:fmtJson}}},{name:"字体大小",col:"tfontsize",value:(a.kpiJson&&a.kpiJson.tfontsize?a.kpiJson.tfontsize:"32"),group:"数据块属性",editor:{type:"numberspinner",options:{min:9,max:100,increment:3}}},{name:"字体颜色",col:"tfontcolor",value:(a.kpiJson&&a.kpiJson.tfontcolor?a.kpiJson.tfontcolor:""),group:"数据块属性",editor:{type:"combobox",options:{data:colorJson,formatter:function(b){return'<div style="background-color:'+b.value+'">'+b.text+"</div>"}}}},{name:"背景颜色",col:"bgcolor",value:(a.bgcolor?a.bgcolor:""),group:"数据块属性",editor:{type:"combobox",options:{data:colorJson,formatter:function(b){return'<div style="background-color:'+b.value+'">'+b.text+"</div>"}}}},{name:"度量比例",col:"rate",value:(a.kpiJson&&a.kpiJson!=null?a.kpiJson.rate:""),group:"数据块属性",editor:{type:"combobox",options:{data:kpirate}}},{name:"数据集",col:"tname",value:(a.tname),group:"数据块属性"}]})}function editBoxData(d){if($("#dataProperty").size()==0){$("#Jlayout").layout("add",{region:"south",id:"dataProperty",split:false,collapsible:false,height:100,title:"绑定数据块度量",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","south")}}]})}else{$("#Jlayout").layout("panel","south").panel("setTitle","绑定数据块度量")}$("#comp_tab").tabs("select",(!curTmpInfo.compEdit?1:0));var c=findCompById(d);var f="";if(!c.kpiJson){f='<div class="tipinfo">拖拽需要展现的立方体度量到此处。</div>'}var b="";var e=c.kpiJson;if(e){b='<span id="d_'+e.kpi_id+'" class="boxcol"><span class="text">'+e.kpi_name+"</span></span>"}var a='<div style="margin:10px;"><div class="tableDatasty" id="boxData">'+f+b+"</div></div>";$("#dataProperty").html(a);$("#dataProperty #boxData").droppable({accept:"#datasettree .tree-node",onDragEnter:function(o,h){var g=$("#datasettree").tree("getNode",h);var p=g.attributes.col_type;if(p==2){}else{return}$(h).draggable("proxy").find("span").removeClass("tree-dnd-no");$(h).draggable("proxy").find("span").addClass("tree-dnd-yes");$(this).css("border","1px solid #ff0000");o.cancelBubble=true;o.stopPropagation()},onDragLeave:function(h,g){$(g).draggable("proxy").find("span").addClass("tree-dnd-no");$(g).draggable("proxy").find("span").removeClass("tree-dnd-yes");$(this).css("border","1px dotted #666");h.cancelBubble=true;h.stopPropagation()},onDrop:function(p,o){var r=d;var g=findCompById(r);p.cancelBubble=true;p.stopPropagation();$(this).css("border","1px dotted #666");var h=$("#datasettree").tree("getNode",o);var q=h.attributes.col_type;if(q==2){}else{msginfo("只能拖拽度量到数据块中显示。");return}g.tid=h.attributes.tid;g.tname=h.attributes.tname;g.kpiJson={kpi_id:h.attributes.col_id,kpi_name:h.text,col_name:h.attributes.col_name,aggre:h.attributes.aggre,fmt:h.attributes.fmt,alias:h.attributes.alias,tid:g.tid,tname:g.tname,unit:h.attributes.unit,rate:h.attributes.rate};$("#dataProperty #boxData").html('<span id="k_'+h.attributes.col_id+'" class="boxcol"><span class="text">'+h.text+"</span></span>");c.name=h.text;$("#c_"+c.id+" .ibox-title").contents().filter(function(t,u){if(u.nodeType==3){u.nodeValue=c.name}});curTmpInfo.isupdate=true;boxView(c)}})}function boxView(a){if(!a.kpiJson){return}var b={kpiJson:a.kpiJson,height:a.height,compParams:a.compParams,portalParams:pageInfo.params,tid:a.tid};__showLoading();$.ajax({type:"POST",url:"BoxView.action",dataType:"html",contentType:"application/json",data:JSON.stringify(b),success:function(c){__hideLoading();$("#c_"+a.id+" div.cctx div.ccctx").html(c)},error:function(c){__hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function findColById(d,a){var b;for(i=0;i<a.cols.length;i++){var c=a.cols[i];if(c.id==d){b=c;break}}return b};