if($==undefined){$=jQuery}function crtChart(e){var a=false;var d=false;var b=false;var g=false;var f=false;if(curTmpInfo.charttype){var h=curTmpInfo.charttype;a=h=="pie"||h=="gauge";d=h=="bubble"||h=="scatter";b=h=="bubble";g=h=="map";f=h=="line"||h=="column"||h=="bar"||h=="area"||h=="radar"}else{var c=findCompById(e);var h=c.chartJson.type;a=h=="pie"||h=="gauge";d=h=="bubble"||h=="scatter";b=h=="bubble";g=h=="map";f=h=="line"||h=="column"||h=="bar"||h=="area"||h=="radar"}if(g){return'<div class="'+(curTmpInfo.chartpos=="left"?"tsbd":"tsbd2")+'"><div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'">地域：<div class="h_ctx" id="xcol"><span class="charttip">将地域拖到这里</span></div></div><div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'">度量：<div id="ycol" class="h_ctx"><span class="charttip">将度量拖到这里</span></div></div></div><div class="chartctx" style="'+(curTmpInfo.chartpos=="top"?"margin-left:auto":"")+'">图表预览区域</div>'}else{return'<div class="'+(curTmpInfo.chartpos=="left"?"tsbd":"tsbd2")+'">'+(d?'<div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'">'+(a?"观察维度":"横轴")+'：<div id="y2col" class="h_ctx"><span class="charttip">将度量拖到这里</span></div></div>':'<div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'">'+(a?"观察维度":"横轴")+'：<div id="xcol" class="h_ctx"><span class="charttip">将维度拖到这里</span></div></div>')+'<div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'">'+(a?"度量":"纵轴")+'：<div id="ycol" class="h_ctx"><span class="charttip">将度量拖到这里</span></div></div>'+(f?'<div class=\'ts_h\' style=\'display:none;\'>纵轴：<div id="ycols" class="h_ctx_multi"><span class="charttip">将度量拖到这里</span></div></div>':"")+(b?'<div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'">气泡大小：<div id="y3col" class="h_ctx"><span class="charttip">将度量拖到这里</span></div></div>':"")+(d?'<div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'">观察维度：<div id="xcol" class="h_ctx"><span class="charttip">将维度拖到这里</span></div></div>':"")+(b?"":'<div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'" '+(a?'style="display:none"':"")+'>图例：<div id="scol" class="h_ctx"><span class="charttip">将维度拖到这里</span></div></div>')+(f?"<div class=\"checkbox checkbox-info checkbox-inline\" style=\"margin-left:10px;\"><input type='checkbox' id='mulitKpi' value='n' onclick=\"mutltiKpiCheck(this)\"><label for='mulitKpi'>多指标查询</labe></div>":"")+"</div>"+(a||d||curTmpInfo.chartpos=="top"?"":"<div class=\"exchangexs\"><img src='../resource/img/exchangexs1.gif'><a title='交换维度' href='javascript:exchangexs("+e+", true);'><img src='../resource/img/reload.png' border='0'></a><img src='../resource/img/exchangexs2.gif'></div>")+'<div class="chartctx" style="'+(curTmpInfo.chartpos=="top"?"margin-left:auto;":"")+(d?"height:220px;":"")+'">图表预览区域</div>'}}function mutltiKpiCheck(b){var a=findCompById(2);if(b.checked){a.mkpi=true;$("#chartarea #scol").parent().hide();$("#chartarea #ycol").parent().hide();$("#chartarea div.exchangexs").hide();$("#chartarea #ycols").parent().show();delete a.chartJson.scol;$("#chartarea #scol").html("")}else{a.mkpi=false;$("#chartarea #scol").parent().show();$("#chartarea #ycol").parent().show();$("#chartarea div.exchangexs").show();$("#chartarea #ycols").parent().hide()}chartview(a,a.id)}function updateChart(){var a=findCompById(2);$("#pdailog").dialog({title:"切换图表",width:400,height:370,closed:false,cache:false,modal:true,toolbar:null,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){if(curTmpInfo.selectChart==undefined){msginfo("您还未选择图表，请点击图表示意图片，再点确认按钮。")}else{var e=a.chartJson.type=curTmpInfo.selectChart;var c=e=="line"||e=="column"||e=="bar"||e=="area"||e=="radar";if(a.mkpi==true){if(c){}else{delete a.mkpiJson;a.mkpi=false}}else{delete a.kpiJson[1];delete a.kpiJson[2];if(e=="pie"||e=="gauge"){delete a.chartJson.scol}}delete curTmpInfo.selectChart;if(e=="map"){var b=$("#pdailog #maparea").val().split(",");a.chartJson.maparea=b[0];a.chartJson.mapAreaName=b[1]}$("#pdailog").dialog("close");var d=crtChart(a.id);$("#chartarea div.ctx").html(d);backChartData(a);if(e=="bubble"||e=="scatter"){initChartByScatter(2)}else{initChartKpiDrop(2)}chartview(a,a.id)}}},{text:"取消",iconCls:"icon-cancel",handler:function(){delete curTmpInfo.selectChart;$("#pdailog").dialog("close")}}]});$("#pdailog").dialog("refresh","insertChart.action?tp="+a.chartJson.type)}function chartcss(){$(".chartselect .selleft ul li").bind("click",function(){var d=$(this).attr("cid");$(".chartselect .selleft ul li").removeClass("select");$(this).addClass("select");$(".chartselect .selright .one").css("display","none");$("#schart"+d).css("display","block");var c=$("#schart"+d).attr("tp");curTmpInfo.selectChart=c});curTmpInfo.selectChart="line";var a=findCompById(2);if(a==null){curTmpInfo.selectChart="line"}else{curTmpInfo.selectChart=a.chartJson.type;var b=$(".chartselect .selleft li.select").attr("cid");$(".chartselect .selright .one").css("display","none");$("#schart"+b).css("display","block")}}function chartview(b,a){if(b.mkpi&&b.mkpi==true){if(!b.mkpiJson||b.mkpiJson.length==0){return}}else{if(!b.kpiJson||b.kpiJson.length==0){return}}if(b.chartJson.type=="scatter"&&(b.kpiJson.length<2||b.kpiJson[1]==null)){return}if(b.chartJson.type=="bubble"&&(b.kpiJson.length<3||b.kpiJson[2]==null)){return}__showLoading();var b={chartJson:b.chartJson,kpiJson:b.kpiJson,mkpiJson:b.mkpiJson,mkpi:b.mkpi,tid:b.tid,id:a,params:pageInfo.params};$.ajax({type:"POST",url:"ChartView.action",dataType:"html",contentType:"application/json",data:JSON.stringify(b),success:function(c){__hideLoading();$("#T"+a+" div.chartctx").css("height","auto");$("#T"+a+" div.chartctx").html(c)},error:function(c){__hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function initChartKpiDrop(a){$("#T"+a+" #xcol, #T"+a+" #ycol, #T"+a+" #ycols, #T"+a+" #scol").droppable({accept:"ul.chartTreeCss .tree-node",onDragEnter:function(d,c){var b=$("#datasettree").tree("getNode",c);var g=b.attributes.col_type;var f=$(this).attr("id");if(g==1&&(f=="xcol"||f=="scol")){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+a+" #"+f).css("border-color","#ff0000")}if(g==2&&(f=="ycol"||f=="ycols")){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+a+" #"+f).css("border-color","#ff0000")}d.cancelBubble=true;d.stopPropagation()},onDragLeave:function(c,b){$(b).draggable("proxy").find("span").addClass("tree-dnd-no");$(b).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#7F9DB9");c.cancelBubble=true;c.stopPropagation()},onDrop:function(h,g){var l=$(this).parents(".comp_table").attr("id").replace("T","");var d=findCompById(Number(l));$("#T"+l+" #"+$(this).attr("id")).css("border-color","#7F9DB9");var f=$("#datasettree").tree("getNode",g);h.cancelBubble=true;h.stopPropagation();if(d.tid!=undefined){if(d.tid!=f.attributes.tid){msginfo("您拖入的"+(f.attributes.col_type==2?"度量":"维度")+"与组件已有的内容不在同一个数据表中，拖放失败。");return}}d.tid=f.attributes.tid;if(d.kpiJson==undefined){d.kpiJson=[]}if(f.attributes.col_type==1){var c=f.attributes.col_id;if(findDimById(c,d.chartJson.params)!=null){msginfo("您拖放的维度已存在于钻取维中，不能拖放。");return}}if(f.attributes.col_type==2&&$(this).attr("id")=="ycol"){d.kpiJson=[];d.kpiJson.push({kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate,fromCol:f.attributes.fromCol});d.chartJson.ycol={type:"kpi"};$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'ycol','"+f.text+"')\"></span>");curTmpInfo.isupdate=true;chartview(d,l)}if(f.attributes.col_type==2&&$(this).attr("id")=="ycols"){if(!d.mkpiJson){d.mkpiJson=[]}if($(this).find("span.charttip").size()>0){$(this).html("")}if(getMultiKpi(f.attributes.col_id,d)!=null){msginfo("度量已经存在。");return}d.mkpiJson.push({kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate,fromCol:f.attributes.fromCol});d.chartJson.ycol={type:"kpi"};$(this).append('<div class="multi_one" id="y'+f.attributes.col_id+'"><span title="'+f.text+'" class="charttxt2">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'ycols','"+f.text+"')\"></span></div>");curTmpInfo.isupdate=true;chartview(d,l)}if(f.attributes.col_type==1&&$(this).attr("id")=="xcol"){if(d.chartJson.scol!=undefined&&d.chartJson.scol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于图例项中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.scol!=undefined&&d.chartJson.scol.grouptype==b){msginfo("您拖放的维度与此图表中已有维度分组相同，不能拖放。");return}}d.chartJson.xcol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.col_name,alias:f.attributes.alias,tid:d.tid,iscas:f.attributes.iscas,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,valType:f.attributes.valType,ordcol:f.attributes.ordcol,dateformat:f.attributes.dateformat,fromCol:f.attributes.fromCol};$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'xcol', '"+f.text+"')\"></span>");curTmpInfo.isupdate=true;chartview(d,l)}if(f.attributes.col_type==1&&$(this).attr("id")=="scol"){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于横轴中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.grouptype==b){msginfo("您拖放的维度与此图表中已有维度分组相同，不能拖放。");return}}d.chartJson.scol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.col_name,alias:f.attributes.alias,tid:d.tid,iscas:f.attributes.iscas,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,valType:f.attributes.valType,ordcol:f.attributes.ordcol,fromCol:f.attributes.fromCol};$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this,'+f.attributes.col_id+", 'scol', '"+f.text+"')\"></span>");curTmpInfo.isupdate=true;chartview(d,l)}}})}function getMultiKpi(d,c){var b=null;for(i=0;c.mkpiJson&&i<c.mkpiJson.length;i++){var a=c.mkpiJson[i];if(a.kpi_id==d){b=a;break}}return b}function initChartByScatter(a){$("#T"+a+" #xcol, #T"+a+" #ycol, #T"+a+" #y2col, #T"+a+" #y3col, #T"+a+" #scol").droppable({accept:"ul.chartTreeCss .tree-node",onDragEnter:function(d,c){var b=$("#datasettree").tree("getNode",c);var f=b.attributes.col_type;if(f==1&&($(this).attr("id")=="scol"||$(this).attr("id")=="xcol")){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#ff0000")}if(f==2&&($(this).attr("id")=="ycol"||$(this).attr("id")=="y2col"||$(this).attr("id")=="y3col")){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#ff0000")}d.cancelBubble=true;d.stopPropagation()},onDragLeave:function(c,b){$(b).draggable("proxy").find("span").addClass("tree-dnd-no");$(b).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#7F9DB9");c.cancelBubble=true;c.stopPropagation()},onDrop:function(h,g){var n=$(this).parents(".comp_table").attr("id").replace("T","");var d=findCompById(Number(n));$("#T"+n+" #"+$(this).attr("id")).css("border-color","#7F9DB9");var f=$("#datasettree").tree("getNode",g);h.cancelBubble=true;h.stopPropagation();if(d.tid!=undefined){if(d.tid!=f.attributes.tid){msginfo("您拖入的"+(f.attributes.col_type==2?"度量":"维度")+"与组件已有的内容不在同一个数据表中，拖放失败。");return}}d.tid=f.attributes.tid;if(d.kpiJson==undefined){d.kpiJson=[]}if(f.attributes.col_type==1){var c=f.attributes.col_id;if(findDimById(c,d.chartJson.params)!=null){msginfo("您拖放的维度已存在于钻取维中，不能拖放。");return}}if(f.attributes.col_type==2&&$(this).attr("id")=="ycol"){if(!d.kpiJson){d.kpiJson=[null,null,null]}if((d.kpiJson[1]!=null&&d.kpiJson[1].kpi_id==f.attributes.col_id)||(d.kpiJson[2]!=null&&d.kpiJson[2].kpi_id==f.attributes.col_id)){msginfo("您拖放的度量已存在当前图表中。");return}d.kpiJson[0]={kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate,fromCol:f.attributes.fromCol};d.chartJson.ycol={type:"kpi"};$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'ycol','"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}if(f.attributes.col_type==2&&$(this).attr("id")=="y2col"){if(!d.kpiJson){d.kpiJson=[null,null,null]}if((d.kpiJson[0]!=null&&d.kpiJson[0].kpi_id==f.attributes.col_id)||(d.kpiJson[2]!=null&&d.kpiJson[2].kpi_id==f.attributes.col_id)){msginfo("您拖放的度量已存在当前图表中。");return}var l={kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate,fromCol:f.attributes.fromCol};d.kpiJson[1]=l;$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'y2col','"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}if(f.attributes.col_type==2&&$(this).attr("id")=="y3col"){if(!d.kpiJson){d.kpiJson=[null,null,null]}if((d.kpiJson[0]!=null&&d.kpiJson[0].kpi_id==f.attributes.col_id)||(d.kpiJson[1]!=null&&d.kpiJson[1].kpi_id==f.attributes.col_id)){msginfo("您拖放的度量已存在当前图表中。");return}var l={kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate,fromCol:f.attributes.fromCol};d.kpiJson[2]=l;$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'y3col','"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}if(f.attributes.col_type==1&&$(this).attr("id")=="xcol"){if(d.chartJson.scol!=undefined&&d.chartJson.scol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于图例项中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.scol!=undefined&&d.chartJson.scol.grouptype==b){msginfo("您拖放的维度与此图表中已有维度分组相同，不能拖放。");return}}d.chartJson.xcol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.col_name,alias:f.attributes.alias,tid:d.tid,iscas:f.attributes.iscas,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,valType:f.attributes.valType,ordcol:f.attributes.ordcol,fromCol:f.attributes.fromCol};$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'xcol', '"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}if(f.attributes.col_type==1&&$(this).attr("id")=="scol"){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于横轴中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.grouptype==b){msginfo("您拖放的维度与此图表中已有维度分组相同，不能拖放。");return}}d.chartJson.scol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.col_name,alias:f.attributes.alias,tid:d.tid,iscas:f.attributes.iscas,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,valType:f.attributes.valType,ordcol:f.attributes.ordcol,fromCol:f.attributes.fromCol};$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this,'+f.attributes.col_id+", 'scol', '"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}}})}function backChartData(a){var c=a.id;if(!$.isEmptyObject(a.chartJson.xcol)){var b=a.chartJson.xcol;$("#T"+c+" #xcol").html('<span title="'+b.dimdesc+'" class="charttxt">'+b.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+b.id+",'xcol', '"+b.dimdesc+"')\"></span>")}if(a.mkpiJson&&a.mkpiJson.length>0){$("#T"+c+" #ycols span.charttip").remove();for(i=0;i<a.mkpiJson.length;i++){var b=a.mkpiJson[i];$("#T"+c+" #ycols").append('<div class="multi_one" id="y'+b.kpi_id+'"><span title="'+b.kpi_name+'" class="charttxt2">'+b.kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+b.kpi_id+",'ycols','"+b.kpi_name+"')\"></span></div>")}}if(a.kpiJson&&a.kpiJson.length>0){var b=a.kpiJson[0];$("#T"+c+" #ycol").html('<span title="'+b.kpi_name+'" class="charttxt">'+b.kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+b.kpi_id+",'ycol','"+b.kpi_name+"')\"></span>")}if(a.mkpi==true){$("#chartarea #mulitKpi").attr("checked",true);mutltiKpiCheck(document.getElementById("mulitKpi"))}if(a.kpiJson&&(a.chartJson.type=="scatter"||a.chartJson.type=="bubble")){var b=a.kpiJson[1];if(b!=null){$("#T"+c+" #y2col").html('<span title="'+b.kpi_name+'" class="charttxt">'+b.kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+b.kpi_id+",'y2col','"+b.kpi_name+"')\"></span>")}b=a.kpiJson[2];if(b!=null){$("#T"+c+" #y3col").html('<span title="'+b.kpi_name+'" class="charttxt">'+b.kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+b.kpi_id+",'y3col','"+b.kpi_name+"')\"></span>")}}if(!$.isEmptyObject(a.chartJson.scol)){if(a.chartJson.type!="pie"&&a.chartJson.type!="gauge"){var b=a.chartJson.scol;$("#T"+c+" #scol").html('<span title="'+b.dimdesc+'" class="charttxt">'+b.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this,'+b.id+", 'scol', '"+b.dimdesc+"')\"></span>")}}}function chartmenu(b,e,d,a){var c=$(b).offset();curTmpInfo.ckid=e;curTmpInfo.tp=d;curTmpInfo.compId=$(b).parents(".comp_table").attr("id").replace("T","");curTmpInfo.dimname=a;if(d=="ycol"||d=="y2col"||d=="y3col"){$("#chartoptmenu").menu("enableItem",$("#m_set"))}else{$("#chartoptmenu").menu("disableItem",$("#m_set"))}$("#chartoptmenu").menu("show",{left:c.left,top:c.top+20})}function chartsort(e){var d=curTmpInfo.tp;var c=curTmpInfo.compId;var f=curTmpInfo.ckid;var b=findCompById(c);if(d=="xcol"){if(b.mkpi==true){for(var a=0;a<b.mkpiJson.length;a++){delete b.mkpiJson[a].sort}}else{delete b.kpiJson[0].sort}b.chartJson.xcol.dimord=e}else{if(d=="ycol"){b.kpiJson[0].sort=e}else{if(d=="ycols"){for(var a=0;a<b.mkpiJson.length;a++){delete b.mkpiJson[a].sort}var a=getMultiKpi(f,b);a.sort=e}else{if(d=="scol"){delete b.kpiJson[0].sort;b.chartJson.scol.dimord=e}}}}curTmpInfo.isupdate=true;chartview(b,c)}function delChartKpiOrDim(){var e=curTmpInfo.tp;var d=curTmpInfo.compId;var f=curTmpInfo.ckid;var c=findCompById(d);if(e=="xcol"){c.chartJson.xcol={};$("#T"+d+" #xcol").html('<span class="charttip">将维度拖到这里</span>');curTmpInfo.isupdate=true;chartview(c,d)}if(e=="ycol"){c.chartJson.ycol={};if(c.kpiJson.length>1){c.kpiJson[0]=null}else{c.kpiJson=[]}$("#T"+d+" #ycol").html('<span class="charttip">将度量拖到这里</span>')}if(e=="ycols"){$("#T"+d+" #ycols #y"+f).remove();var a=-1;for(i=0;i<c.mkpiJson.length;i++){var b=c.mkpiJson[i];if(b.kpi_id==f){a=i;break}}c.mkpiJson.splice(a,1);chartview(c,d)}if(e=="y2col"){if(c.kpiJson.length>1){c.kpiJson[1]=null}else{c.kpiJson=[]}$("#T"+d+" #y2col").html('<span class="charttip">将度量拖到这里</span>')}if(e=="y3col"){c.kpiJson[2]=null;$("#T"+d+" #y3col").html('<span class="charttip">将度量拖到这里</span>')}if(e=="scol"){c.chartJson.scol={};$("#T"+d+" #scol").html('<span class="charttip">将维度拖到这里</span>');curTmpInfo.isupdate=true;chartview(c,d)}}function setChartKpi(){var g=curTmpInfo.tp;if(g=="xcol"||g=="scol"){return}var c=curTmpInfo.ckid;var e=curTmpInfo.compId.replace("T","");var d=curTmpInfo.dimname;var b=findCompById(e);var f=null;if(g=="ycol"){f=b.kpiJson[0]}else{if(g=="y2col"){f=b.kpiJson[1]}else{if(g=="y3col"){f=b.kpiJson[2]}}}var a="<div style='line-height:30px; margin:5px;'><span class=\"inputtext\">度量名称：</span>"+f.kpi_name+'<br><span class="inputtext">所 属 表：</span> '+f.tname+'<br><span class="inputtext">聚合方式：</span> '+f.aggre+"<br><span class=\"inputtext\">度量单位：</span><select id=\"kpiunit\" name=\"kpiunit\" class=\"inputform2\"><option value='1'></option><option value='1000'>千</option><option value='10000'>万</option><option value='1000000'>百万</option><option value='100000000'>亿</option></select>"+f.unit+'<br><span class="inputtext">格 式 化：</span><select id="fmt" name="fmt" class="inputform2"><option value="###,##0">整数</option><option value="###,##0.00">小数(保留2位)</option><option value="0.00%">百分比</option></select></div>';$("#pdailog").dialog({title:"度量属性",width:340,height:260,closed:false,cache:false,modal:true,content:a,toolbar:null,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){f.fmt=$("#pdailog #fmt").val();f.rate=Number($("#pdailog #kpiunit").val());$("#pdailog").dialog("close");curTmpInfo.isupdate=true;chartview(b,e)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #fmt").find("option[value='"+f.fmt+"']").attr("selected",true);$("#pdailog #kpiunit").find("option[value='"+f.rate+"']").attr("selected",true)}function chartfilterDims(){var h=curTmpInfo.tp;var g=curTmpInfo.ckid;var l=curTmpInfo.compId.replace("T","");var b=curTmpInfo.dimname;var e=findCompById(l);var d=null;if(h=="xcol"){d=e.chartJson.xcol}else{if(h=="scol"){d=e.chartJson.scol}else{if(h=="ycols"){return kpiFilter("chart",true)}else{return kpiFilter("chart")}}}$("#pdailog").dialog({title:b+" - 维度筛选",width:300,height:341,closed:false,cache:false,modal:true,content:'<div id="div_chartfilter"><div class="panel-loading">Loading...</div></div>',onClose:function(){$("#pdailog").removeClass("hidebody")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var r=$("#dimfiltertab").tabs("getSelected");var q=$("#dimfiltertab").tabs("getTabIndex",r);if("day"==d.type&&q==0){var p=$("#dimfiltertab #dft2").val();var o=$("#dimfiltertab #dft1").val();if(Number(p.replace(/-/g,""))>Number(o.replace(/-/g,""))){msginfo("您选择的开始日期不能大于结束日期。");return}d.startdt=p;d.enddt=o;d.filtertype=1;delete d.vals}else{if("month"==d.type&&q==0){var p=$("#dimfiltertab #dfm2").val();var o=$("#dimfiltertab #dfm1").val();if(Number(p)>Number(o)){msginfo("您选择的开始月份不能大于结束月份。");return}d.startmt=p;d.endmt=o;d.filtertype=1;delete d.vals}else{var s="";var t=$("#pdailog input[name='dimval']:checkbox:checked");t.each(function(v,u){s=s+$(this).val();if(v!=t.size()-1){s=s+","}});d.vals=s;d.filtertype=2;delete d.startmt;delete d.endmt;delete d.startdt;delete d.enddt}}curTmpInfo.isupdate=true;chartview(e,l);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog").addClass("hidebody");var c=d.type;var n=d;var f=d.filtertype==undefined?"":d.filtertype;var a="DimFilter.action?tid="+e.tid+"&filtertype="+f+"&id="+g;if(c=="month"){a=a+"&st="+(n.startmt==undefined?"":n.startmt);a=a+"&end="+(n.endmt==undefined?"":n.endmt)}if(c=="day"){a=a+"&st="+(n.startdt==undefined?"":n.startdt);a=a+"&end="+(n.enddt==undefined?"":n.enddt);a=a+"&dateformat="+n.dateformat}$("#pdailog #div_chartfilter").load(a,{vals:d.vals?d.vals:""})}function exchangexs(d,f){var b=findCompById(d);if(b.chartJson==undefined||(b.chartJson.xcol==undefined&&b.chartJson.scol==undefined)){msginfo("您还未选择维度。")}var c=b.chartJson.xcol;b.chartJson.xcol=b.chartJson.scol;b.chartJson.scol=c;if(b.chartJson.xcol&&b.chartJson.xcol.id){var e=b.chartJson.xcol;$("#T"+d+" #xcol").html('<span title="'+(e.dimdesc?e.dimdesc:"")+'" class="charttxt">'+(e.dimdesc?e.dimdesc:"")+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+e.id+",'xcol', '"+e.dimdesc+"')\"></span>")}else{$("#T"+d+" #xcol").html('<span class="charttip">将维度拖到这里</span>')}if(b.chartJson.scol&&b.chartJson.scol.id){var e=b.chartJson.scol;$("#T"+d+" #scol").html('<span title="'+(e.dimdesc?e.dimdesc:"")+'" class="charttxt">'+(e.dimdesc?e.dimdesc:"")+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+e.id+",'scol', '"+e.dimdesc+"')\"></span>")}else{$("#T"+d+" #scol").html('<span class="charttip">将维度拖到这里</span>')}curTmpInfo.isupdate=true;chartview(b,d);if(b.complink&&f){var a=findCompById(b.complink);if(a!=null&&isSameDimsInDrill(a,b)){curTmpInfo.compId="T"+a.id;changecolrow(false)}}}function crtChartfromTab(){var compId=curTmpInfo.compId.replace("T","");var comp=findCompById(compId);var rows="";for(i=0;i<comp.rows.length;i++){var selected="";if(i==comp.rows.length-1){selected="selected"}rows=rows+"<option value='"+comp.rows[i].id+"' "+selected+">"+comp.rows[i].dimdesc+"</option>"}var cols="";for(i=0;i<comp.cols.length;i++){var selected="";if(i==comp.cols.length-1){selected="selected"}cols=cols+"<option value='"+comp.cols[i].id+"' "+selected+">"+comp.cols[i].dimdesc+"</option>"}var ctx="<div style='line-height:25px; margin:10px;'><span class=\"inputtext\">类型：</span><select id='charttype' class=\"inputform2\"><option value='line'>曲线图</option><option value='column'>柱状图</option><option value='pie'>饼图</option><option value='radar'>雷达图</option></select><br><span class=\"inputtext\">横轴：</span><select id='hz' class=\"inputform2\">"+rows+'</select><br/><span class="inputtext">图例：</span><select id=\'zz\' class="inputform2">'+cols+"</select></div>";$("#pdailog").dialog({title:"通过表格数据生成图表",width:320,height:220,closed:false,cache:false,modal:true,content:ctx,toolbar:null,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var tp=$("#charttype").val();var xcol=$("#hz").val();var scol=$("#zz").val();var kpi=curTmpInfo.ckid;$("#pdailog").dialog("close");var chart={id:2,name:"图表组件",type:"chart",chartJson:{type:tp,ycol:{type:"kpi"},params:[]},tid:comp.tid,tname:comp.tname,ttype:comp.ttype,kpiJson:[],complink:comp.id};comp.complink=chart.id;var k=eval("("+JSON.stringify(findKpiById(kpi,comp.kpiJson))+")");chart.kpiJson.push(k);if(xcol!=null&&xcol!=""){chart.chartJson.xcol=eval("("+JSON.stringify(findDimById(xcol,comp.rows))+")")}if(scol!=null&&scol!=""){chart.chartJson.scol=eval("("+JSON.stringify(findDimById(scol,comp.cols))+")")}for(k=0;k<comp.rows.length;k++){if(comp.rows[k].id==xcol||comp.rows[k].id==scol){}else{chart.chartJson.params.push(comp.rows[k])}}for(k=0;k<comp.cols.length;k++){if(comp.cols[k].id==xcol||comp.cols[k].id==scol){}else{chart.chartJson.params.push(comp.cols[k])}}curTmpInfo.isupdate=true;curTmpInfo.charttype=tp;addComp(chart.id,chart.name,null,false,chart.type,chart);pageInfo.comps[1]=chart;$('a[data-toggle="tab"]').last().tab("show")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}function exportChart(c){var b=findCompById(c);if(b.kpiJson==undefined||b.kpiJson.length==0){return}var f="[]";if(pageInfo.params&&pageInfo.params.length>0){f=JSON.stringify(pageInfo.params)}var a=JSON.stringify(b.chartJson);var e=JSON.stringify(b.kpiJson);var d=$("<form name='exp' method='post' action=\"ChartView!export.action\" id='exp'><input type='hidden' id='chartJson' name='chartJson'><input type='hidden' id='compId' name='compId'><input type='hidden' id='kpiJson' name='kpiJson'><input type='hidden' id='params' name='params'></form>");d.appendTo("body");d.find("#chartJson").val(a);d.find("#compId").val(c);d.find("#kpiJson").val(e);d.find("#params").val(f);d.submit();d.remove()}if($==undefined){$=jQuery}function drill(g,h,f,b,c,a,l){var e=findCompById(h);var d=function(){var u=null;if(f=="row"){u=e.rows}else{u=e.cols}if(e.complink&&l){var q=findCompById(e.complink);if(q!=null&&isSameDimsInDrill(e,q)){drillingChart(g,q.id,f,b,c,a,false)}}var o=null;var p=0;for(i=0;i<u.length;i++){if(u[i].id==a){p=i;u[i].vals=b;if(u[i].type=="month"){u[i].filtertype=1;u[i].startmt=b;u[i].endmt=b;delete u[i].vals;o=u[i]}if(u[i].type=="day"){var n=u[i].dateformat;var s=b;u[i].filtertype=1;u[i].startdt=s;u[i].enddt=u[i].startdt;delete u[i].vals;o=u[i]}}}var r=null;for(j=0;j<e.dims.length;j++){if(e.dims[j].id==g){r=e.dims[j];break}}var t={id:r.id,dimdesc:r.dimdesc,type:r.type,colname:r.colname,alias:r.alias,tid:r.tid,iscas:"",tableName:"",tableColKey:(r.tableColKey==null?"":r.tableColKey),tableColName:(r.tableColName==null?"":r.tableColName),dimord:(r.dimord==null?"":r.dimord),grouptype:r.grouptype,valType:r.valType,endlvl:r.endlvl,ordcol:(r.ordcol==null?"":r.ordcol),dateformat:(r.dateformat==null?"":r.dateformat),fromCol:r.fromCol};u.splice(p+1,0,t);curTmpInfo.isupdate=true;tableView(e,e.id)};if(!e.dims){if(curTmpInfo.face){$.ajax({async:false,type:"get",jsonp:"jsonpcallback",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"Dim!queryDimsByFace.action",data:{tableId:e.tid},dataType:"jsonp",success:function(n){e.dims=n;d()}})}else{$.ajax({async:false,type:"POST",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"queryDims.action",data:{tableId:e.tid},dataType:"json",success:function(n){e.dims=n;d()}})}}else{d()}}function openTheDim(e,h,g,d,a){var c=findCompById(e);var b=findDimById(a,h=="row"?c.rows:c.cols);if(b.grouptype==null){msginfo("维度无下级层次。","error");return}var f=function(o){var n=0;for(i=0;i<o.length;i++){if(o[i].id==a){if(i<o.length-1&&o[i+1].grouptype==o[i].grouptype){var l=o[i+1];if(dimExist(l.id,c.cols)||dimExist(l.id,c.rows)){n=2;break}drill(l.id,e,h,g,d,a,true);n=1;break}}}if(n==0){msginfo("维度无下级层次。","error")}else{if(n==2){msginfo("维度下级层次已经展开。","error")}}};if(!c.dims){if(curTmpInfo.face){$.ajax({async:false,type:"get",jsonp:"jsonpcallback",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"Dim!queryDimsByFace.action",data:{tableId:c.tid},dataType:"jsonp",success:function(l){c.dims=l;f(c.dims)}})}else{$.ajax({async:false,type:"POST",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"queryDims.action",data:{tableId:c.tid},dataType:"json",success:function(l){c.dims=l;f(c.dims)}})}}else{f(c.dims)}}function drillDim(n,h,l,d,e,c){var g=findCompById(n);var f=$(h).offset();var b=findDimById(c,l=="row"?g.rows:g.cols);var a=function(s){$("#drillmenu").menu("destroy");var w='<div id="drillmenu" style="width:150px">';var q=0;var y=[];var A=function(B,D){var C=false;for(k=0;k<B.length;k++){if(B[k]==D){C=true}}return C};var x=function(B){var C=[];for(j=0;j<s.length;j++){if(s[j].grouptype==B){C.push(s[j])}}return C};for(i=0;i<s.length;i++){if(dimExist(s[i].id,g.cols)||dimExist(s[i].id,g.rows)){continue}if(s[i].grouptype==""||s[i].grouptype==null){var p=s[i].id;w=w+'<div onclick="drill('+p+", "+g.id+", '"+l+"', '"+d+"', '"+e+"', '"+c+'\', true)"><span style="color:#ccc">下钻</span>'+s[i].dimdesc+"</div>";q=q+1}else{if(!A(y,s[i].grouptype)){var r='<div><span style="color:#ccc">下钻</span><span>'+s[i].groupname+'</span><div style="width:150px;">';y.push(s[i].grouptype);var o=x(s[i].grouptype);var z="";var t=0;for(kl=0;kl<o.length;kl++){var u=o[kl];var v=!dimExist(u.id,g.cols)&&!dimExist(u.id,g.rows);if(v){z=z+'<div onclick="drill('+u.id+", "+g.id+", '"+l+"', '"+d+"', '"+e+"', '"+c+'\', true)"><span style="color:#ccc">下钻</span>'+u.dimdesc+"</div>";t=t+1}else{z="";t=0}}r=r+z+"</div></div>";if(t==0){r=""}w=w+r;q=q+t}}}w=w+"</div>";if(q==0){msginfo("数据已钻透。","error");return}$(w).appendTo("body");$("#drillmenu").menu({});$("#drillmenu").menu("show",{left:f.left,top:f.top+20})};if(g.dims){a(g.dims)}else{if(curTmpInfo.face){$.ajax({async:false,type:"get",jsonp:"jsonpcallback",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"Dim!queryDimsByFace.action",data:{tableId:g.tid},dataType:"jsonp",success:function(o){g.dims=o;a(g.dims)}})}else{$.ajax({async:false,type:"POST",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"queryDims.action",data:{tableId:g.tid},dataType:"json",success:function(o){g.dims=o;a(g.dims)}})}}}function goupDim(l,d,e,h,n){var g=null;var c=findCompById(l);if(e=="row"){g=c.rows}else{g=c.cols}if(c.complink&&n){var b=findCompById(c.complink);if(b!=null&&isSameDimsInDrill(c,b)){chartGoupDim(b.id,h,e,false)}}var f=0;for(i=0;i<g.length;i++){if(g[i].id==h){g[i].vals="";if(g[i].type=="day"){delete g[i].startdt;delete g[i].enddt}if(g[i].type=="month"){delete g[i].startmt;delete g[i].endmt}f=i;break}}g.splice(f+1,g.length-1);if(!isExistDateDim(c,"table")){for(var a=0;c.kpiJson&&a<c.kpiJson.length;a++){delete c.kpiJson[a].compute}}if(!paramsamedimdate(c)){for(var a=0;c.kpiJson&&a<c.kpiJson.length;a++){delete c.kpiJson[a].compute}}curTmpInfo.isupdate=true;tableView(c,c.id)}function drillChart(g,e,l,b,h,n,c){var f=findCompById(n);var d=h;var a=function(u){var t=f.chartJson.type;if(t=="map"){if(f.chartJson.xcol.type=="prov"){var C=null;for(j=0;j<u.length;j++){if(u[j].type=="city"){C=u[j]}}if(C==null){msginfo("未找到地市维度。");return}$.post("getProvByName.action",{name:e},function(D){f.chartJson.maparea=D.code;f.chartJson.mapAreaName=D.provName;drillingChart(C.id,n,"row",g,e,c,true)},"JSON");return}else{msginfo("地图只支持从省钻到市。");return}}$("#drillmenu").menu("destroy");var x='<div id="drillmenu" style="width:150px">';var r=0;var z=[];var B=function(D,F){var E=false;for(k=0;k<D.length;k++){if(D[k]==F){E=true}}return E};var y=function(D){var E=[];for(j=0;j<u.length;j++){if(u[j].grouptype==D){E.push(u[j])}}return E};for(i=0;i<u.length;i++){if(dimExist(u[i].id,f.chartJson.params)||(f.chartJson.xcol&&u[i].id==f.chartJson.xcol.id)||(f.chartJson.scol&&u[i].id==f.chartJson.scol.id)){continue}if(u[i].grouptype==""||u[i].grouptype==null){var p=u[i].id;x=x+'<div onclick="drillingChart('+p+", "+f.id+", 'row', '"+g+"', '"+e+"', '"+c+'\', true)"><span style="color:#ccc">下钻</span>'+u[i].dimdesc+"</div>";r=r+1}else{if(!B(z,u[i].grouptype)){var q='<div><span style="color:#ccc">下钻</span><span>'+u[i].groupname+'</span><div style="width:150px;">';z.push(u[i].grouptype);var o=y(u[i].grouptype);var A="";var v=0;for(kl=0;kl<o.length;kl++){var w=o[kl];var s=dimExist(w.id,f.chartJson.params)||(f.chartJson.xcol&&w.id==f.chartJson.xcol.id)||(f.chartJson.scol&&w.id==f.chartJson.scol.id);if(!s){A=A+'<div onclick="drillingChart('+w.id+", "+f.id+", 'row', '"+g+"', '"+e+"', '"+c+'\', true)"><span style="color:#ccc">下钻</span>'+w.dimdesc+"</div>";v=v+1}else{A="";v=0}}q=q+A+"</div></div>";if(v==0){q=""}x=x+q;r=r+v}}}x=x+"</div>";if(r==0){msginfo("数据已钻透。","error");return}$(x).appendTo("body");$("#drillmenu").menu({});$("#drillmenu").menu("show",{left:d.left,top:d.top+20})};if(f.dims){a(f.dims)}else{$.ajax({async:false,type:"POST",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"queryDims.action",data:{tableId:f.tid},dataType:"json",success:function(o){f.dims=o;a(f.dims)}})}}function drillingChart(b,o,n,l,g,a,q){var h=findCompById(o);if(!h.dims){$.ajax({async:false,type:"POST",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"queryDims.action",data:{tableId:h.tid},dataType:"json",success:function(r){h.dims=r}})}if(n=="row"){if(h.chartJson.xcol&&!$.isEmptyObject(h.chartJson.xcol)){h.chartJson.xcol.vals=l+"";h.chartJson.xcol.valDesc=g;h.chartJson.xcol.pos="row"}}else{h.chartJson.scol.vals=l+"";h.chartJson.scol.valDesc=g;h.chartJson.scol.pos="col"}if(h.complink&&q){var d=findCompById(h.complink);if(d!=null&&isSameDimsInDrill(d,h)){drill(b,d.id,"row",l,g,a,false)}}var f=n=="row"?h.chartJson.xcol:h.chartJson.scol;if(f&&!$.isEmptyObject(f)){f.filtertype=2;if(f.type=="month"){delete f.startmt;delete f.endmt}if(f.type=="day"){delete f.startdt;delete f.enddt}}if(f&&!$.isEmptyObject(f)){h.chartJson.params.push(n=="row"?h.chartJson.xcol:h.chartJson.scol)}var p=null;for(j=0;j<h.dims.length;j++){if(h.dims[j].id==b){p=h.dims[j];break}}var e={id:p.id,dimdesc:p.dimdesc,type:p.type,colname:p.colname,alias:p.alias,tid:p.tid,tableName:"",tableColKey:(p.tableColKey==null?"":p.tableColKey),tableColName:(p.tableColName==null?"":p.tableColName),dimord:p.dimord,grouptype:p.grouptype,valType:p.valType,ordcol:(p.ordcol==null?"":p.ordcol),dateformat:(p.dateformat==null?"":p.dateformat),fromCol:p.fromCol};if(n=="row"){h.chartJson.xcol=e}else{h.chartJson.scol=e}var c=e;$("#T"+h.id+(n=="row"?" #xcol":" #scol")).html('<span class="charttxt">'+c.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+c.id+","+(n=="row"?"'xcol'":"'scol'")+", '"+c.dimdesc+"')\"></span>");curTmpInfo.isupdate=true;chartview(h,h.id)}function chartGoupDim(l,g,d,n){var c=findCompById(l);if(c.chartJson.type=="map"){c.chartJson.maparea="china"}var e=c.chartJson.params;if(c.complink&&n){var b=findCompById(c.complink);if(b!=null&&isSameDimsInDrill(b,c)){goupDim(b.id,null,d,g,false)}}var f=0;var h=null;for(i=0;i<e.length;i++){if(e[i].id==g){e[i].vals="";e[i].valDesc="";delete e[i].filtertype;f=i;h=e[i];break}}if(d=="row"){c.chartJson.xcol=h}else{c.chartJson.scol=h}e.splice(f,e.length);var a=h;$("#T"+c.id+(d=="row"?" #xcol":" #scol")).html('<span class="charttxt">'+a.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+a.id+","+(d=="row"?"'xcol'":"'scol'")+", '"+a.dimdesc+"')\"></span>");curTmpInfo.isupdate=true;chartview(c,c.id)}function isSameDimsInDrill(f,e){var d=f;var b=e.chartJson;var g=d.cols.length+d.rows.length;var c=(b.params?b.params.length:0)+($.isEmptyObject(b.xcol)?0:1)+($.isEmptyObject(b.scol)?0:1);if(g!=c){return false}var a=true;for(i=0;b.params&&i<b.params.length;i++){if(!dimExist(b.params[i].id,d.cols)&&!dimExist(b.params[i].id,d.rows)){return false}}if(!$.isEmptyObject(b.xcol)){if(!dimExist(b.xcol.id,d.cols)&&!dimExist(b.xcol.id,d.rows)){return false}}if(!$.isEmptyObject(b.scol)){if(!dimExist(b.scol.id,d.cols)&&!dimExist(b.scol.id,d.rows)){return false}}return a}if($==undefined){$=jQuery}function reloadDatasetTree(){$("#datasettreediv ul").remove();var a=$(window).height()-200;$("#datasettreediv").append('<ul id="datasettree" class="tableTreeCss" style="overflow:auto;height:'+a+'px;"></ul>');if(pageInfo.selectDs==null||pageInfo.selectDs=="null"){$("#datasettree").tree({dnd:false,data:[{id:"err",text:"数据还未创建立方体。",iconCls:"icon-no"}]});return}else{if(pageInfo.selectDs==""){$("#datasettree").tree({dnd:false,data:[{id:"err",text:"还未选择数据。",iconCls:"icon-no"}]});return}else{$("#datasettree").tree({url:"../model/cubeTree.action?selectDsIds="+pageInfo.selectDs+"&t="+Math.random(),dnd:true,lines:false,onBeforeDrag:function(b){if(!b.attributes||b.attributes.tp=="root"){return false}return true},onDragEnter:function(c,b){return false}})}}}function newpage(){var a="ReportDesign.action?menus="+curTmpInfo.menus+"&showtit="+showtit;if(curTmpInfo.isupdate==true){if(confirm("页面还未保存\n是否保存当前页面？")){savepage(function(){location.href=a})}else{location.href=a}}else{location.href=a}}function initparam(){if(pageInfo.params&&pageInfo.params.length>0){$("#p_param div.ptabhelpr").remove();$("#p_param").append("<b>参数： </b>");for(i=0;i<pageInfo.params.length;i++){var a=$("#p_param");var b='<span class="pppp" id="pa_'+pageInfo.params[i].id+'"><span title="筛选" onclick="paramFilter(\''+pageInfo.params[i].id+"', '"+pageInfo.params[i].type+"', '"+pageInfo.params[i].name+'\')" class="text">'+pageInfo.params[i].name+"(";if(pageInfo.params[i].type=="day"||pageInfo.params[i].type=="month"){b=b+pageInfo.params[i].st+" 至 "+pageInfo.params[i].end}else{b=b+(!pageInfo.params[i].valStrs||pageInfo.params[i].valStrs==""?"无":pageInfo.params[i].valStrs)}b=b+')</span><button title="删除" class="btn btn-default btn-xs" onclick="deleteParam(\''+pageInfo.params[i].id+'\')"><i class="fa fa-remove"></i></button></span>';a.append(b)}}$("#p_param").droppable({accept:"#datasettree .tree-node",onDragEnter:function(f,d){var c=$("#datasettree").tree("getNode",d);var g=c.attributes.col_type;if(g==1){$(d).draggable("proxy").find("span").removeClass("tree-dnd-no");$(d).draggable("proxy").find("span").addClass("tree-dnd-yes");$(this).css("border","1px solid #ff0000")}f.cancelBubble=true;f.stopPropagation()},onDragLeave:function(d,c){$(c).draggable("proxy").find("span").addClass("tree-dnd-no");$(c).draggable("proxy").find("span").removeClass("tree-dnd-yes");$(this).css("border","1px solid #d3d3d3");d.cancelBubble=true;d.stopPropagation()},onDrop:function(h,d){h.cancelBubble=true;h.stopPropagation();$(this).css("border","1px solid #d3d3d3");var c=$("#datasettree").tree("getNode",d);var l=c.attributes.col_type;if(l==1){if(!pageInfo.params){pageInfo.params=[]}if(findParamById(c.attributes.col_id)!=null){msginfo("您已经添加了该参数！","error");return}var n=c.attributes.col_id;var g={id:n,name:c.text,type:c.attributes.dim_type,colname:c.attributes.col_name,alias:c.attributes.alias,tname:c.attributes.tname,tid:c.attributes.tid,valType:c.attributes.valType,tableName:c.attributes.tableName,tableColKey:c.attributes.tableColKey,tableColName:c.attributes.tableColName,dimord:c.attributes.dimord,grouptype:c.attributes.grouptype,dateformat:(c.attributes.dateformat==null?"":c.attributes.dateformat),fromCol:c.attributes.fromCol};pageInfo.params.push(g);var f=$(this);f.find("div.ptabhelpr").remove();if(f.find("b").size()==0){f.append("<b>参数： </b>")}f.append('<span class="pppp" id="pa_'+n+'"><span title="筛选" onclick="paramFilter(\''+n+"', '"+c.attributes.dim_type+"','"+c.text+'\')" class="text">'+c.text+'(无)</span><button class="btn btn-default btn-xs" title="删除" onclick="deleteParam(\''+n+'\')"><i class="fa fa-remove"></i></button></span>');paramFilter(n,g.type,g.name)}}})}function paramFilter(e,c,b){var d=findParamById(e);$("#pdailog").dialog({title:b+" - 参数值筛选",width:290,height:d.type=="month"||d.type=="day"?240:320,closed:false,cache:false,modal:true,content:'<div id="div_paramfilter"><div class="panel-loading">Loading...</div></div>',onClose:function(){$("#pdailog").removeClass("hidebody")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var g="";var f="";if(d.type=="month"){d.st=$("#pdailog #dfm2").val();d.end=$("#pdailog #dfm1").val();if(Number(d.st)>Number(d.end)){msginfo("您选择的开始月份不能大于结束月份。","error");return}$("#p_param #pa_"+e+" span.text").text(b+"("+d.st+" 至 "+d.end+")")}else{if(d.type=="day"){d.st=$("#pdailog #dft2").val();d.end=$("#pdailog #dft1").val();if(Number(d.st.replace(/-/g,""))>Number(d.end.replace(/-/g,""))){msginfo("您选择的开始日期不能大于结束日期。","error");return}$("#p_param #pa_"+e+" span.text").text(b+"("+d.st+" 至 "+d.end+")")}else{var h=$("#pdailog input[name='dimval']:checkbox:checked");h.each(function(n,l){if(n>=10){return}g=g+$(this).val();if(n==h.size()-1||n==9){}else{g=g+","}f=f+$(this).attr("desc");if(n==h.size()-1||n==9){}else{f=f+","}});$("#p_param #pa_"+e+" span.text").text(b+"("+(f==""?"无":f)+")");d.vals=g;d.valStrs=f}}$("#pdailog").dialog("close");curTmpInfo.isupdate=true;flushPage()}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog").addClass("hidebody");var a=(curTmpInfo.filterUrl?curTmpInfo.filterUrl:"paramFilter.action")+"?tid="+d.tid+"&id="+e;if(d.type=="month"){a=a+"&st="+(d.st?d.st:"")+"&end="+(d.end?d.end:"")}else{if(d.type=="day"){a=a+"&st="+(d.st?d.st:"")+"&end="+(d.end?d.end:"")}else{}}$("#pdailog #div_paramfilter").load(a,{vals:(!d.vals||d.vals==""?"":d.vals),t:Math.random()})}function searchDims2(c,d){var b=findParamById(d);var a="paramSearch.action?tid="+b.tid+"&id="+d+"";$.ajax({type:"POST",url:a,data:{keyword:c,vals:(!b.vals||b.vals==""?"":b.vals),t:Math.random()},dataType:"HTML",success:function(e){$("#pdailog .dfilter").html(e)}})}function flushPage(){for(var b=0;pageInfo.comps&&b<pageInfo.comps.length;b++){var c=pageInfo.comps[b].type;if(c=="table"){var a=pageInfo.comps[b];if(!paramsamedimdate(a)){for(i=0;a.kpiJson&&i<a.kpiJson.length;i++){delete a.kpiJson[i].compute}}tableView(pageInfo.comps[b],pageInfo.comps[b].id)}else{if(c=="chart"){chartview(pageInfo.comps[b],pageInfo.comps[b].id)}}}}function deleteParam(c){$("#p_param #pa_"+c).remove();var a=-1;for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var b=pageInfo.params[i];if(b.id==c){a=i;break}}pageInfo.params.splice(a,1);if(pageInfo.params.length==0){$("#p_param").html('<div class="ptabhelpr">拖拽维度到此处作为页面参数</div>')}flushPage()}function openreport(){var a='<div class="openlistbody"><div style="margin:5px 5px 5px 1px;float:left;"><button id="rename" class="btn btn-info btn-xs">更名</button> <button class="btn btn-danger btn-xs" id="delreport">删除</button></div><div align="right" style="margin:5px;"><input id="subSearchBox" style="width:160px"></input></div><table id="reportlist" title=""></div><thead><tr><th data-options="field:\'ck\',checkbox:true"></th><th data-options="field:\'pageName\',width:210">报表名称</th><th data-options="field:\'crtuser\',width:100,align:\'center\'">创建人</th><th data-options="field:\'crtDate\',width:90,align:\'center\'">创建时间</th></tr></thead></table></div>';$("#pdailog").dialog({title:"打开报表",width:450,height:360,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#pdailog").removeClass("hidebody")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var c=$("#reportlist").datagrid("getSelected");if(!c||c==null){msginfo("请至少选择一个报表！","error");return}$("#pdailog").dialog("close");$(this).attr("href","#");var b="ReportDesign.action?pageId="+c.pageId+"&showtit="+showtit+"&menus="+curTmpInfo.menus;if(curTmpInfo.isupdate==true){if(confirm("页面还未保存\n是否保存当前页面？")){savepage(function(){location.href=b})}else{location.href=b}}else{location.href=b}}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog").addClass("hidebody");$("#rename").click(function(){var b=$("#reportlist").datagrid("getSelected");if(!b||b==null){msginfo("请至少选择一个报表！","error");return}$.messager.prompt("报表改名","请输入新的报表名称？",function(c){if(c){$.ajax({type:"POST",url:"renameReport.action",dataType:"json",data:{pageId:b.pageId,pageName:c},success:function(d){$("#pdailog #reportlist").datagrid("load",{})},error:function(){}})}})});$("#delreport").click(function(){var b=$("#reportlist").datagrid("getSelected");if(!b||b==null){msginfo("请至少选择一个报表！","error");return}if(confirm("是否确认删除？")){$.ajax({type:"POST",url:"deleteReport.action",dataType:"json",data:{id:b.pageId},success:function(c){$("#pdailog #reportlist").datagrid("load",{})},error:function(){}})}});$("#reportlist").datagrid({singleSelect:true,collapsible:false,pagination:false,border:true,height:256,url:"listReport.action",method:"post",queryParams:{id:"0",t:Math.random()}});$("#subSearchBox").searchbox({searcher:function(c,b){$("#pdailog #reportlist").datagrid("load",{keyword:c,t:Math.random()})},prompt:"请输入查询关键字."})}function addComp(g,c,b,e,f,a){if(b==null||b==undefined){if(f=="table"){if(a==null||a==undefined){b=crtCrossTable()}else{if(a==undefined||a.kpiJson==undefined){b=crtCrossTable()}else{b=""}}}else{if(f=="chart"){b=crtChart(g)}}}if(e==true){pageInfo.comps.push({id:g,name:c,type:f});curTmpInfo.isupdate=true}var d='<div class="comp_table" tp="'+f+'" id="T'+g+'"><div class="ctx">'+(b==null?"":b)+"</div></div>";if(f=="table"){$("#optarea").html(d)}else{if(f=="chart"){$("#chartarea").html(d)}}if(f=="table"){btns=[];if(a!=null&&a!=undefined){if(a==undefined||a.kpiJson==undefined){initDropDiv(g)}else{tableView(a,g)}}else{initDropDiv(g)}}if(f=="chart"){if(a!=null&&a!=undefined){chartview(a,g);backChartData(a);if(a.chartJson.type=="bubble"||a.chartJson.type=="scatter"){initChartByScatter(g)}else{initChartKpiDrop(g)}}else{if(curTmpInfo.charttype=="bubble"||curTmpInfo.charttype=="scatter"){initChartByScatter(g)}else{initChartKpiDrop(g)}}}}function selectdataset(){$("#pdailog").dialog({title:"选择数据模型",width:620,height:400,closed:false,cache:false,modal:true,toolbar:null,content:'<div style="margin:5px;float:left;">主题分类： <input id="subjectCubeSelect" style="width:200px;"></div><div align="right" style="margin:5px;"><input id="subSearchBox" style="width:160px"></input></div><table id="subjectlist" title="" style="width:610px;height:300px;" ><thead><tr><th data-options="field:\'ck\',checkbox:true"><th data-options="field:\'tDesc\',width:160">名称</th><th data-options="field:\'typeName\',width:100">分类</th><th data-options="field:\'tNote\',width:300">说明</th></tr></thead></table>',onClose:function(){$("#pdailog").removeClass("hidebody")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var a=$("#subjectlist").datagrid("getChecked");if(a==null||a.length==0){msginfo("请勾选数据。","error");return}pageInfo.selectDs=a[0].tid;$("#pdailog").dialog("close");curTmpInfo.isupdate=true;reloadDatasetTree()}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog").addClass("hidebody");$("#subjectCubeSelect").combotree({url:"../model/listSubjectType.action",height:25,onClick:function(a){$("#subjectlist").datagrid("load",{typeId:a.id,t:Math.random()})}});$("#subSearchBox").searchbox({searcher:function(b,a){$("#subjectlist").datagrid("load",{key:b,t:Math.random()})},prompt:"请输入查询关键字."});$("#subjectlist").datagrid({singleSelect:true,collapsible:false,pagination:true,pageSize:20,border:true,url:"../model/listAuthSubject.action",method:"post",queryParams:{t:Math.random()}})}function savepage(b){for(k=0;k<pageInfo.comps.length;k++){var e=pageInfo.comps[k];var f=e.type,g=e.id}var a=JSON.stringify(pageInfo);var d=pageInfo.id;if(d==undefined||d==null){d=""}if(d==""){var c='<div style="margin:10px 20px 5px 20px;"><br/><span style="display:inline-block;width:60px;"> 报表名称： </span><input type="text" style="width:187px;" id="pageName"></div>';$("#pdailog").dialog({title:"保存报表",width:330,height:160,closed:false,cache:false,modal:true,toolbar:null,content:c,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var h=$("#pdailog #pageName").val();if(h==""){msginfo("您还未录入文件名称。","error");$("#pdailog #pageName").focus();return}$.post("saveReport.action",{pageInfo:a,pageId:"",pageName:h},function(l){if(l.result==0){msginfo(l.msg,"error");return}pageInfo.id=Number(l.rows);if(b!=undefined){b()}else{}msginfo("保存成功！","success");curTmpInfo.isupdate=false;$("#pdailog").dialog("close")})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}else{$.post("saveReport.action",{pageInfo:a,pageId:d},function(h){if(b!=undefined){b()}else{}msginfo("保存成功！","success");curTmpInfo.isupdate=false})}}function saveas(){var jsonStr=JSON.stringify(pageInfo);var json=eval("("+jsonStr+")");delete json.id;var ctx='<div style="margin:10px 20px 5px 20px;"><br/><span style="display:inline-block;width:60px;"> 报表名称： </span><input type="text" style="width:187px;" id="pageName"></div>';$("#pdailog").dialog({title:"另存报表",width:330,height:160,closed:false,cache:false,modal:true,toolbar:null,content:ctx,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var name=$("#pdailog #pageName").val();if(name==""){msginfo("您还未录入文件名称。","error");$("#pdailog #pageName").focus();return}$.post("saveReport.action",{pageInfo:JSON.stringify(json),pageId:"",pageName:name},function(resp){if(resp.result==0){msginfo(resp.msg,"error");return}else{$("#pdailog").dialog("close");msginfo("保存成功！","success")}})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}function printData(){var d=$("div.tabs-container li.active a").attr("idx");var g=JSON.parse(JSON.stringify(pageInfo));var b=findCompById(d,g);if(!b||!b.tid){msginfo("页面无内容.");return}g.comps=[b];var e=JSON.stringify(g);var f="about:blank";var c="printwindow";window.open(f,c);var a="<form name='prtff' method='post' target='printwindow' action=\"print.action\" id='expff'><input type='hidden' name='pageInfo' id='ppageInfo'></form>";var h=$(a).appendTo("body");$("#ppageInfo").val(e);h.submit().remove()}function exportPage(f){var a="<form name='expff' method='post' action=\"ReportExport.action\" id='expff'><input type='hidden' name='type' id='type'><input type='hidden' name='json' id='json'><input type='hidden' name='picinfo' id='picinfo'></form>";if($("#expff").size()==0){$(a).appendTo("body")}var c=$("div.tabs-container li.active a").attr("idx");var e=JSON.parse(JSON.stringify(pageInfo));var b=findCompById(c,e);if(!b||!b.tid){msginfo("页面无内容.");return}e.comps=[b];$("#expff #type").val(f);$("#expff #json").val(JSON.stringify(e));var d="";if(f=="pdf"||f=="excel"||f=="word"){$("div.chartUStyle").each(function(g,h){var o=$(this).attr("id");o=o.substring(1,o.length);var l=echarts.getInstanceByDom(document.getElementById(o));var n=l.getDataURL({type:"png",pixelRatio:1,backgroundColor:"#fff"});n=n.split(",")[1];n=$(this).attr("label")+","+n;d=d+n;if(g!=$("div.chartUStyle").size()-1){d=d+"@"}})}$("#expff #picinfo").val(d);$("#expff").submit()}function cleanData(){var a=pageInfo.idx?pageInfo.idx:"1";if(a=="1"){pageInfo.comps[0]={name:"表格组件",id:1,type:"table"};$("#T1 div.ctx").html(crtCrossTable());initDropDiv("1")}else{if(a=="2"){pageInfo.comps[1]={name:"",id:2,type:"chart",chartJson:{type:"line",params:[]},kpiJson:[]};$("#T2 div.ctx").html(crtChart(2));initChartKpiDrop(2)}}}function kpidesc(){$("#pdailog").dialog({title:"度量解释",width:600,height:350,closed:false,cache:false,modal:true,toolbar:null,buttons:[{text:"关闭",iconCls:"icon-ok",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog").dialog("refresh","kpidesc.action?selectDsIds="+pageInfo.selectDs,{t:Math.random()})}if($==undefined){$=jQuery}function crtCrossTable(){var a="<table class='d_table'><tr><td class='blank'></td><td><div id='d_colDims' class='tabhelpr'>将维度拖到此处作为列标签</div></td></tr><tr><td><div id='d_rowDims' class='tabhelpr'>将维度拖到此处<br>作为行标签</div></td><td><div id='d_kpi' class='tabhelpr'>将度量拖到此处<br>查询数据</div></td></tr></table>";return a}function initDropDiv(b){var a=false;$("#T"+b+" #d_colDims, #T"+b+" #d_rowDims, #T"+b+" #d_kpi").droppable({accept:"ul.tableTreeCss .tree-node",onDragEnter:function(f,d){var c=$("#datasettree").tree("getNode",d);var g=c.attributes.col_type;if(g==1&&($(this).attr("id")=="d_colDims"||$(this).attr("id")=="d_rowDims")){$(d).draggable("proxy").find("span").removeClass("tree-dnd-no");$(d).draggable("proxy").find("span").addClass("tree-dnd-yes");if($(this).attr("id")=="d_colDims"){$("#T"+b+" #d_colDims").css("border","1px solid #ff0000")}if($(this).attr("id")=="d_rowDims"){$("#T"+b+" #d_rowDims").css("border","1px solid #ff0000")}a=true}else{a=false}if(g==2&&$(this).attr("id")=="d_kpi"){$(d).draggable("proxy").find("span").removeClass("tree-dnd-no");$(d).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+b+" #d_kpi").css("border","1px solid #ff0000");a=false}f.cancelBubble=true;f.stopPropagation()},onDragLeave:function(d,c){if($(this).attr("id")=="d_kpi"&&a==true){}else{$(c).draggable("proxy").find("span").addClass("tree-dnd-no");$(c).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#T"+b+" #"+$(this).attr("id")).css("border","none")}d.cancelBubble=true;d.stopPropagation()},onDrop:function(h,f){var l=$(this).parents(".comp_table").attr("id").replace("T","");var c=findCompById(Number(l));h.cancelBubble=true;h.stopPropagation();$("#T"+l+" #"+$(this).attr("id")).css("border","none");var d=$("#datasettree").tree("getNode",f);if(c.tid!=undefined){if(c.tid!=d.attributes.tid){msginfo("您拖入的"+(d.attributes.col_type==2?"度量":"维度")+"与组件已有的内容不在同一个数据表中，拖放失败。","error");return}}c.tid=d.attributes.tid;c.tname=d.attributes.tname;c.ttype=d.attributes.ttype;c.dsource=d.attributes.dsource;if(c.kpiJson==undefined){c.kpiJson=[]}if(c.cols==undefined){c.cols=[]}if(c.rows==undefined){c.rows=[]}if(d.attributes.col_type==2&&$(this).attr("id")=="d_kpi"){if(!kpiExist(d.attributes.col_id,c.kpiJson)){c.kpiJson.push({kpi_id:d.attributes.col_id,kpi_name:d.text,col_name:d.attributes.col_name,aggre:d.attributes.aggre,fmt:d.attributes.fmt,alias:d.attributes.alias,tid:c.tid,unit:d.attributes.unit,rate:d.attributes.rate,fromCol:d.attributes.fromCol})}else{msginfo("度量已经存在。","error");return}curTmpInfo.isupdate=true;tableView(c,Number(l))}if(d.attributes.col_type==1){if($(this).attr("id")=="d_colDims"){if(dimExist(d.attributes.col_id,c.cols)||dimExist(d.attributes.col_id,c.rows)){msginfo("维度已经存在。","error");return}var g=d.attributes.grouptype;if(g!=null&&findGroup(c.rows,g)){msginfo("拖放失败，同一分组的维度必须在同一行/列标签。","error");return}c.cols.push({id:d.attributes.col_id,dimdesc:d.text,type:d.attributes.dim_type,colname:d.attributes.col_name,alias:d.attributes.alias,tid:c.tid,iscas:d.attributes.iscas,tableName:d.attributes.tableName,tableColKey:d.attributes.tableColKey,tableColName:d.attributes.tableColName,dimord:d.attributes.dimord,grouptype:d.attributes.grouptype,valType:d.attributes.valType,endlvl:d.attributes.endlvl,ordcol:d.attributes.ordcol,dateformat:d.attributes.dateformat,fromCol:d.attributes.fromCol});curTmpInfo.isupdate=true;tableView(c,Number(l))}if($(this).attr("id")=="d_rowDims"){if(dimExist(d.attributes.col_id,c.rows)||dimExist(d.attributes.col_id,c.cols)){msginfo("维度已经存在。","error");return}var g=d.attributes.grouptype;if(g!=null&&findGroup(c.cols,g)){msginfo("拖放失败，同一分组的维度必须在同一行/列标签。","error");return}c.rows.push({id:d.attributes.col_id,dimdesc:d.text,type:d.attributes.dim_type,colname:d.attributes.col_name,alias:d.attributes.alias,tid:c.tid,iscas:d.attributes.iscas,tableName:d.attributes.tableName,tableColKey:d.attributes.tableColKey,tableColName:d.attributes.tableColName,dimord:d.attributes.dimord,grouptype:d.attributes.grouptype,valType:d.attributes.valType,endlvl:d.attributes.endlvl,ordcol:d.attributes.ordcol,dateformat:d.attributes.dateformat,fromCol:d.attributes.fromCol});curTmpInfo.isupdate=true;tableView(c,Number(l))}}}});fireTableScroll(b)}function findGroup(d,c,b){var a=false;if(!d||d==null){return a}for(m=0;m<d.length;m++){if(b&&b==d[m]){continue}if(d[m].grouptype==c){a=true;break}}return a}function paramsamedimdate(a){var d=true;var b=function(e){var f=false;for(var g=0;a.cols&&g<a.cols.length;g++){if(a.cols[g].type==e){f=true;break}}for(var g=0;a.rows&&g<a.rows.length;g++){if(a.rows[g].type==e){f=true;break}}return f};var c=pageInfo.params;for(i=0;c&&i<c.length;i++){if(c[i].type=="year"||c[i].type=="quarter"||c[i].type=="month"||c[i].type=="day"){if(!b(c[i].type)){d=false;break}}}return d}function kpicompute(h){var b={zb:1,sxpm:1,jxpm:1,ydpj:1,sq:2,tq:2,zje:2,hb:2,tb:2};var e=curTmpInfo.ckid;var l=curTmpInfo.compId.replace("T","");var d=findCompById(l);var g=findKpiById(e,d.kpiJson);if(h=="zb"){g.compute="zb"}else{if(h=="sxpm"){g.compute="sxpm"}else{if(h=="jxpm"){g.compute="jxpm"}else{if(!isExistDateDim(d,"table")){msginfo("当前度量计算需要表格中先有时间类型的维度(年/季度/月/日)。","error");return}if(!paramsamedimdate(d)){msginfo("度量计算时，需要表格中具有和参数相同的维度。","error");return}var f=g.compute;if(!f||f==""){g.compute=h}else{var a=f.split(",");if(b[a[0]]==1){g.compute=h}else{var c=false;for(j=0;j<a.length;j++){if(a[j]==h){c=true;break}}if(!c){g.compute=f+","+h}}}}}}tableView(d,l)}function delExtKpi(d,g,f){var c=$(d).parents(".comp_table").attr("id").replace("T","");var a=findCompById(Number(c));var h=findKpiById(g,a.kpiJson);var e=h.compute.split(",");if(e.length==1){delete h.compute}else{var b="";for(i=0;i<e.length;i++){if(e[i]!=f){b=b+e[i]+","}}h.compute=b.substring(0,b.length-1)}tableView(a,c)}function tableView(c,b){if(c.cols==undefined||c.rows==undefined||c.kpiJson==undefined){return}if(c.kpiJson.length==0&&c.cols.length==0&&c.rows.length==0){$("#T"+b+" div.ctx").html(crtCrossTable());initDropDiv(b);return}var a={tid:c.tid,id:c.id,cols:c.cols,rows:c.rows,kpiJson:c.kpiJson,params:pageInfo.params};__showLoading();$.ajax({type:"POST",url:"TableView.action",dataType:"html",contentType:"application/json",data:JSON.stringify(a),success:function(d){__hideLoading();$("#T"+b+" div.ctx").html(d);initDropDiv(b)},error:function(d){__hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function kpiwarning(){var c=curTmpInfo.ckid;var b=curTmpInfo.compId.replace("T","");var a=findCompById(b);var e=findKpiById(c,a.kpiJson);var f=e.warning;var d='<div style=\'margin:10px;\'><span class="inputtext">图片样式：</span><select id="wctype" class="inputform2" style="width:90px;"><option value="1" '+(f&&f.pictype=="1"?"selected":"")+'>交通灯</option><option value="2" '+(f&&f.pictype=="2"?"selected":"")+'>箭头</option></select> <div class="checkbox checkbox-inline"><input type="checkbox" value="y" id="fztp" name="fztp" '+(f&&f.reverse=="y"?"checked":"")+'><label for="fztp">反转图片</label></div><br/>';d=d+'<span id="w1" class="'+(f?f.pic1:"warning6")+'"></span> <span class="inputtext">当前值</span> <select id="logic1" name="logic1" class="inputform2" style="width:50px;"><option value=">=" '+(f&&f.logic1==">="?"selected":"")+'>&gt;=</option><option value=">" '+(f&&f.logic1==">"?"selected":"")+'>&gt;</option></select> <input type="text" id="val1" name="val1" idx="1" value="'+(f?f.val1:"")+'"> <br/><span id="w2" class="'+(f?f.pic2:"warning5")+'"></span> <span class="inputtext">当前值 &lt; <span id="and1">'+(f?f.val1:"X")+'</span> 且 </span> <select id="logic2" name="logic2" class="inputform2" style="width:50px;"><option value=">=" '+(f&&f.logic2==">="?"selected":"")+'>&gt;=</option><option value=">" '+(f&&f.logic2=="="?"selected":"")+'>&gt;</option></select> <input type="text" name="val2" idx="2" id="val2" value="'+(f?f.val2:"")+'"><br/> <span id="w3" class="'+(f?f.pic3:"warning4")+'"></span> <span class="inputtext"> 当前值 &lt;  <span id="and2">'+(f?f.val2:"X")+'</span></span> <br/><div class="checkbox checkbox-info"><input type="checkbox" value="y" id="clear" name="clear" ><label for="clear">清除预警信息</label></div></div>';$("#pdailog").dialog({title:"指标预警",width:360,height:240,closed:false,cache:false,modal:true,toolbar:null,content:d,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var r=$("#pdailog #wctype").val();var n=$('#pdailog input[name="fztp"]:checked').val();if(!n){n="n"}var p=$("#pdailog #logic1").val();var l=$("#pdailog #val1").val();var o=$("#pdailog #logic2").val();var h=$("#pdailog #val2").val();var g=$("#pdailog #w1").attr("class");var s=$("#pdailog #w2").attr("class");var q=$("#pdailog #w3").attr("class");if(l==""||h==""){delete e.warning;tableView(a,b);$("#pdailog").dialog("close");return}e.warning={pictype:r,reverse:n,logic1:p,val1:l,logic2:o,val2:h,pic1:g,pic2:s,pic3:q};tableView(a,b);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #val1,#pdailog #val2").numberbox({width:100,height:28,onChange:function(l,h){var g=$(this).attr("idx");$("#pdailog #and"+g).text(l)}});$("#pdailog #wctype").change(function(){if($(this).val()==1){$("#pdailog #w1").attr("class","warning6");$("#pdailog #w2").attr("class","warning5");$("#pdailog #w3").attr("class","warning4")}else{if($(this).val()==2){$("#pdailog #w1").attr("class","warning3");$("#pdailog #w2").attr("class","warning2");$("#pdailog #w3").attr("class","warning1")}}});$("#pdailog #fztp").change(function(){if(this.checked){if($("#pdailog #wctype").val()==1){$("#pdailog #w1").attr("class","warning4");$("#pdailog #w2").attr("class","warning5");$("#pdailog #w3").attr("class","warning6")}else{if($("#pdailog #wctype").val()==2){$("#pdailog #w1").attr("class","warning1");$("#pdailog #w2").attr("class","warning2");$("#pdailog #w3").attr("class","warning3")}}}else{if($("#pdailog #wctype").val()==1){$("#pdailog #w1").attr("class","warning6");$("#pdailog #w2").attr("class","warning5");$("#pdailog #w3").attr("class","warning4")}else{if($("#pdailog #wctype").val()==2){$("#pdailog #w1").attr("class","warning3");$("#pdailog #w2").attr("class","warning2");$("#pdailog #w3").attr("class","warning1")}}}});$("#pdailog #clear").change(function(){if(this.checked){$("#pdailog #val1").numberbox("clear");$("#pdailog #val2").numberbox("clear")}})}function kpiFilter(g,a){var e=curTmpInfo.ckid;var h=curTmpInfo.compId.replace("T","");var d=findCompById(h);var f=findKpiById(e,a?d.mkpiJson:d.kpiJson);var b=f.filter;var c="";if(f.rate==1000){c="千"}else{if(f.rate==10000){c="万"}else{if(f.rate==1000000){c="百万"}else{if(f.rate==100000000){c="亿"}}}}var l="<div style='margin:5px; line-height:25px;'><span class=\"inputtext\">"+f.kpi_name+'：</span> <select id="ftype" class="inputform" style="width:100px;"><option value=""></option><option value=">" '+(b&&b.filterType==">"?"selected":"")+'>大于</option><option value="<" '+(b&&b.filterType=="<"?"selected":"")+'>小于</option><option value="=" '+(b&&b.filterType=="="?"selected":"")+'>等于</option><option value="between" '+(b&&b.filterType=="between"?"selected":"")+'>区间</option></select> <br/>  <span class="inputtext"> </span> <input type="text" style="" id="startval" size="5" value="'+(b?b.val1:"")+'"><span id="endvalspan" style="display:'+(b&&b.filterType=="between"?"inline":"none")+'"> - <input class="inputform" type="text" id="endval" size="5" value="'+(b?b.val2:"")+'"></span>'+c+f.unit+'<br/><button id="clear" class="btn btn-success btn-xs">清除筛选</button></div>';$("#pdailog").dialog({title:"度量筛选",width:350,height:220,closed:false,cache:false,modal:true,toolbar:null,content:l,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var q=$("#pdailog #ftype").val();var n=$("#pdailog #startval").val();var p=$("#pdailog #endval").val();if(q==""||n==""){delete f.filter}else{var o={kpi:f.kpi_id,filterType:q,val1:Number(n),val2:(p==""?0:Number(p))};f.filter=o}$("#pdailog").dialog("close");curTmpInfo.isupdate=true;if(g=="table"){tableView(d,h)}else{if(g=="chart"){chartview(d,h)}}}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #startval,#pdailog #endval").numberbox({width:100,height:28});$("#pdailog #ftype").bind("change",function(){var n=$(this);if(n.val()=="between"){$("#pdailog #endvalspan").css("display","inline")}else{$("#pdailog #endvalspan").css("display","none")}});$("#pdailog #clear").bind("click",function(){$("#pdailog #ftype").val("");$("#pdailog #startval").numberbox("clear");$("#pdailog #endval").numberbox("clear")})}function delJsonKpiOrDim(f){var a=curTmpInfo.ckid;var n=curTmpInfo.compId.replace("T","");var d=findCompById(Number(n));var e=curTmpInfo.pos;if(f=="kpi"){var l=d.kpiJson;var h=-1;for(var c=0;c<l.length;c++){if(l[c].kpi_id==a){h=c;break}}l.splice(h,1)}if(f=="dim"){var g=null;if(e=="col"){g=d.cols}else{g=d.rows}var h=-1;for(var c=0;c<g.length;c++){if(g[c].id==a){h=c;break}}g.splice(h,1);if(!isExistDateDim(d,"table")){for(var b=0;d.kpiJson&&b<d.kpiJson.length;b++){delete d.kpiJson[b].compute}}if(!paramsamedimdate(d)){for(var b=0;d.kpiJson&&b<d.kpiJson.length;b++){delete d.kpiJson[b].compute}}}curTmpInfo.isupdate=true;tableView(d,n)}function setKpiInfo(b,e){var d=$(b).offset();curTmpInfo.ckid=e;curTmpInfo.compId=$(b).parents(".comp_table").attr("id");var a=findCompById(Number(curTmpInfo.compId.replace("T","")));var c=findKpiById(e,a.kpiJson);if(c.sort=="asc"){$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-ok"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-blank"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-blank"})}else{if(c.sort=="desc"){$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-blank"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-ok"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-blank"})}else{$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-blank"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-blank"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-ok"})}}$("#kpioptmenu").menu("show",{left:d.left,top:d.top+20})}function setCdimInfo(h,b,a){var d=$(h).offset();curTmpInfo.ckid=b;curTmpInfo.compId=$(h).parents(".comp_table").attr("id");curTmpInfo.pos="col";curTmpInfo.dimname=a;var e=false;var g=findCompById(Number(curTmpInfo.compId.replace("T","")));var l=g.cols;for(var f=0;f<l.length;f++){if(l[f].id==b){if(l[f].issum=="y"){e=true;break}}}if(e){var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"取消聚合"})}else{var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"聚合..."})}var c=$("#dimoptmenu").menu("getItem",$("#m_moveto"));$("#dimoptmenu").menu("setText",{target:c.target,text:"移至行维度"});$("#dimoptmenu").menu("show",{left:d.left,top:d.top+20})}function setRdimInfo(h,b,a){var d=$(h).offset();curTmpInfo.ckid=b;curTmpInfo.compId=$(h).parents(".comp_table").attr("id");curTmpInfo.pos="row";curTmpInfo.dimname=a;var e=false;var g=findCompById(Number(curTmpInfo.compId.replace("T","")));var l=g.rows;for(var f=0;f<l.length;f++){if(l[f].id==b){if(l[f].issum=="y"){e=true;break}}}if(e){var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"取消聚合"})}else{var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"聚合..."})}var c=$("#dimoptmenu").menu("getItem",$("#m_moveto"));$("#dimoptmenu").menu("setText",{target:c.target,text:"移至列维度"});$("#dimoptmenu").menu("show",{left:d.left,top:d.top+20})}function changecolrow(e){var d=curTmpInfo.compId.replace("T","");var b=findCompById(d);var c=b.rows;b.rows=b.cols;b.cols=c;tableView(b,d);if(b.complink&&e){var a=findCompById(b.complink);if(a!=null&&isSameDimsInDrill(b,a)){exchangexs(a.id,false)}}}function searchDims(g,c){var f=$("#dimfiltertab").tabs("getSelected");var b=curTmpInfo.ckid;var e=curTmpInfo.compId.replace("T","");var a=findCompById(e);var d="paramSearch.action?id="+b+"&tid="+a.tid;$.ajax({type:"POST",url:d,data:{keyword:g,vals:c,t:Math.random()},dataType:"HTML",success:function(h){$("#dimfiltertab").tabs("update",{tab:f,options:{content:'<div class="dfilter">'+h+"</div>"}})}})}function fireTableScroll(e){$("#T"+e+" #d_kpi").scroll(function(){var g=$(this).scrollTop();$("#d_rowDims table").css("margin-top","-"+g+"px");var f=$(this).scrollLeft();$("#T"+e+" #d_colDims table").css("margin-left","-"+f+"px")});var b=findCompById(e);var d=b.rows?b.rows.length:1;if(d==0){d=1}var a=$("#optarea").width(),c=$(window).height();c=c-300;a=a-(127*d);if(a<0){a=200}$("#T"+e+" #d_rowDims").height(c);$("#T"+e+" #d_colDims").width(a);$("#T"+e+" #d_kpi").width(a).height(c)}function filterDims(){var l=curTmpInfo.ckid;var o=curTmpInfo.compId.replace("T","");var h=curTmpInfo.pos;var b=curTmpInfo.dimname;var e=findCompById(o);var n=null;if(h=="col"){n=e.cols}else{n=e.rows}var q;for(var d=0;d<n.length;d++){if(n[d].id==l){q=n[d].type;break}}$("#pdailog").dialog({title:b+" - 维度筛选",width:300,height:q=="frd"?341:310,closed:false,cache:false,modal:true,content:'<div id="div_dimfilter"><div class="panel-loading">Loading...</div></div>',onClose:function(){$("#pdailog").removeClass("hidebody")},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var y=null;for(var u=0;u<n.length;u++){if(n[u].id==l){y=n[u];break}}var v=$("#dimfiltertab").tabs("getSelected");var t=$("#dimfiltertab").tabs("getTabIndex",v);if("day"==y.type&&t==0){var s=$("#dimfiltertab #dft2").val();var r=$("#dimfiltertab #dft1").val();if(Number(s.replace(/-/g,""))>Number(r.replace(/-/g,""))){msginfo("您选择的开始日期不能大于结束日期。","error");return}y.startdt=s;y.enddt=r;y.filtertype=1;delete y.vals}else{if("month"==y.type&&t==0){var s=$("#dimfiltertab #dfm2").val();var r=$("#dimfiltertab #dfm1").val();if(Number(s)>Number(r)){msginfo("您选择的开始月份不能大于结束月份。","error");return}y.startmt=s;y.endmt=r;y.filtertype=1;delete y.vals}else{var w="";var x=$("#pdailog input[name='dimval']:checkbox:checked");x.each(function(A,z){if(A>=10){return}w=w+$(this).val();if(A==x.size()-1||A==9){}else{w=w+","}});y.vals=w;y.filtertype=2;delete y.startmt;delete y.endmt;delete y.startdt;delete y.enddt}}curTmpInfo.isupdate=true;tableView(e,o);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog").addClass("hidebody");var g="";var c="";var f="";var p=null;for(var d=0;d<n.length;d++){if(n[d].id==l){g=(n[d].vals?n[d].vals:"");c=n[d].type;f=n[d].filtertype==undefined?"":n[d].filtertype;p=n[d];break}}var a=(curTmpInfo.filterUrl?curTmpInfo.filterUrl:"DimFilter.action")+"?filtertype="+f+"&tid="+e.tid+"&id="+l;if(c=="month"){a=a+"&st="+(p.startmt==undefined?"":p.startmt);a=a+"&end="+(p.endmt==undefined?"":p.endmt)}if(c=="day"){a=a+"&st="+(p.startdt==undefined?"":p.startdt);a=a+"&end="+(p.enddt==undefined?"":p.enddt);a=a+"&dateformat="+p.dateformat}$("#pdailog #div_dimfilter").load(a,{vals:g,t:Math.random()})}function aggreDim(){var f=curTmpInfo.ckid;var h=curTmpInfo.compId.replace("T","");var e=curTmpInfo.pos;var a=curTmpInfo.dimname;var d=findCompById(h);var g=null;if(e=="col"){g=d.cols}else{g=d.rows}var c=null;for(var b=0;b<g.length;b++){if(g[b].id==f){c=g[b]}}if(c.issum=="y"){c.issum="n";delete c.aggre;curTmpInfo.isupdate=true;tableView(d,h);return}var l='<div style=\'line-height:30px; margin:20px 20px 20px 40px;\'><span class="inputtext">聚合方式：</span><select id="dimaggre" name="dimaggre" class="inputform2"><option value="sum">求和</option><option value="count">计数</option><option value="avg">平均</option><option value="max">最大</option><option value="min">最小</option><option value="var">方差</option><option value="sd">标准差</option><option value="middle">中位数</option></select></div>';$("#pdailog").dialog({title:"维度聚合",width:300,height:180,closed:false,cache:false,modal:true,toolbar:null,content:l,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){if(c.issum=="y"){c.issum="n";delete c.aggre}else{c.issum="y";c.aggre=$("#pdailog #dimaggre").val()}curTmpInfo.isupdate=true;tableView(d,h);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}function isExistDateDim(a,d){var b=false;if(d=="table"){if(!a||!a.cols){return b}for(var c=0;c<a.cols.length;c++){var d=a.cols[c].type;if(d=="year"||d=="quarter"||d=="month"||d=="day"){b=true;break}}if(!a||!a.rows){return b}for(var c=0;c<a.rows.length;c++){var d=a.rows[c].type;if(d=="year"||d=="quarter"||d=="month"||d=="day"){b=true;break}}}if(d=="chart"){if(!a.chartJson||!a.chartJson.params){return b}for(var c=0;c<a.chartJson.params.length;c++){var d=a.chartJson.params[c].type;if(d=="year"||d=="quarter"||d=="month"||d=="day"){b=true;break}}if(!a.chartJson||!a.chartJson.xcol){return b}var e=a.chartJson.xcol.type;if(e=="year"||e=="quarter"||e=="month"||e=="day"){b=true}}return b}function linkdetail(b){var a=findCompById(1);$.ajax({type:"POST",url:"header.action",dataType:"JSON",data:{tid:a.tid},success:function(e){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var c='<table id="detailTable"></table>';$("#dsColumn_div").dialog({title:"度量提取明细",width:660,height:400,closed:false,cache:false,modal:true,toolbar:null,content:c,toolbar:[{iconCls:"icon-export",text:"导出",handler:function(){location.href="exportDetail.action"}}],onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"关闭",iconCls:"icon-ok",handler:function(){$("#dsColumn_div").dialog("close")}}]});var d=[];for(i=0;i<e.length;i++){d.push({field:e[i].colName,title:e[i].colName,width:"90"})}$("#detailTable").datagrid({fitColumns:true,pagination:true,columns:[d],singleSelect:true,pageSize:20,fit:true,loader:function(l,h,g){var f={pms:b,tid:a.tid,page:l.page,rows:l.rows};$.ajax({type:"POST",url:"detail.action",contentType:"application/json",dataType:"JSON",data:JSON.stringify(f),success:function(n){h(n)},error:function(n){$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}})},error:function(c){$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function kpiproperty(){var d=curTmpInfo.ckid;var c=curTmpInfo.compId.replace("T","");var b=findCompById(c);var e=findKpiById(d,b.kpiJson);var a="<div style='line-height:30px; margin:5px;'><span class=\"inputtext\">度量名称：</span>"+e.kpi_name+'<br><span class="inputtext">所 属 表：</span>'+b.tname+'<br><span class="inputtext">聚合方式：</span>'+e.aggre+"<br><span class=\"inputtext\">度量单位：</span><select id=\"kpiunit\" name=\"kpiunit\" class=\"inputform2\"><option value='1'></option><option value='1000'>千</option><option value='10000'>万</option><option value='1000000'>百万</option><option value='100000000'>亿</option></select>"+e.unit+'<br><span class="inputtext">格 式 化：</span><select id="fmt" name="fmt" class="inputform2"><option value="###,##0">整数</option><option value="###,##0.0">小数(保留1位)</option><option value="###,##0.00">小数(保留2位)</option><option value="0.00%">百分比</option></select></div>';$("#pdailog").dialog({title:"度量属性",width:400,height:250,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){e.fmt=$("#pdailog #fmt").val();e.rate=Number($("#pdailog #kpiunit").val());$("#pdailog").dialog("close");curTmpInfo.isupdate=true;tableView(b,c)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #fmt").find("option[value='"+e.fmt+"']").attr("selected",true);$("#pdailog #kpiunit").find("option[value='"+e.rate+"']").attr("selected",true)}function getDimTop(){var f=curTmpInfo.ckid;var h=curTmpInfo.compId.replace("T","");var e=curTmpInfo.pos;var a=curTmpInfo.dimname;var d=findCompById(h);var g=null;if(e=="col"){g=d.cols}else{g=d.rows}var c=null;for(var b=0;b<g.length;b++){if(g[b].id==f){c=g[b]}}var l='<div style="margin:20px;"><span class="inputtext">维度取Top：</span><input type="text" id="top" name="top" size="5" value="'+(c.top?c.top:"")+'"><br/><span class="inputtext"></span><select id="type" name="type" class="inputform2"><option value="number" '+(c.topType=="number"?"selected":"")+'>数字</option><option value="percent" '+(c.topType=="percent"?"selected":"")+">百分比</option></select></div>";$("#pdailog").dialog({title:"维度取Top",width:360,height:170,closed:false,cache:false,modal:true,toolbar:null,content:l,buttons:[{text:"完成",iconCls:"icon-ok",handler:function(){var o=$("#pdailog #top").numberbox("getValue");var n=$("#pdailog #type").val();c.top=o;c.topType=n;$("#pdailog").dialog("close");tableView(d,h)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #top").numberbox({width:180,height:28})}function kpisort(d){var c=curTmpInfo.ckid;var b=curTmpInfo.compId.replace("T","");var a=findCompById(b);for(i=0;i<a.kpiJson.length;i++){if(a.kpiJson[i].kpi_id==c){a.kpiJson[i].sort=d}else{a.kpiJson[i].sort=""}}for(i=0;a.cols&&i<a.cols.length;i++){a.cols[i].dimord=""}for(i=0;a.rows&&i<a.rows.length;i++){a.rows[i].dimord=""}curTmpInfo.isupdate=true;tableView(a,b)}function dimsort(g){var b=curTmpInfo.ckid;var e=curTmpInfo.compId.replace("T","");var h=curTmpInfo.pos;var c=curTmpInfo.dimname;var a=findCompById(e);var f=null;if(h=="col"){f=a.cols}else{f=a.rows}for(var d=0;d<f.length;d++){if(f[d].id==b){f[d].dimord=g;break}}for(d=0;d<a.kpiJson.length;d++){a.kpiJson[d].sort=""}curTmpInfo.isupdate=true;tableView(a,e);$("#dimoptmenu").menu("hide")}function dimexchange(){var f=curTmpInfo.ckid;var n=curTmpInfo.compId.replace("T","");var e=curTmpInfo.pos;var a=curTmpInfo.dimname;var d=findCompById(n);if(e=="col"){var h=0;var c=null;var g=d.cols;for(var b=0;b<g.length;b++){if(g[b].id==f){h=b;c=g[b];break}}var l=c.grouptype;if(l!=null&&findGroup(d.cols,l,c)){msginfo("移动失败，同一分组的维度必须在同一行/列标签。","error");return}d.cols.splice(h,1);d.rows.push(c)}if(e=="row"){var h=0;var c=null;var g=d.rows;for(var b=0;b<g.length;b++){if(g[b].id==f){h=b;c=g[b];break}}var l=c.grouptype;if(l!=null&&findGroup(d.rows,l,c)){msginfo("移动失败，同一分组的维度必须在同一行/列标签。","error");return}d.rows.splice(h,1);d.cols.push(c)}curTmpInfo.isupdate=true;tableView(d,n)}function dimmove(g){var b=curTmpInfo.ckid;var e=curTmpInfo.compId.replace("T","");var h=curTmpInfo.pos;var c=curTmpInfo.dimname;var a=findCompById(e);var f=null;if(h=="col"){f=a.cols}else{f=a.rows}if(f.length<=1){msginfo("无效移动。","error");return}for(var d=0;d<f.length;d++){if(f[d].id==b){if(g=="left"){if(d<=0){msginfo("无效移动。","error");return}else{var g=f[d-1];f[d-1]=f[d];f[d]=g;curTmpInfo.isupdate=true;tableView(a,e);$("#dimoptmenu").menu("hide");return}}else{if(g=="right"){if(d>=f.length-1){msginfo("无效移动。","error");return}else{var g=f[d+1];f[d+1]=f[d];f[d]=g;curTmpInfo.isupdate=true;tableView(a,e);$("#dimoptmenu").menu("hide");return}}}break}}}function getTableHeadJson(c){var a=findCompById(c);if(a==null){msginfo("组件不存在！","error")}var b;$.ajax({type:"POST",async:false,url:"Table2JSON.action",dataType:"json",data:{json:JSON.stringify(a),_hideMVDiv:"true"},success:function(d){b=d}});return b}function findDimById(c,d){var a=null;if(!d||d==null){return a}for(var b=0;b<d.length;b++){if(d[b].id==c){a=d[b];break}}return a}function findKpiById(d,c){var a=null;if(!c||c==null){return a}for(var b=0;b<c.length;b++){if(c[b].kpi_id==d){a=c[b];break}}return a}function findParamById(a){var b=null;for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var c=pageInfo.params[i];if(c.id==a){b=c;break}}return b}function kpiExist(d,c){var a=false;if(!c||c==null){return a}for(var b=0;b<c.length;b++){if(c[b].kpi_id==d){a=true;break}}return a}function dimExist(c,d){var a=false;if(!d||d==null){return a}for(var b=0;b<d.length;b++){if(d[b].id==c){a=true;break}}return a}function findCompById(e,c){var d=c?c:pageInfo;var a=null;for(i=0;i<d.comps.length;i++){var b=d.comps[i];if(b.id==e){a=b;break}}return a};